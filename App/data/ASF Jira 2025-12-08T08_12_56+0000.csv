Summary,Issue key,Issue id,Parent id,Issue Type,Status,Project key,Project name,Project type,Project lead,Project description,Project url,Priority,Resolution,Assignee,Reporter,Creator,Created,Updated,Last Viewed,Resolved,Affects Version/s,Affects Version/s,Affects Version/s,Affects Version/s,Affects Version/s,Affects Version/s,Affects Version/s,Affects Version/s,Fix Version/s,Fix Version/s,Fix Version/s,Component/s,Component/s,Component/s,Due Date,Votes,Labels,Labels,Labels,Description,Environment,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Log Work,Original Estimate,Remaining Estimate,Time Spent,Work Ratio,Σ Original Estimate,Σ Remaining Estimate,Σ Time Spent,Security Level,Inward issue link (Child-Issue),Inward issue link (Cloners),Outward issue link (Cloners),Inward issue link (Duplicate),Outward issue link (Duplicate),Inward issue link (Problem/Incident),Outward issue link (Problem/Incident),Outward issue link (Problem/Incident),Inward issue link (Reference),Inward issue link (Reference),Outward issue link (Reference),Outward issue link (Reference),Inward issue link (Supercedes),Outward issue link (Supercedes),Outward issue link (Supercedes),Outward issue link (Supercedes),Outward issue link (Supercedes),Attachment,Attachment,Attachment,Attachment,Attachment,Custom field (Affects version (Component)),Custom field (Attachment count),Custom field (Blog - New Blog Administrators),Custom field (Blog - New Blog PMC),Custom field (Blog - Write access),Custom field (Blog Administrator?),Custom field (Blogs - Admin for blog),Custom field (Blogs - Email Address),Custom field (Blogs - Existing Blog Access Level),Custom field (Blogs - Existing Blog Name),Custom field (Blogs - New Blog Write Access),Custom field (Blogs - Username),Custom field (Bug Category),Custom field (Bugzilla - Email Notification Address),Custom field (Bugzilla - List of usernames),Custom field (Bugzilla - PMC Name),Custom field (Bugzilla - Project Name),Custom field (Bugzilla Id),Custom field (Bugzilla Id),Custom field (Change Category),Custom field (Complexity),Custom field (Discovered By),Custom field (Docs Text),Custom field (Enable Automatic Patch Review),Custom field (Epic Colour),Custom field (Epic Link),Custom field (Epic Name),Custom field (Epic Status),Custom field (Estimated Complexity),Custom field (Evidence Of Open Source Adoption),Custom field (Evidence Of Registration),Custom field (Evidence Of Use On World Wide Web),Custom field (Existing GitBox Approval),Custom field (External issue ID),Custom field (External issue URL),Custom field (Fix version (Component)),Custom field (Git Notification Mailing List),Custom field (Git Repository Import Path),Custom field (Git Repository Name),Custom field (Git Repository Type),Custom field (GitHub Options),Custom field (Github Integration),Custom field (Github Integrations - Other),Custom field (Global Rank),Custom field (Hadoop Flags),Custom field (INFRA - Subversion Repository Path),Custom field (Initial Confluence Contributors),Custom field (Language),Custom field (Language),Custom field (Last public comment date),Custom field (Level of effort),Custom field (Machine Readable Info),Custom field (Mentor),Custom field (New-TLP-TLPName),Custom field (Original story points),Custom field (Parent Link),Custom field (Priority),Custom field (Project),Custom field (Protected Branch),Custom field (Rank),Custom field (Rank (Obsolete)),Custom field (Release Note),Custom field (Review Date),Custom field (Reviewer),Custom field (Severity),Custom field (Severity),Custom field (Skill Level),Custom field (Source Control Link),Custom field (Space Description),Custom field (Space Key),Custom field (Space Name),Custom field (Start Date),Custom field (Tags),Custom field (Tags),Custom field (Target end),Custom field (Target start),Custom field (Team),Custom field (Test and Documentation Plan),Custom field (Testcase included),Custom field (Tester),Custom field (Workaround),Comment,Comment,Comment,Comment,Comment,Comment,Comment,Comment,Comment,Comment,Comment,Comment
Compilation of client on Windows with MSVC is broken,ZOOKEEPER-4989,13633310,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Blocker,Fixed,jmalopoy,jmalopoy,jmalopoy,04/Nov/25 12:47,10/Nov/25 13:26,08/Dec/25 08:12,10/Nov/25 13:26,3.9.4,,,,,,,,3.10.0,3.9.5,,c client,,,,0,pull-request-available,,,"Fix added for ZOOKEEPER-4810 (Fix buf data race at format_endpoint_info) in PR [https://github.com/apache/zookeeper/pull/2140] broke the build of the C client on Windows using MVSC.
The error reported is:
{noformat}
error C2143: syntax error: missing ';' before 'type'{noformat}
It is reported at zookeeper-client\zookeeper-client-c\src\zookeeper.c(5134)

 ",,"jmalopoy opened a new pull request, #2335:
URL: https://github.com/apache/zookeeper/pull/2335

   Fixing compilation on Windows with MSVC.
   The build was broken by merged PR https://github.com/apache/zookeeper/pull/2140
   


;04/Nov/25 13:09;githubbot;600","kezhuw merged PR #2335:
URL: https://github.com/apache/zookeeper/pull/2335


;10/Nov/25 13:19;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1200,,,0,1200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,C,,Mon Nov 10 13:26:18 UTC 2025,,,,,,,,,,"0|z1yg3k:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"04/Nov/25 13:11;jmalopoy;I created a proposal of fix in PR [https://github.com/apache/zookeeper/pull/2335]

 ;;;","10/Nov/25 13:26;kezhuw;master: fb43500ea53fa5b57b6dc549c6582ae0ac60d7bc

branch-3.9: 3412d237e5a0174a28f963747c359031248b7c55;;;",,,,,,,,,,
Disable reverse DNS lookup in TLS client and server,ZOOKEEPER-4986,13630806,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,andor,andor,andor,06/Oct/25 20:23,01/Dec/25 21:08,08/Dec/25 08:12,01/Dec/25 21:08,3.10.0,3.9.4,,,,,,,3.10.0,3.9.5,,security,server,,,0,pull-request-available,,,"Port the property behavior from [Apache HBase|https://github.com/apache/hbase/commit/5baeacb7d65f8ec3386690cadbf5e091e20b7b23#diff-b8e69e4d42340619ee4cd63d9e45d7224727f78c05da70ff9ce080c1d33e36d6R157] which controls wether reverse DNS lookup is allowed in TLS handshake if the hostname is not available (e.g. connect via IP address, client hostname verification, etc.)

Disable reverse DNS lookups by default for both quorum and client protocols to be consistent. This should be safe from backward compatibility perspective in a new major (minor?) version if we cut 4.0.0 from master soon. In a {{branch-3.9}} backport we should enable reverse lookup in the quorum protocol by default to support smooth transition.",,"anmolnar opened a new pull request, #2325:
URL: https://github.com/apache/zookeeper/pull/2325

   Inspired by the same property that was implemented in [Apache HBase](https://github.com/apache/hbase/commit/5baeacb7d65f8ec3386690cadbf5e091e20b7b23#diff-b8e69e4d42340619ee4cd63d9e45d7224727f78c05da70ff9ce080c1d33e36d6R157) for the same purpose.
   
   Disable reverse DNS lookups by default for both quorum and client protocols to be consistent. This should be safe from backward compatibility perspective in a new major (minor?) version if we cut 4.0.0 from master soon. In a branch-3.9 backport we should enable reverse lookup in the quorum protocol by default to support smooth transition.
   
   From #2316 


;06/Oct/25 20:33;githubbot;600","onmywaytoheaven commented on PR #2325:
URL: https://github.com/apache/zookeeper/pull/2325#issuecomment-3374172959

   Hey @anmolnar, this one looks fine from the security perspective, thanks!


;06/Oct/25 21:13;githubbot;600","anmolnar merged PR #2325:
URL: https://github.com/apache/zookeeper/pull/2325


;07/Oct/25 12:38;githubbot;600","anmolnar opened a new pull request, #2327:
URL: https://github.com/apache/zookeeper/pull/2327

   Backported from #2325 


;14/Oct/25 22:03;githubbot;600","phunt commented on PR #2327:
URL: https://github.com/apache/zookeeper/pull/2327#issuecomment-3578149620

   +1 lgtm


;26/Nov/25 00:11;githubbot;600","anmolnar commented on PR #2327:
URL: https://github.com/apache/zookeeper/pull/2327#issuecomment-3583138813

   > +1 lgtm
   > 
   > #2331 has 4 files changed vs 13 here - did you get all the files modified? Why the significant diff in file count?
   
   Two different tickets. This one is ZOOKEEPER-4986 (TLS client and server), the other one is ZOOKEEPER-2858 (SASL).
   ZOOKEEPER-4986 has already been submitted to master branch here #2325 


;26/Nov/25 20:37;githubbot;600","anmolnar merged PR #2327:
URL: https://github.com/apache/zookeeper/pull/2327


;01/Dec/25 21:08;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,4200,,,0,4200,,,,,,,,,,,,ZOOKEEPER-2858,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Mon Dec 01 21:08:50 UTC 2025,,,,,,,,,,"0|z1y0n4:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"01/Dec/25 21:08;andor;Issue resolved by pull request 2327
[https://github.com/apache/zookeeper/pull/2327];;;",,,,,,,,,,,
Upgrade OWASP plugin to 12.1.6 due to breaking changes in the API,ZOOKEEPER-4984,13630474,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,andor,andor,andor,01/Oct/25 19:27,02/Dec/25 21:56,08/Dec/25 08:12,06/Oct/25 20:54,3.10.0,3.8.5,3.9.4,,,,,,3.10.0,3.8.6,3.9.5,security,,,,0,pull-request-available,,,"Authentication is now required for {*}Sonatype OSS Index{*}: [https://ossindex.sonatype.org/doc/auth-required]

I don't think we need this feature, so I won't add API key to the public repo, but I have to update the plugin to skip indexing with softfail.",,"anmolnar opened a new pull request, #2323:
URL: https://github.com/apache/zookeeper/pull/2323

   (no comment)


;01/Oct/25 19:31;githubbot;600","phunt commented on PR #2323:
URL: https://github.com/apache/zookeeper/pull/2323#issuecomment-3366711914

   +1 lgtm


;03/Oct/25 18:02;githubbot;600","anmolnar merged PR #2323:
URL: https://github.com/apache/zookeeper/pull/2323


;06/Oct/25 20:54;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1800,,,0,1800,,,,ZOOKEEPER-4960,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Mon Oct 06 20:54:58 UTC 2025,,,,,,,,,,"0|z1xylc:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"06/Oct/25 20:54;andor;Issue resolved by pull request 2323
[https://github.com/apache/zookeeper/pull/2323];;;",,,,,,,,,,,
Update Netty to fix CVE-2025-58057,ZOOKEEPER-4976,13628609,,Task,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,,aonikolaev,aonikolaev,10/Sep/25 18:30,03/Dec/25 17:16,08/Dec/25 08:02,19/Sep/25 16:09,,,,,,,,,3.10.0,3.8.6,3.9.5,,,,,0,pull-request-available,,,Upgrade Netty version to 4.1.127.Final in order to fix CVE-2025-58057,,"nao-it opened a new pull request, #2313:
URL: https://github.com/apache/zookeeper/pull/2313

   (no comment)


;10/Sep/25 18:48;githubbot;600","anmolnar merged PR #2313:
URL: https://github.com/apache/zookeeper/pull/2313


;19/Sep/25 16:08;githubbot;600","anmolnar commented on PR #2313:
URL: https://github.com/apache/zookeeper/pull/2313#issuecomment-3312795254

   Merged to `master` and `branch-3.9` branches. Thanks @nao-it !
   What's your jira id?


;19/Sep/25 16:10;githubbot;600","nao-it commented on PR #2313:
URL: https://github.com/apache/zookeeper/pull/2313#issuecomment-3318080377

   > Merged to `master` and `branch-3.9` branches. Thanks @nao-it ! What's your jira id?
   
   Thx, aonikolaev


;22/Sep/25 10:22;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,Upgrade Netty version to 4.1.127.Final in order to fix CVE-2025-58057,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Sep 19 16:09:09 UTC 2025,,,,,,,,,,"0|z1xn34:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"19/Sep/25 16:09;andor;Issue resolved by pull request 2313
[https://github.com/apache/zookeeper/pull/2313];;;",,,,,,,,,,,
Remove enforced JDK 17 compilation warnings,ZOOKEEPER-4974,13628539,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,andor,richardantal,richardantal,10/Sep/25 07:33,12/Sep/25 21:47,08/Dec/25 08:02,12/Sep/25 20:04,3.10.0,,,,,,,,3.10.0,3.9.5,,,,,,0,pull-request-available,,,"To ensure full compatibility with JDK17 we should remove any usages of SecurityManager
Because it is deprecated and causing the build to fail with extra maven parameters
-Dmaven.compiler.source=17 -Dmaven.compiler.target=17 -Dmaven.compiler.release=17
the build fails because of these warning
{code:java}
[WARNING] COMPILATION WARNING :
[INFO] -------------------------------------------------------------
[WARNING] /Users/andor/git/cdh/zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/WorkerService.java:[180,13] java.lang.SecurityManager in java.lang has been deprecated and marked for removal
[WARNING] /Users/andor/git/cdh/zookeeper/zookeeper-server/src/main/java/org/apache/zookeeper/server/WorkerService.java:[180,39] getSecurityManager() in java.lang.System has been deprecated and marked for removal{code}",,"anmolnar opened a new pull request, #2312:
URL: https://github.com/apache/zookeeper/pull/2312

   There're some deprecated usages in our codebase which prevents compiling with `--release=17` enforcer flag. This patch tries to refactor / remove them.


;10/Sep/25 17:06;githubbot;600","richardantal commented on code in PR #2312:
URL: https://github.com/apache/zookeeper/pull/2312#discussion_r2339031427


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java:
##########
@@ -344,10 +344,7 @@ public QuorumCnxManager(QuorumPeer self, final long mySid, Map<Long, QuorumPeer.
     // can take extra time)
     private void initializeConnectionExecutor(final long mySid, final int quorumCnxnThreadsSize) {
         final AtomicInteger threadIndex = new AtomicInteger(1);
-        SecurityManager s = System.getSecurityManager();
-        final ThreadGroup group = (s != null) ? s.getThreadGroup() : Thread.currentThread().getThreadGroup();
-
-        final ThreadFactory daemonThFactory = runnable -> new Thread(group, runnable,
+        final ThreadFactory daemonThFactory = runnable -> new Thread(runnable,

Review Comment:
   Wouldn't it be beneficial to use to keep the ThreadGroup without the getSecurityManager?
   `ThreadGroup group = Thread.currentThread().getThreadGroup();`



;11/Sep/25 07:09;githubbot;600","richardantal commented on code in PR #2312:
URL: https://github.com/apache/zookeeper/pull/2312#discussion_r2339031427


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java:
##########
@@ -344,10 +344,7 @@ public QuorumCnxManager(QuorumPeer self, final long mySid, Map<Long, QuorumPeer.
     // can take extra time)
     private void initializeConnectionExecutor(final long mySid, final int quorumCnxnThreadsSize) {
         final AtomicInteger threadIndex = new AtomicInteger(1);
-        SecurityManager s = System.getSecurityManager();
-        final ThreadGroup group = (s != null) ? s.getThreadGroup() : Thread.currentThread().getThreadGroup();
-
-        final ThreadFactory daemonThFactory = runnable -> new Thread(group, runnable,
+        final ThreadFactory daemonThFactory = runnable -> new Thread(runnable,

Review Comment:
   Wouldn't it be beneficial to keep the ThreadGroup without the getSecurityManager?
   `ThreadGroup group = Thread.currentThread().getThreadGroup();`



;11/Sep/25 09:01;githubbot;600","anmolnar commented on code in PR #2312:
URL: https://github.com/apache/zookeeper/pull/2312#discussion_r2341676931


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java:
##########
@@ -344,10 +344,7 @@ public QuorumCnxManager(QuorumPeer self, final long mySid, Map<Long, QuorumPeer.
     // can take extra time)
     private void initializeConnectionExecutor(final long mySid, final int quorumCnxnThreadsSize) {
         final AtomicInteger threadIndex = new AtomicInteger(1);
-        SecurityManager s = System.getSecurityManager();
-        final ThreadGroup group = (s != null) ? s.getThreadGroup() : Thread.currentThread().getThreadGroup();
-
-        final ThreadFactory daemonThFactory = runnable -> new Thread(group, runnable,
+        final ThreadFactory daemonThFactory = runnable -> new Thread(runnable,

Review Comment:
   I don't think we need that. Thread's constructor already does the right thing.
   ```java
               SecurityManager sm = System.getSecurityManager();
               if (g == null) {
                   // the security manager can choose the thread group
                   if (sm != null) {
                       g = sm.getThreadGroup();
                   }
   
                   // default to current thread's group
                   if (g == null) {
                       g = parent.getThreadGroup();
                   }
               }
   ```



;11/Sep/25 16:23;githubbot;600","anmolnar merged PR #2312:
URL: https://github.com/apache/zookeeper/pull/2312


;12/Sep/25 20:04;githubbot;600","anmolnar commented on PR #2312:
URL: https://github.com/apache/zookeeper/pull/2312#issuecomment-3286940567

   Merged and backported to `branch-3.9`. Thanks for the reviews @ctubbsii @richardantal !


;12/Sep/25 21:47;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3600,,,0,3600,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Sep 12 20:04:48 UTC 2025,,,,,,,,,,"0|z1xmnk:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"12/Sep/25 20:04;andor;Issue resolved by pull request 2312
[https://github.com/apache/zookeeper/pull/2312];;;",,,,,,,,,,,
Flaky tests in PrometheusMetricsProviderConfigTest,ZOOKEEPER-4972,13627399,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,kezhuw,kezhuw,kezhuw,26/Aug/25 19:00,19/Sep/25 22:46,08/Dec/25 08:02,19/Sep/25 22:46,,,,,,,,,3.10.0,,,server,tests,,,0,pull-request-available,,,"{noformat}
org.apache.zookeeper.metrics.MetricsProviderLifeCycleException: java.io.IOException: Failed to bind to /0.0.0.0:50512
	at org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider.start(PrometheusMetricsProvider.java:213)
	at org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProviderConfigTest.testValidHttpsAndHttpConfig(PrometheusMetricsProviderConfigTest.java:88)
{noformat}",,"kezhuw opened a new pull request, #2311:
URL: https://github.com/apache/zookeeper/pull/2311

   Those tests use hard written ports to listen.
   
   ```
   org.apache.zookeeper.metrics.MetricsProviderLifeCycleException: java.io.IOException: Failed to bind to /0.0.0.0:50512
   	at org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider.start(PrometheusMetricsProvider.java:213)
   	at org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProviderConfigTest.testValidHttpsAndHttpConfig(PrometheusMetricsProviderConfigTest.java:88)
   ```


;26/Aug/25 19:16;githubbot;600","anmolnar merged PR #2311:
URL: https://github.com/apache/zookeeper/pull/2311


;19/Sep/25 22:43;githubbot;600","anmolnar commented on PR #2311:
URL: https://github.com/apache/zookeeper/pull/2311#issuecomment-3314055026

   Merged to `master` branch only. Thanks @kezhuw !


;19/Sep/25 22:44;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1800,,,0,1800,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2025-08-26 19:00:33.0,,,,,,,,,,"0|z1xfm8:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Deprecate methods of ZKConfig which throw QuorumPeerConfig.ConfigException,ZOOKEEPER-4970,13627061,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Blocker,Fixed,kezhuw,kezhuw,kezhuw,22/Aug/25 15:19,01/Oct/25 04:51,08/Dec/25 08:02,30/Aug/25 13:38,3.8.4,3.9.3,,,,,,,3.10.0,3.9.5,,java client,,,,0,pull-request-available,,,"In pursue of ZOOKEEPER-233, I found some methods of {{ZKConfig}} throw {{ConfigException}} from {{QuorumPeerConfig}} which tied strictly with server side code. 

This is the only breaking change I found during draft https://github.com/apache/zookeeper/pull/2307.

So, I suggest we can deprecate theses methods first, both in master and old releases.",,"kezhuw opened a new pull request, #2309:
URL: https://github.com/apache/zookeeper/pull/2309

   `QuorumPeerConfig` belongs to and ties with other server code. To separate a slimmer `zookeeper-client` jar, we have to break the dependency from `ZKConfig` to `QuorumPeerConfig`. But this is a breaking change, it would be good to deprecate these methods first to ease future migration.
   
   Refs: ZOOKEEPER-4966, ZOOKEEPER-4970, ZOOKEEPER-233.


;22/Aug/25 17:34;githubbot;600","kezhuw commented on PR #2309:
URL: https://github.com/apache/zookeeper/pull/2309#issuecomment-3215107605

   See also #2306, #2307.


;22/Aug/25 17:35;githubbot;600","tisonkun commented on PR #2309:
URL: https://github.com/apache/zookeeper/pull/2309#issuecomment-3215900647

   > To separate a slimmer zookeeper-client jar
   
   Maybe we can instead create a `zookeeper-server` jar, and make the `zookeeper` jar depend on it now. Later, we break the dependency and rename `zookeeper` to `zookeeper-client`. This would help us to verify the situation while keeping the b/w compatibility before we do the break.


;22/Aug/25 23:02;githubbot;600","tisonkun commented on PR #2309:
URL: https://github.com/apache/zookeeper/pull/2309#issuecomment-3215907397

   OK. I see https://github.com/apache/zookeeper/pull/2307 now. So just go for 4.0 :D


;22/Aug/25 23:06;githubbot;600","kezhuw merged PR #2309:
URL: https://github.com/apache/zookeeper/pull/2309


;30/Aug/25 13:37;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3000,,,0,3000,,,,,,,ZOOKEEPER-4966,,,,,ZOOKEEPER-233,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Oct 01 04:51:50 UTC 2025,,,,,,,,,,"0|z1xdj4:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"30/Aug/25 13:38;kezhuw;Issue resolved by pull request 2309
[https://github.com/apache/zookeeper/pull/2309];;;","01/Oct/25 04:51;kezhuw;Backported to branch-3.9 in commit f534e7135269d27f78380291b6582f674021239a to deprecate usages of {{QuorumPeerConfig.ConfigException}} from {{ZKClientConfig}}.;;;",,,,,,,,,,
"Drop unnecessary {{@SuppressWarnings(""deprecation"")}}",ZOOKEEPER-4965,13626819,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,kezhuw,kezhuw,kezhuw,20/Aug/25 07:06,01/Oct/25 04:49,08/Dec/25 08:02,20/Aug/25 19:16,,,,,,,,,3.10.0,3.9.5,,,,,,0,pull-request-available,,,,,"kezhuw opened a new pull request, #2304:
URL: https://github.com/apache/zookeeper/pull/2304

   (no comment)


;20/Aug/25 07:10;githubbot;600","kezhuw merged PR #2304:
URL: https://github.com/apache/zookeeper/pull/2304


;20/Aug/25 19:16;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1200,,,0,1200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Aug 20 19:16:43 UTC 2025,,,,,,,,,,"0|z1xc1c:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"20/Aug/25 19:16;kezhuw;Issue resolved by pull request 2304
[https://github.com/apache/zookeeper/pull/2304];;;",,,,,,,,,,,
Introduce ZooKeeper::builder for ZooKeeperBuilder,ZOOKEEPER-4963,13626555,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,kezhuw,kezhuw,kezhuw,17/Aug/25 04:19,23/Aug/25 05:58,08/Dec/25 08:12,23/Aug/25 05:58,,,,,,,,,3.10.0,,,java client,,,,0,pull-request-available,,,,,"kezhuw opened a new pull request, #2301:
URL: https://github.com/apache/zookeeper/pull/2301

   
   
   `ZooKeeper::builder` should be better:
   1. More exposure chance as a newly introduce method in class `ZooKeeper`.
   2. No need to import or remember the newly introduced class as most `ZooKeeper` instances could be built in one chain.
   
   `ZooKeeperBuilder` is introduced in 3.10.0 so it safe to do this.
   
   Refs: ZOOKEEPER-4697


;17/Aug/25 06:27;githubbot;600","kezhuw commented on PR #2301:
URL: https://github.com/apache/zookeeper/pull/2301#issuecomment-3210350774

   This should be superceded by #2308 if we are going that way.


;21/Aug/25 12:13;githubbot;600","kezhuw merged PR #2301:
URL: https://github.com/apache/zookeeper/pull/2301


;23/Aug/25 05:58;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1800,,,0,1800,,,,,,,,,,,,ZOOKEEPER-4697,,ZOOKEEPER-4968,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Sat Aug 23 05:58:30 UTC 2025,,,,,,,,,,"0|z1xaeo:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"23/Aug/25 05:58;kezhuw;Issue resolved by pull request 2301
[https://github.com/apache/zookeeper/pull/2301];;;",,,,,,,,,,,
Add getPort and getSecurePort for ZooKeeperServerEmbedded,ZOOKEEPER-4962,13626541,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,kezhuw,kezhuw,kezhuw,16/Aug/25 21:19,19/Sep/25 17:09,08/Dec/25 08:12,19/Sep/25 17:08,3.9.3,,,,,,,,3.10.0,3.9.5,,server,,,,0,pull-request-available,,,"Since ZOOKEEPER-4303, {{ZooKeeperServerEmbedded}} supports bind to port 0 to get unused port. It would be good to export {{getPort}} and {{getSecurePort}} for both inspection and custom connection string construction.",,"kezhuw opened a new pull request, #2302:
URL: https://github.com/apache/zookeeper/pull/2302

   Since, `ZooKeeperServerEmbedded` could bind to port 0 and get unused port from system. It would be good to export the bound client port in addition to `getConnectionString`.


;17/Aug/25 06:47;githubbot;600","anmolnar merged PR #2302:
URL: https://github.com/apache/zookeeper/pull/2302


;19/Sep/25 17:08;githubbot;600","anmolnar commented on PR #2302:
URL: https://github.com/apache/zookeeper/pull/2302#issuecomment-3313011891

   Merged to `master` and `branch-3.9` branches. Thanks @kezhuw !


;19/Sep/25 17:09;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1800,,,0,1800,,,,,,,,,,,,ZOOKEEPER-4303,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Sep 19 17:08:53 UTC 2025,,,,,,,,,,"0|z1xabk:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"19/Sep/25 17:08;andor;Issue resolved by pull request 2302
[https://github.com/apache/zookeeper/pull/2302];;;",,,,,,,,,,,
Upgrade OWASP plugin to 12.1.3 due to recent parsing errors,ZOOKEEPER-4960,13626477,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,andor,andor,andor,15/Aug/25 17:17,01/Oct/25 19:27,08/Dec/25 08:02,17/Aug/25 13:03,3.10.0,3.8.4,3.9.3,,,,,,3.10.0,3.8.5,3.9.4,security,,,,0,pull-request-available,,,"Looks like our Owasp version 8.3.1 is outdated, because recently started to throw the following errors:
{noformat}
12:06:36  [ERROR] org.owasp.dependencycheck.data.nvdcve.DatabaseException: Unable to parse CPE: cpe:2.3:a:f5:nginx unit:*:*:*:*:*:*:*:*
12:06:36  org.owasp.dependencycheck.data.update.exception.UpdateException: org.owasp.dependencycheck.data.nvdcve.DatabaseException: Unable to parse CPE: cpe:2.3:a:f5:nginx unit:*:*:*:*:*:*:*:*
12:06:36      at org.owasp.dependencycheck.data.update.nvd.ProcessTask.processFiles (ProcessTask.java:157)
12:06:36      at org.owasp.dependencycheck.data.update.nvd.ProcessTask.call (ProcessTask.java:114)
12:06:36      at org.owasp.dependencycheck.data.update.nvd.ProcessTask.call (ProcessTask.java:41)
12:06:36      at java.util.concurrent.FutureTask.run (FutureTask.java:266)
12:06:36      at java.util.concurrent.ThreadPoolExecutor.runWorker (ThreadPoolExecutor.java:1149)
12:06:36      at java.util.concurrent.ThreadPoolExecutor$Worker.run (ThreadPoolExecutor.java:624)
12:06:36      at java.lang.Thread.run (Thread.java:750){noformat}
-I'll try to upgrade to a more recent version which still has Java 8 support.-

We have to upgrade to 12.1.3, because the fix hasn't been backported to Java 8 versions.",,"anmolnar opened a new pull request, #2297:
URL: https://github.com/apache/zookeeper/pull/2297

   Upgrade to the latest version and use JDK11 to run in Jenkins, because fix hasn't been backported to Java 8 releases.
   
   https://github.com/dependency-check/DependencyCheck/issues/7847
   https://github.com/dependency-check/DependencyCheck/issues/7463


;15/Aug/25 19:22;githubbot;600","anmolnar commented on PR #2297:
URL: https://github.com/apache/zookeeper/pull/2297#issuecomment-3194366782

   @ctubbsii I don't see the issue you're talking about. This is only the **Owasp** library which is not used in any of our build configurations. The dependency check build minimum requirement will be JDK 11, but that's only the dependency check. I can still build the full-build profile with Java 8 fine. I updated the Jenkinsfile for the owasp build which is enough. You can see that all build configurations (GH actions, Jenkins CI) are green which means the JDK8 build is not broken.
   
   We need to update our release process page, because after this change release managers will no longer be able to run the dependency check with JDK8 and we also need to update the docker image to use JDK11 as default java runtime.


;17/Aug/25 12:50;githubbot;600","anmolnar merged PR #2297:
URL: https://github.com/apache/zookeeper/pull/2297


;17/Aug/25 13:00;githubbot;600","ctubbsii commented on PR #2297:
URL: https://github.com/apache/zookeeper/pull/2297#issuecomment-3194541903

   @anmolnar wrote:
   > ... that's only the dependency check. ... the JDK8 build is not broken.
   
   I agree with that, and I support the change you made (the gray checkmark on my review indicates a non-binding ""Approve"" for your PR). I am only suggesting that making JDK11 the minimum for all the tasks in the POM will be more convenient than having a special workaround for OWASP only.
   
   > I don't think users want to run the dependency check on their own.
   
   Many won't, but since the ASF's mission is to produce open source software, we should expect that *some* downstream users will build from source. The inconvenience for the ZK release manager is also an inconvenience for those users who want to run the tasks for themselves.
   
   > We need to update our release process page, because after this change release managers will no longer be able to run the dependency check with JDK8 and we also need to update the docker image to use JDK11 as default java runtime.
   
   That is satisfactory, but I think it's an inconvenience to have two separate minimum versions, depending on which tasks one executes. Also, there are other reasons to standardize on the minimum being JDK11 for everything:
   
   1. in this case, only OWASP requires a different minimum JDK... but next time, a plugin that is part of the main build might require JDK11. Making JDK11 the minimum for everything would help avoid such problems in the future,
   2. older JDK versions are increasingly harder to acquire in newer operating systems and corporate environments where security policies prevent the use of older software, so fewer people over time are actually building and testing with JDK8; so, continuing to support it is increasingly a waste of effort,
   3. JDK11 has stricter Java 8 compliance enforcement than JDK 8 does, so it's better to build with JDK11 if you want to support JRE8.


;17/Aug/25 17:36;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,ZOOKEEPER-4984,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2025-08-15 17:17:07.0,,,,,,,,,,"0|z1x9xc:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Fix license files after logback/slf4j upgrade,ZOOKEEPER-4959,13626473,,Task,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,andor,andor,andor,15/Aug/25 17:00,29/Aug/25 21:29,08/Dec/25 08:12,17/Aug/25 12:58,3.10.0,3.8.4,3.9.3,,,,,,3.10.0,3.8.5,3.9.4,license,,,,0,pull-request-available,,,"{{Andor, I notice a number of license files are inaccurate:}}
{code:java}
rw-rr-@  1 phunt  staff    11359 Aug  8 12:21 commons-io-2.11.0.LICENSE.txt
rw-rr-@  1 phunt  staff   515978 Aug  8 12:21 commons-io-2.17.0.jar
rw-rr-@  1 phunt  staff    36274 Aug  8 12:21 logback-classic-1.2.13.LICENSE.txt
rw-rr-@  1 phunt  staff   274470 Aug  8 12:21 logback-classic-1.3.15.jar
rw-rr-@  1 phunt  staff    36274 Aug  8 12:21 logback-core-1.2.13.LICENSE.txt
rw-rr-@  1 phunt  staff   571734 Aug  8 12:21 logback-core-1.3.15.jar
rw-rr-@  1 phunt  staff     1133 Aug  8 12:21 slf4j-1.7.30.LICENSE.txt
rw-rr-@  1 phunt  staff    68605 Aug  8 12:21 slf4j-api-2.0.13.jar{code}
{{Might be more than this (if new deps added?) but these are the obvious ones}}
{{I noticed. I think they need to be addressed/new RC.}}",,"anmolnar opened a new pull request, #2295:
URL: https://github.com/apache/zookeeper/pull/2295

   **Master** branch only needs updated license for SLF4j 2.0.13. Other branches will get new license for **logback** as well.


;15/Aug/25 17:14;githubbot;600","anmolnar opened a new pull request, #2296:
URL: https://github.com/apache/zookeeper/pull/2296

   (no comment)


;15/Aug/25 18:30;githubbot;600","anmolnar commented on PR #2295:
URL: https://github.com/apache/zookeeper/pull/2295#issuecomment-3192522494

   ping @kezhuw @eolivelli @phunt 


;15/Aug/25 19:29;githubbot;600","anmolnar commented on PR #2296:
URL: https://github.com/apache/zookeeper/pull/2296#issuecomment-3192523099

   ping @phunt @eolivelli @kezhuw 


;15/Aug/25 19:29;githubbot;600","ctubbsii commented on PR #2296:
URL: https://github.com/apache/zookeeper/pull/2296#issuecomment-3192969975

   The versions were bumped on the 3.8 branch also, so this patch should be applied there as well.


;15/Aug/25 23:07;githubbot;600","anmolnar merged PR #2295:
URL: https://github.com/apache/zookeeper/pull/2295


;17/Aug/25 12:57;githubbot;600","anmolnar merged PR #2296:
URL: https://github.com/apache/zookeeper/pull/2296


;17/Aug/25 12:58;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,4200,,,0,4200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Sun Aug 17 12:58:47 UTC 2025,,,,,,,,,,"0|z1x9wg:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"17/Aug/25 12:58;andor;Issue resolved by pull request 2296
[https://github.com/apache/zookeeper/pull/2296];;;",,,,,,,,,,,
Replace logback with slf4j-simple on branch-3.8 due to upgrading issues,ZOOKEEPER-4957,13626292,,Task,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Won't Fix,andor,andor,andor,13/Aug/25 16:59,15/Aug/25 19:28,08/Dec/25 08:02,15/Aug/25 19:28,3.8.4,,,,,,,,,,,security,server,tests,,0,pull-request-available,,,"Logback versions 1.2.x have some CVEs which can only be resolved by upgrading to at least logback 1.3.x. Unfortunately it also involves upgrading SLF4j to 2.0.x which is not acceptable on branch-3.8. Instead we should try to replace logback with slf4j-simple, but that implies some test code changes as well.",,"anmolnar opened a new pull request, #2293:
URL: https://github.com/apache/zookeeper/pull/2293

   (no comment)


;13/Aug/25 17:26;githubbot;600","anmolnar commented on PR #2293:
URL: https://github.com/apache/zookeeper/pull/2293#issuecomment-3185030911

   > What does this mean for users of the clien lt library ?
   > What does this mean for system administrators of a server deployed from our tarball ?
   > I am generally +1 to this patch, as far as we clarify those points and maybe document any breaking changes
   
   Yeah, docs are not yet ready, maybe I should convert it to a Draft. First, just trying if I can get the tests green.
   I think people who would like to continue using the shipped **logback** version should upgrade to 3.9 or replace slf4j-simple with the desired logger implementation on the classpath.


;13/Aug/25 18:28;githubbot;600","anmolnar commented on PR #2293:
URL: https://github.com/apache/zookeeper/pull/2293#issuecomment-3186307839

   @eolivelli @ctubbsii 
   
   Okay, the build is now green, so I believe this is all the code change that we need. I have the following open questions:
   1. We still ship example config files for **logback** and still have reference in the documentation, shall I remove them too? 
   2. As @eolivelli raised, we should communicate this change to our users who decide to stay on 3.8.x release line. We're going to have a new version released, 3.8.5, which will be the last patch release of 3.8. How should we articulate the change and recommend users to upgrade to 3.9?


;14/Aug/25 00:52;githubbot;600","ctubbsii commented on code in PR #2293:
URL: https://github.com/apache/zookeeper/pull/2293#discussion_r2274943771


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/LoggerTestTool.java:
##########


Review Comment:
   For this and the tests that use it, I think it would be fine to leave `logback` in as a test dependency `<scope>test</scope>`.
   
   It is ill-advised to do the alternative, which requires modifying the global output stream, as that can affect other threads in pretty substantial ways, like Maven or maven-surefire-plugin threads, during the build.



##########
zookeeper-contrib/zookeeper-contrib-zooinspector/pom.xml:
##########
@@ -90,8 +90,8 @@
       <artifactId>slf4j-api</artifactId>
     </dependency>
     <dependency>
-      <groupId>ch.qos.logback</groupId>
-      <artifactId>logback-core</artifactId>
+      <groupId>org.slf4j</groupId>
+      <artifactId>slf4j-simple</artifactId>

Review Comment:
   ```suggestion
         <artifactId>slf4j-simple</artifactId>
         <scope>test</scope>
   ```



##########
zookeeper-contrib/zookeeper-contrib-zooinspector/src/test/java/org/apache/zookeeper/inspector/LoggerTest.java:
##########
@@ -31,12 +31,12 @@ public class LoggerTest {
     String testMessage = ""a test message"";
 
     @Test
-    public void testLogStdOutConfig() {
+    public void testLogStdErrConfig() {
         ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
-        PrintStream realStdOut = System.out;
-        System.setOut(new PrintStream(byteArrayOutputStream));
+        PrintStream realStdErr = System.err;
+        System.setErr(new PrintStream(byteArrayOutputStream));
         LOG.info(testMessage);
-        System.setOut(realStdOut);
+        System.setErr(realStdErr);

Review Comment:
   This test isn't particularly useful as part of ZooKeeper, and could just be deleted. This isn't even an integration test, and doesn't use any ZK code... it's just literally testing the logging dependency API, which can be assumed to work from upstream testing (or at least, if it broke upstream, it would be noticed long before this test runs). Plus, it's not generally a good idea to modify the global system output streams.



##########
zookeeper-contrib/zookeeper-contrib-loggraph/pom.xml:
##########
@@ -53,8 +53,8 @@
       <artifactId>slf4j-api</artifactId>
     </dependency>
     <dependency>
-      <groupId>ch.qos.logback</groupId>
-      <artifactId>logback-core</artifactId>
+      <groupId>org.slf4j</groupId>
+      <artifactId>slf4j-simple</artifactId>

Review Comment:
   This can be set to `<scope>test</scope>`. It's really only needed as a runtime dependency for modules that do assembly (such as the fatjar module, the zookeeper-assembly module, and maybe the zooinspector module, which I see also has some kind of assembly). It should never be needed as a compile time dependency.
   
   ```suggestion
         <artifactId>slf4j-simple</artifactId>
         <scope>test</scope>
   ```



##########
zookeeper-server/pom.xml:
##########
@@ -75,12 +75,8 @@
       <artifactId>slf4j-api</artifactId>
     </dependency>
     <dependency>
-      <groupId>ch.qos.logback</groupId>
-      <artifactId>logback-core</artifactId>
-    </dependency>
-    <dependency>
-      <groupId>ch.qos.logback</groupId>
-      <artifactId>logback-classic</artifactId>
+      <groupId>org.slf4j</groupId>
+      <artifactId>slf4j-simple</artifactId>

Review Comment:
   ```suggestion
         <artifactId>slf4j-simple</artifactId>
         <scope>test</scope>
   ```
   
   `runtime` may also be an appropriate scope here, to document to users that depend on the `zookeeper` artifactId that this, or an alternative implementation is needed at runtime. If this is marked as a runtime dependency rather than a test dependency, I would also add `<optional>true</optional>` so that it is not automatically picked up by other projects that depend on the zookeeper-server jar during their Maven builds, for their slf4j runtime implementation, as a transitive dependency. Otherwise, everybody would have to add `<exclusions>` elements to their `<dependency>` on `zookeeper-server`, the same way ZooKeeper has to for the `kerby-config` dependency, which would otherwise bring in the `slf4j-log4j12` runtime. This should have been done with logback as well, but never was. This isn't necessary if it's set to test scope, since test scopes are never added automatically as a transitive dependency.



##########
zookeeper-contrib/zookeeper-contrib-rest/pom.xml:
##########
@@ -69,8 +69,8 @@
       <artifactId>slf4j-api</artifactId>
     </dependency>
     <dependency>
-      <groupId>ch.qos.logback</groupId>
-      <artifactId>logback-core</artifactId>
+      <groupId>org.slf4j</groupId>
+      <artifactId>slf4j-simple</artifactId>

Review Comment:
   ```suggestion
         <artifactId>slf4j-simple</artifactId>
         <scope>test</scope>
   ```



##########
zookeeper-contrib/zookeeper-contrib-fatjar/pom.xml:
##########
@@ -91,8 +91,8 @@
       <artifactId>snappy-java</artifactId>
     </dependency>
     <dependency>
-      <groupId>ch.qos.logback</groupId>
-      <artifactId>logback-core</artifactId>
+      <groupId>org.slf4j</groupId>
+      <artifactId>slf4j-simple</artifactId>

Review Comment:
   ```suggestion
         <artifactId>slf4j-simple</artifactId>
         <scope>runtime</scope>
   ```



;14/Aug/25 01:15;githubbot;600","ctubbsii commented on code in PR #2293:
URL: https://github.com/apache/zookeeper/pull/2293#discussion_r2275011963


##########
zookeeper-server/pom.xml:
##########
@@ -75,12 +75,8 @@
       <artifactId>slf4j-api</artifactId>
     </dependency>
     <dependency>
-      <groupId>ch.qos.logback</groupId>
-      <artifactId>logback-core</artifactId>
-    </dependency>
-    <dependency>
-      <groupId>ch.qos.logback</groupId>
-      <artifactId>logback-classic</artifactId>
+      <groupId>org.slf4j</groupId>
+      <artifactId>slf4j-simple</artifactId>

Review Comment:
   Since `slf4j-simple` is not listed in the `zookeeper-assembly/pom.xml`, it is assumed to be picked up automatically as a transitive dependency of the `zookeeper-server` module (artifactId: zookeeper). So, using test scope or optional won't work, because the intent is that it will automatically get picked up transitively for the assembly. I still think test scope is most appropriate, so the fix would be to explicitly add slf4j-simple to the `zookeeper-assembly/pom.xml`, so it will be included in the assembly directly, rather than transitively.



;14/Aug/25 01:20;githubbot;600","ctubbsii commented on PR #2293:
URL: https://github.com/apache/zookeeper/pull/2293#issuecomment-3186413064

   > What does this mean for users of the clien lt library ?
   
   ZooKeeper clients will use whatever slf4j runtime is on their classpath, just as before. If they had included the `$ZOOKEEPER_TARBALL_DIRECTORY/lib` in that classpath before, then they would have automatically used the logback runtime library... but if they didn't have a logback configuration file, it would have done whatever logback defaulted to without a config. Now, it would pick up the slf4j-simple runtime, and log to the console, configurable with some [basic system properties](https://www.slf4j.org/api/org/slf4j/simple/SimpleLogger.html).
   
   If a different logging runtime is desired, the user would set their classpath appropriately to use the desired runtime library, and configure it according to their selected library.
   
   > What does this mean for system administrators of a server deployed from our tarball ?
   
   By default, they will use the slf4j-simple implementation jar in the `$ZOOKEEPER_TARBALL_DIRECTORY/lib` directory which will be on their classpath. If they want to use a different implementation, they will need to modify their CLASSPATH, which they can do in the `$ZOOCFGDIR/java.env` file or the `$ZOOCFGDIR/zookeeper-env.sh` file. If they want to keep slf4j-simple, but don't want the default behavior, they can set system properties in those files, by setting one of several different JVM flags environment variables (`SERVER_JVMFLAGS`, `CLIENT_JVMFLAGS`, the older `JAVA_TOOL_OPTIONS`, or the newer `JDK_JAVA_OPTIONS`, or the poorly documented `_JAVA_OPTIONS`) to include `-Dorg.slf4j.simpleLogger.logFile=` or similar system properties from the [`slf4j-simple` documentation](https://www.slf4j.org/api/org/slf4j/simple/SimpleLogger.html).


;14/Aug/25 01:44;githubbot;600","ctubbsii commented on PR #2293:
URL: https://github.com/apache/zookeeper/pull/2293#issuecomment-3186450248

   > 1. We still ship example config files for **logback** and still have reference in the documentation, shall I remove them too?
   
   I would. You could add example java.env for some slf4j-simple config, but it's also okay to just link to the documentation at https://www.slf4j.org/api/org/slf4j/simple/SimpleLogger.html
   
   > 2. As @eolivelli raised, we should communicate this change to our users who decide to stay on 3.8.x release line. We're going to have a new version released, 3.8.5, which will be the last patch release of 3.8. How should we articulate the change and recommend users to upgrade to 3.9?
   
   I think the including the recommendation to upgrade in the `[ANNOUNCE]` message, and a clear indicator on the downloads page that it is EOL is generally sufficient.


;14/Aug/25 01:57;githubbot;600","kezhuw commented on PR #2293:
URL: https://github.com/apache/zookeeper/pull/2293#issuecomment-3186641236

   > I think the including the recommendation to upgrade in the [ANNOUNCE] message, and a clear indicator on the downloads page that it is EOL is generally sufficient.
   
   We also have release note page, here is 3.8.4: https://zookeeper.apache.org/doc/r3.8.4/releasenotes.html. We could highlight this change and point out possible consequences there.


;14/Aug/25 03:21;githubbot;600","ctubbsii commented on PR #2293:
URL: https://github.com/apache/zookeeper/pull/2293#issuecomment-3189752245

   I missed the fact that this was targeting branch-3.8. I don't think this should be done for 3.8. I think this is a good path forward for the master branch and future versions (3.10 and later), but I don't think 3.8 should be changed. I think it's too disruptive to existing users, and does not really benefit anybody to do it in a patch/maintenance release. Existing 3.8 users can just change their logging runtime in their own classpath if they are impacted and need to continue using 3.8. Most people should just upgrade to 3.9 instead.


;14/Aug/25 20:13;githubbot;600","ctubbsii commented on PR #2293:
URL: https://github.com/apache/zookeeper/pull/2293#issuecomment-3189909305

   > > I think the including the recommendation to upgrade in the [ANNOUNCE] message, and a clear indicator on the downloads page that it is EOL is generally sufficient.
   > 
   > We also have release note page, here is 3.8.4: https://zookeeper.apache.org/doc/r3.8.4/releasenotes.html. We could highlight this change and point out possible consequences there.
   
   That page appears generated, at least initially, from JIRA. It has always bothered me that JIRA calls those ""release notes"" when they are really just a ""Changelog"", and basically just a subset of what you can find from git. I've never found those particularly useful. Editing it to have advice/warnings/notices, or a summarized narrative of the changes, would make it much more useful, I think. So, yes, I think that would be a perfect place to put some information about this. The main concern I would have is that people probably don't ever read those, because people have been trained to think of them as merely a changelog, and probably wouldn't think to look there for more useful information.


;14/Aug/25 21:23;githubbot;600","anmolnar closed pull request #2293: ZOOKEEPER-4957. Replace logback with slf4j-simple on branch-3.8 due to upgrading issues
URL: https://github.com/apache/zookeeper/pull/2293


;15/Aug/25 19:27;githubbot;600","anmolnar commented on PR #2293:
URL: https://github.com/apache/zookeeper/pull/2293#issuecomment-3192518340

   Thanks @ctubbsii and @eolivelli for the reviews. Closing this one, because we upgrade logging libraries instead.
   Superseded by https://github.com/apache/zookeeper/commit/1a316edd454f5123b4f6a5389c6887f015482c05


;15/Aug/25 19:27;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,7200,,,0,7200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Aug 15 19:28:24 UTC 2025,,,,,,,,,,"0|z1x8s8:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"15/Aug/25 19:28;andor;We ended up upgrading logging libraries on *branch-3.8* too, so we won't do this for now.;;;",,,,,,,,,,,
Fix intererence with jvm ssl properties for ssl.crl and ssl.ocsp,ZOOKEEPER-4955,13625234,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,kezhuw,stoty,stoty,01/Aug/25 06:49,28/Aug/25 03:32,08/Dec/25 08:02,26/Aug/25 19:18,,,,,,,,,3.10.0,,,security,,,,0,pull-request-available,,,"EDIT:

The original proposal was rejected, and a different solution is implemented which mimics the JVM internal logic.


Zookeeper currenlty automatically calls PKIXBuilderParameters#setRevocationEnabled() based on the values of the *ssl.(quorum.)ocsp* and ssl(.quorum).crl config options.

This means that if we don't set the above options, then ZK will explicitly disable revocation checks. As those options are also setting global System/Security properties, we do not have a way to enable revocation checks without clobbering the revocation related global properties.

Adding a new property will let ZK enable/disable revocation checks without clobbering the JVM global properties.",,"stoty opened a new pull request, #2289:
URL: https://github.com/apache/zookeeper/pull/2289

   (no comment)


;01/Aug/25 06:50;githubbot;600","stoty commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3142968537

   In previous patched, this functionality was split into two separated config options.
   I have consolidated those into a single property with four possible values here.
   
   FYI @anmolnar 


;01/Aug/25 06:51;githubbot;600","anmolnar commented on code in PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#discussion_r2252784327


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ZKConfig.java:
##########
@@ -146,6 +155,21 @@ public String getProperty(String key) {
         return properties.get(key);
     }
 
+    /**
+     * Get the property value and call String.trim() on it if not null
+     *
+     * @param key
+     * @return property value
+     */
+    public String getTrimmedProperty(String key) {
+        String property = getProperty(key);
+        if (property != null) {
+            return property.trim();
+        } else {
+            return property;
+        }

Review Comment:
   nit:
   ```java
   return property != null ? property.trim() : """";
   ```
   You don't need the null check in this case.



;04/Aug/25 23:33;githubbot;600","anmolnar commented on code in PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#discussion_r2252790455


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ZKConfig.java:
##########
@@ -284,4 +308,29 @@ public int getInt(String key, int defaultValue) {
         return defaultValue;
     }
 
+    /**
+     * Get the value of the <code>key</code> property as an
+     * <code>SslRevocationEnabled</code> enum. If property is not set
+     * <code>SslRevocationEnabled.LEGACY</code> is returned.
+     *
+     * @param key
+     * @return the SslRevocationEnabled enum
+     * @throws IllegalArgumentException if the value cannot be parsed
+     */
+    public SslRevocationEnabled getSslRevocationEnabled(String key) throws SSLContextException {
+        String value = getTrimmedProperty(key);
+        if (value == null || value.equalsIgnoreCase(SslRevocationEnabled.LEGACY.toString())) {
+            return SslRevocationEnabled.LEGACY;
+        } else if (value.equalsIgnoreCase(SslRevocationEnabled.JAVA_DEFAULT.toString())) {
+            return SslRevocationEnabled.JAVA_DEFAULT;
+        } else if (value.equalsIgnoreCase(SslRevocationEnabled.TRUE.toString())) {
+            return SslRevocationEnabled.TRUE;
+        } else if (value.equalsIgnoreCase(SslRevocationEnabled.FALSE.toString())) {
+            return SslRevocationEnabled.FALSE;

Review Comment:
   What if...?
   ```java
   SslRevocationEnabled value = SslRevocationEnabled.valueOf(getProperty(key, SslRevocationEnabled.LEGACY.toString()));
   if (value == null) {
     // Error handling...
   } else {
     return value;
   }
   ```



##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ZKConfig.java:
##########
@@ -284,4 +308,29 @@ public int getInt(String key, int defaultValue) {
         return defaultValue;
     }
 
+    /**
+     * Get the value of the <code>key</code> property as an
+     * <code>SslRevocationEnabled</code> enum. If property is not set
+     * <code>SslRevocationEnabled.LEGACY</code> is returned.
+     *
+     * @param key
+     * @return the SslRevocationEnabled enum
+     * @throws IllegalArgumentException if the value cannot be parsed
+     */
+    public SslRevocationEnabled getSslRevocationEnabled(String key) throws SSLContextException {
+        String value = getTrimmedProperty(key);
+        if (value == null || value.equalsIgnoreCase(SslRevocationEnabled.LEGACY.toString())) {
+            return SslRevocationEnabled.LEGACY;
+        } else if (value.equalsIgnoreCase(SslRevocationEnabled.JAVA_DEFAULT.toString())) {
+            return SslRevocationEnabled.JAVA_DEFAULT;
+        } else if (value.equalsIgnoreCase(SslRevocationEnabled.TRUE.toString())) {
+            return SslRevocationEnabled.TRUE;
+        } else if (value.equalsIgnoreCase(SslRevocationEnabled.FALSE.toString())) {
+            return SslRevocationEnabled.FALSE;

Review Comment:
   In this case you don't need `getTrimmedProperty()` at all.



;04/Aug/25 23:33;githubbot;600","anmolnar commented on code in PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#discussion_r2252790455


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ZKConfig.java:
##########
@@ -284,4 +308,29 @@ public int getInt(String key, int defaultValue) {
         return defaultValue;
     }
 
+    /**
+     * Get the value of the <code>key</code> property as an
+     * <code>SslRevocationEnabled</code> enum. If property is not set
+     * <code>SslRevocationEnabled.LEGACY</code> is returned.
+     *
+     * @param key
+     * @return the SslRevocationEnabled enum
+     * @throws IllegalArgumentException if the value cannot be parsed
+     */
+    public SslRevocationEnabled getSslRevocationEnabled(String key) throws SSLContextException {
+        String value = getTrimmedProperty(key);
+        if (value == null || value.equalsIgnoreCase(SslRevocationEnabled.LEGACY.toString())) {
+            return SslRevocationEnabled.LEGACY;
+        } else if (value.equalsIgnoreCase(SslRevocationEnabled.JAVA_DEFAULT.toString())) {
+            return SslRevocationEnabled.JAVA_DEFAULT;
+        } else if (value.equalsIgnoreCase(SslRevocationEnabled.TRUE.toString())) {
+            return SslRevocationEnabled.TRUE;
+        } else if (value.equalsIgnoreCase(SslRevocationEnabled.FALSE.toString())) {
+            return SslRevocationEnabled.FALSE;

Review Comment:
   What if...?
   ```java
   SslRevocationEnabled value = SslRevocationEnabled.valueOf(getProperty(key, SslRevocationEnabled.LEGACY.toString().toUpperCase()));
   if (value == null) {
     // Error handling...
   } else {
     return value;
   }
   ```



;04/Aug/25 23:34;githubbot;600","anmolnar commented on code in PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#discussion_r2252790455


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ZKConfig.java:
##########
@@ -284,4 +308,29 @@ public int getInt(String key, int defaultValue) {
         return defaultValue;
     }
 
+    /**
+     * Get the value of the <code>key</code> property as an
+     * <code>SslRevocationEnabled</code> enum. If property is not set
+     * <code>SslRevocationEnabled.LEGACY</code> is returned.
+     *
+     * @param key
+     * @return the SslRevocationEnabled enum
+     * @throws IllegalArgumentException if the value cannot be parsed
+     */
+    public SslRevocationEnabled getSslRevocationEnabled(String key) throws SSLContextException {
+        String value = getTrimmedProperty(key);
+        if (value == null || value.equalsIgnoreCase(SslRevocationEnabled.LEGACY.toString())) {
+            return SslRevocationEnabled.LEGACY;
+        } else if (value.equalsIgnoreCase(SslRevocationEnabled.JAVA_DEFAULT.toString())) {
+            return SslRevocationEnabled.JAVA_DEFAULT;
+        } else if (value.equalsIgnoreCase(SslRevocationEnabled.TRUE.toString())) {
+            return SslRevocationEnabled.TRUE;
+        } else if (value.equalsIgnoreCase(SslRevocationEnabled.FALSE.toString())) {
+            return SslRevocationEnabled.FALSE;

Review Comment:
   What if...?
   ```java
   SslRevocationEnabled value = SslRevocationEnabled.valueOf(getProperty(key, SslRevocationEnabled.LEGACY.toString()).toUpperCase());
   if (value == null) {
     // Error handling...
   } else {
     return value;
   }
   ```



;04/Aug/25 23:35;githubbot;600","stoty commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3153547370

   re-written config parsing, and added some UTs, @anmolnar .


;05/Aug/25 06:09;githubbot;600","anmolnar commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3160548716

   ping @eolivelli @kezhuw @ztzg PTAL.


;06/Aug/25 15:03;githubbot;600","kezhuw commented on code in PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#discussion_r2260437454


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -541,21 +548,32 @@ public static X509TrustManager createTrustManager(
         boolean ocspEnabled,
         final boolean serverHostnameVerificationEnabled,
         final boolean clientHostnameVerificationEnabled,
-        final boolean fipsMode) throws TrustManagerException {
+        final boolean fipsMode,
+        final SslRevocationEnabled revocationEnabled) throws TrustManagerException {
         if (trustStorePassword == null) {
             trustStorePassword = """";
         }
         try {
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
             if (crlEnabled || ocspEnabled) {
-                pbParams.setRevocationEnabled(true);
+                if (revocationEnabled == SslRevocationEnabled.LEGACY) {
+                    pbParams.setRevocationEnabled(true);
+                }
                 System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
                 System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
                 if (ocspEnabled) {
                     Security.setProperty(""ocsp.enable"", ""true"");
                 }
             } else {
+                if (revocationEnabled == SslRevocationEnabled.LEGACY) {
+                    pbParams.setRevocationEnabled(false);
+                }
+            }
+
+            if (revocationEnabled == SslRevocationEnabled.TRUE) {
+                pbParams.setRevocationEnabled(true);
+            } else if (revocationEnabled == SslRevocationEnabled.FALSE) {

Review Comment:
   `revocationEnabled` is default to `true` in java since java-8. In old path, it clears `revocationEnabled`.
   
   I don't think it deserves `JAVA_DEFAULT` for a public default. I think we could shape the candidates:
   1. `legacy`:  behaves same as old, this should be the default in case of backport.
   2. `true` or `false` to enable/disalbe revocation. `true` could be the default.
   
   * https://devdocs.io/openjdk~8/java/security/cert/pkixparameters#setRevocationEnabled-boolean-
   * https://devdocs.io/openjdk~21/java.base/java/security/cert/pkixparameters#setRevocationEnabled(boolean)



;07/Aug/25 14:22;githubbot;600","stoty commented on code in PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#discussion_r2260852403


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -541,21 +548,32 @@ public static X509TrustManager createTrustManager(
         boolean ocspEnabled,
         final boolean serverHostnameVerificationEnabled,
         final boolean clientHostnameVerificationEnabled,
-        final boolean fipsMode) throws TrustManagerException {
+        final boolean fipsMode,
+        final SslRevocationEnabled revocationEnabled) throws TrustManagerException {
         if (trustStorePassword == null) {
             trustStorePassword = """";
         }
         try {
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
             if (crlEnabled || ocspEnabled) {
-                pbParams.setRevocationEnabled(true);
+                if (revocationEnabled == SslRevocationEnabled.LEGACY) {
+                    pbParams.setRevocationEnabled(true);
+                }
                 System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
                 System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
                 if (ocspEnabled) {
                     Security.setProperty(""ocsp.enable"", ""true"");
                 }
             } else {
+                if (revocationEnabled == SslRevocationEnabled.LEGACY) {
+                    pbParams.setRevocationEnabled(false);
+                }
+            }
+
+            if (revocationEnabled == SslRevocationEnabled.TRUE) {
+                pbParams.setRevocationEnabled(true);
+            } else if (revocationEnabled == SslRevocationEnabled.FALSE) {

Review Comment:
   > `revocationEnabled` is default to `true` in java since java-8. In old path, it clears `revocationEnabled`.
   
   That's only true sometimes.
   It is enabled by default in SunJCE, but (only by looking at the code, not tested) it is disabled by default in BouncyCastle. There also other Cryptography providers where the behaviour may be different.
   
   > 
   > I don't think it deserves `JAVA_DEFAULT` for a public default. I think we could shape the candidates:
   > 
   > 1. `legacy`:  behaves same as old, this should be the default in case of backport.
   > 2. `true` or `false` to enable/disalbe revocation. `true` could be the default.
   
   The case for having a default NoOp option is that there are already mechanisms and defaults in the JVM that can be used to set this up.
   
   There can be any number of HTTP clients (and servers) in an application that includes the ZK client, and a user may want to threat these in a unified way.
   
   By not exposing a JVM default options, we force the user to always separately consider the ZK clients.
   (Servers are less of a problem, as those are standlone processes)
   
   ""Yes, you have set up your JVM system properties to enable/disable CRL globally, but now you also need to make a separate change for the ZK config anyway"" is not user / admin friendly.
   
   My preference would be defaulting to ""java_default"" for 3.10 and ""legacy"" for backports.
   
   > 
   > * https://devdocs.io/openjdk~8/java/security/cert/pkixparameters#setRevocationEnabled-boolean-
   > * https://devdocs.io/openjdk~21/java.base/java/security/cert/pkixparameters#setRevocationEnabled(boolean)
   
   



;07/Aug/25 16:34;githubbot;600","stoty commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3165021402

   > I left comment about current approach.
   > 
   > > As those options are also setting global System/Security properties, we do not have a way to enable revocation checks without clobbering the revocation related global properties.
   > 
   > How about introducing `ssl.crl.populate-jvm-property` and `ssl.ocsp.populate-jvm-property` ?
   > 
   > 1. Default to `true` for those in case of backporting.
   > 2. Default to `false` for future versions.
   
   That's totally fine, one of my earlier patches did something similar.
   
   It's not really necessary, as simply leaving those at the default ""false"" settings will leave the System/Security properties alone, but this is the most unambigious solution.
   
   > 
   > This way we can solve the problem precisely without introducing `ssl.revocationEnabled` as an replacement of `ssl.crl`.
   
   That's not really true.
   
   The problem is that we need to work Java's capabilities, which are limited.
   
   Apart from the single setRevocationEnabled method (which only exists if we install a custom TrustManager), Java only has global settings for handling revocation config.
   
   That's why I think that the proper way to handle this to effectively deprecate the existing crl and ocsp properties (at least for the client), as figuring out how those work and interact is not rather ambigious.
   
   Ideally, in the client config both the crl and ocsp settings would default false, while the new ssl.revocationEnabled would default to ""java_default"". This effectively turns off any ZK specific CRL config.
   
   This lets any global JVM settings the user set work as expected.
   Since Java does provide us with the single setRevocationEnabled knob, we expose that in case the user wants to get fancy, that lets the user control the ZK client setting 
   
   If we only add the two populate properties, then we are giving the user a puzzle to figure out how to set up revocation.
   (and also leave them with no way to use the security provider defaults for the custom truststore)
   


;07/Aug/25 16:54;githubbot;600","kezhuw commented on code in PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#discussion_r2262197297


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -541,21 +548,32 @@ public static X509TrustManager createTrustManager(
         boolean ocspEnabled,
         final boolean serverHostnameVerificationEnabled,
         final boolean clientHostnameVerificationEnabled,
-        final boolean fipsMode) throws TrustManagerException {
+        final boolean fipsMode,
+        final SslRevocationEnabled revocationEnabled) throws TrustManagerException {
         if (trustStorePassword == null) {
             trustStorePassword = """";
         }
         try {
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
             if (crlEnabled || ocspEnabled) {
-                pbParams.setRevocationEnabled(true);
+                if (revocationEnabled == SslRevocationEnabled.LEGACY) {
+                    pbParams.setRevocationEnabled(true);
+                }
                 System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
                 System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
                 if (ocspEnabled) {
                     Security.setProperty(""ocsp.enable"", ""true"");
                 }
             } else {
+                if (revocationEnabled == SslRevocationEnabled.LEGACY) {
+                    pbParams.setRevocationEnabled(false);
+                }
+            }
+
+            if (revocationEnabled == SslRevocationEnabled.TRUE) {
+                pbParams.setRevocationEnabled(true);
+            } else if (revocationEnabled == SslRevocationEnabled.FALSE) {

Review Comment:
   I agree to most of above comments but one.
   
   > That's only true sometimes.
   
   >  It is enabled by default in SunJCE, but (only by looking at the code, not tested) it is disabled by default in BouncyCastle. There also other Cryptography providers where the behaviour may be different.
   
   How could cryptography providers override the default in jdk ?
   
   https://github.com/openjdk/jdk/blob/jdk-11%2B28/src/java.base/share/classes/java/security/cert/PKIXParameters.java#L86-L92
   
   ```java
   public class PKIXParameters implements CertPathParameters {
   
       private Set<TrustAnchor> unmodTrustAnchors;
       private Date date;
       private List<PKIXCertPathChecker> certPathCheckers;
       private String sigProvider;
       private boolean revocationEnabled = true;
   ```
   
   > The case for having a default NoOp option is that there are already mechanisms and defaults in the JVM that can be used to set this up.
   
   We are using explicitly `PKIXBuilderParameters`, according to the documentation, `com.sun.net.ssl.checkRevocation` is useless in our path.
   
   https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/JSSERefGuide.html states that:
   > If the init(KeyStore ks) method is used, then default PKIX parameters are used with the exception that revocation checking is disabled. It can be enabled by setting the com.sun.net.ssl.checkRevocation system property to true. This setting requires that the CertPath implementation can locate revocation information by itself. The PKIX implementation in the provider can do this in many cases but requires that the system property com.sun.security.enableCRLDP be set to true.
   
   https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/ocsp.html states that:
   > Client-driven OCSP is enabled by enabling revocation checking and enabling OCSP.
   > 
   > To configure a Java client to use client-driven OCSP, the Java client must already be set up to connect to a > server using TLS.
   >
   >    Enable revocation checking. You can do this in two different ways.
   >        Set the system property com.sun.net.ssl.checkRevocation to true.
   >        Use the setRevocationEnabled method on PKIXParameters.
   >    Enable client-driven OCSP:
   >
   >    Set the Security Property ocsp.enable to true.
   >
   > Both steps are necessary. The ocsp.enable setting has no effect unless revocation checking is enabled.
   
   I dropped `pbParams.setRevocationEnabled(true)` and `System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"")` in https://github.com/kezhuw/zookeeper/commit/826b33862832f04f0171a47a03b420f955fa0b9f and [`QuorumSSLTest` passes](https://github.com/kezhuw/zookeeper/actions/runs/16824320595/job/47657245027#step:6:541). This conforms to the doc that `PKIXParameters::revocationEnabled` is default to `true` and `com.sun.net.ssl.checkRevocation` is not consulted in case of explicitly pkix parameters.



;08/Aug/25 07:47;githubbot;600","stoty commented on code in PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#discussion_r2262370296


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -541,21 +548,32 @@ public static X509TrustManager createTrustManager(
         boolean ocspEnabled,
         final boolean serverHostnameVerificationEnabled,
         final boolean clientHostnameVerificationEnabled,
-        final boolean fipsMode) throws TrustManagerException {
+        final boolean fipsMode,
+        final SslRevocationEnabled revocationEnabled) throws TrustManagerException {
         if (trustStorePassword == null) {
             trustStorePassword = """";
         }
         try {
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
             if (crlEnabled || ocspEnabled) {
-                pbParams.setRevocationEnabled(true);
+                if (revocationEnabled == SslRevocationEnabled.LEGACY) {
+                    pbParams.setRevocationEnabled(true);
+                }
                 System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
                 System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
                 if (ocspEnabled) {
                     Security.setProperty(""ocsp.enable"", ""true"");
                 }
             } else {
+                if (revocationEnabled == SslRevocationEnabled.LEGACY) {
+                    pbParams.setRevocationEnabled(false);
+                }
+            }
+
+            if (revocationEnabled == SslRevocationEnabled.TRUE) {
+                pbParams.setRevocationEnabled(true);
+            } else if (revocationEnabled == SslRevocationEnabled.FALSE) {

Review Comment:
   Thanks for correcting me.
   
   Your findings above also support that the current code (specifically explicitly calling pbParams.setRevocationEnabled(false) when the ZK crl properties are not set)
   are not fit for the client library use case.
   
   There are many possible ways to fix this by adding/modifying the behaviour of config properties.
   IMO my proposal of directly exposing the setRevocationEnabled() property and disabling the old behaviour 
   (i.e setting the system/security properties and calling setRevocationEnabled()  based on the values of the old crl and ocsp ZK properties) by default (depending on branch) is the most straightforward.
   
   The only problem I have with my proposed changes is that old defauit ""false"" value for the old crl and ocsp ZK properties becomes effectively a no-op. We could add a third ""java_default"" like state and default to that, but that would actually behave exactly like the ""false"", so it may not be worth it.
   
   Here are some possible option sets, and the settings for making ZK leave the revaction settings and JVM System/Security proprties alone:
   
   current patch:
   
   ```
   ssl.revocationEnabled: java_default (true/false/java_default/legacy)
   ssl.crl: false (true/false) 
   ssl.ocsp: false (true/false)
   ```
   
   Alternative 1 :
   add a third state to ocsp and crl properties, but don't add explicit override for setRevocationEnabled()
   This won't let the user override the system defaults on the custom truststore, so this loses functionality
   
   ```
   ssl.crl: java_default (true/false/java_default)
   ssl.ocsp: java_default (true/false/java_default) 
   ```
   
   Alternative 2 :
   add a third state to ocsp and crl properties, and also an explicit override for setRevocationEnabled()
   
   ```
   ssl.revocationEnabled: java_default (true/false/java_default/legacy)
   ssl.crl: java_default (true/false/java_default)
   ssl.ocsp: java_default  (true/false/java/default)
   ```
   
   Alternative 3:
   Separate options for disabling setting global property and revocationEnabled logic
   and only using simple booleans:
   
   ```
   ssl.set.revocation.enabled f (t/f)
   ss.set.revocation.disabled f (t/f)
   ssl.crl: false (true/false)
   ssl.ocsp: false (true/false)
   ssl.crl.populate-java-property: false (t/f)
   ssl.ocsp.populate-java-property: false (t/f)
   ssl.revocation.setRevocatioEnable-based-on-crl-and-ocsp: false (t/f)
   ```
   
   Or some combination of the above.
   
   Which one do you prefer ?
   



;08/Aug/25 09:01;githubbot;600","anmolnar commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3169082765

   @stoty @kezhuw Would you like this patch to be included in the **3.9.4** release?


;08/Aug/25 19:28;githubbot;600","stoty commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3169109085

   Yes,
   Though as discussed, we'd have to use the ""legacy"" deafults in 3.9


;08/Aug/25 19:41;githubbot;600","kezhuw commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3170465635

   > Apart from the single setRevocationEnabled method (which only exists if we install a custom TrustManager), Java only has global settings for handling revocation config.
   
   Turns out, this is not ture.
   
   > The PKIXRevocationChecker is added to a PKIXParameters object using the [addCertPathChecker](https://docs.oracle.com/javase/8/docs/api/java/security/cert/PKIXParameters.html#addCertPathChecker-java.security.cert.PKIXCertPathChecker-) or [setCertPathCheckers](https://docs.oracle.com/javase/8/docs/api/java/security/cert/PKIXParameters.html#setCertPathCheckers-java.util.List-) method, and then the PKIXParameters is passed along with the CertPath to be validated to the [validate](https://docs.oracle.com/javase/8/docs/api/java/security/cert/CertPathValidator.html#validate-java.security.cert.CertPath-java.security.cert.CertPathParameters-) method of a PKIX CertPathValidator. When supplying a revocation checker in this manner, it will be used to check revocation irrespective of the setting of the [RevocationEnabled](https://docs.oracle.com/javase/8/docs/api/java/security/cert/PKIXParameters.html#isRevocationEnabled--) flag.
   >
   > https://docs.oracle.com/javase/8/docs/api/java/security/cert/PKIXRevocationChecker.html
   
   It is this since Java 8. I opened stoty/zookeeper#2 for alternative, see https://github.com/stoty/zookeeper/pull/2/commits/68839ce266b75537b4bb3bfce63bca484a77b94c for changes.
   
   See also:
   * https://docs.oracle.com/javase/8/docs/api/java/security/cert/CertPathValidator.html
   * https://bugs.openjdk.org/browse/JDK-8225433
   * https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/security/cert/PKIXParameters.html#setRevocationEnabled(boolean)


;09/Aug/25 07:43;githubbot;600","stoty commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3173707043

   This is your patch @kezhuw , please approve.


;11/Aug/25 08:15;githubbot;600","kezhuw commented on code in PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#discussion_r2266359323


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -549,12 +554,21 @@ public static X509TrustManager createTrustManager(
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
             if (crlEnabled || ocspEnabled) {

Review Comment:
   ```suggestion
               if (crlEnabled) {
   ```
   
   I think we probably should make this consistent how jdk handle ""com.sun.net.ssl.checkRevocation"" and ""ocsp.enable"". Revocation checking will only be enabled through ""com.sun.net.ssl.checkRevocation"" but not ""ocsp.enable"".



;11/Aug/25 11:05;githubbot;600","kezhuw commented on code in PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#discussion_r2266363109


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -549,12 +554,21 @@ public static X509TrustManager createTrustManager(
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
             if (crlEnabled || ocspEnabled) {

Review Comment:
   This should be much important if we are going to default `ssl.crl` and `ssl.ocsp` to `com.sun.net.ssl.checkRevocation` and `ocsp.enable`. @stoty Any thoughts ?



;11/Aug/25 11:06;githubbot;600","anmolnar commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3176041041

   Uh, this is really nasty and way more complicated than I expected. Still trying to fully understand your comments. So, basically the goal is to make the ZooKeeper client completely independent from global system properties (apart from deriving the defaults from them) and set up the revocation on a per-client basis. Is that correct?


;11/Aug/25 17:34;githubbot;600","stoty commented on code in PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#discussion_r2267591086


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -549,12 +554,21 @@ public static X509TrustManager createTrustManager(
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
             if (crlEnabled || ocspEnabled) {

Review Comment:
   I agree @kezhuw .
   
   Since this version is your work, would you like to open an another PR (so that you own that) ?



;11/Aug/25 18:03;githubbot;600","stoty commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3176219483

   Yes, that's correct.
   
   The advantage of the new patch is that it's fully backwards compatible (apart from not clobbering the globals), so it works equally well for the server and the client.
   
   


;11/Aug/25 18:04;githubbot;600","anmolnar commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3176574561

   Thanks. We don't set the globals anymore, because with the Options set it's not needed anymore. Neither on the client, nor the server side.
   
   I see you remove unit tests regarding this behavior, but is there any existing test which verifies if the revocation is still working?


;11/Aug/25 19:29;githubbot;600","kezhuw commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3177252237

   > I see you remove unit tests regarding this behavior, but is there any existing test which verifies if the revocation is still working?
   
   `QuorumSSLTest::testCertificateRevocationList` and `QuorumSSLTest::testOCSP`.
   
   I planned to add tests for client-server communication also.


;12/Aug/25 00:04;githubbot;600","kezhuw opened a new pull request, #2292:
URL: https://github.com/apache/zookeeper/pull/2292

   Refs: ZOOKEEPER-4955, apache/zookeeper#2289, stoty/zookeeper#2


;12/Aug/25 14:45;githubbot;600","kezhuw commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3179680351

   > Since this version is your work, would you like to open an another PR (so that you own that) ?
   
   > I see you remove unit tests regarding this behavior, but is there any existing test which verifies if the revocation is still working?
   
   I have opened #2292 with tests for client-server tls communication. I think we can move further review there now.


;12/Aug/25 14:49;githubbot;600","kezhuw commented on code in PR #2292:
URL: https://github.com/apache/zookeeper/pull/2292#discussion_r2270162687


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1768,13 +1768,17 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     (Java system properties: **zookeeper.ssl.crl** and **zookeeper.ssl.quorum.crl**)
     **New in 3.5.5:**
     Specifies whether Certificate Revocation List is enabled in client and quorum TLS protocols.
-    Default: false
+    Default: jvm property ""com.sun.net.ssl.checkRevocation"" since 3.10.0, false otherwise
 
 * *ssl.ocsp* and *ssl.quorum.ocsp* :
     (Java system properties: **zookeeper.ssl.ocsp** and **zookeeper.ssl.quorum.ocsp**)
     **New in 3.5.5:**
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
-    Default: false
+    **Changed in 3.10.0:**
+    Before 3.10.0, *ssl.ocsp* and *ssl.quorum.ocsp* implies *ssl.crl* and *ssl.quorum.crl* correspondingly.
+    After 3.10.0, one has to setup both *ssl.crl* and *ssl.ocsp* (or *ssl.quorum.crl* and *ssl.quorum.ocsp*)
+    to enable OCSP. This is consistent with jdk's method of [Setting up a Java Client to use Client-Driven OCSP](https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/ocsp.html#setting-up-a-java-client-to-use-client-driven-ocsp).

Review Comment:
   Is this acceptable in 3.10 ? @anmolnar @phunt @eolivelli @tisonkun
   
   If not, I think we could add a note to notice the difference with jdk's handling though it behaves this way long time ago.



;12/Aug/25 14:55;githubbot;600","anmolnar commented on code in PR #2292:
URL: https://github.com/apache/zookeeper/pull/2292#discussion_r2271175266


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1768,13 +1768,17 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     (Java system properties: **zookeeper.ssl.crl** and **zookeeper.ssl.quorum.crl**)
     **New in 3.5.5:**
     Specifies whether Certificate Revocation List is enabled in client and quorum TLS protocols.
-    Default: false
+    Default: jvm property ""com.sun.net.ssl.checkRevocation"" since 3.10.0, false otherwise
 
 * *ssl.ocsp* and *ssl.quorum.ocsp* :
     (Java system properties: **zookeeper.ssl.ocsp** and **zookeeper.ssl.quorum.ocsp**)
     **New in 3.5.5:**
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
-    Default: false
+    **Changed in 3.10.0:**
+    Before 3.10.0, *ssl.ocsp* and *ssl.quorum.ocsp* implies *ssl.crl* and *ssl.quorum.crl* correspondingly.
+    After 3.10.0, one has to setup both *ssl.crl* and *ssl.ocsp* (or *ssl.quorum.crl* and *ssl.quorum.ocsp*)
+    to enable OCSP. This is consistent with jdk's method of [Setting up a Java Client to use Client-Driven OCSP](https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/ocsp.html#setting-up-a-java-client-to-use-client-driven-ocsp).

Review Comment:
   Yes, I think that's fine.



;12/Aug/25 20:42;githubbot;600","anmolnar commented on code in PR #2292:
URL: https://github.com/apache/zookeeper/pull/2292#discussion_r2271183447


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1768,13 +1768,17 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     (Java system properties: **zookeeper.ssl.crl** and **zookeeper.ssl.quorum.crl**)
     **New in 3.5.5:**
     Specifies whether Certificate Revocation List is enabled in client and quorum TLS protocols.
-    Default: false
+    Default: jvm property ""com.sun.net.ssl.checkRevocation"" since 3.10.0, false otherwise
 
 * *ssl.ocsp* and *ssl.quorum.ocsp* :
     (Java system properties: **zookeeper.ssl.ocsp** and **zookeeper.ssl.quorum.ocsp**)
     **New in 3.5.5:**
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
-    Default: false
+    **Changed in 3.10.0:**
+    Before 3.10.0, *ssl.ocsp* and *ssl.quorum.ocsp* implies *ssl.crl* and *ssl.quorum.crl* correspondingly.
+    After 3.10.0, one has to setup both *ssl.crl* and *ssl.ocsp* (or *ssl.quorum.crl* and *ssl.quorum.ocsp*)
+    to enable OCSP. This is consistent with jdk's method of [Setting up a Java Client to use Client-Driven OCSP](https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/ocsp.html#setting-up-a-java-client-to-use-client-driven-ocsp).

Review Comment:
   Is this the server or the client driven OCSP or both?
   Because previously we didn't have a separate option, `ssl.ocsp` enabled the server driven and optionally implied the client driven if it was supported by the SSL library being in use. e.g. with OpenSSL we automatically enabled the client driven OCSP.



;12/Aug/25 20:45;githubbot;600","anmolnar commented on code in PR #2292:
URL: https://github.com/apache/zookeeper/pull/2292#discussion_r2271206120


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -548,13 +553,22 @@ public static X509TrustManager createTrustManager(
         try {
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
-            if (crlEnabled || ocspEnabled) {
-                pbParams.setRevocationEnabled(true);
-                System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
-                System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
-                if (ocspEnabled) {
-                    Security.setProperty(""ocsp.enable"", ""true"");
+            if (crlEnabled) {
+                // See [RevocationChecker][1] for details. Basically, we are mimicking legacy path as
+                // that is the path we are routing before(i.e. no explicit `PKIXRevocationChecker`).
+                //
+                // [1]: https://github.com/openjdk/jdk/blob/jdk-11%2B28/src/java.base/share/classes/sun/security/provider/certpath/RevocationChecker.java#L98
+                Set<PKIXRevocationChecker.Option> options = new HashSet<>();
+                if (!ocspEnabled) {
+                    options.add(PKIXRevocationChecker.Option.NO_FALLBACK);
+                    options.add(PKIXRevocationChecker.Option.PREFER_CRLS);
+                }
+                if (Boolean.parseBoolean(Security.getProperty(""com.sun.security.onlyCheckRevocationOfEECert"")))  {
+                    options.add(PKIXRevocationChecker.Option.ONLY_END_ENTITY);

Review Comment:
   You're basically following the guide here: https://docs.oracle.com/javase/8/docs/technotes/guides/security/certpath/CertPathProgGuide.html#PKIXRevocationChecker



##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -548,13 +553,22 @@ public static X509TrustManager createTrustManager(
         try {
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
-            if (crlEnabled || ocspEnabled) {
-                pbParams.setRevocationEnabled(true);
-                System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
-                System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
-                if (ocspEnabled) {
-                    Security.setProperty(""ocsp.enable"", ""true"");
+            if (crlEnabled) {
+                // See [RevocationChecker][1] for details. Basically, we are mimicking legacy path as
+                // that is the path we are routing before(i.e. no explicit `PKIXRevocationChecker`).
+                //
+                // [1]: https://github.com/openjdk/jdk/blob/jdk-11%2B28/src/java.base/share/classes/sun/security/provider/certpath/RevocationChecker.java#L98
+                Set<PKIXRevocationChecker.Option> options = new HashSet<>();
+                if (!ocspEnabled) {
+                    options.add(PKIXRevocationChecker.Option.NO_FALLBACK);
+                    options.add(PKIXRevocationChecker.Option.PREFER_CRLS);
+                }
+                if (Boolean.parseBoolean(Security.getProperty(""com.sun.security.onlyCheckRevocationOfEECert"")))  {
+                    options.add(PKIXRevocationChecker.Option.ONLY_END_ENTITY);

Review Comment:
   This is super weird. Is it really necessary?



;12/Aug/25 21:03;githubbot;600","kezhuw commented on code in PR #2292:
URL: https://github.com/apache/zookeeper/pull/2292#discussion_r2272053667


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1768,13 +1768,17 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     (Java system properties: **zookeeper.ssl.crl** and **zookeeper.ssl.quorum.crl**)
     **New in 3.5.5:**
     Specifies whether Certificate Revocation List is enabled in client and quorum TLS protocols.
-    Default: false
+    Default: jvm property ""com.sun.net.ssl.checkRevocation"" since 3.10.0, false otherwise
 
 * *ssl.ocsp* and *ssl.quorum.ocsp* :
     (Java system properties: **zookeeper.ssl.ocsp** and **zookeeper.ssl.quorum.ocsp**)
     **New in 3.5.5:**
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
-    Default: false
+    **Changed in 3.10.0:**
+    Before 3.10.0, *ssl.ocsp* and *ssl.quorum.ocsp* implies *ssl.crl* and *ssl.quorum.crl* correspondingly.
+    After 3.10.0, one has to setup both *ssl.crl* and *ssl.ocsp* (or *ssl.quorum.crl* and *ssl.quorum.ocsp*)
+    to enable OCSP. This is consistent with jdk's method of [Setting up a Java Client to use Client-Driven OCSP](https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/ocsp.html#setting-up-a-java-client-to-use-client-driven-ocsp).

Review Comment:
   I was somewhat confused by the words ""client driven"" and ""server driven"". From my understanding, CRLDP/OCSP is a way to verify **peer**'s certificate using **peer** certificate's crldp and ocsp responder.
   
   Apply this to ZooKeeper world:
   1. From client side(i.e. `ZooKeeper`), it will verify server's certificate using crl when crl  is enabled. For a successful verification, the server cert has to be generated with crldp/ocsp and not revoked.
   2. From server side(i.e. `ZooKeeperServer`), it will verify client's certificate using crl when crl  is enabled. For a successful verification, the client cert has to be generated with crldp/ocsp and not revoked.
   
   So the verification happens on the side which crl is enabled.
   
   If client and server are running in different jvms, then everything is ok. Enabling crl in client side will not forbid revoked client connecting to valid server, and vice verse.
   
   If client and server  are running in same jvm, then it is indistinguishable of the purpose of ""ssl.crl""/""ssl.ocsp"". This is why I have to code `client1Config.setProperty(""zookeeper.ssl.crl"", ""false"");` in tests to disabble client side crl.
   
   https://github.com/kezhuw/zookeeper/blob/ZOOKEEPER-4955-fix-interference-with-jvm-properties/zookeeper-server/src/test/java/org/apache/zookeeper/server/ClientSSLRevocationTest.java#L512-L513
   
   
   
   
   



;13/Aug/25 04:42;githubbot;600","kezhuw commented on code in PR #2292:
URL: https://github.com/apache/zookeeper/pull/2292#discussion_r2272053667


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1768,13 +1768,17 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     (Java system properties: **zookeeper.ssl.crl** and **zookeeper.ssl.quorum.crl**)
     **New in 3.5.5:**
     Specifies whether Certificate Revocation List is enabled in client and quorum TLS protocols.
-    Default: false
+    Default: jvm property ""com.sun.net.ssl.checkRevocation"" since 3.10.0, false otherwise
 
 * *ssl.ocsp* and *ssl.quorum.ocsp* :
     (Java system properties: **zookeeper.ssl.ocsp** and **zookeeper.ssl.quorum.ocsp**)
     **New in 3.5.5:**
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
-    Default: false
+    **Changed in 3.10.0:**
+    Before 3.10.0, *ssl.ocsp* and *ssl.quorum.ocsp* implies *ssl.crl* and *ssl.quorum.crl* correspondingly.
+    After 3.10.0, one has to setup both *ssl.crl* and *ssl.ocsp* (or *ssl.quorum.crl* and *ssl.quorum.ocsp*)
+    to enable OCSP. This is consistent with jdk's method of [Setting up a Java Client to use Client-Driven OCSP](https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/ocsp.html#setting-up-a-java-client-to-use-client-driven-ocsp).

Review Comment:
   I was somewhat confused by the words ""client driven"" and ""server driven"". From my understanding, CRLDP/OCSP is a way to verify **peer**'s certificate using **peer** certificate's crldp and ocsp responder.
   
   Apply this to ZooKeeper world:
   1. From client side(i.e. `ZooKeeper`), it will verify server's certificate using crl when crl  is enabled. For a successful verification, the server cert has to be generated with crldp/ocsp and not revoked.
   2. From server side(i.e. `ZooKeeperServer`), it will verify client's certificate using crl when crl  is enabled. For a successful verification, the client cert has to be generated with crldp/ocsp and not revoked.
   
   So the verification happens on the side which crl is enabled.
   
   If client and server are running in different jvms, then everything is ok. Enabling crl solely in client side will not forbid revoked client connecting to valid server, and vice verse.
   
   If client and server  are running in same jvm, then it is indistinguishable of the purpose of ""ssl.crl""/""ssl.ocsp"". This is why I have to code `client1Config.setProperty(""zookeeper.ssl.crl"", ""false"");` in tests to disabble client side crl.
   
   https://github.com/kezhuw/zookeeper/blob/ZOOKEEPER-4955-fix-interference-with-jvm-properties/zookeeper-server/src/test/java/org/apache/zookeeper/server/ClientSSLRevocationTest.java#L512-L513
   
   
   
   
   



;13/Aug/25 04:44;githubbot;600","kezhuw commented on code in PR #2292:
URL: https://github.com/apache/zookeeper/pull/2292#discussion_r2272208833


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -548,13 +553,22 @@ public static X509TrustManager createTrustManager(
         try {
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
-            if (crlEnabled || ocspEnabled) {
-                pbParams.setRevocationEnabled(true);
-                System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
-                System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
-                if (ocspEnabled) {
-                    Security.setProperty(""ocsp.enable"", ""true"");
+            if (crlEnabled) {
+                // See [RevocationChecker][1] for details. Basically, we are mimicking legacy path as
+                // that is the path we are routing before(i.e. no explicit `PKIXRevocationChecker`).
+                //
+                // [1]: https://github.com/openjdk/jdk/blob/jdk-11%2B28/src/java.base/share/classes/sun/security/provider/certpath/RevocationChecker.java#L98
+                Set<PKIXRevocationChecker.Option> options = new HashSet<>();
+                if (!ocspEnabled) {
+                    options.add(PKIXRevocationChecker.Option.NO_FALLBACK);
+                    options.add(PKIXRevocationChecker.Option.PREFER_CRLS);
+                }
+                if (Boolean.parseBoolean(Security.getProperty(""com.sun.security.onlyCheckRevocationOfEECert"")))  {
+                    options.add(PKIXRevocationChecker.Option.ONLY_END_ENTITY);

Review Comment:
   Add more comments about this.



;13/Aug/25 06:31;githubbot;600","kezhuw commented on code in PR #2292:
URL: https://github.com/apache/zookeeper/pull/2292#discussion_r2272212501


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1768,13 +1768,17 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     (Java system properties: **zookeeper.ssl.crl** and **zookeeper.ssl.quorum.crl**)
     **New in 3.5.5:**
     Specifies whether Certificate Revocation List is enabled in client and quorum TLS protocols.
-    Default: false
+    Default: jvm property ""com.sun.net.ssl.checkRevocation"" since 3.10.0, false otherwise
 
 * *ssl.ocsp* and *ssl.quorum.ocsp* :
     (Java system properties: **zookeeper.ssl.ocsp** and **zookeeper.ssl.quorum.ocsp**)
     **New in 3.5.5:**
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
-    Default: false
+    **Changed in 3.10.0:**
+    Before 3.10.0, *ssl.ocsp* and *ssl.quorum.ocsp* implies *ssl.crl* and *ssl.quorum.crl* correspondingly.
+    After 3.10.0, one has to setup both *ssl.crl* and *ssl.ocsp* (or *ssl.quorum.crl* and *ssl.quorum.ocsp*)
+    to enable OCSP. This is consistent with jdk's method of [Setting up a Java Client to use Client-Driven OCSP](https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/ocsp.html#setting-up-a-java-client-to-use-client-driven-ocsp).

Review Comment:
   I have refactor tests to reflect that revocation checking is only enforced in enabled side.



;13/Aug/25 06:33;githubbot;600","anmolnar merged PR #2292:
URL: https://github.com/apache/zookeeper/pull/2292


;14/Aug/25 00:24;githubbot;600","anmolnar commented on PR #2292:
URL: https://github.com/apache/zookeeper/pull/2292#issuecomment-3186263668

   Merged to `master`. `branch-3.9` has come conflicts, please create separate PR if you want to backport the patch. I think you also want to change the default value of properties, so we need a new PR anyways. Thanks for the great work @stoty @kezhuw !


;14/Aug/25 00:26;githubbot;600","anmolnar closed pull request #2289: ZOOKEEPER-4955: Fix intererence with jvm wide ssl properties for ssl.crl and ssl.ocsp
URL: https://github.com/apache/zookeeper/pull/2289


;14/Aug/25 00:48;githubbot;600","anmolnar commented on PR #2289:
URL: https://github.com/apache/zookeeper/pull/2289#issuecomment-3186300453

   Superseded by #2292 


;14/Aug/25 00:48;githubbot;600","kezhuw opened a new pull request, #2300:
URL: https://github.com/apache/zookeeper/pull/2300

   This is a fixup commit to #2292. It contains only test code changes to make SSL related classes, e.g. Ca, Cert and etcd., to be reusable.


;16/Aug/25 10:51;githubbot;600","kezhuw commented on PR #2300:
URL: https://github.com/apache/zookeeper/pull/2300#issuecomment-3224363123

   @anmolnar Would you like to take a look at this ? It is a fixup commit to #2292(ZOOKEEPER-4955) and touchs only test codes.


;26/Aug/25 14:15;githubbot;600","anmolnar merged PR #2300:
URL: https://github.com/apache/zookeeper/pull/2300


;27/Aug/25 15:51;githubbot;600","kezhuw commented on PR #2300:
URL: https://github.com/apache/zookeeper/pull/2300#issuecomment-3229220498

   >  Have you generated it with some AI?
   
   No. But I do use IntelliJ IDEA in this refactoring, not sure whether the code completions/suggestions(line by line, it will recommend you `public CertSigner withExpiration(Duration expiration) {}` or `this.expiration = expiration;`) are backed by AI.


;27/Aug/25 18:07;githubbot;600","anmolnar commented on PR #2300:
URL: https://github.com/apache/zookeeper/pull/2300#issuecomment-3229841380

   > > Have you generated it with some AI?
   > 
   > No. But I do use IntelliJ IDEA in this refactoring, not sure whether the code completions/suggestions(line by line, it will recommend you `public CertSigner withExpiration(Duration expiration) {}` or `this.expiration = expiration;`) are backed by AI.
   
   I dunno, but it's pretty impressive how quickly you were able to create the framework. Borrowed from other project or wrote from scratch?


;27/Aug/25 21:44;githubbot;600","kezhuw commented on PR #2300:
URL: https://github.com/apache/zookeeper/pull/2300#issuecomment-3231701754

   > Borrowed from other project or wrote from scratch?
   
   From scratch. But I do write tls related tests code in rust, they probably have something in common despite the language.
   
   https://github.com/kezhuw/zookeeper-client-rust/blob/4ae35472bf8545ee3462aaf287e9359ae8953644/src/tls/client.rs#L211


;28/Aug/25 03:32;githubbot;600",,,,0,26400,,,0,26400,,ZOOKEEPER-4949,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2025-08-01 06:49:46.0,,,,,,,,,,"0|z1x26w:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Use FIPS style hostname verification when no custom truststore is specified,ZOOKEEPER-4954,13624796,,Improvement,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,stoty,stoty,stoty,28/Jul/25 17:28,29/Aug/25 21:29,08/Dec/25 08:12,30/Jul/25 18:38,,,,,,,,,3.10.0,3.9.4,,,,,,0,pull-request-available,,,"Zookeeper has two ways to enable hostname verification:

The traditional one is set in ZKTrustManager when a custome truststore is used.
The FIPS style one is used when when FIPs mode is set.

However, there is currently no way to specify hostname verification when no custom truststore is used.
The FIPS style hostname verification does not depend on having a truststore defined, and can be used as a fallback when no custom trustore and no FIPS mode is configured.",,"stoty opened a new pull request, #2283:
URL: https://github.com/apache/zookeeper/pull/2283

   …ruststore is specified


;28/Jul/25 17:39;githubbot;600","stoty commented on PR #2283:
URL: https://github.com/apache/zookeeper/pull/2283#issuecomment-3128310190

   This is the hostname verification change separated from the OCSP stuff, @anmolnar .


;28/Jul/25 17:40;githubbot;600","stoty commented on PR #2283:
URL: https://github.com/apache/zookeeper/pull/2283#issuecomment-3135252991

   Added a unit test @anmolnar .


;30/Jul/25 08:01;githubbot;600","anmolnar merged PR #2283:
URL: https://github.com/apache/zookeeper/pull/2283


;30/Jul/25 18:35;githubbot;600","anmolnar commented on PR #2283:
URL: https://github.com/apache/zookeeper/pull/2283#issuecomment-3137448406

   Merged and and backported to `branch-3.9`. Thanks @stoty !
   Could you please create separate PR for the 3.8 backport if you need that. I cannot tell if we're going to accept it, because this is not a critical fix.


;30/Jul/25 18:39;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3000,,,0,3000,,ZOOKEEPER-4949,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Jul 30 18:38:22 UTC 2025,,,,,,,,,,"0|z1wzhk:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"30/Jul/25 18:38;andor;Issue resolved by pull request 2283
[https://github.com/apache/zookeeper/pull/2283];;;",,,,,,,,,,,
Fixing Typo In ZooKeeper Programmer's Guide,ZOOKEEPER-4953,13624298,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,rahulonasf,rahulonasf,rahulonasf,22/Jul/25 16:33,29/Aug/25 21:28,08/Dec/25 08:02,06/Aug/25 08:04,3.9.3,,,,,,,,3.10.0,3.8.5,3.9.4,documentation,,,,0,pull-request-available,,,"There are typo errors in Programmers Guide in the documentation of zookeeper 3.9.3.
Need to fix it.",,"rahulonGH opened a new pull request, #2281:
URL: https://github.com/apache/zookeeper/pull/2281

   There are typo errors in Programmers Guide in the documentation of zookeeper 3.9.3.


;22/Jul/25 16:36;githubbot;600","kezhuw commented on PR #2281:
URL: https://github.com/apache/zookeeper/pull/2281#issuecomment-3108792489

   `rg -i zookeeeper` gives me more than above, wound you mind fix them also ?
   
   ```
   zookeeper-docs/src/main/resources/markdown/zookeeperProgrammers.md
   840:ZooKeeeper has the following built in schemes:
   1109:_-Dzookeeeper.authProvider.X=com.f.MyAuth_ or adding entries such as
   1118:duplicates such as _-Dzookeeeper.authProvider.X=com.f.MyAuth -Dzookeeper.authProvider.X=com.f.MyAuth2_,
   
   zookeeper-server/src/test/java/org/apache/zookeeper/ZooKeeperTest.java
   804:                ""ZooKeeeperMain does not wait until the specified timeout"");
   
   zookeeper-contrib/zookeeper-contrib-zooinspector/src/main/java/org/apache/zookeeper/inspector/manager/ZooInspectorManager.java
   121:     *            zookeeeper instance
   127:     *         to connect to the zookeeeper instance
   ```


;23/Jul/25 14:01;githubbot;600","rahulonGH commented on PR #2281:
URL: https://github.com/apache/zookeeper/pull/2281#issuecomment-3111633354

   Thanks for pointing out @kezhuw 


;24/Jul/25 01:16;githubbot;600","kezhuw commented on PR #2281:
URL: https://github.com/apache/zookeeper/pull/2281#issuecomment-3111893768

   Still one more in https://github.com/apache/zookeeper/blob/b224d27d57d0b5b422e71a7bc0b046b432a8434b/zookeeper-contrib/zookeeper-contrib-zooinspector/src/main/java/org/apache/zookeeper/inspector/manager/ZooInspectorManager.java#L125-L129


;24/Jul/25 04:15;githubbot;600","rahulonGH commented on PR #2281:
URL: https://github.com/apache/zookeeper/pull/2281#issuecomment-3151544264

   > Still one more in https://github.com/apache/zookeeper/blob/b224d27d57d0b5b422e71a7bc0b046b432a8434b/zookeeper-contrib/zookeeper-contrib-zooinspector/src/main/java/org/apache/zookeeper/inspector/manager/ZooInspectorManager.java#L125-L129
   
   Updated.


;04/Aug/25 16:52;githubbot;600","kezhuw merged PR #2281:
URL: https://github.com/apache/zookeeper/pull/2281


;06/Aug/25 08:00;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3600,,,0,3600,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Aug 06 08:04:15 UTC 2025,,,,,,,,,,"0|z1wwfk:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"22/Jul/25 16:37;rahulonasf;https://github.com/apache/zookeeper/pull/2281;;;","06/Aug/25 08:04;kezhuw;Issue resolved by pull request 2281
[https://github.com/apache/zookeeper/pull/2281];;;",,,,,,,,,,
Reduce the GC overhead of Prometheus reject exception handling,ZOOKEEPER-4952,13624161,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,liwang,liwang,liwang,21/Jul/25 18:22,28/Aug/25 07:55,08/Dec/25 08:02,28/Aug/25 07:54,3.8.0,3.8.2,3.8.3,3.8.4,3.9.0,3.9.1,3.9.2,3.9.3,3.10.0,,,metric system,,,,0,pull-request-available,,,"As part of ZOOKEEPER-4289,  Prometheus summary reporting is handled as an async operation using ThreadPoolExecutor.

The default RejectedExecutionHandler used by ThreadPoolExecutor is AbortPolicy, which performs toString() on both the Runnable object and exception object. This can significantly impact performance when too many exceptions occur after the max queue size exceeds.

{code:java}
public static class AbortPolicy implements RejectedExecutionHandler {
        /**
         * Creates an {@code AbortPolicy}.
         */
        public AbortPolicy() { }

        /**
         * Always throws RejectedExecutionException.
         *
         * @param r the runnable task requested to be executed
         * @param e the executor attempting to execute this task
         * @throws RejectedExecutionException always
         */
        public void rejectedExecution(Runnable r, ThreadPoolExecutor e) {
            throw new RejectedExecutionException(""Task "" + r.toString() +
                                                 "" rejected from "" +
                                                 e.toString());
        }
    }

{code}

We can reduce the GC overhead and improve performance by implementing a PrometheusRejectExceptionHandler and overriding the rejectedExecution() API.",,"li4wang opened a new pull request, #2279:
URL: https://github.com/apache/zookeeper/pull/2279

   Implemented `PrometheusRejectedExecutionHandler` and override the `rejectedExecution()` API to fix the large memory footprint and long GC pause of RejectedExecutionException handler.  No more RejectedExecutionException() will be thrown.
   
   This enhancement increased read throughput by 140% based on perf comparison test result.


;21/Jul/25 20:24;githubbot;600","kezhuw commented on code in PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#discussion_r2225592721


##########
zookeeper-metrics-providers/zookeeper-prometheus-metrics/src/main/java/org/apache/zookeeper/metrics/prometheus/PrometheusMetricsProvider.java:
##########
@@ -714,14 +714,21 @@ public Thread newThread(final Runnable runnable) {
         }
     }
 
+    private static class PrometheusRejectedExecutionHandler implements RejectedExecutionHandler {
+        private static boolean maxQueueSizeExceeded = false;
+
+        @Override
+        public void rejectedExecution(final Runnable r, final ThreadPoolExecutor e) {
+            if (!maxQueueSizeExceeded) {
+                maxQueueSizeExceeded = true;
+                LOG.warn(""Prometheus metrics queue size exceeded the max"");

Review Comment:
   Why drop the rate limit logger ?
   
   I would expect rejections are periodically events but not a lifetime event.



;23/Jul/25 13:20;githubbot;600","kezhuw commented on PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#issuecomment-3108731274

   > This enhancement increased read throughput by 140% according to our perf comparison tests result.
   
   Is it possible to add the perf code to tests so others can evaluate it ? I saw three in our codebase.
   1. https://github.com/apache/zookeeper/blob/9d1d25cd75295b4529ce5348ba0cfce9ef4fefd7/zookeeper-server/src/test/java/org/apache/zookeeper/server/DeserializationPerfTest.java#L65-L72
   2. https://github.com/apache/zookeeper/blob/9d1d25cd75295b4529ce5348ba0cfce9ef4fefd7/zookeeper-server/src/test/java/org/apache/zookeeper/server/util/RequestPathMetricsCollectorTest.java#L416-L449
   3. https://github.com/apache/zookeeper/blob/9d1d25cd75295b4529ce5348ba0cfce9ef4fefd7/zookeeper-server/src/test/java/org/apache/zookeeper/audit/ZKAuditLoggerPerformance.java#L139-L141


;23/Jul/25 13:53;githubbot;600","li4wang commented on code in PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#discussion_r2226190582


##########
zookeeper-metrics-providers/zookeeper-prometheus-metrics/src/main/java/org/apache/zookeeper/metrics/prometheus/PrometheusMetricsProvider.java:
##########
@@ -714,14 +714,21 @@ public Thread newThread(final Runnable runnable) {
         }
     }
 
+    private static class PrometheusRejectedExecutionHandler implements RejectedExecutionHandler {
+        private static boolean maxQueueSizeExceeded = false;
+
+        @Override
+        public void rejectedExecution(final Runnable r, final ThreadPoolExecutor e) {
+            if (!maxQueueSizeExceeded) {
+                maxQueueSizeExceeded = true;
+                LOG.warn(""Prometheus metrics queue size exceeded the max"");

Review Comment:
   The rate limit logger was dropped based on the following two considerations:
   
   1. To avoid the unnecessary overhead of logging the same warn msg repeatedly even it's rate limited
   2. It's important to know whether rejection happens, but don't see too much benefits for knowing when the rejection stops and restarts.
   
   We can add the rate limit logger back if there is a strong preference to having it. 



;23/Jul/25 17:08;githubbot;600","li4wang commented on code in PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#discussion_r2226190582


##########
zookeeper-metrics-providers/zookeeper-prometheus-metrics/src/main/java/org/apache/zookeeper/metrics/prometheus/PrometheusMetricsProvider.java:
##########
@@ -714,14 +714,21 @@ public Thread newThread(final Runnable runnable) {
         }
     }
 
+    private static class PrometheusRejectedExecutionHandler implements RejectedExecutionHandler {
+        private static boolean maxQueueSizeExceeded = false;
+
+        @Override
+        public void rejectedExecution(final Runnable r, final ThreadPoolExecutor e) {
+            if (!maxQueueSizeExceeded) {
+                maxQueueSizeExceeded = true;
+                LOG.warn(""Prometheus metrics queue size exceeded the max"");

Review Comment:
   The rate limit logger was dropped based on the following two considerations:
   
   1. To avoid the unnecessary overhead of logging the same warn msg repeatedly even it's rate limited
   2. It's important to know whether rejection happens, but don't see too much benefits for knowing when the rejection stops and restarts.
   
   We can add the rate limit logger back if there is a strong preference to have it. @kezhuw  



;23/Jul/25 17:09;githubbot;600","li4wang commented on code in PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#discussion_r2226190582


##########
zookeeper-metrics-providers/zookeeper-prometheus-metrics/src/main/java/org/apache/zookeeper/metrics/prometheus/PrometheusMetricsProvider.java:
##########
@@ -714,14 +714,21 @@ public Thread newThread(final Runnable runnable) {
         }
     }
 
+    private static class PrometheusRejectedExecutionHandler implements RejectedExecutionHandler {
+        private static boolean maxQueueSizeExceeded = false;
+
+        @Override
+        public void rejectedExecution(final Runnable r, final ThreadPoolExecutor e) {
+            if (!maxQueueSizeExceeded) {
+                maxQueueSizeExceeded = true;
+                LOG.warn(""Prometheus metrics queue size exceeded the max"");

Review Comment:
   The rate limit logger was dropped based on the following two considerations:
   
   1. To avoid the unnecessary overhead of logging the same warn msg repeatedly even it's rate limited
   2. It's important to know whether rejection happens, but don't see too many benefits of knowing when the rejection stops and restarts.
   
   I am ok with either way, so let me know if there is a strong preference to have it back. @kezhuw  



;23/Jul/25 17:12;githubbot;600","kezhuw commented on code in PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#discussion_r2226456903


##########
zookeeper-metrics-providers/zookeeper-prometheus-metrics/src/main/java/org/apache/zookeeper/metrics/prometheus/PrometheusMetricsProvider.java:
##########
@@ -714,14 +714,21 @@ public Thread newThread(final Runnable runnable) {
         }
     }
 
+    private static class PrometheusRejectedExecutionHandler implements RejectedExecutionHandler {
+        private static boolean maxQueueSizeExceeded = false;
+
+        @Override
+        public void rejectedExecution(final Runnable r, final ThreadPoolExecutor e) {
+            if (!maxQueueSizeExceeded) {
+                maxQueueSizeExceeded = true;
+                LOG.warn(""Prometheus metrics queue size exceeded the max"");

Review Comment:
   > It's important to know whether rejection happens, but don't see too many benefits of knowing when the rejection stops and restarts.
   
   My concern is that: people could lost the rejection if we log it only once as it could be too far from inspection time. ZooKeeper servers in production are supposed to run for a long time, logs could be truncated or archived periodically. If we log it only once at the first occurence, then it would be hard or even impossible to notice that the metrics backend is overloading now.
   
   > To avoid the unnecessary overhead of logging the same warn msg repeatedly even it's rate limited
   
   Is it possible to optimize this as the log string is a const.
   
   I personally think rejection policy deserve rate limit as it could happen shortly and periodically due to system load.



;23/Jul/25 19:28;githubbot;600","li4wang commented on code in PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#discussion_r2227145903


##########
zookeeper-metrics-providers/zookeeper-prometheus-metrics/src/main/java/org/apache/zookeeper/metrics/prometheus/PrometheusMetricsProvider.java:
##########
@@ -714,14 +714,21 @@ public Thread newThread(final Runnable runnable) {
         }
     }
 
+    private static class PrometheusRejectedExecutionHandler implements RejectedExecutionHandler {
+        private static boolean maxQueueSizeExceeded = false;
+
+        @Override
+        public void rejectedExecution(final Runnable r, final ThreadPoolExecutor e) {
+            if (!maxQueueSizeExceeded) {
+                maxQueueSizeExceeded = true;
+                LOG.warn(""Prometheus metrics queue size exceeded the max"");

Review Comment:
   Yeah, let me just add the rate limit logger.
   
   



;24/Jul/25 02:01;githubbot;600","li4wang commented on PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#issuecomment-3111749957

   > Is it possible to add the perf code to tests so others can evaluate it 
   Do you mean to evaluate the performance improvement of this change?   
   
   Any tests that perform some write operation can be used if we set the max queue size to a very small number (e.g. 1), however, the challenge is how to measure and compare the perf improvement. This is not something can be simply done by printing out some duration like the sample tests.
   
   If we analyze how `AbortPolicy()` is implemented, it's quite obvious that this change can reduce GC overhead and memory footprint when queue size exceeds the max.   The perf improvement number is provided here for reference purpose.  We've done quite comprehensive comparison tests w/o the change.
   
   I would be very happy to provide any clarification on the perf improvement, but personally don't think it's possible to write a meaningful perf test for it in the current code base and don't feel it's necessary neither. 


;24/Jul/25 02:31;githubbot;600","kezhuw commented on PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#issuecomment-3124442260

   > I would be very happy to provide any clarification on the perf improvement, but personally don't think it's possible to write a meaningful perf test for it in the current code base and don't feel it's really necessary neither.
   
   I am ok for this, please go ahead!


;27/Jul/25 14:08;githubbot;600","li4wang commented on code in PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#discussion_r2298937582


##########
zookeeper-metrics-providers/zookeeper-prometheus-metrics/src/main/java/org/apache/zookeeper/metrics/prometheus/PrometheusMetricsProvider.java:
##########
@@ -714,14 +714,21 @@ public Thread newThread(final Runnable runnable) {
         }
     }
 
+    private static class PrometheusRejectedExecutionHandler implements RejectedExecutionHandler {
+        private static boolean maxQueueSizeExceeded = false;
+
+        @Override
+        public void rejectedExecution(final Runnable r, final ThreadPoolExecutor e) {
+            if (!maxQueueSizeExceeded) {
+                maxQueueSizeExceeded = true;
+                LOG.warn(""Prometheus metrics queue size exceeded the max"");

Review Comment:
   Added log with constant string.
   RateLogger has been optimized to enable logging a constant msg efficiently.



;25/Aug/25 19:25;githubbot;600","li4wang commented on code in PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#discussion_r2298937582


##########
zookeeper-metrics-providers/zookeeper-prometheus-metrics/src/main/java/org/apache/zookeeper/metrics/prometheus/PrometheusMetricsProvider.java:
##########
@@ -714,14 +714,21 @@ public Thread newThread(final Runnable runnable) {
         }
     }
 
+    private static class PrometheusRejectedExecutionHandler implements RejectedExecutionHandler {
+        private static boolean maxQueueSizeExceeded = false;
+
+        @Override
+        public void rejectedExecution(final Runnable r, final ThreadPoolExecutor e) {
+            if (!maxQueueSizeExceeded) {
+                maxQueueSizeExceeded = true;
+                LOG.warn(""Prometheus metrics queue size exceeded the max"");

Review Comment:
   - Enhanced `RateLogger `  reduce string concatenation overhead.
   - Added the rate logger back to visibility when exceeding max  happens



;25/Aug/25 22:38;githubbot;600","li4wang commented on PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#issuecomment-3222066651

   Hi @kezhuw The rate logger has been added back with optimized RateLogger for reducing string concatenations. Would you mind taking a look at it? Thanks. 


;25/Aug/25 23:46;githubbot;600","li4wang merged PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279


;27/Aug/25 21:47;githubbot;600","li4wang commented on PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#issuecomment-3229848169

   Thanks @kezhuw I will go ahead to merge it. 


;27/Aug/25 21:47;githubbot;600","li4wang commented on PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#issuecomment-3229852477

   @kezhuw Do you know if we  need to open a separate JIRA and PR if we want to include this in the upcoming 3.10.0 release?


;27/Aug/25 21:50;githubbot;600","kezhuw commented on PR #2279:
URL: https://github.com/apache/zookeeper/pull/2279#issuecomment-3232367030

   Hi @li4wang, master will be 3.10.0.


;28/Aug/25 07:55;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,10200,,,0,10200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2025-07-21 18:22:45.0,,,,,,,,,,"0|z1wvl4:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Cache zookeeper dists for end to end compatibility tests,ZOOKEEPER-4944,13621542,,Improvement,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,kezhuw,kezhuw,kezhuw,23/Jun/25 09:59,29/Aug/25 21:28,08/Dec/25 08:02,25/Jun/25 23:29,,,,,,,,,3.10.0,3.8.5,3.9.4,tests,,,,0,pull-request-available,,,Our github action's end to end test fails quite often in downloading zookeeper dists from archive.apache.org. I think we could use github action's cache to eliminate this as much as possible.,,"kezhuw merged PR #2273:
URL: https://github.com/apache/zookeeper/pull/2273


;25/Jun/25 23:21;githubbot;600","kezhuw commented on PR #2273:
URL: https://github.com/apache/zookeeper/pull/2273#issuecomment-3006652265

   Merged and backported to master, branch-3.9 and branch-3.8. Thank you for reviewing! @cnauroth 
   
   The result is pretty good. All branches and prs are benefit from this. Forks should be same after rebasing master(the default branch).
   
   > The cache action first searches for cache hits for key and the cache version in the branch containing the workflow run. If there is no hit, it searches for prefix-matches for key, and if there is still no hit, it searches for restore-keys and the version. If there are still no hits in the current branch, the cache action retries the same steps on the default branch.    ;26/Jun/25 00:58;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1200,,,0,1200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2025-06-23 09:59:05.0,,,,,,,,,,"0|z1wfts:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Use Duration instead of int timeout for ZooKeeperBuilder,ZOOKEEPER-4943,13621529,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,kezhuw,kezhuw,kezhuw,23/Jun/25 07:55,26/Jun/25 01:03,08/Dec/25 08:12,26/Jun/25 01:01,3.10.0,,,,,,,,3.10.0,,,java client,,,,0,pull-request-available,,,Some of zookeeper codes predate even java 8. It would be nice to use {{Duration}} for newly introduced {{ZooKeeperBuilder}}.,,"purushah commented on PR #2274:
URL: https://github.com/apache/zookeeper/pull/2274#issuecomment-3006078135

   @kezhuw  Since we’re updating the ZooKeeperBuilder constructor, could this break backward compatibility?
   Can we retain the old constructor (marked as @Deprecated) for now? 
   The same approach should apply to ZooKeeperOptions.getSessionTimeout().


;25/Jun/25 20:38;githubbot;600","kezhuw commented on PR #2274:
URL: https://github.com/apache/zookeeper/pull/2274#issuecomment-3006506332

   Hi @purushah, thank you for you remind! `ZooKeeperBuilder` was introduced in ZOOKEEPER-4697 which targets [3.10.0](https://issues.apache.org/jira/projects/ZOOKEEPER/versions/12353481) which has not been released yet. So there is no reason for us to do this.


;25/Jun/25 23:20;githubbot;600","kezhuw merged PR #2274:
URL: https://github.com/apache/zookeeper/pull/2274


;26/Jun/25 01:01;githubbot;600","kezhuw commented on PR #2274:
URL: https://github.com/apache/zookeeper/pull/2274#issuecomment-3006659232

   Merged to master. I am counting LGTM as approval. Thank you all for reviewing! @eolivelli @purushah 


;26/Jun/25 01:03;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,,,,,,,,,,ZOOKEEPER-4697,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Thu Jun 26 01:01:24 UTC 2025,,,,,,,,,,"0|z1wfqw:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"26/Jun/25 01:01;kezhuw;Issue resolved by pull request 2274
[https://github.com/apache/zookeeper/pull/2274];;;",,,,,,,,,,,
Add option to preserve JVM TLS certification revocation properties,ZOOKEEPER-4942,13621201,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Workaround,stoty,stoty,stoty,18/Jun/25 08:17,07/Aug/25 05:32,08/Dec/25 08:12,07/Aug/25 05:32,,,,,,,,,,,,security,,,,0,pull-request-available,,,"The current behaviour is to overwrite the JVM global TLS certification revocation properties based on ZK configuration.

This is a bad idea, as ZK is unlikely to be the only thing running in the JVM (unless it is the ZK server process), and the ZK settings (Even the OCSP/CRL disabled default settings) will apply to ALL connections in the JVM.

Ideally, ZK would just leave these properties alone, but that would break backwards compatibility.

I propose the following fixes:

A. Change the default behaviour, so that if the _zookeeper.ssl.ocsp_ _zookeeper.ssl.crl_ properties are not defined then ZK skips changing the certificate revocation related global settings, and relies on the JVM System/Security properties.

B. Change the default behaviour, so that if the _zookeeper.ssl.ocsp_ _zookeeper.ssl.crl_ properties are set to a specific value (i.e. ""system"") ZK skips changing the certificate revocation related global settings, and relies on the JVM System/Security properties.

Option A. would be the more secure, as it doesn't overwrite the system settings, but it does break backwards compatibiliry with existing ZK versions.

Option B. is less secure, as it requires explicit configuration not to clobber the JVM global settings, but it is fully backwards compatible with existing configurations.
",,"anmolnar commented on code in PR #2271:
URL: https://github.com/apache/zookeeper/pull/2271#discussion_r2163666292


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -548,17 +548,19 @@ public static X509TrustManager createTrustManager(
         try {
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
-            if (crlEnabled || ocspEnabled) {
-                pbParams.setRevocationEnabled(true);
-                System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
-                System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
-                if (ocspEnabled) {
-                    Security.setProperty(""ocsp.enable"", ""true"");
-                }
-            } else {
-                pbParams.setRevocationEnabled(false);
+            // Leave CRL/OCSP JVM global properties alone both are set to ""system"" (represented as null)
+            if (!crlEnabled.isSystem() || !ocspEnabled.isSystem()) {
+	            if (crlEnabled.isTrue() || ocspEnabled.isTrue()) {
+	                pbParams.setRevocationEnabled(true);
+	                System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
+	                System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
+	                if (ocspEnabled.isTrue()) {
+	                    Security.setProperty(""ocsp.enable"", ""true"");
+	                }
+	            } else {
+	                pbParams.setRevocationEnabled(false);
+	            }

Review Comment:
   One question here:
   In the case when both parameters are set to 'system', we won't do anything: not altering system properties and not setting revocation in `pbParams`. Will that work correctly, I mean will `pbParams` revocation flag follow the system settings?



;24/Jun/25 11:07;githubbot;600","anmolnar commented on code in PR #2271:
URL: https://github.com/apache/zookeeper/pull/2271#discussion_r2163676682


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -548,17 +548,19 @@ public static X509TrustManager createTrustManager(
         try {
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
-            if (crlEnabled || ocspEnabled) {
-                pbParams.setRevocationEnabled(true);
-                System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
-                System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
-                if (ocspEnabled) {
-                    Security.setProperty(""ocsp.enable"", ""true"");
-                }
-            } else {
-                pbParams.setRevocationEnabled(false);
+            // Leave CRL/OCSP JVM global properties alone both are set to ""system"" (represented as null)
+            if (!crlEnabled.isSystem() || !ocspEnabled.isSystem()) {
+	            if (crlEnabled.isTrue() || ocspEnabled.isTrue()) {
+	                pbParams.setRevocationEnabled(true);
+	                System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
+	                System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
+	                if (ocspEnabled.isTrue()) {
+	                    Security.setProperty(""ocsp.enable"", ""true"");
+	                }
+	            } else {
+	                pbParams.setRevocationEnabled(false);
+	            }

Review Comment:
   Doc:
   > When a PKIXParameters object is created, this flag is set to true. This setting reflects the most common strategy for checking revocation, since each service provider must support revocation checking to be PKIX compliant. Sophisticated applications should set this flag to false when it is not practical to use a PKIX service provider's default revocation checking mechanism or when an alternative revocation checking mechanism is to be substituted (by also calling the addCertPathChecker or setCertPathCheckers methods).



;24/Jun/25 11:11;githubbot;600","anmolnar commented on code in PR #2271:
URL: https://github.com/apache/zookeeper/pull/2271#discussion_r2163676682


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java:
##########
@@ -548,17 +548,19 @@ public static X509TrustManager createTrustManager(
         try {
             KeyStore ts = loadTrustStore(trustStoreLocation, trustStorePassword, trustStoreTypeProp);
             PKIXBuilderParameters pbParams = new PKIXBuilderParameters(ts, new X509CertSelector());
-            if (crlEnabled || ocspEnabled) {
-                pbParams.setRevocationEnabled(true);
-                System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
-                System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
-                if (ocspEnabled) {
-                    Security.setProperty(""ocsp.enable"", ""true"");
-                }
-            } else {
-                pbParams.setRevocationEnabled(false);
+            // Leave CRL/OCSP JVM global properties alone both are set to ""system"" (represented as null)
+            if (!crlEnabled.isSystem() || !ocspEnabled.isSystem()) {
+	            if (crlEnabled.isTrue() || ocspEnabled.isTrue()) {
+	                pbParams.setRevocationEnabled(true);
+	                System.setProperty(""com.sun.net.ssl.checkRevocation"", ""true"");
+	                System.setProperty(""com.sun.security.enableCRLDP"", ""true"");
+	                if (ocspEnabled.isTrue()) {
+	                    Security.setProperty(""ocsp.enable"", ""true"");
+	                }
+	            } else {
+	                pbParams.setRevocationEnabled(false);
+	            }

Review Comment:
   Doc:
   > If this flag is true, the default revocation checking mechanism of the underlying PKIX service provider will be used
   
   > When a PKIXParameters object is created, this flag is set to true. This setting reflects the most common strategy for checking revocation, since each service provider must support revocation checking to be PKIX compliant. Sophisticated applications should set this flag to false when it is not practical to use a PKIX service provider's default revocation checking mechanism or when an alternative revocation checking mechanism is to be substituted (by also calling the addCertPathChecker or setCertPathCheckers methods).



;24/Jun/25 11:11;githubbot;600","Seanhom opened a new pull request, #2275:
URL: https://github.com/apache/zookeeper/pull/2275

   1. Improved error handling for read() failures
   2. Enhanced backup randomness by combining current time with PID
   3. Fixed potential infinite loop when read() returns error


;01/Jul/25 08:34;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,ZOOKEEPER-4949,,,,,,,,ZOOKEEPER-4941,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Thu Aug 07 05:32:15 UTC 2025,,,,,,,,,,"0|z1wdq0:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"18/Jun/25 08:23;stoty;FYI [~andor];;;","07/Aug/25 05:32;stoty;As noted by [~andor] , this can be achieved by simply setting the revocation related config properties to their default (false) setting, so this is not really necessary.

The new per-trustore revocation checking property makes this redundant.;;;",,,,,,,,,,
Enabling zookeeper.ssl.ocsp with JRE TLS provider errors out,ZOOKEEPER-4940,13621180,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,stoty,stoty,stoty,18/Jun/25 04:12,29/Aug/25 21:28,08/Dec/25 08:12,29/Jul/25 20:04,3.10.0,3.9.3,,,,,,,3.10.0,3.9.4,,security,,,,0,pull-request-available,,,"The problem is that ZK uncoditionally calls *io.netty.handler.ssl.SslContextBuilder.enableOcsp(boolean)*
when _zookeeper.ssl.ocsp_ is set to true, even though Netty explicitly does not support that for the JRE provider.

For JRE OCSP is set in the javax.net.ssl.TrustManager object.
I did not dig deep, but I presume that the OpenSSL provider ignores that, hence it needs another property.

-To make this even more intersting, this setting doesn't actually do anything at all in Zookeeper.-
-Zookeeper use netty-tcnative-boringssl-static , but this method is a NoOP for boringSSL, it is only supported by tcnative-
-for OpenSSL.-
-(I guess in theory the consumer could replace the tcnative implementation, in which case it would work as intended)-
{noformat}
[zk: ccycloud-1.nightly7310-og.root.comops.site:2182(CONNECTING) 0] 2025-06-18 04:06:01,013 [myid:] - WARN  [zkNetty-EpollEventLoopGroup-1-1:o.a.z.c.ClientX509Util@72] - zookeeper.ssl.keyStore.location not specified
2025-06-18 04:06:01,074 [myid:] - WARN  [zkNetty-EpollEventLoopGroup-1-1:i.n.c.ChannelInitializer@97] - Failed to initialize a channel. Closing: [id: 0x1fac3cf9]
java.lang.IllegalArgumentException: OCSP is not supported with this SslProvider: JDK
	at io.netty.handler.ssl.SslContext.newClientContextInternal(SslContext.java:837)
	at io.netty.handler.ssl.SslContextBuilder.build(SslContextBuilder.java:648)
	at org.apache.zookeeper.common.ClientX509Util.createNettySslContextForClient(ClientX509Util.java:93)
	at org.apache.zookeeper.ClientCnxnSocketNetty$ZKClientPipelineFactory.initSSL(ClientCnxnSocketNetty.java:449)
	at org.apache.zookeeper.ClientCnxnSocketNetty$ZKClientPipelineFactory.initChannel(ClientCnxnSocketNetty.java:438)
	at org.apache.zookeeper.ClientCnxnSocketNetty$ZKClientPipelineFactory.initChannel(ClientCnxnSocketNetty.java:424)
	at io.netty.channel.ChannelInitializer.initChannel(ChannelInitializer.java:129)
	at io.netty.channel.ChannelInitializer.handlerAdded(ChannelInitializer.java:112)
	at io.netty.channel.AbstractChannelHandlerContext.callHandlerAdded(AbstractChannelHandlerContext.java:1130)
	at io.netty.channel.DefaultChannelPipeline.callHandlerAdded0(DefaultChannelPipeline.java:558)
	at io.netty.channel.DefaultChannelPipeline.access$100(DefaultChannelPipeline.java:45)
	at io.netty.channel.DefaultChannelPipeline$PendingHandlerAddedTask.execute(DefaultChannelPipeline.java:1410)
	at io.netty.channel.DefaultChannelPipeline.callHandlerAddedForAllHandlers(DefaultChannelPipeline.java:1064)
	at io.netty.channel.DefaultChannelPipeline.invokeHandlerAddedIfNeeded(DefaultChannelPipeline.java:599)
	at io.netty.channel.AbstractChannel$AbstractUnsafe.register0(AbstractChannel.java:513)
	at io.netty.channel.AbstractChannel$AbstractUnsafe.access$200(AbstractChannel.java:428)
	at io.netty.channel.AbstractChannel$AbstractUnsafe$1.run(AbstractChannel.java:485)
	at io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:173)
	at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:166)
	at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:472)
	at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:408)
	at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:998)
	at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)
	at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)
	at java.lang.Thread.run(Thread.java:750)

{noformat}",,"anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2192960833


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -79,7 +79,11 @@ public SslContext createNettySslContextForClient(ZKConfig config)
             sslContextBuilder.trustManager(tm);
         }
 
-        sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
+        SslProvider sslProvider = getSslProvider(config);
+        sslContextBuilder.sslProvider(sslProvider);
+        if (sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT) {

Review Comment:
   What about using `OpenSsl.isAvailable()` and `OpenSsl.isOcspSupported()` together?



;08/Jul/25 16:30;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2192964233


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   In think we should rename this to `ssl.ocsp.stapling` and `ssl.quorum.ocsp.stapling`. As you mention in the description, the feature is only available when native OpenSSL library is in use, otherwise setting this is a no-op.



;08/Jul/25 16:32;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2192989031


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -99,6 +113,14 @@ public SslContext createNettySslContextForClient(ZKConfig config)
         }
     }
 
+    private void logTcnativeOcsp(boolean enable) {
+        if (enable && !OpenSsl.isOcspSupported()) {
+            // SslContextBuilder.enableOcsp() doesn't do anything, unless the default BoringSSL
+            // tcnative dependency is replaced with an OpenSsl one.
+            LOG.warn(""Trying to enable OCSP for tcnative OpenSSL provider, but it is not supported. The setting will be ignored"");

Review Comment:
   ""Trying to enable OCSP stapling, but the selected SSL provider {name} doesn't support it""



;08/Jul/25 16:45;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2192989031


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -99,6 +113,14 @@ public SslContext createNettySslContextForClient(ZKConfig config)
         }
     }
 
+    private void logTcnativeOcsp(boolean enable) {
+        if (enable && !OpenSsl.isOcspSupported()) {
+            // SslContextBuilder.enableOcsp() doesn't do anything, unless the default BoringSSL
+            // tcnative dependency is replaced with an OpenSsl one.
+            LOG.warn(""Trying to enable OCSP for tcnative OpenSSL provider, but it is not supported. The setting will be ignored"");

Review Comment:
   ""Trying to enable OCSP stapling, but the selected SSL provider {name} doesn't support it. Ignored.""



;08/Jul/25 16:45;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2193127088


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   There are two distinct ways to enable (request) OCSP stapling depending on the TLS provider:
   
   https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/ocsp.html#setting-up-a-java-client-to-use-ocsp-stapling
   
   ""ssl.ocsp.stapling"" would mask the fact that this is only for the netty tcnative/openssl provider.
   
   We could use ""ssl.tcnative.ocsp.stapling""  or ""ssl.openssl.ocsp.stapling"" .
   



;08/Jul/25 17:58;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2193146205


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -99,6 +113,14 @@ public SslContext createNettySslContextForClient(ZKConfig config)
         }
     }
 
+    private void logTcnativeOcsp(boolean enable) {
+        if (enable && !OpenSsl.isOcspSupported()) {
+            // SslContextBuilder.enableOcsp() doesn't do anything, unless the default BoringSSL
+            // tcnative dependency is replaced with an OpenSsl one.
+            LOG.warn(""Trying to enable OCSP for tcnative OpenSSL provider, but it is not supported. The setting will be ignored"");

Review Comment:
   There is no API to get the tcnative implementation name.
   
   The closest thing I could find is OpenSsl.versionString() .



;08/Jul/25 18:09;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2193150616


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   I went for ssl.tcnative.ocsp.stapling for now, LMK if that's acceptable to you, @anmolnar .



;08/Jul/25 18:12;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2193162482


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -99,6 +113,14 @@ public SslContext createNettySslContextForClient(ZKConfig config)
         }
     }
 
+    private void logTcnativeOcsp(boolean enable) {
+        if (enable && !OpenSsl.isOcspSupported()) {
+            // SslContextBuilder.enableOcsp() doesn't do anything, unless the default BoringSSL
+            // tcnative dependency is replaced with an OpenSsl one.
+            LOG.warn(""Trying to enable OCSP for tcnative OpenSSL provider, but it is not supported. The setting will be ignored"");

Review Comment:
   Would you like to add that to the log line ?



;08/Jul/25 18:18;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2211511647


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -99,6 +113,14 @@ public SslContext createNettySslContextForClient(ZKConfig config)
         }
     }
 
+    private void logTcnativeOcsp(boolean enable) {
+        if (enable && !OpenSsl.isOcspSupported()) {
+            // SslContextBuilder.enableOcsp() doesn't do anything, unless the default BoringSSL
+            // tcnative dependency is replaced with an OpenSsl one.
+            LOG.warn(""Trying to enable OCSP for tcnative OpenSSL provider, but it is not supported. The setting will be ignored"");

Review Comment:
   What does `sslProvider.toString()` give?



;16/Jul/25 20:21;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2211513984


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   We might want to add full support by setting the following JDK properties too:
   
   `jdk.tls.server.enableStatusRequestExtension` and `jdk.tls.client.enableStatusRequestExtension`
   
   wdyt?



;16/Jul/25 20:22;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2211519787


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -79,7 +79,11 @@ public SslContext createNettySslContextForClient(ZKConfig config)
             sslContextBuilder.trustManager(tm);
         }
 
-        sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
+        SslProvider sslProvider = getSslProvider(config);
+        sslContextBuilder.sslProvider(sslProvider);
+        if (sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT) {

Review Comment:
   @stoty did you see this?



;16/Jul/25 20:24;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2212148314


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -79,7 +79,11 @@ public SslContext createNettySslContextForClient(ZKConfig config)
             sslContextBuilder.trustManager(tm);
         }
 
-        sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
+        SslProvider sslProvider = getSslProvider(config);
+        sslContextBuilder.sslProvider(sslProvider);
+        if (sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT) {

Review Comment:
   OpenSsl.isAvailable() is completely irrelevant. It only tells if the OpenSSL provider is present on the classpath (perhaps with some sanity checks).
   We COULD make a different check for it, but Netty will handle this and error out anyway, so I don't see any added value.
   
   **The actual error that we want to fix is the error that we get when netty is configured to use the JRE PROVIDER and 
   we're calling enableOCSP().**
   
   OpenSsl.isOcspSupported() is actually broken:
   
   `    sslCtx = SSLContext.make(SSL.SSL_PROTOCOL_TLSV1_2, SSL.SSL_MODE_SERVER);
                   SSLContext.enableOcsp(sslCtx, false);
                   supportsOcsp = true;
   `
   
   As tcnative will simply ignore enableOcsp() if the native library does not support it, that call will return true for BoringSSL, so it only really tells us wheter calling enableOcsp() would cause the SSLContextContext creation to fail.
   Additionally, all enableOcsp() does is set a member in the builder, the actual check only happens at build time.
   
   While this won't do anything useful for now, we can add a check for this in case tcnative behaviour changes in the future and some relevant check is added in enableOcsp()
   



;17/Jul/25 03:53;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2212150000


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -123,7 +126,11 @@ public SslContext createNettySslContextForServer(ZKConfig config, KeyManager key
             sslContextBuilder.trustManager(trustManager);
         }
 
-        sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
+        SslProvider sslProvider = getSslProvider(config);
+        sslContextBuilder.sslProvider(sslProvider);
+        if (sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT) {

Review Comment:
   see above



;17/Jul/25 03:53;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2212148314


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -79,7 +79,11 @@ public SslContext createNettySslContextForClient(ZKConfig config)
             sslContextBuilder.trustManager(tm);
         }
 
-        sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
+        SslProvider sslProvider = getSslProvider(config);
+        sslContextBuilder.sslProvider(sslProvider);
+        if (sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT) {

Review Comment:
   OpenSsl.isAvailable() is completely irrelevant. It only tells if the OpenSSL provider is present on the classpath (perhaps with some sanity checks).
   We COULD make a different check for it, but Netty will handle this and error out anyway (whether enableOcsp is called or not), so I don't see any added value.
   
   **The actual error that we want to fix is the error that we get when netty is configured to use the JRE PROVIDER and 
   we're calling enableOCSP().**
   
   OpenSsl.isOcspSupported() is actually broken:
   
   `    sslCtx = SSLContext.make(SSL.SSL_PROTOCOL_TLSV1_2, SSL.SSL_MODE_SERVER);
                   SSLContext.enableOcsp(sslCtx, false);
                   supportsOcsp = true;
   `
   
   As tcnative will simply ignore enableOcsp() if the native library does not support it, that call will return true for BoringSSL, so it only really tells us wheter calling enableOcsp() would cause the SSLContextContext creation to fail.
   Additionally, all enableOcsp() does is set a member in the builder, the actual check only happens at build time.
   
   While this won't do anything useful for now, we can add a check for this in case tcnative behaviour changes in the future and some relevant check is added in enableOcsp()
   



;17/Jul/25 03:55;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2212244622


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   I want to move away from directly setting JDK global system properties, not add more.
   
   I would perhaps make sense the server which does not have other code running in it, but definitely not for the client. The ZK TLS config code is currently not structured to handle server-only settings well, adding server-only settings could also confuse users.
   
   In any case, we agreed to try and keep the individual changes as small as possible, so this is outside the scope of this particular ticket.



;17/Jul/25 04:47;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2212246941


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -99,6 +113,14 @@ public SslContext createNettySslContextForClient(ZKConfig config)
         }
     }
 
+    private void logTcnativeOcsp(boolean enable) {
+        if (enable && !OpenSsl.isOcspSupported()) {
+            // SslContextBuilder.enableOcsp() doesn't do anything, unless the default BoringSSL
+            // tcnative dependency is replaced with an OpenSsl one.
+            LOG.warn(""Trying to enable OCSP for tcnative OpenSSL provider, but it is not supported. The setting will be ignored"");

Review Comment:
   The Enum default: ""JRE""/""OPENSSL""/""OPENSSL_REFCNT""
   
   I have added the version string to the error message (which won't ever trigger unless tcnative fixes OpenSSL.isOcspSupported().
   



;17/Jul/25 04:50;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2212244622


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   I want to move away from directly setting JDK global system properties, not add more.
   
   It would perhaps make sense the server which does not have other code running in it, but definitely not for the client. The ZK TLS config code is currently not structured to handle server-only settings well, adding server-only settings could also confuse users.
   
   In any case, we agreed to try and keep the individual changes as small as possible, so this is outside the scope of this particular ticket.



;17/Jul/25 04:51;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2212148314


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -79,7 +79,11 @@ public SslContext createNettySslContextForClient(ZKConfig config)
             sslContextBuilder.trustManager(tm);
         }
 
-        sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
+        SslProvider sslProvider = getSslProvider(config);
+        sslContextBuilder.sslProvider(sslProvider);
+        if (sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT) {

Review Comment:
   OpenSsl.isAvailable() is completely irrelevant. It only tells if the OpenSSL provider is present on the classpath (perhaps with some sanity checks).
   We COULD make a different check for it, but Netty will handle this and error out anyway (whether enableOcsp is called or not), so I don't see any added value.
   
   **The actual error that we want to fix is the error that we get when netty is configured to use the JRE PROVIDER and 
   we're calling enableOCSP().**
   
   I have some doubts about whether OpenSSL.enableOcsp() does what we would expect it to do, but as this is the API we have, we should use it. 
   
   Even if it returns a wrong result (i.e. true for BoringSSL), that only means that the setting will be silently ignored. We can't fix that from our side.
   



;17/Jul/25 05:34;githubbot;600","stoty commented on PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#issuecomment-3082667525

   Thanks for the review @anmolnar .
   
   It turns out that I have misread the tcnative/boringssl code, and current BoringSSL DOES support ocsp stapling.
   I have removed the comments and docs stating that BoringSSL does not support stapling.
   
   In any case, I have added checks for OpenSSL.isOcspSupported() and refactored the duplicate logic into a new method.
   I have also added more logging and tried to make the logic simpler and easier to follow.


;17/Jul/25 05:59;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2213461306


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -79,7 +79,11 @@ public SslContext createNettySslContextForClient(ZKConfig config)
             sslContextBuilder.trustManager(tm);
         }
 
-        sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
+        SslProvider sslProvider = getSslProvider(config);
+        sslContextBuilder.sslProvider(sslProvider);
+        if (sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT) {

Review Comment:
   If it errors out only for JRE provider, why don't we check the other way around like `provider != JDK`. But anyways, let's keep this check if there's no better way.



;17/Jul/25 14:11;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2213461306


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -79,7 +79,11 @@ public SslContext createNettySslContextForClient(ZKConfig config)
             sslContextBuilder.trustManager(tm);
         }
 
-        sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
+        SslProvider sslProvider = getSslProvider(config);
+        sslContextBuilder.sslProvider(sslProvider);
+        if (sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT) {

Review Comment:
   If it errors out only for JRE provider, why don't we check the other way around like `provider != JDK`? But anyways, let's keep this check if there's no better way.



;17/Jul/25 14:11;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2213528034


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   No, the reason for introducing TriState settings is to keep setting Java system properties if needed. I don't want to move away from setting them, because they're required and work fine on the server side. Instead, we should distinguish client and server side code wherever it's necessary.
   
   > The ZK TLS config code is currently not structured to handle server-only settings well, adding server-only settings could also confuse users.
   
   This is not true. You could add server-only code to this [method](https://github.com/apache/zookeeper/blob/master/zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java#L119). 
   
   `zoo.cfg` config file is for server settings only, while client config is handled by `ZKClientConfig` class. Both sides could work fine with TriState settings and with proper documentation they won't be confusing at all.
   
   ```
   if (ocspStapling.isTrue()) {
     if (provider == JDK) {
       System.setProperty(...);
     } else {
       provider.enableOcsp(...);
     }
   }
   ```
   
   > In any case, we agreed to try and keep the individual changes as small as possible, so this is outside the scope of this particular ticket.
   
   You're already introducing a new config setting to resolve the problem and I suggest to generalize for wider use cases, not just for OpenSSL.



;17/Jul/25 14:33;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2213840189


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   I still don't see why we should add more fetures to a bugfix ticket.
   You said that you oppose cleanup tickets, yet want to cram only tangetially related fixes to this ticket.
   I can remove the new property for this ticket if you prefer.



;17/Jul/25 16:50;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2213840189


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   I still don't see why we should add more fetures to a bugfix ticket.
   You said that you oppose cleanup tickets, yet want to cram only tangetially related bew features into this ticket.
   I can remove the new property for this ticket if you prefer.



;17/Jul/25 16:50;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2213844214


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   The new server only properties would be the first of their kind, but we can add them.
   We can indeed document that they work differently from all the other properties.
   
   I personally think that setting those properties on the server JDK command line is a better option though.



##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   I still don't see why we should add more fetures to a bugfix ticket.
   You said that you oppose cleanup tickets, yet want to cram only tangetially related new features into this ticket.
   I can remove the new property for this ticket if you prefer.



;17/Jul/25 16:52;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2213840189


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   I still don't see why we should add more fetures to a bugfix ticket.
   You said that you oppose cleanup tickets, yet want to cram only tangetially related new features into this ticket.
   I can remove the new property from this ticket if you prefer.



;17/Jul/25 16:52;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2213867123


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -79,7 +79,11 @@ public SslContext createNettySslContextForClient(ZKConfig config)
             sslContextBuilder.trustManager(tm);
         }
 
-        sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
+        SslProvider sslProvider = getSslProvider(config);
+        sslContextBuilder.sslProvider(sslProvider);
+        if (sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT) {

Review Comment:
   Checking for JDK would also work.
   I prefer checking for the implementations that are known to implement the feature, as this would keep working in the (highly theoretical) case that new provider is added to netty.



;17/Jul/25 17:05;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2214028950


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1776,6 +1776,16 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Specifies whether Online Certificate Status Protocol is enabled in client and quorum TLS protocols.
     Default: false
 
+* *ssl.tcnative.ocsp* and *ssl.quorum.tcnative.ocsp* :

Review Comment:
   Ok, I accept that. Let's go with the current approach.



;17/Jul/25 18:35;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2214029758


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -79,7 +79,11 @@ public SslContext createNettySslContextForClient(ZKConfig config)
             sslContextBuilder.trustManager(tm);
         }
 
-        sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
+        SslProvider sslProvider = getSslProvider(config);
+        sslContextBuilder.sslProvider(sslProvider);
+        if (sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT) {

Review Comment:
   Ok, let's go with that.



;17/Jul/25 18:35;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2214039840


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -144,6 +145,33 @@ public SslContext createNettySslContextForServer(ZKConfig config, KeyManager key
         }
     }
 
+    private SslContextBuilder handleTcnativeOcspStapling(SslContextBuilder builder, ZKConfig config) {
+        SslProvider sslProvider = getSslProvider(config);
+        boolean tcnative = sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT;
+        boolean ocspEnabled = config.getBoolean(getSslOcspEnabledProperty());
+        TriState tcnativeOcspStapling = config.getTristate(getSslTcnativeOcspStaplingEnabledProperty());
+
+        if (tcnative && ocspEnabled && tcnativeOcspStapling.isDefault() && OpenSsl.isOcspSupported()) {
+            // Maintain old behaviour (mostly, we also check for OpenSsl.isOcspSupported())
+            builder.enableOcsp(ocspEnabled);
+        } else if (tcnativeOcspStapling.isTrue()) {
+            if (!tcnative) {
+                // Don't override the explicit setting, let it error out
+                LOG.error(""Trying to enable OpenSSL OCSP stapling for non-OpenSSL TLS provider. ""
+                        + ""This is going to fail. Please fix the TLS configuration"");
+            } else if (!OpenSsl.isOcspSupported()) {
+                LOG.warn(""Trying to enable OpenSSL OCSP stapling for OpenSSL provider {} which does not support it. ""
+                        + ""This is either going to be ignored or fail."", OpenSsl.versionString());
+            }
+            builder.enableOcsp(true);
+        } else if (tcnativeOcspStapling.isFalse()) {
+            // Disabling OCSP for the builder is always safe.
+            // This is the same as the builder default, effectively a noop.

Review Comment:
   I was thinking about this too. Why do we bother with TriState property if the default is obviously that the feature is disabled? We're trying to cover a highly unlikely case if ever in the future the enabled OCSP Stapling feature will become the default.
   
   Instead - strictly fixing the bug only - we could do:
   ```java
   if (tcnative && ocspEnabled && tcnativeOcspStapling && OpenSsl.isOcspSupported()) {
     builder.enableOcsp(ocspEnabled);
   }
   ```



##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -144,6 +145,33 @@ public SslContext createNettySslContextForServer(ZKConfig config, KeyManager key
         }
     }
 
+    private SslContextBuilder handleTcnativeOcspStapling(SslContextBuilder builder, ZKConfig config) {
+        SslProvider sslProvider = getSslProvider(config);
+        boolean tcnative = sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT;
+        boolean ocspEnabled = config.getBoolean(getSslOcspEnabledProperty());
+        TriState tcnativeOcspStapling = config.getTristate(getSslTcnativeOcspStaplingEnabledProperty());
+
+        if (tcnative && ocspEnabled && tcnativeOcspStapling.isDefault() && OpenSsl.isOcspSupported()) {
+            // Maintain old behaviour (mostly, we also check for OpenSsl.isOcspSupported())
+            builder.enableOcsp(ocspEnabled);
+        } else if (tcnativeOcspStapling.isTrue()) {
+            if (!tcnative) {
+                // Don't override the explicit setting, let it error out
+                LOG.error(""Trying to enable OpenSSL OCSP stapling for non-OpenSSL TLS provider. ""
+                        + ""This is going to fail. Please fix the TLS configuration"");
+            } else if (!OpenSsl.isOcspSupported()) {
+                LOG.warn(""Trying to enable OpenSSL OCSP stapling for OpenSSL provider {} which does not support it. ""
+                        + ""This is either going to be ignored or fail."", OpenSsl.versionString());
+            }
+            builder.enableOcsp(true);
+        } else if (tcnativeOcspStapling.isFalse()) {
+            // Disabling OCSP for the builder is always safe.
+            // This is the same as the builder default, effectively a noop.

Review Comment:
   We could do even less if not introducing the new config setting for stapling. If OCSP is enabled in the config and `tcnative` is in use, then we enabled OCSP stapling. This is the simplest bugfix I can think of and it covers all mentioned - currently broken - use cases as well and it's fully backward compatible.
   
   wdyt?



;17/Jul/25 18:45;githubbot;600","stoty commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2214120127


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -144,6 +145,33 @@ public SslContext createNettySslContextForServer(ZKConfig config, KeyManager key
         }
     }
 
+    private SslContextBuilder handleTcnativeOcspStapling(SslContextBuilder builder, ZKConfig config) {
+        SslProvider sslProvider = getSslProvider(config);
+        boolean tcnative = sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT;
+        boolean ocspEnabled = config.getBoolean(getSslOcspEnabledProperty());
+        TriState tcnativeOcspStapling = config.getTristate(getSslTcnativeOcspStaplingEnabledProperty());
+
+        if (tcnative && ocspEnabled && tcnativeOcspStapling.isDefault() && OpenSsl.isOcspSupported()) {
+            // Maintain old behaviour (mostly, we also check for OpenSsl.isOcspSupported())
+            builder.enableOcsp(ocspEnabled);
+        } else if (tcnativeOcspStapling.isTrue()) {
+            if (!tcnative) {
+                // Don't override the explicit setting, let it error out
+                LOG.error(""Trying to enable OpenSSL OCSP stapling for non-OpenSSL TLS provider. ""
+                        + ""This is going to fail. Please fix the TLS configuration"");
+            } else if (!OpenSsl.isOcspSupported()) {
+                LOG.warn(""Trying to enable OpenSSL OCSP stapling for OpenSSL provider {} which does not support it. ""
+                        + ""This is either going to be ignored or fail."", OpenSsl.versionString());
+            }
+            builder.enableOcsp(true);
+        } else if (tcnativeOcspStapling.isFalse()) {
+            // Disabling OCSP for the builder is always safe.
+            // This is the same as the builder default, effectively a noop.

Review Comment:
   Yes, it would fix the original issue.
   
   However we want to phase out the exisitng OCSP setting (at least for the client), as it relies on setting a JVM global system property. If we phase that out, there will still be a need to somehow set this property, and that's what the new property is for.
   
   If you prefer, we can remove the new property from this patch and it back in a follow-up patch that deals with the JVM globals.



;17/Jul/25 19:26;githubbot;600","anmolnar commented on code in PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#discussion_r2214421475


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -144,6 +145,33 @@ public SslContext createNettySslContextForServer(ZKConfig config, KeyManager key
         }
     }
 
+    private SslContextBuilder handleTcnativeOcspStapling(SslContextBuilder builder, ZKConfig config) {
+        SslProvider sslProvider = getSslProvider(config);
+        boolean tcnative = sslProvider == SslProvider.OPENSSL || sslProvider == SslProvider.OPENSSL_REFCNT;
+        boolean ocspEnabled = config.getBoolean(getSslOcspEnabledProperty());
+        TriState tcnativeOcspStapling = config.getTristate(getSslTcnativeOcspStaplingEnabledProperty());
+
+        if (tcnative && ocspEnabled && tcnativeOcspStapling.isDefault() && OpenSsl.isOcspSupported()) {
+            // Maintain old behaviour (mostly, we also check for OpenSsl.isOcspSupported())
+            builder.enableOcsp(ocspEnabled);
+        } else if (tcnativeOcspStapling.isTrue()) {
+            if (!tcnative) {
+                // Don't override the explicit setting, let it error out
+                LOG.error(""Trying to enable OpenSSL OCSP stapling for non-OpenSSL TLS provider. ""
+                        + ""This is going to fail. Please fix the TLS configuration"");
+            } else if (!OpenSsl.isOcspSupported()) {
+                LOG.warn(""Trying to enable OpenSSL OCSP stapling for OpenSSL provider {} which does not support it. ""
+                        + ""This is either going to be ignored or fail."", OpenSsl.versionString());
+            }
+            builder.enableOcsp(true);
+        } else if (tcnativeOcspStapling.isFalse()) {
+            // Disabling OCSP for the builder is always safe.
+            // This is the same as the builder default, effectively a noop.

Review Comment:
   Thanks, I prefer to go with smaller steps.
   
   I don't think you can get rid of the original property entirely, because there must be a way to set `pbParams.setRevocationEnabled(true)`, but we can discuss that in a different patch. 



;17/Jul/25 22:27;githubbot;600","anmolnar merged PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270


;18/Jul/25 14:15;githubbot;600","anmolnar commented on PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#issuecomment-3089627469

   Merged to master. `branch-3.9` and `branch-3.8` have conflicts, please create separate pull requests.


;18/Jul/25 14:16;githubbot;600","stoty commented on PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#issuecomment-3128085084

   Is 3.8 active ?
   My last patch was rejected from 3.8


;28/Jul/25 16:38;githubbot;600","stoty opened a new pull request, #2282:
URL: https://github.com/apache/zookeeper/pull/2282

   …ors out
   
   add docs
   add new property for tcnative OCSP setting
   rename property
   factor out the stapling handling code to a new method use and honor OpenSSL.isOcspSupported()
   Add more log messages
   Remove comments about BoringSSL not supporting OCSP stapling rearrange code to make patch smaller
   add comment for clarification
   remove new property
   Reviewers: anmolnar
   Author: stoty
   Closes #2270 from stoty/ZOOKEEPER-4940
   
   (cherry picked from commit 9d1d25cd75295b4529ce5348ba0cfce9ef4fefd7)


;28/Jul/25 16:45;githubbot;600","stoty commented on PR #2270:
URL: https://github.com/apache/zookeeper/pull/2270#issuecomment-3128124288

   3.8 doesn't have tcnative support, so this is not relevant there.
   
   I've opened #2282 for branch-3.9 @anmolnar .


;28/Jul/25 16:49;githubbot;600","anmolnar merged PR #2282:
URL: https://github.com/apache/zookeeper/pull/2282


;29/Jul/25 20:04;githubbot;600","anmolnar commented on PR #2282:
URL: https://github.com/apache/zookeeper/pull/2282#issuecomment-3133886173

   Merged and jira ticket has been resolved. Thanks @stoty !


;29/Jul/25 20:05;githubbot;600",,,,,,,,,0,23400,,,0,23400,,ZOOKEEPER-4949,,,,,ZOOKEEPER-4622,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Tue Jul 29 20:04:32 UTC 2025,,,,,,,,,,"0|z1wdlc:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"18/Jun/25 04:51;stoty;FYI [~andor];;;","18/Jun/25 18:33;andor;{quote}when _zookeeper.ssl.ocsp_ is set to true
{quote}
This sounds like a user error to me. Why do you want to set it if it's not supported by your runtime?;;;","19/Jun/25 05:21;stoty;No.
This happens if you set ocsp to true and use the JRE provider , which is totally supported by the runtime.

Setting the parameter causes the Tcnative provider to request a stapled OCSP response from the server.
The JRE provider has a system property for the same purpose, and no way to configure this on an Connection/SSLContext basis.

So Netty is kind of right by not accepting the parameter for JRE, but this is still a horrible API.

(And this still doesn't do anything unless you replace the default tcnative implementation used by ZK)
;;;","21/Jun/25 22:59;andor;Could you please share both the client and server configuration (config files and command line parameters) which is broken?

What if we just put this setting behind an SslProvider check and don't set it if SslProvider == JDK?;;;","21/Jun/25 23:10;andor;{quote}Setting the parameter causes the Tcnative provider to request a stapled OCSP response from the server.
{quote}
Really? We've never added OCSP stapling support to ZooKeeper. Based on the JDK documentation, it can be enabled on both client and server side by setting
{noformat}
jdk.tls.client.enableStatusRequestExtension=true
jdk.tls.server.enableStatusRequestExtension=true{noformat}
system properties, but ZooKeeper doesn't touch these. Therefore we only do CRL and client-side OCSP if revocation is enabled.

In which case we might not need to set it in SslContext at all. Have you found Netty's documentation of this property?;;;","21/Jun/25 23:19;andor;[Even better|https://netty.io/4.1/api/io/netty/handler/ssl/OpenSsl.html#isOcspSupported--]
{code:java}
if (OpenSsl.isOcspSupported()) {
    sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
} {code}
which will enable Ocsp stapling if set in the ZooKeeper configuration _and_ the provider supports it. For the JRE provider one must set it via the above mentioned properties. I'm not sure if we want to integrate that in ZooKeeper, though we already set some other system properties on the server side.;;;","07/Jul/25 13:11;stoty;I've just replied to the same issue on the PR.

jdk.tls.client.enableStatusRequestExtension=true
jdk.tls.server.enableStatusRequestExtension=true

works for the JRE TLS provider, while 

sslContextBuilder.enableOcsp() works for tcnative. (if supported)

The problem is that sslContextBuilder.enableOcsp() when the provider is JRE will just throw an exception, hence we need to check for the provider before calling it.

OpenSsl.isOcspSupported() only tells us if the native library loaded by tcnative supports it, but that's unrelated to whether we're using tcnative or the JRE provider.
i.e tcnative could have loaded an OpenSSL native library that supports OCSP, but if we set the JRE TLS provider for Netty, it still won't work.
;;;","29/Jul/25 20:04;andor;Issue resolved by pull request 2282
[https://github.com/apache/zookeeper/pull/2282];;;",,,,
Make ZookeeperServer.shutdown(fullyShutdown) Non-final fix curator's TestingZookeeperMain,ZOOKEEPER-4936,13620638,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Information Provided,,vinayakumarb,vinayakumarb,11/Jun/25 08:48,27/Jul/25 14:03,08/Dec/25 08:02,27/Jul/25 14:03,,,,,,,,,,,,,,,,0,pull-request-available,,,"Curator's [TestingZookeeperMain|https://github.com/apache/curator/blob/master/curator-test/src/main/java/org/apache/curator/test/TestingZooKeeperMain.java#L259] is used for integration testing in many projects.

It overrides {{Zookeeper#shutdown(fullyShutdown)}} to add additional logic. But recent change in this [commit|https://github.com/apache/zookeeper/commit/bc9afbf8ef1bc6156643d3d05c87fcf8411e9d8f] has made {{Zookeeper#shutdown(fullyShutdown)}} final.

Due to this 3.9.3 Zookeeper is unable to be used in TestingZooKeeperMain. Resulting in {quote}java.lang.VerifyError: class org.apache.curator.test.TestingZooKeeperMain$TestZooKeeperServer overrides final method org.apache.zookeeper.server.ZooKeeperServer.shutdown(Z)V{quote}",,"vinayakumarb opened a new pull request, #2267:
URL: https://github.com/apache/zookeeper/pull/2267

   (no comment)


;11/Jun/25 08:54;githubbot;600","ctubbsii commented on PR #2267:
URL: https://github.com/apache/zookeeper/pull/2267#issuecomment-2967244173

   The change seems simple enough, and beneficial, but do you know the justification for making it final in the first place? Will this introduce some regression because it fails to consider that original justification?


;12/Jun/25 15:13;githubbot;600","kezhuw closed pull request #2267: ZOOKEEPER-4936 - Make ZookeeperServer.shutdown(fullyShutdown) Non-final fix curator's TestingZookeeperMain
URL: https://github.com/apache/zookeeper/pull/2267


;27/Jul/25 14:02;githubbot;600","kezhuw commented on PR #2267:
URL: https://github.com/apache/zookeeper/pull/2267#issuecomment-3124438864

   Apache Curator 5.9.0 has been released. https://lists.apache.org/thread/70st1k9wpkg6fkxt2xymolkpqt25fp4r
   
   If anyone is using `ZookeeperServer` directly, I recommend they to migrate to:
   1. `void shutdownComponents()` to release extra resources.
   2. [ZooKeeperServerEmbedded](https://zookeeper.apache.org/doc/r3.9.3/apidocs/zookeeper-server/org/apache/zookeeper/server/embedded/ZooKeeperServerEmbedded.html) is designed for public usage.
   
   Thank you all for contribution and participation! I am going to close this.


;27/Jul/25 14:02;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2025-06-11 08:48:07.0,,,,,,,,,,"0|z1wa94:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Connection throttle exception causing all connections to be rejected,ZOOKEEPER-4933,13619525,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,damumu,damumu,damumu,29/May/25 10:01,29/Aug/25 21:29,08/Dec/25 08:02,05/Jun/25 01:05,,,,,,,,,3.10.0,3.8.5,3.9.4,server,,,,0,pull-request-available,,,"When there is no request for a long time, the diff may be very large, causing the refill value to become negative.

!image-2025-05-29-18-01-04-561.png!",,"damumu0625 opened a new pull request, #2264:
URL: https://github.com/apache/zookeeper/pull/2264

   When there is no request for a long time, the diff may be very large, causing the refill value to become negative. Then, all connections rejected


;29/May/25 10:10;githubbot;600","kezhuw commented on code in PR #2264:
URL: https://github.com/apache/zookeeper/pull/2264#discussion_r2113804414


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/BlueThrottle.java:
##########
@@ -323,6 +323,7 @@ public synchronized boolean checkLimit(int need) {
 
         long now = Time.currentElapsedTime();
         long diff = now - lastTime;
+        diff = Math.min((long) maxTokens * fillTime / fillCount, diff);

Review Comment:
   This confuses me in the first glance. I would prefer below code.
   
   ```java
   long refill = diff * fillCount / fillTime;
   tokens = (int) Math.min(tokens + refill, maxTokens);
   ```
   
   What are the configured values for these options to trigger the problem in your case ?
   
   I think above should be sufficient. If not, I think we could be more explict for overflow.
   
   ```
   if (tokens <= 0) {
       tokens = maxTokens;
   }
   ```
   ```



;29/May/25 12:00;githubbot;600","damumu0625 commented on code in PR #2264:
URL: https://github.com/apache/zookeeper/pull/2264#discussion_r2115605506


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/BlueThrottle.java:
##########
@@ -323,6 +323,7 @@ public synchronized boolean checkLimit(int need) {
 
         long now = Time.currentElapsedTime();
         long diff = now - lastTime;
+        diff = Math.min((long) maxTokens * fillTime / fillCount, diff);

Review Comment:
   fillCount is 3 and fillTime is 1，this case is triggered  when there is no request for more than 8 days.
   @kezhuw Please review it again, thank you.



;30/May/25 10:20;githubbot;600","kezhuw commented on code in PR #2264:
URL: https://github.com/apache/zookeeper/pull/2264#discussion_r2120001122


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/BlueThrottle.java:
##########
@@ -327,6 +327,9 @@ public synchronized boolean checkLimit(int need) {
         if (diff > fillTime) {
             int refill = (int) (diff * fillCount / fillTime);
             tokens = Math.min(tokens + refill, maxTokens);
+            if (tokens < 0) {
+                tokens = maxTokens;
+            }

Review Comment:
   ```suggestion
               long refill = diff * fillCount / fillTime;
               tokens = (int) Math.min(tokens + refill, maxTokens);
               if (tokens < 0) {
                   tokens = maxTokens;
                   LOG.error(""Throttle config values {}({}) and {}({}) are insane and cause long integer overflow after {}ms"",
                       CONNECTION_THROTTLE_FILL_TIME, fillTime, CONNECTION_THROTTLE_FILL_COUNT, fillCount, diff);
               }
   ```
   
   > fillCount is 3 and fillTime is 1，this case is triggered when there is no request for more than 8 days.
   
   In case of `long` and above settings, it will take 90 million years to overflow. Even for `fillCount 30000, filleTime 1`(which is insane) it takes 9 thousand years.
   
   So I think we could combine [the two methods](https://github.com/apache/zookeeper/pull/2264#discussion_r2113804414) together to solve both overflow and insane/incorrect configurations.



;02/Jun/25 04:13;githubbot;600","kezhuw commented on code in PR #2264:
URL: https://github.com/apache/zookeeper/pull/2264#discussion_r2120006191


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/BlueThrottle.java:
##########
@@ -327,6 +327,9 @@ public synchronized boolean checkLimit(int need) {
         if (diff > fillTime) {
             int refill = (int) (diff * fillCount / fillTime);
             tokens = Math.min(tokens + refill, maxTokens);
+            if (tokens < 0) {
+                tokens = maxTokens;
+            }

Review Comment:
   Anyway, we should not do milliseconds calaculation using `int`.



;02/Jun/25 04:16;githubbot;600","damumu0625 commented on code in PR #2264:
URL: https://github.com/apache/zookeeper/pull/2264#discussion_r2120947718


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/BlueThrottle.java:
##########
@@ -327,6 +327,9 @@ public synchronized boolean checkLimit(int need) {
         if (diff > fillTime) {
             int refill = (int) (diff * fillCount / fillTime);
             tokens = Math.min(tokens + refill, maxTokens);
+            if (tokens < 0) {
+                tokens = maxTokens;
+            }

Review Comment:
   Yes，I think so too.



;02/Jun/25 12:05;githubbot;600","kezhuw merged PR #2264:
URL: https://github.com/apache/zookeeper/pull/2264


;05/Jun/25 01:03;githubbot;600","kezhuw commented on PR #2264:
URL: https://github.com/apache/zookeeper/pull/2264#issuecomment-2942406659

   Merged. Thank you for contribution! @damumu0625 
   
   I mistakely drop the jira id in commit title in merging. Sorry for that! cc @tisonkun @li4wang @cnauroth @anmolnar @eolivelli 


;05/Jun/25 01:30;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,4800,,,0,4800,,,,,,,,,,,,,,,,,,,"29/May/25 09:59;damumu;image-2025-05-29-17-59-16-113.png;https://issues.apache.org/jira/secure/attachment/13076752/image-2025-05-29-17-59-16-113.png","29/May/25 10:01;damumu;image-2025-05-29-18-01-04-561.png;https://issues.apache.org/jira/secure/attachment/13076751/image-2025-05-29-18-01-04-561.png",,,,,2.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Thu Jun 05 01:05:24 UTC 2025,,,,,,,,,,"0|z1w3e0:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"05/Jun/25 01:05;kezhuw;Issue resolved by pull request 2264
[https://github.com/apache/zookeeper/pull/2264];;;",,,,,,,,,,,
The newest version of zookeeper includes Jetty versiob 9.4.57.x which has CVE-2024-6763 issue,ZOOKEEPER-4932,13618680,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,andor,satyapira,satyapira,20/May/25 14:59,29/Aug/25 21:29,08/Dec/25 08:12,25/Aug/25 22:01,,,,,,,,,3.10.0,3.9.4,,build,,,,0,pull-request-available,,,"Hi,

Can you please help me on below request.

The newest version of zookeeper includes Jetty version 9.4.57.x which has CVE-2024-6763 issue. When can the Jetty version will be upgraded to 12.0.12 or greater for zookeeper 3.9.4 or greater version


https://github.com/apache/zookeeper/blob/release-3.9.3-2/pom.xml#L563",,"anmolnar opened a new pull request, #2288:
URL: https://github.com/apache/zookeeper/pull/2288

   Based on [ZOOKEEPER-4876](https://issues.apache.org/jira/browse/ZOOKEEPER-4876) ZooKeeper is not affected by this CVE, but we have removed it from Owasp suppressions for some reason. Accidentally...?
   I put it back in this patch for all active branches.


;31/Jul/25 22:19;githubbot;600","kezhuw commented on PR #2288:
URL: https://github.com/apache/zookeeper/pull/2288#issuecomment-3141974992

   Hi @anmolnar, I think it is deleted by #2220 in bumping jetty to [`9.4.57.v20241219`](https://github.com/jetty/jetty.project/releases/tag/jetty-9.4.57.v20241219) which includes [patch](https://github.com/jetty/jetty.project/pull/12532) to fix CVE-2024-6763. 


;01/Aug/25 02:40;githubbot;600","anmolnar commented on PR #2288:
URL: https://github.com/apache/zookeeper/pull/2288#issuecomment-3144580090

   > Hi @anmolnar, I think it is deleted by #2220 in bumping jetty to [`9.4.57.v20241219`](https://github.com/jetty/jetty.project/releases/tag/jetty-9.4.57.v20241219) which includes [patch](https://github.com/jetty/jetty.project/pull/12532) to fix [CVE-2024-6763](https://github.com/advisories/GHSA-qh8g-58pp-2wxh).
   
   That's interesting. It was told that they're not backporting patches to EOL versions anymore and OWASP is still flagging the version.
   
   ```
   16:07:29  jetty-http-9.4.57.v20241219.jar (pkg:maven/org.eclipse.jetty/jetty-http@9.4.57.v20241219, cpe:2.3:a:eclipse:jetty:9.4.57:20241219:*:*:*:*:*:*, cpe:2.3:a:jetty:jetty:9.4.57:20241219:*:*:*:*:*:*, cpe:2.3:a:mortbay_jetty:jetty:9.4.57:20241219:*:*:*:*:*:*) : CVE-2024-6763
   ```


;01/Aug/25 13:22;githubbot;600","anmolnar commented on PR #2288:
URL: https://github.com/apache/zookeeper/pull/2288#issuecomment-3144584996

   I would still put this back to make Owasp happy regardless.


;01/Aug/25 13:23;githubbot;600","kezhuw commented on code in PR #2288:
URL: https://github.com/apache/zookeeper/pull/2288#discussion_r2248164943


##########
owaspSuppressions.xml:
##########
@@ -18,6 +18,11 @@
 -->
 
 <suppressions xmlns=""https://jeremylong.github.io/DependencyCheck/dependency-suppression.1.2.xsd"">
+   <suppress>
+      <!;01/Aug/25 14:51;githubbot;600","anmolnar commented on code in PR #2288:
URL: https://github.com/apache/zookeeper/pull/2288#discussion_r2248466613


##########
owaspSuppressions.xml:
##########
@@ -18,6 +18,11 @@
 -->
 
 <suppressions xmlns=""https://jeremylong.github.io/DependencyCheck/dependency-suppression.1.2.xsd"">
+   <suppress>
+      <!;01/Aug/25 17:09;githubbot;600","kezhuw commented on code in PR #2288:
URL: https://github.com/apache/zookeeper/pull/2288#discussion_r2248712696


##########
owaspSuppressions.xml:
##########
@@ -18,6 +18,11 @@
 -->
 
 <suppressions xmlns=""https://jeremylong.github.io/DependencyCheck/dependency-suppression.1.2.xsd"">
+   <suppress>
+      <!;01/Aug/25 19:20;githubbot;600","kezhuw commented on code in PR #2288:
URL: https://github.com/apache/zookeeper/pull/2288#discussion_r2248712696


##########
owaspSuppressions.xml:
##########
@@ -18,6 +18,11 @@
 -->
 
 <suppressions xmlns=""https://jeremylong.github.io/DependencyCheck/dependency-suppression.1.2.xsd"">
+   <suppress>
+      <!;01/Aug/25 19:22;githubbot;600","anmolnar commented on PR #2288:
URL: https://github.com/apache/zookeeper/pull/2288#issuecomment-3145686718

   Thanks @kezhuw . I'm trying to upgrade Jetty to latest stable version 12.0.23 at the same time which doesn't seem to be impossible at first glance. Maybe we could work on it in a separate ticket.


;01/Aug/25 20:25;githubbot;600","anmolnar merged PR #2288:
URL: https://github.com/apache/zookeeper/pull/2288


;01/Aug/25 21:35;githubbot;600","anmolnar commented on PR #2288:
URL: https://github.com/apache/zookeeper/pull/2288#issuecomment-3145841395

   > Thanks @kezhuw . I'm trying to upgrade Jetty to latest stable version 12.0.23 at the same time which doesn't seem to be impossible at first glance. Maybe we could work on it in a separate ticket.
   
   We already have a ticket for that: [ZOOKEEPER-4931](https://issues.apache.org/jira/browse/ZOOKEEPER-4931)
   Unfortunately Jetty 12 requires Java 17.


;01/Aug/25 21:39;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,6600,,,0,6600,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Thu Jul 31 22:16:04 UTC 2025,,,,,,,,,,"0|z1vy60:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"31/Jul/25 22:16;andor;According to ZOOKEEPER-4876 ZooKeeper is not vulnerable to CVE-2024-6763, but looks like we accidentally removed it from Owasp suppressions.

Let me put it back with this ticket.

We cannot upgrade to the latest version of Jetty, because it doesn't support Java 8 anymore.

cc [~eolivelli] [~kezhuw] ;;;",,,,,,,,,,,
Make c client side cert optional in connecting to tls server,ZOOKEEPER-4929,13617801,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,eseabrook1,kezhuw,kezhuw,12/May/25 07:50,21/Aug/25 15:19,08/Dec/25 08:02,18/Aug/25 18:42,3.9.3,,,,,,,,3.10.0,,,c client,,,,0,pull-request-available,,,"Created for [https://github.com/apache/zookeeper/pull/2257]

Currently, client side cert is mandatory to connect to tls server.",,"zeekling commented on code in PR #2257:
URL: https://github.com/apache/zookeeper/pull/2257#discussion_r2120043028


##########
zookeeper-client/zookeeper-client-c/src/zookeeper.c:
##########
@@ -2769,27 +2769,30 @@ static int init_ssl_for_socket(zsock_t *fd, zhandle_t *zh, int fail_on_error) {
             errno = EINVAL;
             return ZBADARGUMENTS;
         }
-        /*CLIENT CA FILE (With Certificate Chain)*/
-        if (SSL_CTX_use_certificate_chain_file(*ctx, fd->cert->cert) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""Failed to load client certificate chain from %s"", fd->cert->cert);
-            errno = EINVAL;
-            return ZBADARGUMENTS;
-        }
-        /*CLIENT PRIVATE KEY*/
-        SSL_CTX_set_default_passwd_cb_userdata(*ctx, fd->cert->passwd);
-        if (SSL_CTX_use_PrivateKey_file(*ctx, fd->cert->key, SSL_FILETYPE_PEM) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""Failed to load client private key from %s"", fd->cert->key);
-            errno = EINVAL;
-            return ZBADARGUMENTS;
-        }
-        /*CHECK*/
-        if (SSL_CTX_check_private_key(*ctx) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""SSL_CTX_check_private_key failed"");
-            errno = EINVAL;
-            return ZBADARGUMENTS;
+        if (fd->cert->cert != NULL && fd->cert->passwd != NULL && fd->cert->key != NULL)

Review Comment:
   maybe need   `SSL_CTX_set_verify(ssl_ctx, SSL_VERIFY_NONE, NULL);` in client when skip cert.
   



;02/Jun/25 04:55;githubbot;600","eseabrook1 commented on code in PR #2257:
URL: https://github.com/apache/zookeeper/pull/2257#discussion_r2120757755


##########
zookeeper-client/zookeeper-client-c/src/zookeeper.c:
##########
@@ -2769,27 +2769,30 @@ static int init_ssl_for_socket(zsock_t *fd, zhandle_t *zh, int fail_on_error) {
             errno = EINVAL;
             return ZBADARGUMENTS;
         }
-        /*CLIENT CA FILE (With Certificate Chain)*/
-        if (SSL_CTX_use_certificate_chain_file(*ctx, fd->cert->cert) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""Failed to load client certificate chain from %s"", fd->cert->cert);
-            errno = EINVAL;
-            return ZBADARGUMENTS;
-        }
-        /*CLIENT PRIVATE KEY*/
-        SSL_CTX_set_default_passwd_cb_userdata(*ctx, fd->cert->passwd);
-        if (SSL_CTX_use_PrivateKey_file(*ctx, fd->cert->key, SSL_FILETYPE_PEM) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""Failed to load client private key from %s"", fd->cert->key);
-            errno = EINVAL;
-            return ZBADARGUMENTS;
-        }
-        /*CHECK*/
-        if (SSL_CTX_check_private_key(*ctx) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""SSL_CTX_check_private_key failed"");
-            errno = EINVAL;
-            return ZBADARGUMENTS;
+        if (fd->cert->cert != NULL && fd->cert->passwd != NULL && fd->cert->key != NULL)

Review Comment:
   I am not particularly familiar with the SSL APIs, but my assumption was that we would be in client mode, and still want to validate the server certificate so the existing settings are still correct. We only want the TLS handshake to continue if ths server certificate is valid
   
   https://docs.openssl.org/master/man3/SSL_CTX_set_verify/



;02/Jun/25 10:43;githubbot;600","kezhuw commented on code in PR #2257:
URL: https://github.com/apache/zookeeper/pull/2257#discussion_r2121477728


##########
zookeeper-client/zookeeper-client-c/src/zookeeper.c:
##########
@@ -2769,27 +2769,30 @@ static int init_ssl_for_socket(zsock_t *fd, zhandle_t *zh, int fail_on_error) {
             errno = EINVAL;
             return ZBADARGUMENTS;
         }
-        /*CLIENT CA FILE (With Certificate Chain)*/
-        if (SSL_CTX_use_certificate_chain_file(*ctx, fd->cert->cert) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""Failed to load client certificate chain from %s"", fd->cert->cert);
-            errno = EINVAL;
-            return ZBADARGUMENTS;
-        }
-        /*CLIENT PRIVATE KEY*/
-        SSL_CTX_set_default_passwd_cb_userdata(*ctx, fd->cert->passwd);
-        if (SSL_CTX_use_PrivateKey_file(*ctx, fd->cert->key, SSL_FILETYPE_PEM) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""Failed to load client private key from %s"", fd->cert->key);
-            errno = EINVAL;
-            return ZBADARGUMENTS;
-        }
-        /*CHECK*/
-        if (SSL_CTX_check_private_key(*ctx) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""SSL_CTX_check_private_key failed"");
-            errno = EINVAL;
-            return ZBADARGUMENTS;
+        if (fd->cert->cert != NULL && fd->cert->passwd != NULL && fd->cert->key != NULL)

Review Comment:
   Sounds like a server side option `ssl.clientAuth`.
   
   I plan to construct a test for this pr.



;02/Jun/25 15:17;githubbot;600","kezhuw commented on code in PR #2257:
URL: https://github.com/apache/zookeeper/pull/2257#discussion_r2123355809


##########
zookeeper-client/zookeeper-client-c/src/zookeeper.c:
##########
@@ -2769,27 +2769,30 @@ static int init_ssl_for_socket(zsock_t *fd, zhandle_t *zh, int fail_on_error) {
             errno = EINVAL;
             return ZBADARGUMENTS;
         }
-        /*CLIENT CA FILE (With Certificate Chain)*/
-        if (SSL_CTX_use_certificate_chain_file(*ctx, fd->cert->cert) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""Failed to load client certificate chain from %s"", fd->cert->cert);
-            errno = EINVAL;
-            return ZBADARGUMENTS;
-        }
-        /*CLIENT PRIVATE KEY*/
-        SSL_CTX_set_default_passwd_cb_userdata(*ctx, fd->cert->passwd);
-        if (SSL_CTX_use_PrivateKey_file(*ctx, fd->cert->key, SSL_FILETYPE_PEM) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""Failed to load client private key from %s"", fd->cert->key);
-            errno = EINVAL;
-            return ZBADARGUMENTS;
-        }
-        /*CHECK*/
-        if (SSL_CTX_check_private_key(*ctx) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""SSL_CTX_check_private_key failed"");
-            errno = EINVAL;
-            return ZBADARGUMENTS;
+        if (fd->cert->cert != NULL && fd->cert->passwd != NULL && fd->cert->key != NULL)

Review Comment:
   Hi @eseabrook1, I created eseabrook1/zookeeper#1 to add test case for this pr. Would you mind take a look ? This pr will be updated automatically once your merged that pr.



;03/Jun/25 10:08;githubbot;600","kezhuw commented on code in PR #2257:
URL: https://github.com/apache/zookeeper/pull/2257#discussion_r2123355809


##########
zookeeper-client/zookeeper-client-c/src/zookeeper.c:
##########
@@ -2769,27 +2769,30 @@ static int init_ssl_for_socket(zsock_t *fd, zhandle_t *zh, int fail_on_error) {
             errno = EINVAL;
             return ZBADARGUMENTS;
         }
-        /*CLIENT CA FILE (With Certificate Chain)*/
-        if (SSL_CTX_use_certificate_chain_file(*ctx, fd->cert->cert) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""Failed to load client certificate chain from %s"", fd->cert->cert);
-            errno = EINVAL;
-            return ZBADARGUMENTS;
-        }
-        /*CLIENT PRIVATE KEY*/
-        SSL_CTX_set_default_passwd_cb_userdata(*ctx, fd->cert->passwd);
-        if (SSL_CTX_use_PrivateKey_file(*ctx, fd->cert->key, SSL_FILETYPE_PEM) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""Failed to load client private key from %s"", fd->cert->key);
-            errno = EINVAL;
-            return ZBADARGUMENTS;
-        }
-        /*CHECK*/
-        if (SSL_CTX_check_private_key(*ctx) != 1) {
-            SSL_CTX_free(*ctx);
-            LOG_ERROR(LOGCALLBACK(zh), ""SSL_CTX_check_private_key failed"");
-            errno = EINVAL;
-            return ZBADARGUMENTS;
+        if (fd->cert->cert != NULL && fd->cert->passwd != NULL && fd->cert->key != NULL)

Review Comment:
   Hi @eseabrook1, I created eseabrook1/zookeeper#1 to add test case for this pr. Would you mind take a look ? This pr will be updated automatically once you merged that pr.



;03/Jun/25 11:42;githubbot;600","kezhuw commented on PR #2257:
URL: https://github.com/apache/zookeeper/pull/2257#issuecomment-3114428512

   Hi, @ztzg @anmolnar @symat @cnauroth  does anyone want to take another look ? 


;24/Jul/25 18:25;githubbot;600","kezhuw merged PR #2257:
URL: https://github.com/apache/zookeeper/pull/2257


;18/Aug/25 18:41;githubbot;600","kezhuw commented on PR #2257:
URL: https://github.com/apache/zookeeper/pull/2257#issuecomment-3198023234

   Merged this as it has been exposed for a long time and I have constructed test for this.
   
   @eseabrook1 Thank you for your contribution! Do you have a jira id so I have assign ZOOKEEPER-4929 to you ? If not, I think you could follow the link to register one. You probably will guide to sending account approval mail finally those days, please add link to this pr/jira so pmc know your contribution.


;18/Aug/25 18:47;githubbot;600","eseabrook1 commented on PR #2257:
URL: https://github.com/apache/zookeeper/pull/2257#issuecomment-3211062613

   I just created this account https://issues.apache.org/jira/secure/ViewProfile.jspa?name=eseabrook1


;21/Aug/25 15:15;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,5400,,,0,5400,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Mon Aug 18 18:42:13 UTC 2025,,,,,,,,,,"0|z1vsqo:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"18/Aug/25 18:42;kezhuw;master commit: d7f9717adf46addb582c0e0d90bf03a6ac6666af;;;",,,,,,,,,,,
Version in zookeeper_version.h is not updated,ZOOKEEPER-4928,13617750,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,kezhuw,kezhuw,kezhuw,11/May/25 03:00,29/Aug/25 21:29,08/Dec/25 08:12,12/May/25 01:23,3.9.3,,,,,,,,3.10.0,3.8.5,3.9.4,build,,,,0,pull-request-available,,,"[~ctubbsii] pointed out this in https://github.com/apache/zookeeper/pull/2241.

I confirmed this in https://github.com/apache/zookeeper/blob/release-3.9.4-0/zookeeper-client/zookeeper-client-c/include/zookeeper_version.h

cc [~Tison]",,"kezhuw opened a new pull request, #2259:
URL: https://github.com/apache/zookeeper/pull/2259

   (no comment)


;11/May/25 14:39;githubbot;600","kezhuw commented on PR #2259:
URL: https://github.com/apache/zookeeper/pull/2259#issuecomment-2869905675

   I verified this using `mvn release:prepare -Pfull-build` according to https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToRelease+using+maven+release+plugin.


;11/May/25 14:40;githubbot;600","kezhuw merged PR #2259:
URL: https://github.com/apache/zookeeper/pull/2259


;12/May/25 01:23;githubbot;600","kezhuw commented on PR #2259:
URL: https://github.com/apache/zookeeper/pull/2259#issuecomment-2870485055

   Thank you for reviewing!
   
   I have merged and backported this to master, branch-3.9(adc8744a0f3d395aa02ec75d99d7c0a7f8dbcbf0 with ZOO_VERSION in zookeeper_version.h bumped) and branch-3.8(56cc908c88658173b092f3ffb1d794cb268bf6bf).
   
   @tisonkun I marked ZOOKEEPER-4928 also fixed in 3.9.4 as it supposed to be included in that version. I planed to create a pr for branch-3.9.4, but it is versioned as 3.9.5-SNAPSHOT currently. I am going to leave 3.9.4 backport to you so to avoid conflict.
   
   


;12/May/25 01:47;githubbot;600","kezhuw commented on PR #2259:
URL: https://github.com/apache/zookeeper/pull/2259#issuecomment-2942397554

   I have moved the fixVersion from 3.9.4 to 3.9.5 to reflect the backport facts for now. cc @tisonkun 


;05/Jun/25 01:22;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3000,,,0,3000,,,,,,,ZOOKEEPER-3635,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Mon May 12 01:23:48 UTC 2025,,,,,,,,,,"0|z1vsfc:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"11/May/25 07:53;kezhuw;I am not sure how release manager update versions in c client, but seems that [replace-cclient-files-during-release|https://github.com/apache/zookeeper/blob/2aaeff840e8e5b61a30530b261b8c05c181d078f/zookeeper-client/zookeeper-client-c/pom.xml#L119] was skipped long time ago in ZOOKEEPER-3226([pr-758|https://github.com/apache/zookeeper/pull/758/files#diff-c0941f37053212308258c9f1382b7ab811ecf40ad05a3c4d683b3d5e0829f4e6L33]).;;;","11/May/25 14:38;kezhuw;Found https://cwiki.apache.org/confluence/display/ZOOKEEPER/HowToRelease+using+maven+release+plugin.

Profile {{full-build}} is needed to generate versions for c client.;;;","12/May/25 01:23;kezhuw;Issue resolved by pull request 2259
[https://github.com/apache/zookeeper/pull/2259];;;",,,,,,,,,
Diff sync introduce hole in stale follower's committedLog which cause data loss in leading,ZOOKEEPER-4925,13616749,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Critical,Fixed,kezhuw,kezhuw,kezhuw,30/Apr/25 02:21,29/Aug/25 21:29,08/Dec/25 08:12,10/Jun/25 17:41,3.9.3,,,,,,,,3.10.0,3.9.4,,server,,,,0,data-loss,pull-request-available,,"There are two variants of {{ZooKeeperServer::processTxn}}. Those two variants diverge in behavior since ZOOKEEPER-3484. {{processTxn(Request request)}} pops outstanding change from {{outstandingChanges}} and adds txn to {{committedLog}} for follower to sync in addition to what {{processTxn(TxnHeader hdr, Record txn)}} does. The {{Learner}} uses {{processTxn(TxnHeader hdr, Record txn)}} to commit txn to memory after ZOOKEEPER-4394, which means it leaves {{committedLog}} untouched in {{SYNCHRONIZATION}} phase.

In above case, a stale follower will have hole in its {{committedLog}} after joining cluster. The stale follower will propagate the in memory hole to other stale nodes after becoming leader. This causes data loss.
",,"kezhuw opened a new pull request, #2254:
URL: https://github.com/apache/zookeeper/pull/2254

   There are two variants of `ZooKeeperServer::processTxn`. Those two variants diverge significantly since ZOOKEEPER-3484. `processTxn(Request request)` pops outstanding change from `outstandingChanges` and adds txn to `committedLog` for follower to sync in addition to what `processTxn(TxnHeader hdr, Record txn)` does. The `Learner` uses `processTxn(TxnHeader hdr, Record txn)` to commit txn to memory after ZOOKEEPER-4394, which means it leaves `committedLog` untouched in `SYNCHRONIZATION` phase.
   
   This way, a stale follower will have hole in its `committedLog` after joining cluster. The stale follower will propagate the in memory hole to other stale nodes after becoming leader. This causes data loss.
   
   The test case fails on master and 3.9.3, and passes on 3.9.2. So only 3.9.3 is affected.
   
   This commit drops `processTxn(TxnHeader hdr, Record txn)` as `processTxn(Request request)` is capable in `SYNCHRONIZATION` phase too.
   
   Also, this commit rejects discontinuous proposals in `syncWithLeader` and `committedLog`, so to avoid possible data loss.
   
   Refs: ZOOKEEPER-4925, ZOOKEEPER-4394, ZOOKEEPER-3484


;04/May/25 12:27;githubbot;600","li4wang commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2121930956


##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/QuorumSyncTest.java:
##########
@@ -0,0 +1,100 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.server.quorum;
+
+import static org.junit.jupiter.api.Assertions.assertNotNull;
+import java.util.Comparator;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.test.ClientBase;
+import org.apache.zookeeper.test.QuorumUtil;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.Test;
+
+public class QuorumSyncTest extends ZKTestCase {
+    private QuorumUtil qu;
+
+    @AfterEach
+    public void tearDown() throws Exception {
+        if (qu != null) {
+            qu.shutdownAll();
+        }
+    }
+
+    @Test
+    public void testStaleDiffSync() throws Exception {
+        qu = new QuorumUtil(2);
+        qu.startAll();
+
+        int[] followerIds = qu.getFollowerQuorumPeers()
+            .stream()
+            .sorted(Comparator.comparingLong(QuorumPeer::getMyId).reversed())
+            .mapToInt(peer -> (int) peer.getMyId()).toArray();
+
+        int follower1 = followerIds[0];
+        int follower2 = followerIds[1];
+
+        String leaderConnectString = qu.getConnectString(qu.getLeaderQuorumPeer());
+        try (ZooKeeper zk = ClientBase.createZKClient(leaderConnectString)) {
+            qu.shutdown(follower2);
+
+            for (int i = 0; i < 10; i++) {
+                zk.create(""/foo"" + i, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
+            }
+
+            qu.shutdown(follower1);
+
+            for (int i = 0; i < 10; i++) {
+                zk.create(""/bar"" + i, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
+            }
+
+            qu.restart(follower1);
+        }
+
+        try (ZooKeeper zk = ClientBase.createZKClient(qu.getConnectionStringForServer(follower1))) {
+            for (int i = 0; i < 10; i++) {
+                String path = ""/foo"" + i;
+                assertNotNull(zk.exists(path, false), path + "" not found"");
+            }
+
+            for (int i = 0; i < 10; i++) {

Review Comment:
   How about adding the JIRA ticket to help people understand the issue and fix? Basically all the /boo related txns are  synced via DIFF and added to the committed logs with the fix.



;02/Jun/25 18:55;githubbot;600","li4wang commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2121953646


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:
##########
@@ -780,8 +803,8 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {
                                 continue;
                             }
                             packetsNotLogged.removeFirst();
-                            fzk.appendRequest(pif.hdr, pif.rec, pif.digest);
-                            fzk.processTxn(pif.hdr, pif.rec);
+                            fzk.appendRequest(pif.toRequest());
+                            fzk.processTxn(pif.toRequest());

Review Comment:
   nitpick
   
   
   
   ```suggestion
   Request request = pif.toRequest()
   fzk.appendRequest(request)
   fzk.processTxn（request)
   ```
   
   



;02/Jun/25 19:09;githubbot;600","li4wang commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2121953646


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:
##########
@@ -780,8 +803,8 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {
                                 continue;
                             }
                             packetsNotLogged.removeFirst();
-                            fzk.appendRequest(pif.hdr, pif.rec, pif.digest);
-                            fzk.processTxn(pif.hdr, pif.rec);
+                            fzk.appendRequest(pif.toRequest());
+                            fzk.processTxn(pif.toRequest());

Review Comment:
   nitpick
   
   How about create the request object and reuse it instead of converting twice?
   
   ```
   Request request = pif.toRequest()
   fzk.appendRequest(request)
   fzk.processTxn（request)
   
   ```



;02/Jun/25 19:11;githubbot;600","li4wang commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2121976783


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:
##########
@@ -696,18 +710,27 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {
                         packet.rec = logEntry.getTxn();
                         packet.hdr = logEntry.getHeader();
                         packet.digest = logEntry.getDigest();
-                        // Log warning message if txn comes out-of-order
-                        if (packet.hdr.getZxid() != lastQueued + 1) {
-                            LOG.warn(
-                                ""Got zxid 0x{} expected 0x{}"",
-                                Long.toHexString(packet.hdr.getZxid()),
-                                Long.toHexString(lastQueued + 1));
+                        if (lastQueued == 0) {
+                            LOG.info(""DIFF sync got first proposal 0x{}"", Long.toHexString(packet.hdr.getZxid()));
+                        } else if (packet.hdr.getZxid() != lastQueued + 1) {
+                            if (ZxidUtils.getEpochFromZxid(packet.hdr.getZxid()) <= ZxidUtils.getEpochFromZxid(lastQueued)) {
+                                String msg = String.format(""DIFF sync got proposal 0x%s which is not next of last proposal 0x%s"",
+                                    Long.toHexString(packet.hdr.getZxid()),
+                                    Long.toHexString(lastQueued));
+                                LOG.error(msg);
+                                throw new Exception(msg);
+                            }
+                            // We can't tell whether it is a data loss. Given that new epoch is rare,
+                            // log at warn should not be too verbose.
+                            LOG.warn(""DIFF sync got new epoch proposal 0x{}, last proposal 0x{}"",
+                                    Long.toHexString(packet.hdr.getZxid()),
+                                    Long.toHexString(lastQueued));

Review Comment:
   This is the same code as line 637-651. How about creating a common method to check if proposal is out of order so it can be used in both places?



;02/Jun/25 19:23;githubbot;600","li4wang commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2121999705


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:
##########
@@ -630,11 +634,21 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {
                     pif.hdr = logEntry.getHeader();
                     pif.rec = logEntry.getTxn();
                     pif.digest = logEntry.getDigest();
-                    if (pif.hdr.getZxid() != lastQueued + 1) {
-                        LOG.warn(
-                            ""Got zxid 0x{} expected 0x{}"",
+                    if (lastQueued == 0) {
+                        LOG.info(""DIFF sync got first proposal 0x{}"", Long.toHexString(pif.hdr.getZxid()));
+                    } else if (pif.hdr.getZxid() != lastQueued + 1) {
+                        if (ZxidUtils.getEpochFromZxid(pif.hdr.getZxid()) <= ZxidUtils.getEpochFromZxid(lastQueued)) {
+                            String msg = String.format(""DIFF sync got proposal 0x%s which is not next of last proposal 0x%s"",
+                                Long.toHexString(pif.hdr.getZxid()),
+                                Long.toHexString(lastQueued));
+                            LOG.error(msg);
+                            throw new Exception(msg);
+                        }
+                        // We can't tell whether it is a data loss. Given that new epoch is rare,
+                        // log at warn should not be too verbose.
+                        LOG.warn(""DIFF sync got new epoch proposal 0x{}, last proposal 0x{}"",

Review Comment:
   How about  keeping the original WARN statement, so it's very clear what is the actual, what is the expected?



;02/Jun/25 19:34;githubbot;600","li4wang commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2121999705


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:
##########
@@ -630,11 +634,21 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {
                     pif.hdr = logEntry.getHeader();
                     pif.rec = logEntry.getTxn();
                     pif.digest = logEntry.getDigest();
-                    if (pif.hdr.getZxid() != lastQueued + 1) {
-                        LOG.warn(
-                            ""Got zxid 0x{} expected 0x{}"",
+                    if (lastQueued == 0) {
+                        LOG.info(""DIFF sync got first proposal 0x{}"", Long.toHexString(pif.hdr.getZxid()));
+                    } else if (pif.hdr.getZxid() != lastQueued + 1) {
+                        if (ZxidUtils.getEpochFromZxid(pif.hdr.getZxid()) <= ZxidUtils.getEpochFromZxid(lastQueued)) {
+                            String msg = String.format(""DIFF sync got proposal 0x%s which is not next of last proposal 0x%s"",
+                                Long.toHexString(pif.hdr.getZxid()),
+                                Long.toHexString(lastQueued));
+                            LOG.error(msg);
+                            throw new Exception(msg);
+                        }
+                        // We can't tell whether it is a data loss. Given that new epoch is rare,
+                        // log at warn should not be too verbose.
+                        LOG.warn(""DIFF sync got new epoch proposal 0x{}, last proposal 0x{}"",

Review Comment:
   How about  keeping the original WARN statement, so it's very clear what is the actual and what is the expected?



;02/Jun/25 19:35;githubbot;600","li4wang commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122040634


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/ZKDatabase.java:
##########
@@ -320,17 +323,30 @@ public void addCommittedProposal(Request request) {
         WriteLock wl = logLock.writeLock();
         try {
             wl.lock();
-            if (committedLog.size() > commitLogCount) {
-                committedLog.remove();
-                minCommittedLog = committedLog.peek().getZxid();
-            }
             if (committedLog.isEmpty()) {
                 minCommittedLog = request.zxid;
                 maxCommittedLog = request.zxid;
+            } else if (request.zxid <= maxCommittedLog) {
+                // This could happen if lastProcessedZxid is rewinded and database is re-synced.
+                // Currently, it only happens in test codes, but it should also be safe for production path.
+                return;
+            } else if (!allowDiscontinuousProposals
+                    && request.zxid != maxCommittedLog + 1
+                    && ZxidUtils.getEpochFromZxid(request.zxid) <= ZxidUtils.getEpochFromZxid(maxCommittedLog)) {
+                String msg = String.format(
+                    ""Committed proposal cached out of order: 0x%s is not the next proposal of 0x%s"",
+                    ZxidUtils.zxidToString(request.zxid),
+                    ZxidUtils.zxidToString(maxCommittedLog));
+                LOG.error(msg);
+                throw new IllegalStateException(msg);

Review Comment:
   Do we have a test case for it?



;02/Jun/25 19:59;githubbot;600","li4wang commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122042468


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/ZKDatabase.java:
##########
@@ -320,17 +323,30 @@ public void addCommittedProposal(Request request) {
         WriteLock wl = logLock.writeLock();
         try {
             wl.lock();
-            if (committedLog.size() > commitLogCount) {
-                committedLog.remove();
-                minCommittedLog = committedLog.peek().getZxid();
-            }
             if (committedLog.isEmpty()) {
                 minCommittedLog = request.zxid;
                 maxCommittedLog = request.zxid;
+            } else if (request.zxid <= maxCommittedLog) {
+                // This could happen if lastProcessedZxid is rewinded and database is re-synced.
+                // Currently, it only happens in test codes, but it should also be safe for production path.

Review Comment:
   Adding a test case for the scenario?



;02/Jun/25 20:00;githubbot;600","li4wang commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122042468


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/ZKDatabase.java:
##########
@@ -320,17 +323,30 @@ public void addCommittedProposal(Request request) {
         WriteLock wl = logLock.writeLock();
         try {
             wl.lock();
-            if (committedLog.size() > commitLogCount) {
-                committedLog.remove();
-                minCommittedLog = committedLog.peek().getZxid();
-            }
             if (committedLog.isEmpty()) {
                 minCommittedLog = request.zxid;
                 maxCommittedLog = request.zxid;
+            } else if (request.zxid <= maxCommittedLog) {
+                // This could happen if lastProcessedZxid is rewinded and database is re-synced.
+                // Currently, it only happens in test codes, but it should also be safe for production path.

Review Comment:
   How about adding a test case for the scenario?



;02/Jun/25 20:04;githubbot;600","li4wang commented on PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#issuecomment-2932370939

   The changes for fixing the data loss issue looks good. It's a very critical issue. Thanks for fixing it.
   
   The changes for blocking proposal and commit requests being out of order looks good in general, but please make sure it doesn't introduce any unexpected issue.


;02/Jun/25 20:27;githubbot;600","kezhuw commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122561575


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/ZKDatabase.java:
##########
@@ -320,17 +323,30 @@ public void addCommittedProposal(Request request) {
         WriteLock wl = logLock.writeLock();
         try {
             wl.lock();
-            if (committedLog.size() > commitLogCount) {
-                committedLog.remove();
-                minCommittedLog = committedLog.peek().getZxid();
-            }
             if (committedLog.isEmpty()) {
                 minCommittedLog = request.zxid;
                 maxCommittedLog = request.zxid;
+            } else if (request.zxid <= maxCommittedLog) {
+                // This could happen if lastProcessedZxid is rewinded and database is re-synced.
+                // Currently, it only happens in test codes, but it should also be safe for production path.

Review Comment:
   `LoadFromLogTest::testRestore` fails without this. Here is the javadoc of the test.
   
   ```java
       /**
        * Test we can restore the snapshot that has data ahead of the zxid
        * of the snapshot file.
        */
   ```
   
   https://github.com/apache/zookeeper/blob/aeadf574c0463e7e3db092b588033d8347989d4c/zookeeper-server/src/test/java/org/apache/zookeeper/test/LoadFromLogTest.java#L178-L182



;03/Jun/25 03:28;githubbot;600","kezhuw commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122595721


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/ZKDatabase.java:
##########
@@ -320,17 +323,30 @@ public void addCommittedProposal(Request request) {
         WriteLock wl = logLock.writeLock();
         try {
             wl.lock();
-            if (committedLog.size() > commitLogCount) {
-                committedLog.remove();
-                minCommittedLog = committedLog.peek().getZxid();
-            }
             if (committedLog.isEmpty()) {
                 minCommittedLog = request.zxid;
                 maxCommittedLog = request.zxid;
+            } else if (request.zxid <= maxCommittedLog) {
+                // This could happen if lastProcessedZxid is rewinded and database is re-synced.
+                // Currently, it only happens in test codes, but it should also be safe for production path.
+                return;
+            } else if (!allowDiscontinuousProposals
+                    && request.zxid != maxCommittedLog + 1
+                    && ZxidUtils.getEpochFromZxid(request.zxid) <= ZxidUtils.getEpochFromZxid(maxCommittedLog)) {
+                String msg = String.format(
+                    ""Committed proposal cached out of order: 0x%s is not the next proposal of 0x%s"",
+                    ZxidUtils.zxidToString(request.zxid),
+                    ZxidUtils.zxidToString(maxCommittedLog));
+                LOG.error(msg);
+                throw new IllegalStateException(msg);

Review Comment:
   I think it is already covered by existing tests. `allowDiscontinuousProposals`(used by `ZxidRolloverTest`, `TxnLogDigestTest`, both introduce discontinuous proposals on purpose) was introduced to bypass this restriction.
   
   Also this path will fail newly introduced test if we rollback changes involed in sync phase.
   
   ```bash
   git checkout HEAD^ ;03/Jun/25 03:58;githubbot;600","kezhuw commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122629733


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:
##########
@@ -630,11 +634,21 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {
                     pif.hdr = logEntry.getHeader();
                     pif.rec = logEntry.getTxn();
                     pif.digest = logEntry.getDigest();
-                    if (pif.hdr.getZxid() != lastQueued + 1) {
-                        LOG.warn(
-                            ""Got zxid 0x{} expected 0x{}"",
+                    if (lastQueued == 0) {
+                        LOG.info(""DIFF sync got first proposal 0x{}"", Long.toHexString(pif.hdr.getZxid()));
+                    } else if (pif.hdr.getZxid() != lastQueued + 1) {
+                        if (ZxidUtils.getEpochFromZxid(pif.hdr.getZxid()) <= ZxidUtils.getEpochFromZxid(lastQueued)) {
+                            String msg = String.format(""DIFF sync got proposal 0x%s which is not next of last proposal 0x%s"",
+                                Long.toHexString(pif.hdr.getZxid()),
+                                Long.toHexString(lastQueued));
+                            LOG.error(msg);
+                            throw new Exception(msg);
+                        }
+                        // We can't tell whether it is a data loss. Given that new epoch is rare,
+                        // log at warn should not be too verbose.
+                        LOG.warn(""DIFF sync got new epoch proposal 0x{}, last proposal 0x{}"",

Review Comment:
   Add expected zxid in newly introduced method `enforceContinuousProposal`.



;03/Jun/25 04:31;githubbot;600","kezhuw commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122631097


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:
##########
@@ -696,18 +710,27 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {
                         packet.rec = logEntry.getTxn();
                         packet.hdr = logEntry.getHeader();
                         packet.digest = logEntry.getDigest();
-                        // Log warning message if txn comes out-of-order
-                        if (packet.hdr.getZxid() != lastQueued + 1) {
-                            LOG.warn(
-                                ""Got zxid 0x{} expected 0x{}"",
-                                Long.toHexString(packet.hdr.getZxid()),
-                                Long.toHexString(lastQueued + 1));
+                        if (lastQueued == 0) {
+                            LOG.info(""DIFF sync got first proposal 0x{}"", Long.toHexString(packet.hdr.getZxid()));
+                        } else if (packet.hdr.getZxid() != lastQueued + 1) {
+                            if (ZxidUtils.getEpochFromZxid(packet.hdr.getZxid()) <= ZxidUtils.getEpochFromZxid(lastQueued)) {
+                                String msg = String.format(""DIFF sync got proposal 0x%s which is not next of last proposal 0x%s"",
+                                    Long.toHexString(packet.hdr.getZxid()),
+                                    Long.toHexString(lastQueued));
+                                LOG.error(msg);
+                                throw new Exception(msg);
+                            }
+                            // We can't tell whether it is a data loss. Given that new epoch is rare,
+                            // log at warn should not be too verbose.
+                            LOG.warn(""DIFF sync got new epoch proposal 0x{}, last proposal 0x{}"",
+                                    Long.toHexString(packet.hdr.getZxid()),
+                                    Long.toHexString(lastQueued));

Review Comment:
   Move them to `enforceContinuousProposal`.



;03/Jun/25 04:32;githubbot;600","kezhuw commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122631643


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:
##########
@@ -780,8 +803,8 @@ protected void syncWithLeader(long newLeaderZxid) throws Exception {
                                 continue;
                             }
                             packetsNotLogged.removeFirst();
-                            fzk.appendRequest(pif.hdr, pif.rec, pif.digest);
-                            fzk.processTxn(pif.hdr, pif.rec);
+                            fzk.appendRequest(pif.toRequest());
+                            fzk.processTxn(pif.toRequest());

Review Comment:
   Done.



;03/Jun/25 04:32;githubbot;600","kezhuw commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2122632370


##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/QuorumSyncTest.java:
##########
@@ -0,0 +1,100 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.server.quorum;
+
+import static org.junit.jupiter.api.Assertions.assertNotNull;
+import java.util.Comparator;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.test.ClientBase;
+import org.apache.zookeeper.test.QuorumUtil;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.Test;
+
+public class QuorumSyncTest extends ZKTestCase {
+    private QuorumUtil qu;
+
+    @AfterEach
+    public void tearDown() throws Exception {
+        if (qu != null) {
+            qu.shutdownAll();
+        }
+    }
+
+    @Test
+    public void testStaleDiffSync() throws Exception {
+        qu = new QuorumUtil(2);
+        qu.startAll();
+
+        int[] followerIds = qu.getFollowerQuorumPeers()
+            .stream()
+            .sorted(Comparator.comparingLong(QuorumPeer::getMyId).reversed())
+            .mapToInt(peer -> (int) peer.getMyId()).toArray();
+
+        int follower1 = followerIds[0];
+        int follower2 = followerIds[1];
+
+        String leaderConnectString = qu.getConnectString(qu.getLeaderQuorumPeer());
+        try (ZooKeeper zk = ClientBase.createZKClient(leaderConnectString)) {
+            qu.shutdown(follower2);
+
+            for (int i = 0; i < 10; i++) {
+                zk.create(""/foo"" + i, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
+            }
+
+            qu.shutdown(follower1);
+
+            for (int i = 0; i < 10; i++) {
+                zk.create(""/bar"" + i, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
+            }
+
+            qu.restart(follower1);
+        }
+
+        try (ZooKeeper zk = ClientBase.createZKClient(qu.getConnectionStringForServer(follower1))) {
+            for (int i = 0; i < 10; i++) {
+                String path = ""/foo"" + i;
+                assertNotNull(zk.exists(path, false), path + "" not found"");
+            }
+
+            for (int i = 0; i < 10; i++) {

Review Comment:
   ZOOKEEPER-4925 ?



;03/Jun/25 04:33;githubbot;600","kezhuw commented on PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#issuecomment-2933376784

   Hi @li4wang, thank for for reviewing this! I have pushed a new commit. Please take another to look and let me know whether it solves your concerns.


;03/Jun/25 04:35;githubbot;600","li4wang commented on code in PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#discussion_r2125310908


##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/QuorumSyncTest.java:
##########
@@ -0,0 +1,100 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.server.quorum;
+
+import static org.junit.jupiter.api.Assertions.assertNotNull;
+import java.util.Comparator;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.test.ClientBase;
+import org.apache.zookeeper.test.QuorumUtil;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.Test;
+
+public class QuorumSyncTest extends ZKTestCase {
+    private QuorumUtil qu;
+
+    @AfterEach
+    public void tearDown() throws Exception {
+        if (qu != null) {
+            qu.shutdownAll();
+        }
+    }
+
+    @Test
+    public void testStaleDiffSync() throws Exception {
+        qu = new QuorumUtil(2);
+        qu.startAll();
+
+        int[] followerIds = qu.getFollowerQuorumPeers()
+            .stream()
+            .sorted(Comparator.comparingLong(QuorumPeer::getMyId).reversed())
+            .mapToInt(peer -> (int) peer.getMyId()).toArray();
+
+        int follower1 = followerIds[0];
+        int follower2 = followerIds[1];
+
+        String leaderConnectString = qu.getConnectString(qu.getLeaderQuorumPeer());
+        try (ZooKeeper zk = ClientBase.createZKClient(leaderConnectString)) {
+            qu.shutdown(follower2);
+
+            for (int i = 0; i < 10; i++) {
+                zk.create(""/foo"" + i, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
+            }
+
+            qu.shutdown(follower1);
+
+            for (int i = 0; i < 10; i++) {
+                zk.create(""/bar"" + i, null, ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT);
+            }
+
+            qu.restart(follower1);
+        }
+
+        try (ZooKeeper zk = ClientBase.createZKClient(qu.getConnectionStringForServer(follower1))) {
+            for (int i = 0; i < 10; i++) {
+                String path = ""/foo"" + i;
+                assertNotNull(zk.exists(path, false), path + "" not found"");
+            }
+
+            for (int i = 0; i < 10; i++) {

Review Comment:
   Yes



;04/Jun/25 02:07;githubbot;600","kezhuw commented on PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254#issuecomment-2942413138

   @cnauroth @anmolnar @eolivelli @tisonkun Would you like to take another look ? I plan to merge this in days to not block 3.9.4.


;05/Jun/25 01:34;githubbot;600","kezhuw merged PR #2254:
URL: https://github.com/apache/zookeeper/pull/2254


;10/Jun/25 17:36;githubbot;600","kezhuw opened a new pull request, #2266:
URL: https://github.com/apache/zookeeper/pull/2266

   There are two variants of `ZooKeeperServer::processTxn`. Those two variants diverge significantly since ZOOKEEPER-3484. `processTxn(Request request)` pops outstanding change from `outstandingChanges` and adds txn to `committedLog` for follower to sync in addition to what `processTxn(TxnHeader hdr, Record txn)` does. The `Learner` uses `processTxn(TxnHeader hdr, Record txn)` to commit txn to memory after ZOOKEEPER-4394, which means it leaves `committedLog` untouched in `SYNCHRONIZATION` phase.
   
   This way, a stale follower will have hole in its `committedLog` after joining cluster. The stale follower will propagate the in memory hole to other stale nodes after becoming leader. This causes data loss.
   
   The test case fails on master and 3.9.3, and passes on 3.9.2. So only 3.9.3 is affected.
   
   This commit drops `processTxn(TxnHeader hdr, Record txn)` as `processTxn(Request request)` is capable in `SYNCHRONIZATION` phase too.
   
   Also, this commit rejects discontinuous proposals in `syncWithLeader` and `committedLog`, so to avoid possible data loss.
   
   Refs: ZOOKEEPER-4925, ZOOKEEPER-4394, ZOOKEEPER-3484
   
   Reviewers: li4wang
   Author: kezhuw
   Closes #2254 from kezhuw/ZOOKEEPER-4925-fix-data-loss
   
   (cherry picked from commit e5dd60bf0512ccc1e090d99410a8da48623219da)


;10/Jun/25 17:44;githubbot;600","kezhuw commented on PR #2266:
URL: https://github.com/apache/zookeeper/pull/2266#issuecomment-2960133540

   This is the 3.9.4 backport of #2254. I have backported it to branch-3.9. cc @tisonkun


;10/Jun/25 17:47;githubbot;600","anmolnar commented on PR #2266:
URL: https://github.com/apache/zookeeper/pull/2266#issuecomment-3096796833

   You might want to rebase the patch to re-trigger the failing tests.


;21/Jul/25 13:28;githubbot;600","kezhuw merged PR #2266:
URL: https://github.com/apache/zookeeper/pull/2266


;07/Aug/25 14:42;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,0,15000,,,0,15000,,,,,,,ZOOKEEPER-4394,,,,,ZOOKEEPER-3484,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Apr 30 04:01:19 UTC 2025,,,,,,,,,,"0|z1vm8w:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"30/Apr/25 03:58;kezhuw;Added a test case for this: https://github.com/kezhuw/zookeeper/commit/c9e00b87bd0c952d382250d7b911896f52e92407. Only 3.9.3 is affected;;;","30/Apr/25 04:01;kezhuw;Just in case, I found this in writing test cases for ZOOKEEPER-4882.;;;",,,,,,,,,,
"Fix double ""the"" word typos",ZOOKEEPER-4924,13616748,,Task,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,,sssdnsy666,sssdnsy666,30/Apr/25 02:17,06/May/25 12:55,08/Dec/25 08:12,30/Apr/25 02:27,,,,,,,,,3.10.0,,,documentation,,,,0,pull-request-available,,,Resolved in https://github.com/apache/zookeeper/commit/bf71704249f447601926d96592075809dcb1e8e9,none,"tisonkun commented on PR #2251:
URL: https://github.com/apache/zookeeper/pull/2251#issuecomment-2840692786

   Thanks! Merging....


;30/Apr/25 03:13;githubbot;600","tisonkun merged PR #2251:
URL: https://github.com/apache/zookeeper/pull/2251


;30/Apr/25 03:14;githubbot;600","SSSDNSY commented on PR #2251:
URL: https://github.com/apache/zookeeper/pull/2251#issuecomment-2854472331

   Excuse me, How can I  find the ""good first issue"" or ""beginner""  in  https://issues.apache.org/jira/projects/ZOOKEEPER , I use the jira filters but there no this tag word to filter issue. Could you give me some advice ,thank you much! @tisonkun 


;06/May/25 12:55;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,300,0,1800,600%,300,0,1800,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Apr 30 02:19:27 UTC 2025,,,,,,,,,,"0|z1vm8o:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"30/Apr/25 02:19;sssdnsy666;make new Issue for this (PR)[https://github.com/apache/zookeeper/pull/2251/files];;;","30/Apr/25 02:19;sssdnsy666;I have fixed this ;;;",,,,,,,,,,
Zookeeper Client 3.9.3 Fails to Reconnect After Network Failures,ZOOKEEPER-4921,13616163,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Critical,Fixed,kezhuw,tranvanchuong1995,tranvanchuong1995,23/Apr/25 17:51,29/Aug/25 21:29,08/Dec/25 08:12,11/May/25 02:20,3.9.3,,,,,,,,3.10.0,3.9.4,,java client,,,,0,pull-request-available,,,"After upgrading the Java Zookeeper client to version 3.9.3, we observed that it is not resilient to brief network disruptions, such as a short VPN blip. In such cases, the client attempts to reconnect only once, and if unsuccessful, the session expires.
{quote}Apr 23, 2025 10:19:23 AM com.twitter.finagle.common.zookeeper.ZooKeeperClient$3 process
INFO: Zookeeper session expired. Event: WatchedEvent state:Expired type:None path:null zxid: -1
{quote}
In contrast, the previous version (3.9.2) would continuously retry until the network connection was restored, maintaining the session more reliably.

I believe it's a new issue with this change: https://issues.apache.org/jira/browse/ZOOKEEPER-4508

 

Step to repro:
 # Open VPN.
 # Start the application which connects to the Zookeeper server with the VPN.
 # Disable VPN for a couple of minutes.
 # Observe the application.
 # Enable the VPN again.

{quote}3.9.3:
""message"" : ""Session 0x0 for server XXX, Closing socket connection. Attempting reconnect except it is a SessionExpiredException or SessionTimeoutException."",
  ""stackTrace"" : ""o.a.z.ClientCnxn$SessionTimeoutException: Client session timed out, have not heard from server in 5590ms for session id 0x0
        at o.a.z.ClientCnxn$SendThread.run(ClientCnxn.java:1253)
{quote}
3.9.2: Application will be reconnected successfully.",,"kezhuw opened a new pull request, #2252:
URL: https://github.com/apache/zookeeper/pull/2252

   This partially rollback ZOOKEEPER-4508 to keep consistent with versions prior to 3.9.3 (excluded), so to maintain compatibility with third party libraries.
   
   Refs: ZOOKEEPER-4508, ZOOKEEPER-4921, ZOOKEEPER-4923 and https://lists.apache.org/thread/nfb9z7rhgglbjzfxvg4z2m3pks53b3c1


;29/Apr/25 13:55;githubbot;600","kezhuw commented on PR #2252:
URL: https://github.com/apache/zookeeper/pull/2252#issuecomment-2839076094

   This is the 3.9 of #2253.


;29/Apr/25 14:08;githubbot;600","kezhuw merged PR #2252:
URL: https://github.com/apache/zookeeper/pull/2252


;11/May/25 02:18;githubbot;600","kezhuw commented on PR #2252:
URL: https://github.com/apache/zookeeper/pull/2252#issuecomment-2869354482

   Hi @tisonkun, I have merged this to branch-3.9.
   
   Besides, I have marked ZOOKEEPER-4921 as resolved with fix version 3.9.4, as 3.9.5 has not been created. Feel free to decide the final ship version as the release manager.
   
   Refs: https://lists.apache.org/thread/sq5djdm5ttbscbtdw5ykp5vl4dfb8p56


;11/May/25 02:28;githubbot;600","kezhuw opened a new pull request, #2265:
URL: https://github.com/apache/zookeeper/pull/2265

   This partially rollback ZOOKEEPER-4508 to keep consistent with versions prior to 3.9.3 (excluded), so to maintain compatibility with third party libraries.
   
   Refs: ZOOKEEPER-4508, ZOOKEEPER-4921, ZOOKEEPER-4923 and https://lists.apache.org/thread/nfb9z7rhgglbjzfxvg4z2m3pks53b3c1


;05/Jun/25 01:16;githubbot;600","kezhuw commented on PR #2265:
URL: https://github.com/apache/zookeeper/pull/2265#issuecomment-2942389965

   This is 3.9.4 version of #2252.  cc @tisonkun 


;05/Jun/25 01:18;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3600,,,0,3600,,,,,,,ZOOKEEPER-4508,,,ZOOKEEPER-4923,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,Java,Scala,Sun May 11 02:20:55 UTC 2025,,,,,,,,,,"0|z1vimo:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"23/Apr/25 17:53;tranvanchuong1995;cc [~andor] as I see your comment on the previous issue.;;;","23/Apr/25 18:02;ctubbsii;The Accumulo team has noticed this and has developed a solution, a ""ZooSession"" object that mostly mimics the API of ZooKeeper client object, and automatically reconnects. However, it needs additional work to be fully resilient to exceptions thrown due to transient failures. Some of that is encapsulated in a helper ""ZooReader"" and ""ZooReaderWriter"" objects which retry operations on transient errors, and plan to merge those into the ZooSession feature. I think if we can make it resilient enough to be generally useful, it is something that we could contribute directly to the ZooKeeper project. However, that requires some time to polish up the API and behavior, and we have a lot of other development tasks we're working on.

But, I think the idea is sound. It's very weird, after all, that the ZK client is useless after network failures. It's a bit like having to restart your browser every time you navigate to website with an error. That shouldn't be necessary.

You may want to take a look at the workarounds that the Accumulo project has come up with for handling these transient issues.;;;","24/Apr/25 01:30;kezhuw;Hi [~tranvanchuong1995], did you have more logs during repro steps ?

>  Disable VPN for a couple of minutes.

What is the ZooKeeper session timeout ? ZOOKEEPER-4508 enforced client side check to expire zookeeper session in case of unreachable of cluster to avoid endless reconnection(a.k.a. no {{Expired}} after lose connection to cluster). The timeout is {{sessionTimeout * 4 /3}}. The default max session timeout in zookeeper is 1 minute, ""a couple of minutes"" usually enough for a zookeeper session to expire.;;;","24/Apr/25 02:25;kezhuw;{noformat}
  ""stackTrace"" : ""o.a.z.ClientCnxn$SessionTimeoutException: Client session timed out, have not heard from server in 5590ms for session id 0x0
{noformat}

This is the log when client decide to give up retry.
1. This log comes from an unestablished zookeeper session as it prints ""session id 0x0"".
2. The server is configured with a small session timeout as the default min expiration timeout in client is {{8000ms}} (it is {{4/3}} of the default min session timeout in server which is {{6000ms}}).

;;;","24/Apr/25 02:33;tranvanchuong1995;[~kezhuw] This is the full log of 3.9.3:

{
""time"" : ""2025-04-23T18:51:35.611-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZkAnnouncer Mutator-SendThread(XXX:2181)"",
""level"" : ""WARN"",
""myid"" : ""XXX:2181"",
""message"" : ""Session 0x100707c2dc261da for server XXX/YYYY:2181, Closing socket connection. Attempting reconnect except it is a SessionExpiredException or SessionTimeoutException."",
""stackTrace"" : ""o.a.z.ClientCnxn$ConnectionTimeoutException: Client connection timed out, have not heard from server in 2667ms for session id 0x100707c2dc261da
at o.a.z.ClientCnxn$SendThread.run(ClientCnxn.java:1259)
""
}
{
""time"" : ""2025-04-23T18:51:37.218-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZkAnnouncer Mutator-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""Opening socket connection to server XXX/YYYY:2181.""
}
{
""time"" : ""2025-04-23T18:51:37.219-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZkAnnouncer Mutator-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""SASL config status: Will not attempt to authenticate using SASL (unknown error)""
}
{
""time"" : ""2025-04-23T18:51:41.355-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZkAnnouncer Mutator-SendThread(XXX:2181)"",
""level"" : ""WARN"",
""myid"" : ""XXX:2181"",
""message"" : ""Client session timed out, have not heard from server in 8393ms for session id 0x100707c2dc261da""
}
{
""time"" : ""2025-04-23T18:51:41.360-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZkAnnouncer Mutator-SendThread(XXX:2181)"",
""level"" : ""WARN"",
""myid"" : ""XXX:2181"",
""message"" : ""Session 0x100707c2dc261da for server XXX/YYYY:2181, Closing socket connection. Attempting reconnect except it is a SessionExpiredException or SessionTimeoutException."",
""stackTrace"" : ""o.a.z.ClientCnxn$SessionTimeoutException: Client session timed out, have not heard from server in 8393ms for session id 0x100707c2dc261da
at o.a.z.ClientCnxn$SendThread.run(ClientCnxn.java:1253)
""
}
Apr 23, 2025 6:51:41 PM com.twitter.finagle.common.zookeeper.ZooKeeperClient$3 process
INFO: Zookeeper session expired. Event: WatchedEvent state:Expired type:None path:null zxid: -1
{
""time"" : ""2025-04-23T18:51:41.588-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZkAnnouncer Mutator-EventThread"",
""level"" : ""INFO"",
""message"" : ""EventThread shut down for session: 0x100707c2dc261da""
}
{
""time"" : ""2025-04-23T18:51:41.595-07:00"",
""logger_name"" : ""org.apache.zookeeper.ZooKeeper"",
""thread_name"" : ""ZookeeperClient-watcherProcessor"",
""level"" : ""INFO"",
""message"" : ""Initiating client connection, connectString=XXX:2181 sessionTimeout=4000 watcher=com.twitter.finagle.common.zookeeper.ZooKeeperClient$3@6ecbbfdf""
}
{
""time"" : ""2025-04-23T18:51:41.596-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxnSocket"",
""thread_name"" : ""ZookeeperClient-watcherProcessor"",
""level"" : ""INFO"",
""message"" : ""jute.maxbuffer value is 1048575 Bytes""
}
{
""time"" : ""2025-04-23T18:51:41.597-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor"",
""level"" : ""INFO"",
""message"" : ""zookeeper.request.timeout value is 0. feature enabled=false""
}
{
""time"" : ""2025-04-23T18:51:41.600-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""Opening socket connection to server XXX/YYYY:2181.""
}
{
""time"" : ""2025-04-23T18:51:41.601-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""SASL config status: Will not attempt to authenticate using SASL (unknown error)""
}
{
""time"" : ""2025-04-23T18:51:45.613-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""WARN"",
""myid"" : ""XXX:2181"",
""message"" : ""Session 0x0 for server XXX/YYYY:2181, Closing socket connection. Attempting reconnect except it is a SessionExpiredException or SessionTimeoutException."",
""stackTrace"" : ""o.a.z.ClientCnxn$ConnectionTimeoutException: Client connection timed out, have not heard from server in 4005ms for session id 0x0
at o.a.z.ClientCnxn$SendThread.run(ClientCnxn.java:1259)
""
}
{
""time"" : ""2025-04-23T18:51:46.730-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""Opening socket connection to server XXX/YYYY:2181.""
}
{
""time"" : ""2025-04-23T18:51:46.730-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""SASL config status: Will not attempt to authenticate using SASL (unknown error)""
}
{
""time"" : ""2025-04-23T18:51:50.732-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""WARN"",
""myid"" : ""XXX:2181"",
""message"" : ""Client session timed out, have not heard from server in 9134ms for session id 0x0""
}
{
""time"" : ""2025-04-23T18:51:50.732-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""WARN"",
""myid"" : ""XXX:2181"",
""message"" : ""Session 0x0 for server XXX/YYYY:2181, Closing socket connection. Attempting reconnect except it is a SessionExpiredException or SessionTimeoutException."",
""stackTrace"" : ""o.a.z.ClientCnxn$SessionTimeoutException: Client session timed out, have not heard from server in 9134ms for session id 0x0
at o.a.z.ClientCnxn$SendThread.run(ClientCnxn.java:1253)
""
}
Apr 23, 2025 6:51:50 PM com.twitter.finagle.common.zookeeper.ZooKeeperClient$3 process
INFO: Zookeeper session expired. Event: WatchedEvent state:Expired type:None path:null zxid: -1;;;","24/Apr/25 02:44;tranvanchuong1995;With 3.9.2, it will retry really hard until we connect to the VPN:
{
""time"" : ""2025-04-23T19:42:23.638-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""WARN"",
""myid"" : ""XXX:2181"",
""message"" : ""Session 0x100707c2dc26281 for server XXX:2181, Closing socket connection. Attempting reconnect except it is a SessionExpiredException."",
""stackTrace"" : ""j.l.IllegalArgumentException: Unable to canonicalize address XXX:2181 because it's not resolvable
at o.a.z.SaslServerPrincipal.getServerPrincipal(SaslServerPrincipal.java:78)
at o.a.z.SaslServerPrincipal.getServerPrincipal(SaslServerPrincipal.java:41)
at o.a.z.ClientCnxn$SendThread.startConnect(ClientCnxn.java:1142)
at o.a.z.ClientCnxn$SendThread.run(ClientCnxn.java:1192)
""
}
{
""time"" : ""2025-04-23T19:42:25.506-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""Opening socket connection to server XXX/YYY:2181.""
}
{
""time"" : ""2025-04-23T19:42:25.507-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""SASL config status: Will not attempt to authenticate using SASL (unknown error)""
}
{
""time"" : ""2025-04-23T19:42:25.519-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""Socket connection established, initiating session, client: /10.4.9.178:61916, server: XXX/YYY:2181""
}
{
""time"" : ""2025-04-23T19:42:25.536-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""WARN"",
""myid"" : ""XXX:2181"",
""message"" : ""Unable to reconnect to ZooKeeper service, session 0x100707c2dc26281 has expired""
}
{
""time"" : ""2025-04-23T19:42:25.537-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""WARN"",
""myid"" : ""XXX:2181"",
""message"" : ""Session 0x100707c2dc26281 for server XXX/YYY:2181, Closing socket connection. Attempting reconnect except it is a SessionExpiredException."",
""stackTrace"" : ""o.a.z.ClientCnxn$SessionExpiredException: Unable to reconnect to ZooKeeper service, session 0x100707c2dc26281 has expired
at o.a.z.ClientCnxn$SendThread.onConnected(ClientCnxn.java:1418)
at o.a.z.ClientCnxnSocket.readConnectResult(ClientCnxnSocket.java:148)
at o.a.z.ClientCnxnSocketNIO.doIO(ClientCnxnSocketNIO.java:86)
at o.a.z.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:350)
at o.a.z.ClientCnxn$SendThread.run(ClientCnxn.java:1274)
""
}
{
""time"" : ""2025-04-23T19:42:25.542-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-EventThread"",
""level"" : ""INFO"",
""message"" : ""EventThread shut down for session: 0x100707c2dc26281""
}
{
""time"" : ""2025-04-23T19:42:25.543-07:00"",
""logger_name"" : ""org.apache.zookeeper.ZooKeeper"",
""thread_name"" : ""ZookeeperClient-watcherProcessor"",
""level"" : ""INFO"",
""message"" : ""Initiating client connection, connectString=XXX:2181 sessionTimeout=4000 watcher=com.twitter.finagle.common.zookeeper.ZooKeeperClient$3@38b9cd1e""
}
{
""time"" : ""2025-04-23T19:42:25.544-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxnSocket"",
""thread_name"" : ""ZookeeperClient-watcherProcessor"",
""level"" : ""INFO"",
""message"" : ""jute.maxbuffer value is 1048575 Bytes""
}
{
""time"" : ""2025-04-23T19:42:25.545-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor"",
""level"" : ""INFO"",
""message"" : ""zookeeper.request.timeout value is 0. feature enabled=false""
}
{
""time"" : ""2025-04-23T19:42:25.546-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""Opening socket connection to server XXX/YYY:2181.""
}
{
""time"" : ""2025-04-23T19:42:25.547-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""SASL config status: Will not attempt to authenticate using SASL (unknown error)""
}
Apr 23, 2025 7:42:25 PM com.twitter.finagle.common.zookeeper.ZooKeeperClient$3 process
INFO: Zookeeper session expired. Event: WatchedEvent state:Expired type:None path:null zxid: -1
{
""time"" : ""2025-04-23T19:42:25.557-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""Socket connection established, initiating session, client: /10.4.9.178:61917, server: XXX/YYY:2181""
}
{
""time"" : ""2025-04-23T19:42:25.571-07:00"",
""logger_name"" : ""org.apache.zookeeper.ClientCnxn"",
""thread_name"" : ""ZookeeperClient-watcherProcessor-SendThread(XXX:2181)"",
""level"" : ""INFO"",
""myid"" : ""XXX:2181"",
""message"" : ""Session establishment complete on server XXX/YYY:2181, session id = 0x100707c2dc26286, negotiated timeout = 4000""
}
Apr 23, 2025 7:42:25 PM com.twitter.finagle.common.zookeeper.Group$ActiveMembership join
INFO: Membership path is : /env-q/finagle/service/example-server/thrift/member_0000000003
Apr 23, 2025 7:42:25 PM com.twitter.finagle.common.zookeeper.Group$ActiveMembership join
INFO: Set group member ID to member_0000000003;;;","24/Apr/25 04:21;kezhuw;[~tranvanchuong1995] Thank you for your sharing! You could upload log file directly to jira.

3.9.3:
{noformat}
o.a.z.ClientCnxn$ConnectionTimeoutException: Client connection timed out, have not heard from server in 2667ms for session id 0x100707c2dc261da
{noformat}

3.9.2:
{noformat}
Session 0x100707c2dc26281 for server XXX:2181, Closing socket connection. Attempting reconnect except it is a SessionExpiredException.
{noformat}

Sessions will expired finally in your cases. In case of 3.9.3, it is *considered expired* by client, while in 3.9.2, it is *confirmed expired* by server. There is no much differences in these two cases from client's perspective except *the later will be delayed substantially if cluster is unreachable*, just like this case.

{noformat}
With 3.9.2, it will retry really hard until we connect to the VPN:

{""2025-04-23T19:42:25.543-07:00"",""Initiating client connection, connectString=XXX:2181 sessionTimeout=4000 "" }
{""2025-04-23T19:42:25.557-07:00"", ""Socket connection established, initiating session, client: /10.4.9.178:61917, server: XXX/YYY:2181"" }
{""2025-04-23T19:42:25.571-07:00"", ""Session establishment complete on server XXX/YYY:2181, session id = 0x100707c2dc26286, negotiated timeout = 4000"" }
{noformat}

It will retry hard(*actually endless*) to get reconnected and to know its expiration. The next client will success immediately in your case as network has been repaired.
3.9.3:
{noformat}
2025-04-23T18:51:41.595-07:00,  Initiating client connection, connectString=XXX:2181 sessionTimeout=4000
2025-04-23T18:51:41.600-07:00, Opening socket connection to server XXX/YYYY:2181
2025-04-23T18:51:45.613-07:00, Client connection timed out, have not heard from server in 4005ms for session id 0x0

2025-04-23T18:51:46.730-07:00, Opening socket connection to server XXX/YYYY:2181
2025-04-23T18:51:50.732-07:00, Client session timed out, have not heard from server in 9134ms for session id 0x0
{noformat}

From the log, I can tell the it try twice before exhausting expiration timeout(a.k.a. 4/3 * 4000ms).

3.9.2
{noformat}
Session establishment complete on server XXX/YYY:2181, session id = 0x100707c2dc26286, negotiated timeout = 4000
{noformat}

In 3.9.2, the client will keeping retry(*actuall endless*) until a brand new session established while 3.9.3 does not. 

 Those endless retry is what ZOOKEEPER-4508 try to fix so client can get prompt notification according to session timeout and react somehow.

I think you could mimic 3.9.2 behavior by looping new session establishment so you could get a brand new session after network repaired.;;;","24/Apr/25 04:57;tranvanchuong1995;[~kezhuw] Are you saying that starting with version 3.9.3, the application is now responsible for managing session establishment itself? In our case, the Zookeeper library is embedded within the Twitter Finagle library, creating multiple layers of abstraction that make it nearly impossible for us to override this behavior.;;;","24/Apr/25 08:14;kezhuw;> Are you saying that starting with version 3.9.3, the application is now responsible for managing session establishment itself?

{{org.apache.zookeeper.ZooKeeper}} manages a single session which tolerate network downtime within session timeout. Beyond that, applications(Finagle, Curator, etc.) have to manage themselves across sessions.

> In our case, the Zookeeper library is embedded within the Twitter Finagle library, creating multiple layers of abstraction that make it nearly impossible for us to override this behavior.

Seems that finagle's [ZooKeeperClient.get|https://github.com/twitter/finagle/blob/develop/finagle-serversets/src/main/java/com/twitter/finagle/common/zookeeper/ZooKeeperClient.java#L357] relies on the endless retrying during estalishing a brand new session. We could fix it there.

Alternative, we could provide a option for zookeeper to loop until a customized timeout in new session establishment. I think it might be a common pattern to get {{Expired}} and then loop until connected.;;;","24/Apr/25 15:10;kezhuw;> Alternative, we could provide a option for zookeeper to loop until a customized timeout in new session establishment. I think it might be a common pattern to get {{Expired}} and then loop until connected.

I sent a dev mail to discuss this. https://lists.apache.org/thread/nfb9z7rhgglbjzfxvg4z2m3pks53b3c1;;;","24/Apr/25 16:10;tranvanchuong1995;[~kezhuw] this dev mail discussion looks really good. I am looking forward to hearing about the final decision. Thank you!;;;","11/May/25 02:20;kezhuw;Issue resolved by pull request 2252
[https://github.com/apache/zookeeper/pull/2252];;;"
ZooKeeperServerMaxCnxnsTest is flaky,ZOOKEEPER-4920,13615856,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,kezhuw,kezhuw,kezhuw,20/Apr/25 16:10,25/Apr/25 01:59,08/Dec/25 08:02,25/Apr/25 01:59,,,,,,,,,3.10.0,,,tests,,,,0,pull-request-available,,,"https://github.com/apache/zookeeper/actions/runs/14560136021/job/40842324999?pr=2211#step:6:494

{noformat}
[ERROR] Tests run: 2, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 22.06 s <<< FAILURE! - in org.apache.zookeeper.server.ZooKeeperServerMaxCnxnsTest
[ERROR] testMaxZooKeeperClientsWithNIOServerCnxnFactory  Time elapsed: 2.687 s  <<< FAILURE!
org.opentest4j.AssertionFailedError: Client is not supposed to get connected as max connection already reached.
	at org.apache.zookeeper.server.ZooKeeperServerMaxCnxnsTest.testMaxZooKeeperClients(ZooKeeperServerMaxCnxnsTest.java:124)
	at org.apache.zookeeper.server.ZooKeeperServerMaxCnxnsTest.testMaxZooKeeperClientsWithNIOServerCnxnFactory(ZooKeeperServerMaxCnxnsTest.java:58)
{noformat}",,"kezhuw opened a new pull request, #2249:
URL: https://github.com/apache/zookeeper/pull/2249

   The restriction of maxCnxns may not be accurate due to concurrent races, say concurrent accepting. This is totally fine and not worth to make it accurate due to possible negative effects.
   
   This commit circumvents this by connecting to each server maxCnxns times.


;20/Apr/25 16:20;githubbot;600","kezhuw merged PR #2249:
URL: https://github.com/apache/zookeeper/pull/2249


;25/Apr/25 01:59;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1200,,,0,1200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Apr 25 01:59:30 UTC 2025,,,,,,,,,,"0|z1vgqg:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"25/Apr/25 01:59;kezhuw;Issue resolved by pull request 2249
[https://github.com/apache/zookeeper/pull/2249];;;",,,,,,,,,,,
ResponseCache supposed to be a LRU cache,ZOOKEEPER-4919,13615802,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,mikko,kezhuw,kezhuw,19/Apr/25 08:33,29/Aug/25 21:28,08/Dec/25 08:12,19/Apr/25 16:59,3.8.4,3.9.3,,,,,,,3.10.0,3.8.5,3.9.4,server,,,,0,pull-request-available,,,Created for https://github.com/apache/zookeeper/pull/2243,,"kezhuw commented on code in PR #2243:
URL: https://github.com/apache/zookeeper/pull/2243#discussion_r2051433517


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ResponseCacheTest.java:
##########
@@ -146,15 +147,21 @@ public void performCacheTest(ZooKeeper zk, String path, boolean useCache) throws
         createPath(path + ""/a/b/e/g"", zk);
         createPath(path + ""/a/b/e/h"", zk);
 
+        createPath(path + ""/x"", zk);
+        for (int i = 0; i < cacheSize*2; ++i) {

Review Comment:
   ```suggestion
           for (int i = 0; i < cacheSize * 2; ++i) {
   ```



##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ResponseCacheTest.java:
##########
@@ -170,6 +177,19 @@ public void performCacheTest(ZooKeeper zk, String path, boolean useCache) throws
 
         checkCacheStatus(expectedHits, expectedMisses, ""response_packet_get_children_cache_hits"",
                 ""response_packet_get_children_cache_misses"");
+
+        for (int i = 0; i < cacheSize*2; ++i) {
+            checkPath(path + ""/a"", zk, 2);
+            checkPath(path + ""/x/y""+i, zk, 0);

Review Comment:
   ```suggestion
               checkPath(path + ""/x/y"" + i, zk, 0);
   ```



##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ResponseCacheTest.java:
##########
@@ -170,6 +177,19 @@ public void performCacheTest(ZooKeeper zk, String path, boolean useCache) throws
 
         checkCacheStatus(expectedHits, expectedMisses, ""response_packet_get_children_cache_hits"",
                 ""response_packet_get_children_cache_misses"");
+
+        for (int i = 0; i < cacheSize*2; ++i) {

Review Comment:
   ```suggestion
           for (int i = 0; i < cacheSize * 2; ++i) {
   ```



;19/Apr/25 08:49;githubbot;600","kezhuw merged PR #2243:
URL: https://github.com/apache/zookeeper/pull/2243


;19/Apr/25 16:58;githubbot;600","kezhuw commented on PR #2243:
URL: https://github.com/apache/zookeeper/pull/2243#issuecomment-2816784313

   Merged and backported to 3.9 and 3.8 as it is a bug.
   
   @mikkosc Thank you for your contribution! Do you have a jira account so I can assign ZOOKEEPER-4919 to you ?
   
   


;19/Apr/25 17:03;githubbot;600","mikkosc commented on PR #2243:
URL: https://github.com/apache/zookeeper/pull/2243#issuecomment-2817941591

   Yes. It seems to be _mikko_ / Mikko Tiihonen. I added comment to the jira to make it obvious


;21/Apr/25 08:34;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,,,,,,,,,,ZOOKEEPER-3180,ZOOKEEPER-4351,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Mon Apr 21 08:33:42 UTC 2025,,,,,,,,,,"0|z1vgeg:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"19/Apr/25 16:59;kezhuw;Issue resolved by pull request 2243
[https://github.com/apache/zookeeper/pull/2243];;;","21/Apr/25 08:33;mikko;Thank you for backporting this also to older releases!;;;",,,,,,,,,,
Remove default TLS cipher overrides,ZOOKEEPER-4912,13612947,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,stoty,stoty,stoty,24/Mar/25 18:10,18/Jun/25 16:31,08/Dec/25 08:12,11/May/25 02:16,,,,,,,,,3.10.0,,,security,,,,0,pull-request-available,,,"This is a follow-up on the discussion on the ZOOKEEPER-4415 [PR|https://github.com/apache/zookeeper/pull/1919] .

ZK currently hardcodes the list of ciphers, and needs to add code to handle all new ciphers and Java TLS changes.

This was originally added as a performance optimization, which is not very relevant today, and interferes with normal TLS operation.

I propose removing the default cipher logic from X509Util.

Ciphers could still be specified either by the existing config properties, or via the standard java properties / security config, but would otherwise default to the JVM defaults, and pick up any changes from new JDKs or security settings.

This could cause performance problems for very old JDK8 JVMs, where the current behaviour can be restored by explicitly specifying the CBC cipher list, which should be added to the documentation.",,"stoty opened a new pull request, #2239:
URL: https://github.com/apache/zookeeper/pull/2239

   (no comment)


;25/Mar/25 08:24;githubbot;600","cnauroth commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2012556770


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -80,7 +80,10 @@ public SslContext createNettySslContextForClient(ZKConfig config)
         }
 
         sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
-        sslContextBuilder.protocols(getEnabledProtocols(config));
+        String[] enabledProtocols = getEnabledProtocols(config);

Review Comment:
   Is this change necessary? It seems that `SslContextBuilder#protocols` is null-safe:
   
   https://github.com/netty/netty/blob/netty-4.1.105.Final/handler/src/main/java/io/netty/handler/ssl/SslContextBuilder.java#L569-L572



;25/Mar/25 17:11;githubbot;600","stoty commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2013634870


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -80,7 +80,10 @@ public SslContext createNettySslContextForClient(ZKConfig config)
         }
 
         sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
-        sslContextBuilder.protocols(getEnabledProtocols(config));
+        String[] enabledProtocols = getEnabledProtocols(config);

Review Comment:
   You're right, it's not necessary.
   However, I think that the it improves readability by handling the null value explicitly.
   
   I can remove it if you prefer.



;26/Mar/25 08:43;githubbot;600","stoty commented on PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#issuecomment-2753616853

   > @stoty , I thought of one more thing. The JIRA issue mentioned discussing the cipher change in documentation. Do you want to include that documentation change in this pull request?
   
   Yes, I do.
   I just need to familiarize myself with how the docs are generated for ZK.


;26/Mar/25 08:44;githubbot;600","stoty commented on PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#issuecomment-2753809899

   I have updated the admin guide, @cnauroth @anmolnar .
   
   We could go into more detail (like the full cipher lists for Java 8/9, or more information on how to influence that cipher selection), but I couldn't a good place to put that information. 
   
   I also couldn't find a focused doc for the relevant JVM config properties, as it's a large topic, as well as being provider dependent.
   
   Please let me know if more documentation is needed, and where I should add that.


;26/Mar/25 09:52;githubbot;600","stoty commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2013634870


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -80,7 +80,10 @@ public SslContext createNettySslContextForClient(ZKConfig config)
         }
 
         sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
-        sslContextBuilder.protocols(getEnabledProtocols(config));
+        String[] enabledProtocols = getEnabledProtocols(config);

Review Comment:
   You're right, it's not necessary.
   However, I think that the if improves readability by handling the null value explicitly, and showing that we leave the defaults in this case.
   
   I can remove it if you prefer.



;26/Mar/25 09:54;githubbot;600","cnauroth commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2014561794


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -80,7 +80,10 @@ public SslContext createNettySslContextForClient(ZKConfig config)
         }
 
         sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
-        sslContextBuilder.protocols(getEnabledProtocols(config));
+        String[] enabledProtocols = getEnabledProtocols(config);

Review Comment:
   Readability is a good reason to keep this as it is. No change necessary. Thanks!



;26/Mar/25 16:29;githubbot;600","cnauroth commented on PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#issuecomment-2755032921

   From my perspective, this looks like sufficient documentation.


;26/Mar/25 16:30;githubbot;600","anmolnar commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2014700415


##########
zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java:
##########
@@ -80,7 +80,10 @@ public SslContext createNettySslContextForClient(ZKConfig config)
         }
 
         sslContextBuilder.enableOcsp(config.getBoolean(getSslOcspEnabledProperty()));
-        sslContextBuilder.protocols(getEnabledProtocols(config));
+        String[] enabledProtocols = getEnabledProtocols(config);

Review Comment:
   Setting it to null explicitly and not setting it are two different things. What's the default value?
   With this behaviour we will keep the default value which I think makes sense in this case.



##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1738,7 +1738,9 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     (Java system properties: **zookeeper.ssl.ciphersuites** and **zookeeper.ssl.quorum.ciphersuites**)
     **New in 3.5.5:**
     Specifies the enabled cipher suites to be used in client and quorum TLS negotiation.
-    Default: Enabled cipher suites depend on the Java runtime version being used.
+    Default: None, the JVM defaults are used (3.10.0+),
+    Enabled cipher suites are hard coded, with the ordering dependent on whether Java 8, or Java 9+ is used.
+    For Java 8 the list begins with the TLSv1.2 CBC ciphers, while for Java 9+ it begins with the TLSv1.2 CBM ciphers (3.5.5-3.9.x).

Review Comment:
   Shall we list the cipher suites explicitly here which were previously in the code?
   I know source control preserves it for the future, but I think it could be beneficial here as well for future doc readers.



;26/Mar/25 17:42;githubbot;600","stoty commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2014827959


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1738,7 +1738,9 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     (Java system properties: **zookeeper.ssl.ciphersuites** and **zookeeper.ssl.quorum.ciphersuites**)
     **New in 3.5.5:**
     Specifies the enabled cipher suites to be used in client and quorum TLS negotiation.
-    Default: Enabled cipher suites depend on the Java runtime version being used.
+    Default: None, the JVM defaults are used (3.10.0+),
+    Enabled cipher suites are hard coded, with the ordering dependent on whether Java 8, or Java 9+ is used.
+    For Java 8 the list begins with the TLSv1.2 CBC ciphers, while for Java 9+ it begins with the TLSv1.2 CBM ciphers (3.5.5-3.9.x).

Review Comment:
   The format of this list doesn't really allow for long readable explanations.
   
   We could add it in a separate section maybe ?



;26/Mar/25 18:58;githubbot;600","anmolnar commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2015126733


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1738,7 +1738,9 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     (Java system properties: **zookeeper.ssl.ciphersuites** and **zookeeper.ssl.quorum.ciphersuites**)
     **New in 3.5.5:**
     Specifies the enabled cipher suites to be used in client and quorum TLS negotiation.
-    Default: Enabled cipher suites depend on the Java runtime version being used.
+    Default: None, the JVM defaults are used (3.10.0+),
+    Enabled cipher suites are hard coded, with the ordering dependent on whether Java 8, or Java 9+ is used.
+    For Java 8 the list begins with the TLSv1.2 CBC ciphers, while for Java 9+ it begins with the TLSv1.2 CBM ciphers (3.5.5-3.9.x).

Review Comment:
   Sounds good to me, thanks.



;26/Mar/25 23:27;githubbot;600","stoty commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2016137870


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1738,7 +1738,9 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     (Java system properties: **zookeeper.ssl.ciphersuites** and **zookeeper.ssl.quorum.ciphersuites**)
     **New in 3.5.5:**
     Specifies the enabled cipher suites to be used in client and quorum TLS negotiation.
-    Default: Enabled cipher suites depend on the Java runtime version being used.
+    Default: None, the JVM defaults are used (3.10.0+),
+    Enabled cipher suites are hard coded, with the ordering dependent on whether Java 8, or Java 9+ is used.
+    For Java 8 the list begins with the TLSv1.2 CBC ciphers, while for Java 9+ it begins with the TLSv1.2 CBM ciphers (3.5.5-3.9.x).

Review Comment:
   I've added a new section, @anmolnar .



;27/Mar/25 10:06;githubbot;600","kezhuw commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2051661384


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1738,7 +1738,9 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     (Java system properties: **zookeeper.ssl.ciphersuites** and **zookeeper.ssl.quorum.ciphersuites**)
     **New in 3.5.5:**
     Specifies the enabled cipher suites to be used in client and quorum TLS negotiation.
-    Default: Enabled cipher suites depend on the Java runtime version being used.
+    Default: None, the JVM defaults are used (3.10.0+),
+    Enabled cipher suites are hard coded, with the ordering dependent on whether Java 8, or Java 9+ is used.
+    For Java 8 the list begins with the TLSv1.2 CBC ciphers, while for Java 9+ it begins with the TLSv1.2 CBM ciphers (3.5.5-3.9.x).

Review Comment:
   > Default: None, the JVM defaults are used (3.10.0+), Enabled cipher suites are hard coded, with the ordering dependent on whether Java 8, or Java 9+ is used. For Java 8 the list begins with the TLSv1.2 CBC ciphers, while for Java 9+ it begins with the TLSv1.2 CBM ciphers (3.5.5-3.9.x).
   
   The render version does not look clear here. Given that we have a new section, I think we can move some words there.



##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1877,6 +1879,17 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     
     Default: **true** (3.9.0+), **false** (3.8.x)
 
+##### Cipher handling changes
+
+From 3.5.5 to 3.9 a hard coded default cipher list was used, with the ordering
+dependent on whether it is run Java 8 or a later version.
+
+In 3.9 the list on Java 8 is: *TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256, TLS_CHACHA20_POLY1305_SHA256*
+
+In 3.10 the list on Java 8 is: *TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256, TLS_CHACHA20_POLY1305_SHA256*

Review Comment:
   It should be `In 3.9 the list on Java 9+ is` ?



;20/Apr/25 08:17;githubbot;600","stoty commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2053432499


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1877,6 +1879,17 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     
     Default: **true** (3.9.0+), **false** (3.8.x)
 
+##### Cipher handling changes
+
+From 3.5.5 to 3.9 a hard coded default cipher list was used, with the ordering
+dependent on whether it is run Java 8 or a later version.
+
+In 3.9 the list on Java 8 is: *TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256, TLS_CHACHA20_POLY1305_SHA256*
+
+In 3.10 the list on Java 8 is: *TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256, TLS_CHACHA20_POLY1305_SHA256*

Review Comment:
   No, the point is that before this patch ZK is hardcoded to start the list with the  CBC ciphers on Java 8.
   
   In 3.10 we remove that, so the default Java 8 cipher list is used, and the GCM ciphers are first, even on Java 8.
   
   On Java 9+ the GCM ciphers are always coming first, and this patch doesn't make a lot of changes (it mostly allows new ciphers by default, and lets the JVM level settings take effect)
   



;22/Apr/25 06:43;githubbot;600","stoty commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2053432499


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1877,6 +1879,17 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     
     Default: **true** (3.9.0+), **false** (3.8.x)
 
+##### Cipher handling changes
+
+From 3.5.5 to 3.9 a hard coded default cipher list was used, with the ordering
+dependent on whether it is run Java 8 or a later version.
+
+In 3.9 the list on Java 8 is: *TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256, TLS_CHACHA20_POLY1305_SHA256*
+
+In 3.10 the list on Java 8 is: *TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256, TLS_CHACHA20_POLY1305_SHA256*

Review Comment:
   No, the point is that before this patch ZK is hardcoded to start the list with the  CBC ciphers on Java 8.
   
   In 3.10 we remove that, so the default Java 8 cipher list is used, and the GCM ciphers are first, even on Java 8.
   
   On Java 9+ the GCM ciphers are always coming first, and this patch doesn't make a lot of changes (it mostly allows new ciphers by default, and lets the JVM level settings take effect)
   



;22/Apr/25 07:03;githubbot;600","stoty commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2053465860


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1877,6 +1879,17 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     
     Default: **true** (3.9.0+), **false** (3.8.x)
 
+##### Cipher handling changes
+
+From 3.5.5 to 3.9 a hard coded default cipher list was used, with the ordering
+dependent on whether it is run Java 8 or a later version.
+
+In 3.9 the list on Java 8 is: *TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256, TLS_CHACHA20_POLY1305_SHA256*
+
+In 3.10 the list on Java 8 is: *TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256, TLS_CHACHA20_POLY1305_SHA256*

Review Comment:
   That's not what I meant to document, but your version is probably more relevant.



;22/Apr/25 07:06;githubbot;600","stoty commented on PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#issuecomment-2820294896

   > I left some comments about the doc and opened [stoty#1](https://github.com/stoty/zookeeper/pull/1) for suggetions.
   > 
   > The rest looks good.
   
   Thanks, added your changes @kezhuw .


;22/Apr/25 07:07;githubbot;600","kezhuw commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2054278734


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1738,7 +1739,7 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     (Java system properties: **zookeeper.ssl.ciphersuites** and **zookeeper.ssl.quorum.ciphersuites**)
     **New in 3.5.5:**
     Specifies the enabled cipher suites to be used in client and quorum TLS negotiation.
-    Default: Enabled cipher suites depend on the Java runtime version being used.
+    Default: JVM defaults since 3.10.0, and hard coded cipher suites for 3.9 and earlier versions. See [TLS Cipher Suites](#sc_tls_cipher_suites).

Review Comment:
   ```suggestion
       Default: JDK defaults since 3.10.0, and hard coded cipher suites for 3.9 and earlier versions. See [TLS Cipher Suites](#sc_tls_cipher_suites).
   ```
   
   Sounds like it should be ""JDK"" here.



;22/Apr/25 14:45;githubbot;600","kezhuw commented on code in PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#discussion_r2078797537


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1877,6 +1878,19 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     
     Default: **true** (3.9.0+), **false** (3.8.x)
 
+<a name=""sc_tls_cipher_suites""></a>
+
+##### TLS Cipher Suites
+
+From 3.5.5 to 3.9 a hard coded default cipher list was used, with the ordering
+dependent on whether it is run Java 8 or a later version.
+
+The list on Java 8 includes TLSv1.2 CBC, GCM and TLSv1.3 ciphers in ordering: *TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256, TLS_CHACHA20_POLY1305_SHA256*
+
+The list on Java 9+ includes TLSv1.2 GCM, CBC and TLSv1.3 ciphers in ordering: *TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256, TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_AES_256_GCM_SHA384,TLS_AES_128_GCM_SHA256, TLS_CHACHA20_POLY1305_SHA256*
+
+Since 3.10 there is no hardcoded list, and the JVM defaults are used.

Review Comment:
   ```suggestion
   Since 3.10 there is no hardcoded list, and the JDK defaults are used.
   ```



;08/May/25 02:48;githubbot;600","kezhuw merged PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239


;11/May/25 02:16;githubbot;600","kezhuw commented on PR #2239:
URL: https://github.com/apache/zookeeper/pull/2239#issuecomment-2869355048

   Merged. @stoty Thank you for taking care of this!
   
   cc @cnauroth @anmolnar 


;11/May/25 02:30;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,0,12600,,,0,12600,,,,,,,,,,OMID-305,ZOOKEEPER-4415,HBASE-29403,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Sun May 11 02:16:49 UTC 2025,,,,,,,,,,"0|z1uytc:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"11/May/25 02:16;kezhuw;Issue resolved by pull request 2239
[https://github.com/apache/zookeeper/pull/2239];;;",,,,,,,,,,,
"When a spurious wakeup occurs, the client’s waiting time may exceed requestTimeout.",ZOOKEEPER-4909,13612228,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,luozongle01,luozongle01,luozongle01,18/Mar/25 15:42,29/Aug/25 21:29,08/Dec/25 08:12,25/Mar/25 00:45,,,,,,,,,3.10.0,3.8.5,3.9.4,java client,,,,0,pull-request-available,,,I noticed that a while loop is used here to avoid spurious wakeups. I think we should calculate the total sleep time to prevent it from exceeding requestTimeout too much in case of spurious wakeups and the server not responding for a long time.,,"luozongle01 opened a new pull request, #2237:
URL: https://github.com/apache/zookeeper/pull/2237

   Modify client wait time: https://issues.apache.org/jira/browse/ZOOKEEPER-4909


;18/Mar/25 15:52;githubbot;600","kezhuw commented on code in PR #2237:
URL: https://github.com/apache/zookeeper/pull/2237#discussion_r2008796107


##########
zookeeper-server/src/test/java/org/apache/zookeeper/ClientRequestTimeoutTest.java:
##########
@@ -94,6 +99,90 @@ public void testClientRequestTimeout() throws Exception {
         }
     }
 
+    @Test
+    void testClientRequestTimeoutSpuriousWakeup() throws Exception {
+        Long requestTimeout = 2000L;
+        System.setProperty(""zookeeper.request.timeout"", requestTimeout.toString());
+        final int[] clientPorts = new int[SERVER_COUNT];
+        StringBuilder sb = new StringBuilder();
+        String server;
+
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            clientPorts[i] = PortAssignment.unique();
+            server = ""server."" + i + ""=127.0.0.1:"" + PortAssignment.unique() + "":"" + PortAssignment.unique()
+                    + "":participant;127.0.0.1:"" + clientPorts[i];
+            sb.append(server + ""\n"");
+        }
+        String currentQuorumCfgSection = sb.toString();
+        MainThread[] mt = new MainThread[SERVER_COUNT];
+
+        for (int i = 0; i < SERVER_COUNT; i++) {

Review Comment:
   Do we need a cluster for this test ? Is a standalone server enough ?



##########
zookeeper-server/src/test/java/org/apache/zookeeper/ClientRequestTimeoutTest.java:
##########
@@ -94,6 +99,90 @@ public void testClientRequestTimeout() throws Exception {
         }
     }
 
+    @Test
+    void testClientRequestTimeoutSpuriousWakeup() throws Exception {
+        Long requestTimeout = 2000L;
+        System.setProperty(""zookeeper.request.timeout"", requestTimeout.toString());
+        final int[] clientPorts = new int[SERVER_COUNT];
+        StringBuilder sb = new StringBuilder();
+        String server;
+
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            clientPorts[i] = PortAssignment.unique();
+            server = ""server."" + i + ""=127.0.0.1:"" + PortAssignment.unique() + "":"" + PortAssignment.unique()
+                    + "":participant;127.0.0.1:"" + clientPorts[i];
+            sb.append(server + ""\n"");
+        }
+        String currentQuorumCfgSection = sb.toString();
+        MainThread[] mt = new MainThread[SERVER_COUNT];
+
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            mt[i] = new MainThread(i, clientPorts[i], currentQuorumCfgSection, false);
+            mt[i].start();
+        }
+
+        // ensure server started
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            assertTrue(ClientBase.waitForServerUp(""127.0.0.1:"" + clientPorts[i], CONNECTION_TIMEOUT),
+                    ""waiting for server "" + i + "" being up"");
+        }
+
+        CountdownWatcher watch1 = new CountdownWatcher();
+        CustomZooKeeper zk = new CustomZooKeeper(getCxnString(clientPorts), ClientBase.CONNECTION_TIMEOUT, watch1);
+        watch1.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
+
+
+        ReplyHeader r = new ReplyHeader();
+        ClientCnxn.Packet packet = new ClientCnxn.Packet(null, null, null, null, null);
+        ClientCnxn clientCnxn = zk.getClientCnxn();
+
+        // Simulate spurious wakeup.
+        new Thread(() -> {
+            try {
+                TimeUnit.MILLISECONDS.sleep(1500);
+            } catch (InterruptedException e) {
+                throw new RuntimeException(e);
+            }
+            synchronized (packet) {
+                packet.notifyAll();
+            }
+        }).start();
+
+        long startTime = System.currentTimeMillis();

Review Comment:
   Use `Time.currentElapsedTime` here also ?



##########
zookeeper-server/src/test/java/org/apache/zookeeper/ClientRequestTimeoutTest.java:
##########
@@ -94,6 +99,90 @@ public void testClientRequestTimeout() throws Exception {
         }
     }
 
+    @Test
+    void testClientRequestTimeoutSpuriousWakeup() throws Exception {
+        Long requestTimeout = 2000L;
+        System.setProperty(""zookeeper.request.timeout"", requestTimeout.toString());
+        final int[] clientPorts = new int[SERVER_COUNT];
+        StringBuilder sb = new StringBuilder();
+        String server;
+
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            clientPorts[i] = PortAssignment.unique();
+            server = ""server."" + i + ""=127.0.0.1:"" + PortAssignment.unique() + "":"" + PortAssignment.unique()
+                    + "":participant;127.0.0.1:"" + clientPorts[i];
+            sb.append(server + ""\n"");
+        }
+        String currentQuorumCfgSection = sb.toString();
+        MainThread[] mt = new MainThread[SERVER_COUNT];
+
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            mt[i] = new MainThread(i, clientPorts[i], currentQuorumCfgSection, false);
+            mt[i].start();
+        }
+
+        // ensure server started
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            assertTrue(ClientBase.waitForServerUp(""127.0.0.1:"" + clientPorts[i], CONNECTION_TIMEOUT),
+                    ""waiting for server "" + i + "" being up"");
+        }
+
+        CountdownWatcher watch1 = new CountdownWatcher();
+        CustomZooKeeper zk = new CustomZooKeeper(getCxnString(clientPorts), ClientBase.CONNECTION_TIMEOUT, watch1);
+        watch1.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
+
+
+        ReplyHeader r = new ReplyHeader();
+        ClientCnxn.Packet packet = new ClientCnxn.Packet(null, null, null, null, null);
+        ClientCnxn clientCnxn = zk.getClientCnxn();
+
+        // Simulate spurious wakeup.
+        new Thread(() -> {
+            try {
+                TimeUnit.MILLISECONDS.sleep(1500);
+            } catch (InterruptedException e) {
+                throw new RuntimeException(e);
+            }
+            synchronized (packet) {
+                packet.notifyAll();
+            }
+        }).start();
+
+        long startTime = System.currentTimeMillis();
+        synchronized (packet) {
+            invokeMethod(clientCnxn, ""waitForPacketFinish"", r, packet);

Review Comment:
   Is it possible to hang somewhere to simulate request timeout with possible large session timeout value instead of intercept this internal method?



;22/Mar/25 15:35;githubbot;600","luozongle01 commented on code in PR #2237:
URL: https://github.com/apache/zookeeper/pull/2237#discussion_r2008993866


##########
zookeeper-server/src/test/java/org/apache/zookeeper/ClientRequestTimeoutTest.java:
##########
@@ -94,6 +99,90 @@ public void testClientRequestTimeout() throws Exception {
         }
     }
 
+    @Test
+    void testClientRequestTimeoutSpuriousWakeup() throws Exception {
+        Long requestTimeout = 2000L;
+        System.setProperty(""zookeeper.request.timeout"", requestTimeout.toString());
+        final int[] clientPorts = new int[SERVER_COUNT];
+        StringBuilder sb = new StringBuilder();
+        String server;
+
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            clientPorts[i] = PortAssignment.unique();
+            server = ""server."" + i + ""=127.0.0.1:"" + PortAssignment.unique() + "":"" + PortAssignment.unique()
+                    + "":participant;127.0.0.1:"" + clientPorts[i];
+            sb.append(server + ""\n"");
+        }
+        String currentQuorumCfgSection = sb.toString();
+        MainThread[] mt = new MainThread[SERVER_COUNT];
+
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            mt[i] = new MainThread(i, clientPorts[i], currentQuorumCfgSection, false);
+            mt[i].start();
+        }
+
+        // ensure server started
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            assertTrue(ClientBase.waitForServerUp(""127.0.0.1:"" + clientPorts[i], CONNECTION_TIMEOUT),
+                    ""waiting for server "" + i + "" being up"");
+        }
+
+        CountdownWatcher watch1 = new CountdownWatcher();
+        CustomZooKeeper zk = new CustomZooKeeper(getCxnString(clientPorts), ClientBase.CONNECTION_TIMEOUT, watch1);
+        watch1.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
+
+
+        ReplyHeader r = new ReplyHeader();
+        ClientCnxn.Packet packet = new ClientCnxn.Packet(null, null, null, null, null);
+        ClientCnxn clientCnxn = zk.getClientCnxn();
+
+        // Simulate spurious wakeup.
+        new Thread(() -> {
+            try {
+                TimeUnit.MILLISECONDS.sleep(1500);
+            } catch (InterruptedException e) {
+                throw new RuntimeException(e);
+            }
+            synchronized (packet) {
+                packet.notifyAll();
+            }
+        }).start();
+
+        long startTime = System.currentTimeMillis();

Review Comment:
   Yes, I neglected it.



;23/Mar/25 02:22;githubbot;600","luozongle01 commented on code in PR #2237:
URL: https://github.com/apache/zookeeper/pull/2237#discussion_r2008993898


##########
zookeeper-server/src/test/java/org/apache/zookeeper/ClientRequestTimeoutTest.java:
##########
@@ -94,6 +99,90 @@ public void testClientRequestTimeout() throws Exception {
         }
     }
 
+    @Test
+    void testClientRequestTimeoutSpuriousWakeup() throws Exception {
+        Long requestTimeout = 2000L;
+        System.setProperty(""zookeeper.request.timeout"", requestTimeout.toString());
+        final int[] clientPorts = new int[SERVER_COUNT];
+        StringBuilder sb = new StringBuilder();
+        String server;
+
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            clientPorts[i] = PortAssignment.unique();
+            server = ""server."" + i + ""=127.0.0.1:"" + PortAssignment.unique() + "":"" + PortAssignment.unique()
+                    + "":participant;127.0.0.1:"" + clientPorts[i];
+            sb.append(server + ""\n"");
+        }
+        String currentQuorumCfgSection = sb.toString();
+        MainThread[] mt = new MainThread[SERVER_COUNT];
+
+        for (int i = 0; i < SERVER_COUNT; i++) {

Review Comment:
   Yeah, I'll edit this.



;23/Mar/25 02:22;githubbot;600","luozongle01 commented on code in PR #2237:
URL: https://github.com/apache/zookeeper/pull/2237#discussion_r2008994000


##########
zookeeper-server/src/test/java/org/apache/zookeeper/ClientRequestTimeoutTest.java:
##########
@@ -94,6 +99,90 @@ public void testClientRequestTimeout() throws Exception {
         }
     }
 
+    @Test
+    void testClientRequestTimeoutSpuriousWakeup() throws Exception {
+        Long requestTimeout = 2000L;
+        System.setProperty(""zookeeper.request.timeout"", requestTimeout.toString());
+        final int[] clientPorts = new int[SERVER_COUNT];
+        StringBuilder sb = new StringBuilder();
+        String server;
+
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            clientPorts[i] = PortAssignment.unique();
+            server = ""server."" + i + ""=127.0.0.1:"" + PortAssignment.unique() + "":"" + PortAssignment.unique()
+                    + "":participant;127.0.0.1:"" + clientPorts[i];
+            sb.append(server + ""\n"");
+        }
+        String currentQuorumCfgSection = sb.toString();
+        MainThread[] mt = new MainThread[SERVER_COUNT];
+
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            mt[i] = new MainThread(i, clientPorts[i], currentQuorumCfgSection, false);
+            mt[i].start();
+        }
+
+        // ensure server started
+        for (int i = 0; i < SERVER_COUNT; i++) {
+            assertTrue(ClientBase.waitForServerUp(""127.0.0.1:"" + clientPorts[i], CONNECTION_TIMEOUT),
+                    ""waiting for server "" + i + "" being up"");
+        }
+
+        CountdownWatcher watch1 = new CountdownWatcher();
+        CustomZooKeeper zk = new CustomZooKeeper(getCxnString(clientPorts), ClientBase.CONNECTION_TIMEOUT, watch1);
+        watch1.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
+
+
+        ReplyHeader r = new ReplyHeader();
+        ClientCnxn.Packet packet = new ClientCnxn.Packet(null, null, null, null, null);
+        ClientCnxn clientCnxn = zk.getClientCnxn();
+
+        // Simulate spurious wakeup.
+        new Thread(() -> {
+            try {
+                TimeUnit.MILLISECONDS.sleep(1500);
+            } catch (InterruptedException e) {
+                throw new RuntimeException(e);
+            }
+            synchronized (packet) {
+                packet.notifyAll();
+            }
+        }).start();
+
+        long startTime = System.currentTimeMillis();
+        synchronized (packet) {
+            invokeMethod(clientCnxn, ""waitForPacketFinish"", r, packet);

Review Comment:
   Makes sense, I'll edit it.



;23/Mar/25 02:23;githubbot;600","luozongle01 commented on PR #2237:
URL: https://github.com/apache/zookeeper/pull/2237#issuecomment-2745980687

   Hi @kezhuw , I've made some changes. Could you help me check it again?


;23/Mar/25 02:42;githubbot;600","kezhuw commented on code in PR #2237:
URL: https://github.com/apache/zookeeper/pull/2237#discussion_r2009001042


##########
zookeeper-server/src/test/java/org/apache/zookeeper/ClientRequestTimeoutTest.java:
##########
@@ -94,6 +102,105 @@ public void testClientRequestTimeout() throws Exception {
         }
     }
 
+    @Test
+    void testClientRequestTimeoutTime() throws Exception {
+        long requestTimeout = TimeUnit.SECONDS.toMillis(5);
+        System.setProperty(""zookeeper.request.timeout"", Long.toString(requestTimeout));
+
+        CustomZooKeeper zk = null;
+        int clientPort = PortAssignment.unique();
+        MainThread mainThread = new MainThread(0, clientPort, """", false);
+        mainThread.start();
+        try {
+            assertTrue(ClientBase.waitForServerUp(""127.0.0.1:"" + clientPort, CONNECTION_TIMEOUT),
+                    ""waiting for server 0 being up"");
+
+            CountdownWatcher watch = new CountdownWatcher();
+            zk = new CustomZooKeeper(getCxnString(new int[]{clientPort}), ClientBase.CONNECTION_TIMEOUT, watch);
+            watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
+
+            dropPacket = true;
+            dropPacketType = ZooDefs.OpCode.create;
+
+            String data = ""originalData"";
+            long startTime = Time.currentElapsedTime();
+            try {
+                zk.create(""/testClientRequestTimeout"", data.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT_SEQUENTIAL);
+                fail(""KeeperException is expected."");
+            } catch (KeeperException exception) {
+                long cost = Time.currentElapsedTime() - startTime;
+                assertEquals(KeeperException.Code.REQUESTTIMEOUT.intValue(), exception.code().intValue());
+                LOG.info(""testClientRequestTimeoutTime cost:{}"", cost);
+                assertTrue(cost >= requestTimeout);
+                assertTrue(cost < requestTimeout + 500);
+            }
+        } finally {
+            mainThread.shutdown();
+            if (zk != null) {
+                zk.close();
+            }
+        }
+    }
+
+
+    @Test
+    void testClientRequestTimeoutTimeSimulatingSpuriousWakeup() throws Exception {
+        long requestTimeout = TimeUnit.SECONDS.toMillis(5);
+        System.setProperty(""zookeeper.request.timeout"", Long.toString(requestTimeout));
+
+        CustomZooKeeper zk = null;
+        int clientPort = PortAssignment.unique();
+        MainThread mainThread = new MainThread(0, clientPort, """", false);
+        mainThread.start();
+        try {
+            assertTrue(ClientBase.waitForServerUp(""127.0.0.1:"" + clientPort, CONNECTION_TIMEOUT),
+                    ""waiting for server 0 being up"");
+
+            CountdownWatcher watch = new CountdownWatcher();
+            zk = new CustomZooKeeper(getCxnString(new int[]{clientPort}), ClientBase.CONNECTION_TIMEOUT, watch);
+            watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
+
+            dropPacket = true;
+            dropPacketType = ZooDefs.OpCode.create;
+            capturePacket = true;
+            capturePacketType = ZooDefs.OpCode.create;
+
+            // Simulating spurious wakeup
+            new Thread(() -> {
+                try {
+                    TimeUnit.SECONDS.sleep(4);
+                    if (capturedPacket != null) {
+                        synchronized (capturedPacket) {
+                            capturedPacket.notifyAll();
+                        }
+                    }
+                } catch (InterruptedException e) {
+                    throw new RuntimeException(e);
+                }
+            }).start();
+
+            String data = ""originalData"";
+            long startTime = Time.currentElapsedTime();
+            try {
+                zk.create(""/testClientRequestTimeout"", data.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT_SEQUENTIAL);
+                fail(""KeeperException is expected."");
+            } catch (KeeperException exception) {
+                long cost = Time.currentElapsedTime() - startTime;
+                assertEquals(KeeperException.Code.REQUESTTIMEOUT.intValue(), exception.code().intValue());
+                LOG.info(""testClientRequestTimeoutTimeSimulatingSpuriousWakeup cost:{}"", cost);
+                assertTrue(cost >= requestTimeout);
+                assertTrue(cost < requestTimeout + 500);

Review Comment:
   ```suggestion
                   assertThat(cost, greaterThanOrEqualTo(requestTimeout));
                   assertThat(cost, lessThan(requestTimeout + 500));
   ```
   
   Same as above.



##########
zookeeper-server/src/test/java/org/apache/zookeeper/ClientRequestTimeoutTest.java:
##########
@@ -94,6 +102,105 @@ public void testClientRequestTimeout() throws Exception {
         }
     }
 
+    @Test
+    void testClientRequestTimeoutTime() throws Exception {
+        long requestTimeout = TimeUnit.SECONDS.toMillis(5);
+        System.setProperty(""zookeeper.request.timeout"", Long.toString(requestTimeout));
+
+        CustomZooKeeper zk = null;
+        int clientPort = PortAssignment.unique();
+        MainThread mainThread = new MainThread(0, clientPort, """", false);
+        mainThread.start();
+        try {
+            assertTrue(ClientBase.waitForServerUp(""127.0.0.1:"" + clientPort, CONNECTION_TIMEOUT),
+                    ""waiting for server 0 being up"");
+
+            CountdownWatcher watch = new CountdownWatcher();
+            zk = new CustomZooKeeper(getCxnString(new int[]{clientPort}), ClientBase.CONNECTION_TIMEOUT, watch);
+            watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
+
+            dropPacket = true;
+            dropPacketType = ZooDefs.OpCode.create;
+
+            String data = ""originalData"";
+            long startTime = Time.currentElapsedTime();
+            try {
+                zk.create(""/testClientRequestTimeout"", data.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT_SEQUENTIAL);
+                fail(""KeeperException is expected."");
+            } catch (KeeperException exception) {
+                long cost = Time.currentElapsedTime() - startTime;
+                assertEquals(KeeperException.Code.REQUESTTIMEOUT.intValue(), exception.code().intValue());
+                LOG.info(""testClientRequestTimeoutTime cost:{}"", cost);
+                assertTrue(cost >= requestTimeout);
+                assertTrue(cost < requestTimeout + 500);

Review Comment:
   ```suggestion
                   assertThat(cost, greaterThanOrEqualTo(requestTimeout));
                   assertThat(cost, lessThan(requestTimeout + 500));
   ```
   
   In rare(a.k.a. flaky or debug) cases, it gives us more comparing to `assertEquals`.



##########
zookeeper-server/src/test/java/org/apache/zookeeper/ClientRequestTimeoutTest.java:
##########
@@ -94,6 +102,105 @@ public void testClientRequestTimeout() throws Exception {
         }
     }
 
+    @Test
+    void testClientRequestTimeoutTime() throws Exception {
+        long requestTimeout = TimeUnit.SECONDS.toMillis(5);
+        System.setProperty(""zookeeper.request.timeout"", Long.toString(requestTimeout));
+
+        CustomZooKeeper zk = null;
+        int clientPort = PortAssignment.unique();
+        MainThread mainThread = new MainThread(0, clientPort, """", false);
+        mainThread.start();
+        try {
+            assertTrue(ClientBase.waitForServerUp(""127.0.0.1:"" + clientPort, CONNECTION_TIMEOUT),
+                    ""waiting for server 0 being up"");
+
+            CountdownWatcher watch = new CountdownWatcher();
+            zk = new CustomZooKeeper(getCxnString(new int[]{clientPort}), ClientBase.CONNECTION_TIMEOUT, watch);
+            watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
+
+            dropPacket = true;
+            dropPacketType = ZooDefs.OpCode.create;
+
+            String data = ""originalData"";
+            long startTime = Time.currentElapsedTime();
+            try {
+                zk.create(""/testClientRequestTimeout"", data.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT_SEQUENTIAL);
+                fail(""KeeperException is expected."");
+            } catch (KeeperException exception) {
+                long cost = Time.currentElapsedTime() - startTime;
+                assertEquals(KeeperException.Code.REQUESTTIMEOUT.intValue(), exception.code().intValue());

Review Comment:
   ```suggestion
                   assertEquals(KeeperException.Code.REQUESTTIMEOUT, exception.code());
   ```



##########
zookeeper-server/src/test/java/org/apache/zookeeper/ClientRequestTimeoutTest.java:
##########
@@ -94,6 +102,105 @@ public void testClientRequestTimeout() throws Exception {
         }
     }
 
+    @Test
+    void testClientRequestTimeoutTime() throws Exception {
+        long requestTimeout = TimeUnit.SECONDS.toMillis(5);
+        System.setProperty(""zookeeper.request.timeout"", Long.toString(requestTimeout));
+
+        CustomZooKeeper zk = null;
+        int clientPort = PortAssignment.unique();
+        MainThread mainThread = new MainThread(0, clientPort, """", false);
+        mainThread.start();
+        try {
+            assertTrue(ClientBase.waitForServerUp(""127.0.0.1:"" + clientPort, CONNECTION_TIMEOUT),
+                    ""waiting for server 0 being up"");
+
+            CountdownWatcher watch = new CountdownWatcher();
+            zk = new CustomZooKeeper(getCxnString(new int[]{clientPort}), ClientBase.CONNECTION_TIMEOUT, watch);
+            watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
+
+            dropPacket = true;
+            dropPacketType = ZooDefs.OpCode.create;
+
+            String data = ""originalData"";
+            long startTime = Time.currentElapsedTime();
+            try {
+                zk.create(""/testClientRequestTimeout"", data.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT_SEQUENTIAL);
+                fail(""KeeperException is expected."");
+            } catch (KeeperException exception) {
+                long cost = Time.currentElapsedTime() - startTime;
+                assertEquals(KeeperException.Code.REQUESTTIMEOUT.intValue(), exception.code().intValue());
+                LOG.info(""testClientRequestTimeoutTime cost:{}"", cost);
+                assertTrue(cost >= requestTimeout);
+                assertTrue(cost < requestTimeout + 500);
+            }
+        } finally {
+            mainThread.shutdown();
+            if (zk != null) {
+                zk.close();
+            }
+        }
+    }
+
+
+    @Test
+    void testClientRequestTimeoutTimeSimulatingSpuriousWakeup() throws Exception {
+        long requestTimeout = TimeUnit.SECONDS.toMillis(5);
+        System.setProperty(""zookeeper.request.timeout"", Long.toString(requestTimeout));
+
+        CustomZooKeeper zk = null;
+        int clientPort = PortAssignment.unique();
+        MainThread mainThread = new MainThread(0, clientPort, """", false);
+        mainThread.start();
+        try {
+            assertTrue(ClientBase.waitForServerUp(""127.0.0.1:"" + clientPort, CONNECTION_TIMEOUT),
+                    ""waiting for server 0 being up"");
+
+            CountdownWatcher watch = new CountdownWatcher();
+            zk = new CustomZooKeeper(getCxnString(new int[]{clientPort}), ClientBase.CONNECTION_TIMEOUT, watch);
+            watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
+
+            dropPacket = true;
+            dropPacketType = ZooDefs.OpCode.create;
+            capturePacket = true;
+            capturePacketType = ZooDefs.OpCode.create;
+
+            // Simulating spurious wakeup
+            new Thread(() -> {
+                try {
+                    TimeUnit.SECONDS.sleep(4);

Review Comment:
   ```suggestion
                       TimeUnit.MILLISECONDS.sleep(requestTimeout / 2);
   ```
   
   Make the bound to `requestTimeout` explicit.



##########
zookeeper-server/src/test/java/org/apache/zookeeper/ClientRequestTimeoutTest.java:
##########
@@ -94,6 +102,105 @@ public void testClientRequestTimeout() throws Exception {
         }
     }
 
+    @Test
+    void testClientRequestTimeoutTime() throws Exception {
+        long requestTimeout = TimeUnit.SECONDS.toMillis(5);
+        System.setProperty(""zookeeper.request.timeout"", Long.toString(requestTimeout));
+
+        CustomZooKeeper zk = null;
+        int clientPort = PortAssignment.unique();
+        MainThread mainThread = new MainThread(0, clientPort, """", false);
+        mainThread.start();
+        try {
+            assertTrue(ClientBase.waitForServerUp(""127.0.0.1:"" + clientPort, CONNECTION_TIMEOUT),
+                    ""waiting for server 0 being up"");
+
+            CountdownWatcher watch = new CountdownWatcher();
+            zk = new CustomZooKeeper(getCxnString(new int[]{clientPort}), ClientBase.CONNECTION_TIMEOUT, watch);
+            watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
+
+            dropPacket = true;
+            dropPacketType = ZooDefs.OpCode.create;
+
+            String data = ""originalData"";
+            long startTime = Time.currentElapsedTime();
+            try {
+                zk.create(""/testClientRequestTimeout"", data.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT_SEQUENTIAL);
+                fail(""KeeperException is expected."");
+            } catch (KeeperException exception) {
+                long cost = Time.currentElapsedTime() - startTime;
+                assertEquals(KeeperException.Code.REQUESTTIMEOUT.intValue(), exception.code().intValue());
+                LOG.info(""testClientRequestTimeoutTime cost:{}"", cost);
+                assertTrue(cost >= requestTimeout);
+                assertTrue(cost < requestTimeout + 500);
+            }
+        } finally {
+            mainThread.shutdown();
+            if (zk != null) {
+                zk.close();
+            }
+        }
+    }
+
+
+    @Test
+    void testClientRequestTimeoutTimeSimulatingSpuriousWakeup() throws Exception {
+        long requestTimeout = TimeUnit.SECONDS.toMillis(5);
+        System.setProperty(""zookeeper.request.timeout"", Long.toString(requestTimeout));
+
+        CustomZooKeeper zk = null;
+        int clientPort = PortAssignment.unique();
+        MainThread mainThread = new MainThread(0, clientPort, """", false);
+        mainThread.start();
+        try {
+            assertTrue(ClientBase.waitForServerUp(""127.0.0.1:"" + clientPort, CONNECTION_TIMEOUT),
+                    ""waiting for server 0 being up"");
+
+            CountdownWatcher watch = new CountdownWatcher();
+            zk = new CustomZooKeeper(getCxnString(new int[]{clientPort}), ClientBase.CONNECTION_TIMEOUT, watch);
+            watch.waitForConnected(ClientBase.CONNECTION_TIMEOUT);
+
+            dropPacket = true;
+            dropPacketType = ZooDefs.OpCode.create;
+            capturePacket = true;
+            capturePacketType = ZooDefs.OpCode.create;
+
+            // Simulating spurious wakeup
+            new Thread(() -> {
+                try {
+                    TimeUnit.SECONDS.sleep(4);
+                    if (capturedPacket != null) {
+                        synchronized (capturedPacket) {
+                            capturedPacket.notifyAll();
+                        }
+                    }
+                } catch (InterruptedException e) {
+                    throw new RuntimeException(e);
+                }
+            }).start();
+
+            String data = ""originalData"";
+            long startTime = Time.currentElapsedTime();
+            try {
+                zk.create(""/testClientRequestTimeout"", data.getBytes(), Ids.OPEN_ACL_UNSAFE, CreateMode.PERSISTENT_SEQUENTIAL);
+                fail(""KeeperException is expected."");
+            } catch (KeeperException exception) {
+                long cost = Time.currentElapsedTime() - startTime;
+                assertEquals(KeeperException.Code.REQUESTTIMEOUT.intValue(), exception.code().intValue());

Review Comment:
   ```suggestion
                   assertEquals(KeeperException.Code.REQUESTTIMEOUT, exception.code());
   ```



;23/Mar/25 03:34;githubbot;600","luozongle01 commented on PR #2237:
URL: https://github.com/apache/zookeeper/pull/2237#issuecomment-2746049230

   Hi @kezhuw , I have completed the modification, can you take a look at it again?


;23/Mar/25 06:32;githubbot;600","cnauroth closed pull request #2237: ZOOKEEPER-4909: Fix exceeded request timeout in case of spurious wakeup
URL: https://github.com/apache/zookeeper/pull/2237


;25/Mar/25 00:41;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,5400,,,0,5400,,,,,,,,,,,,,,,,,,,"18/Mar/25 13:39;luozongle01;Snipaste_2025-03-18_21-35-42.png;https://issues.apache.org/jira/secure/attachment/13075489/Snipaste_2025-03-18_21-35-42.png",,,,,,1.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,Reviewed,,,Java,,2025-03-18 15:42:14.0,,,,,,,,,,"0|z1uudk:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
"Shouldn't throw ""Len error"" when server closing cause confusion",ZOOKEEPER-4907,13612043,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,fujian1115,fujian1115,fujian1115,17/Mar/25 09:56,29/Aug/25 21:29,08/Dec/25 08:12,25/Mar/25 10:40,,,,,,,,,3.10.0,3.9.4,,server,,,,0,pull-request-available,,,"We got the error:
 
{code:java}
2024-11-07 19:03:01,414 [myid:14] - WARN [nioEventLoopGroup-7-25:NettyServerCnxn@537] - Closing connection to /135.224.186.250:47051


java.io.IOException: Len error 794913900
at org.apache.zookeeper.server.NettyServerCnxn.receiveMessage(NettyServerCnxn.java:521)
at org.apache.zookeeper.server.NettyServerCnxn.processMessage(NettyServerCnxn.java:374)
at org.apache.zookeeper.server.NettyServerCnxnFactory$CnxnChannelHandler.channelRead(NettyServerCnxnFactory.java:357)
at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)
at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)
at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead
 {code}
It cause us very confused about it : if we write some big data into zookeeper. Thus. we found, in actual. it is just the log/issue when closing the server when reelecting the leader sometime. We don't send any big data.
So I think we can do one tiny code change to avoid throw the error which causing confuse with big size's data to reduce trouble shooting effort.",,"jiafu1115 opened a new pull request, #2236:
URL: https://github.com/apache/zookeeper/pull/2236

   Refer to [ZOOKEEPER-4907](https://issues.apache.org/jira/browse/ZOOKEEPER-4907)
   
   We got the error:
   
   2024-11-07 19:03:01,414 [myid:14] - WARN [nioEventLoopGroup-7-25:NettyServerCnxn@537] - Closing connection to /135.224.186.250:47051
   java.io.IOException: **Len error** 794913900
   at org.apache.zookeeper.server.NettyServerCnxn.receiveMessage(NettyServerCnxn.java:521)
   at org.apache.zookeeper.server.NettyServerCnxn.processMessage(NettyServerCnxn.java:374)
   at org.apache.zookeeper.server.NettyServerCnxnFactory$CnxnChannelHandler.channelRead(NettyServerCnxnFactory.java:357)
   at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:379)
   at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:365)
   at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead
   
   It cause us very confused about it whether we write some big data into zookeeper. Thus. After trouble shooting, we found that it is just the log/issue when closing the server caused by reelecting the leader sometimes. In actually. We don't send any big data.
   
   So I think we can do one tiny code change to avoid throw the error which causing confusion to reduce trouble shooting effort.


;17/Mar/25 10:09;githubbot;600","jiafu1115 commented on PR #2236:
URL: https://github.com/apache/zookeeper/pull/2236#issuecomment-2728913907

   the root cause for the error throw is cause by:
   when closing the server. the follow code don't have chance to get executed.
     bb = ByteBuffer.allocate(len); 
   so the remain message (body) will be taken as the head msg again and parsed again for the header. 
   the body length is not right now. sometimes it over the max size.
   So I move the server status check before the length check.


;17/Mar/25 10:13;githubbot;600","kezhuw commented on PR #2236:
URL: https://github.com/apache/zookeeper/pull/2236#issuecomment-2746005109

   > The root cause for the error throw is caused by follow logic:
   when closing the server. the follow code don't have chance to get executed:
   bb = ByteBuffer.allocate(len); //line 552
   so the remain message (body) will be taken as the head msg again and parsed again as the header.
   then body length is not right now. sometimes it over the max size.
   So I move the server status check before the length check.
   
   Seems that there are multiple incoming packets during server close. Since `processMessage` is called sequential in event loop thread, I would suggest to guard against `closingChannel` before decoding the packet inside `processMessage`. That is we should not even reading the packet.


;23/Mar/25 03:55;githubbot;600","jiafu1115 commented on PR #2236:
URL: https://github.com/apache/zookeeper/pull/2236#issuecomment-2747282001

   @kezhuw thanks for comment. I update the code according to your suggestion. You can help to double check. thanks


;24/Mar/25 08:28;githubbot;600","jiafu1115 commented on PR #2236:
URL: https://github.com/apache/zookeeper/pull/2236#issuecomment-2747493642

   test fail? no relationshiop with this commit? 
   08:43:08  [ERROR] Tests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 4.045 s <<< FAILURE! - in org.apache.zookeeper.server.admin.RestoreQuorumTest
   08:43:08  [ERROR] testRestoreAfterQuorumLost  Time elapsed: 3.805 s  <<< ERROR!
   08:43:08  java.net.ConnectException: Connection refused (Connection refused)
   08:43:08  	at java.net.PlainSocketImpl.socketConnect(Native Method)
   08:43:08  	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)
   08:43:08  	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)
   08:43:08  	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)
   08:43:08  	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)
   08:43:08  	at java.net.Socket.connect(Socket.java:607)
   08:43:08  	at java.net.Socket.connect(Socket.java:556)
   08:43:08  	at java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:480)
   08:43:08  	at org.apache.zookeeper.server.admin.SnapshotAndRestoreCommandTest.takeSnapshotAndValidate(SnapshotAndRestoreCommandTest.java:413)
   08:43:08  	at org.apache.zookeeper.server.admin.RestoreQuorumTest.testRestoreAfterQuorumLost(RestoreQuorumTest.java:56)


;24/Mar/25 09:43;githubbot;600","kezhuw commented on code in PR #2236:
URL: https://github.com/apache/zookeeper/pull/2236#discussion_r2010479529


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/NettyServerCnxn.java:
##########
@@ -366,7 +366,12 @@ private void appendToQueuedBuffer(ByteBuf buf) {
     void processMessage(ByteBuf buf) {
         checkIsInEventLoop(""processMessage"");
         LOG.debug(""0x{} queuedBuffer: {}"", Long.toHexString(sessionId), queuedBuffer);
-
+        
+        if (closingChannel) {
+            LOG.info(""Closing connection to {}"", getRemoteSocketAddress());
+            return;
+        }
+        

Review Comment:
   ```suggestion
   
           if (closingChannel) {
               LOG.debug(""Drop incoming message during connection closing for session 0x{}"", Long.toHexString(sessionId));
               return;
           }
   
   ```
   
   I am not sure `getRemoteSocketAddress` is safe after channel closed. Also, postmortem log probably don't deserve `LOG.info`.
   
   Connection is closing, any postmortem



;24/Mar/25 16:03;githubbot;600","kezhuw commented on code in PR #2236:
URL: https://github.com/apache/zookeeper/pull/2236#discussion_r2010479529


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/NettyServerCnxn.java:
##########
@@ -366,7 +366,12 @@ private void appendToQueuedBuffer(ByteBuf buf) {
     void processMessage(ByteBuf buf) {
         checkIsInEventLoop(""processMessage"");
         LOG.debug(""0x{} queuedBuffer: {}"", Long.toHexString(sessionId), queuedBuffer);
-
+        
+        if (closingChannel) {
+            LOG.info(""Closing connection to {}"", getRemoteSocketAddress());
+            return;
+        }
+        

Review Comment:
   ```suggestion
   
           if (closingChannel) {
               LOG.debug(""Drop incoming message during connection closing for session 0x{}"", Long.toHexString(sessionId));
               return;
           }
   
   ```
   
   I am not sure `getRemoteSocketAddress` is safe after channel closed. Also, postmortem log probably don't deserve `LOG.info`.



;24/Mar/25 16:06;githubbot;600","kezhuw merged PR #2236:
URL: https://github.com/apache/zookeeper/pull/2236


;25/Mar/25 10:39;githubbot;600","kezhuw commented on PR #2236:
URL: https://github.com/apache/zookeeper/pull/2236#issuecomment-2750833641

   @jiafu1115 Thank you for your contribution! Merged to master and backported to branch-3.9.


;25/Mar/25 10:42;githubbot;600","jiafu1115 commented on PR #2236:
URL: https://github.com/apache/zookeeper/pull/2236#issuecomment-2757762116

   > @jiafu1115 Thank you for your contribution! Merged to master and backported to branch-3.9.
   
   Thanks ! It is my pleasure ! @kezhuw @tisonkun 


;27/Mar/25 11:51;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,6000,,,0,6000,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Tue Mar 25 10:40:38 UTC 2025,,,,,,,,,,"0|z1ut8g:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"17/Mar/25 10:10;fujian1115;[https://github.com/apache/zookeeper/pull/2236]
attach the PR. ;;;","25/Mar/25 10:40;kezhuw;Issue resolved by pull request 2236
[https://github.com/apache/zookeeper/pull/2236];;;",,,,,,,,,,
Log full exception details for server JAAS config failure,ZOOKEEPER-4906,13611795,,Improvement,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,cnauroth,cnauroth,cnauroth,14/Mar/25 03:56,29/Aug/25 21:29,08/Dec/25 08:12,26/Mar/25 19:58,3.8.4,3.9.3,,,,,,,3.10.0,3.8.5,3.9.4,server,,,,0,pull-request-available,,,"For a server configured with SASL authentication, startup can fail due to failures loading the JAAS configuration file. ZooKeeper doesn't log the details of the failure though, which makes it difficult to troubleshoot. We can improve this by logging the full root cause exception.",,"cnauroth opened a new pull request, #2234:
URL: https://github.com/apache/zookeeper/pull/2234

   (no comment)


;14/Mar/25 03:57;githubbot;600","cnauroth commented on PR #2234:
URL: https://github.com/apache/zookeeper/pull/2234#issuecomment-2725101077

   It looks like there was an unrelated test failure.


;14/Mar/25 15:54;githubbot;600","cnauroth commented on PR #2234:
URL: https://github.com/apache/zookeeper/pull/2234#issuecomment-2752725095

   @kezhuw , thank you for reviewing.
   
   @anmolnar , @eolivelli or @tisonkun , may I request one more code review from one of you?


;25/Mar/25 22:57;githubbot;600","cnauroth commented on PR #2234:
URL: https://github.com/apache/zookeeper/pull/2234#issuecomment-2753170512

   It looks like the last CI run had an unrelated failure again. Thanks for the reviews, everyone! I'm planning to commit soon.


;26/Mar/25 03:50;githubbot;600","anmolnar commented on PR #2234:
URL: https://github.com/apache/zookeeper/pull/2234#issuecomment-2755191794

   > It looks like the last CI run had an unrelated failure again. Thanks for the reviews, everyone! I'm planning to commit soon.
   
   I keep trying to get a green build. Tbh as long as Jenkins CI is happy, I'm happy too.


;26/Mar/25 17:31;githubbot;600","cnauroth closed pull request #2234: ZOOKEEPER-4906: Log full exception details for server JAAS config failure
URL: https://github.com/apache/zookeeper/pull/2234


;26/Mar/25 19:55;githubbot;600","cnauroth commented on PR #2234:
URL: https://github.com/apache/zookeeper/pull/2234#issuecomment-2755615099

   I committed this to master, branch-3.9 and branch-3.8. Thank you for the reviews, @kezhuw , @tisonkun and @anmolnar .


;26/Mar/25 19:58;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,4200,,,0,4200,,,,,,,,,,,,,,,ZOOKEEPER-3743,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,Reviewed,,,,,2025-03-14 03:56:03.0,,,,,,,,,,"0|z1urpc:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Document that read-only mode also enables isro 4lw,ZOOKEEPER-4902,13610954,,Improvement,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,cnauroth,cnauroth,cnauroth,06/Mar/25 22:50,29/Aug/25 21:29,08/Dec/25 08:12,12/Mar/25 21:25,3.8.4,3.9.3,,,,,,,3.10.0,3.8.5,3.9.4,documentation,,,,0,pull-request-available,,,"ZooKeeper admin docs state that the 4lw white list only contains ""srvr"" by default. However, if read-only mode is enabled, then this implicitly also adds the ""isro"" command to the whitelist. Update documentation to mention this.",,"cnauroth opened a new pull request, #2231:
URL: https://github.com/apache/zookeeper/pull/2231

   (no comment)


;06/Mar/25 22:52;githubbot;600","cnauroth commented on PR #2231:
URL: https://github.com/apache/zookeeper/pull/2231#issuecomment-2705120101

   Code reference showing where this is done:
   
   https://github.com/apache/zookeeper/blob/master/zookeeper-server/src/main/java/org/apache/zookeeper/server/command/FourLetterCommands.java#L217-L219


;06/Mar/25 22:54;githubbot;600","cnauroth commented on PR #2231:
URL: https://github.com/apache/zookeeper/pull/2231#issuecomment-2715118762

   @anmolnar , @eolivelli , @tisonkun , are any of you available for a code review of this small documentation change? Thank you.


;11/Mar/25 17:13;githubbot;600","cnauroth closed pull request #2231: ZOOKEEPER-4902: Document that read-only mode also enables isro 4lw
URL: https://github.com/apache/zookeeper/pull/2231


;12/Mar/25 21:21;githubbot;600","cnauroth commented on PR #2231:
URL: https://github.com/apache/zookeeper/pull/2231#issuecomment-2719167310

   I have committed this to master, branch-3.9 and branch-3.8. Thank you for the reviews, @tisonkun and @kezhuw .


;12/Mar/25 21:25;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3000,,,0,3000,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,Reviewed,,,,,2025-03-06 22:50:09.0,,,,,,,,,,"0|z1umig:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Correct logback license information on master branch.,ZOOKEEPER-4901,13610222,,Task,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,cnauroth,cnauroth,cnauroth,28/Feb/25 22:21,01/Mar/25 01:27,08/Dec/25 08:12,01/Mar/25 01:25,,,,,,,,,3.10.0,,,license,,,,0,pull-request-available,,,The last few Logback upgrades on the master branch missed updating the license files. Update them to match the current dependency version: 1.3.15.,,"cnauroth opened a new pull request, #2229:
URL: https://github.com/apache/zookeeper/pull/2229

   (no comment)


;28/Feb/25 22:24;githubbot;600","cnauroth commented on PR #2229:
URL: https://github.com/apache/zookeeper/pull/2229#issuecomment-2691651166

   @anmolnar and @tisonkun , would you please review? Thank you!


;28/Feb/25 22:26;githubbot;600","tisonkun merged PR #2229:
URL: https://github.com/apache/zookeeper/pull/2229


;01/Mar/25 01:24;githubbot;600","cnauroth commented on PR #2229:
URL: https://github.com/apache/zookeeper/pull/2229#issuecomment-2691816292

   Thanks very much, @tisonkun !


;01/Mar/25 01:27;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Sat Mar 01 01:25:24 UTC 2025,,,,,,,,,,"0|z1uiew:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"01/Mar/25 01:25;tison;master via https://github.com/apache/zookeeper/pull/2229;;;",,,,,,,,,,,
Bump patch release of jetty to include CVE fix for CVE-2024-6763,ZOOKEEPER-4900,13610204,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,pfcoperez,cnauroth,cnauroth,28/Feb/25 21:39,29/Aug/25 21:29,08/Dec/25 08:12,09/Apr/25 07:58,3.8.4,3.9.3,,,,,,,3.10.0,3.8.5,3.9.4,build,,,,0,pull-request-available,,,Jetty 9.4.57.v20241219 contains the fix for CVE-2024-6763. We can update the ZooKeeper dependency.,,"pfcoperez commented on PR #2220:
URL: https://github.com/apache/zookeeper/pull/2220#issuecomment-2696818817

   > Hello @pfcoperez . Thank you for the patch. Since [CVE-2024-6763](https://github.com/advisories/GHSA-qh8g-58pp-2wxh) is now fixed, can you please remove the suppression from the OWASP configuration?
   > 
   > https://github.com/apache/zookeeper/blob/master/owaspSuppressions.xml#L21-L25
   > 
   > CC: @anmolnar who previously worked on #2202 .
   
   Thanks you @cnauroth , sure I'll do it.  


;04/Mar/25 09:35;githubbot;600","pfcoperez commented on PR #2220:
URL: https://github.com/apache/zookeeper/pull/2220#issuecomment-2697904701

   > @pfcoperez , can you also please update all of the Jetty license files listed here?
   > 
   > https://github.com/apache/zookeeper/tree/master/zookeeper-server/src/main/resources/lib
   > 
   > Run `git mv` commands to rename the files from ""9.4.53.v20231009.LICENSE.txt"" to ""9.4.57.v20241219.LICENSE.txt"". The contents of the files won't need to change.
   
   Done in 28bffa27435a034edea5c42bdfc1b2d917a3724a


;04/Mar/25 14:48;githubbot;600","pfcoperez commented on PR #2220:
URL: https://github.com/apache/zookeeper/pull/2220#issuecomment-2697906029

   > > Hello @pfcoperez . Thank you for the patch. Since [CVE-2024-6763](https://github.com/advisories/GHSA-qh8g-58pp-2wxh) is now fixed, can you please remove the suppression from the OWASP configuration?
   > > https://github.com/apache/zookeeper/blob/master/owaspSuppressions.xml#L21-L25
   > > CC: @anmolnar who previously worked on #2202 .
   > 
   > Thanks you @cnauroth , sure I'll do it.
   
   Done in f6e3af3ab792858187240b959dcc870116cbf9b0


;04/Mar/25 14:49;githubbot;600","pfcoperez commented on PR #2220:
URL: https://github.com/apache/zookeeper/pull/2220#issuecomment-2700550833

   > +1. I'll wait for one more committer to review and +1 before I commit.
   > 
   
   Thank you @cnauroth !
   
   > Thank you for this patch, @pfcoperez ! I would like to assign [ZOOKEEPER-4900](https://issues.apache.org/jira/browse/ZOOKEEPER-4900) to you for proper tracking of the effort. Do you have an ASF JIRA account? If not, you can request one here:
   > 
   > https://selfserve.apache.org/jira-account.html
   > 
   > Let me know your ASF JIRA ID, and I can assign the bug.
   
   I do have a  Jira account. My user id is `pfcoperez` and I think the account ID is `JIRAUSER281850`.
   


;05/Mar/25 10:48;githubbot;600","cnauroth commented on PR #2220:
URL: https://github.com/apache/zookeeper/pull/2220#issuecomment-2702062831

   @pfcoperez , great! I assigned the issue.


;05/Mar/25 20:58;githubbot;600","pfcoperez commented on PR #2220:
URL: https://github.com/apache/zookeeper/pull/2220#issuecomment-2760781941

   @cnauroth Sorry for the direct ping, I am abusing the fact that you took the time and effort of reviewing this PR. Do you think there is something else I can do to help moving this change forward :pray: ? 
   
   Thank you again for all your time and help/


;28/Mar/25 09:58;githubbot;600","cnauroth commented on PR #2220:
URL: https://github.com/apache/zookeeper/pull/2220#issuecomment-2766730098

   > @cnauroth Sorry for the direct ping, I am abusing the fact that you took the time and effort of reviewing this PR. Do you think there is something else I can do to help moving this change forward 🙏 ?
   > 
   > Thank you again for all your time and help.
   
   Hello @pfcoperez . Sorry for the delay. On ZooKeeper, we aim for two +1s from committers before committing changes. I'll try directly asking a few other committers: @anmolnar , @eolivelli , @tisonkun , @kezhuw .


;31/Mar/25 16:15;githubbot;600","pfcoperez commented on PR #2220:
URL: https://github.com/apache/zookeeper/pull/2220#issuecomment-2768703679

   Thank you folks :bow: Should I back-port 3.9 branch too?  


;01/Apr/25 09:11;githubbot;600","pfcoperez opened a new pull request, #2242:
URL: https://github.com/apache/zookeeper/pull/2242

   This is a backport PR for https://github.com/apache/zookeeper/pull/2220 addressing https://issues.apache.org/jira/browse/ZOOKEEPER-4900 in branch-3.9.
   
   


;02/Apr/25 13:01;githubbot;600","pfcoperez commented on PR #2220:
URL: https://github.com/apache/zookeeper/pull/2220#issuecomment-2772494771

   This is the backport PR to branch-3.9 


;02/Apr/25 13:01;githubbot;600","kezhuw merged PR #2220:
URL: https://github.com/apache/zookeeper/pull/2220


;09/Apr/25 07:57;githubbot;600","kezhuw closed pull request #2242: ZOOKEEPER-4900: (Backport) Bump patch release of jetty to include CVE fix for CVE-2024-6763 #2220
URL: https://github.com/apache/zookeeper/pull/2242


;09/Apr/25 08:00;githubbot;600","kezhuw commented on PR #2242:
URL: https://github.com/apache/zookeeper/pull/2242#issuecomment-2788703153

   @pfcoperez Thank you for contribution! Backported in df4599083fae483f8c055b6871fdac1b0d2e76c3.


;09/Apr/25 08:00;githubbot;600","anmolnar opened a new pull request, #2286:
URL: https://github.com/apache/zookeeper/pull/2286

   Another one to make **owasp** happy again.


;30/Jul/25 20:54;githubbot;600","anmolnar merged PR #2286:
URL: https://github.com/apache/zookeeper/pull/2286


;31/Jul/25 20:45;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,9000,,,0,9000,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Apr 09 07:58:51 UTC 2025,,,,,,,,,,"0|z1uiaw:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"02/Apr/25 13:17;pfcoperez;Backport to branch-3.9: [https://github.com/apache/zookeeper/pull/2242];;;","09/Apr/25 07:58;kezhuw;Issue resolved by pull request 2220
[https://github.com/apache/zookeeper/pull/2220];;;",,,,,,,,,,
The incorrect usage of the subclass of ZooKeeperThread leads to the failure of exception handling,ZOOKEEPER-4898,13609807,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Trivial,Fixed,,zlatan628,zlatan628,26/Feb/25 01:49,28/Feb/25 16:02,08/Dec/25 08:12,28/Feb/25 16:02,,,,,,,,,3.10.0,,,leaderElection,,,,0,pull-request-available,,,"WorkerSender inherits from ZooKeeperThread. When using WorkerSender, a WorkerSender thread is created first, followed by the creation of a new thread where WorkerSender is passed as a task. At this point, the ExceptionHandler in ZooKeeperThread does not take effect.  !image-2025-02-26-09-48-32-165.png!!image-2025-02-26-09-43-37-299.png!",all operating system,"ZLATAN628 opened a new pull request, #2228:
URL: https://github.com/apache/zookeeper/pull/2228

   WorkerSender inherits from ZooKeeperThread. When using WorkerSender, a WorkerSender thread is created first, followed by the creation of a new thread where WorkerSender is passed as a task. At this point, the ExceptionHandler in ZooKeeperThread does not take effect.


;26/Feb/25 01:54;githubbot;600","kezhuw commented on code in PR #2228:
URL: https://github.com/apache/zookeeper/pull/2228#discussion_r1974830580


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/FastLeaderElection.java:
##########
@@ -485,8 +485,8 @@ class WorkerSender extends ZooKeeperThread {
             volatile boolean stop;
             QuorumCnxManager manager;
 
-            WorkerSender(QuorumCnxManager manager) {
-                super(""WorkerSender"");
+            WorkerSender(QuorumCnxManager manager, String threadName) {
+                super(threadName);

Review Comment:
   How about change LOG.info(""WorkerSender is down""); to LOG.info(""{} is down"", getName()); ?
   



##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/FastLeaderElection.java:
##########
@@ -223,8 +223,8 @@ class WorkerReceiver extends ZooKeeperThread {
             volatile boolean stop;
             QuorumCnxManager manager;
 
-            WorkerReceiver(QuorumCnxManager manager) {
-                super(""WorkerReceiver"");
+            WorkerReceiver(QuorumCnxManager manager, String threadName) {
+                super(threadName);

Review Comment:
   How about change `LOG.info(""WorkerReceiver is down"");` to `LOG.info(""{} is down"", getName());` ?



;28/Feb/25 06:03;githubbot;600","ZLATAN628 commented on code in PR #2228:
URL: https://github.com/apache/zookeeper/pull/2228#discussion_r1974910644


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/FastLeaderElection.java:
##########
@@ -223,8 +223,8 @@ class WorkerReceiver extends ZooKeeperThread {
             volatile boolean stop;
             QuorumCnxManager manager;
 
-            WorkerReceiver(QuorumCnxManager manager) {
-                super(""WorkerReceiver"");
+            WorkerReceiver(QuorumCnxManager manager, String threadName) {
+                super(threadName);

Review Comment:
   You are right, I didn’t notice that.



;28/Feb/25 07:04;githubbot;600","tisonkun merged PR #2228:
URL: https://github.com/apache/zookeeper/pull/2228


;28/Feb/25 16:01;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,,,,,,,,,,,,,,,,,"26/Feb/25 01:43;zlatan628;image-2025-02-26-09-43-37-299.png;https://issues.apache.org/jira/secure/attachment/13075007/image-2025-02-26-09-43-37-299.png","26/Feb/25 01:48;zlatan628;image-2025-02-26-09-48-32-165.png;https://issues.apache.org/jira/secure/attachment/13075006/image-2025-02-26-09-48-32-165.png",,,,,2.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Feb 28 16:02:06 UTC 2025,,,,,,,,,,"0|z1ufuo:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"26/Feb/25 01:56;zlatan628;I have submitted a Pull Request #2228 , and I hope it will be helpful.;;;","28/Feb/25 16:02;tison;master via https://github.com/apache/zookeeper/pull/2228;;;",,,,,,,,,,
Upgrade Netty to fix CVE-2025-24970 in ZooKeeper 3.9.3,ZOOKEEPER-4897,13609486,,Task,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,jimqin,jimqin,jimqin,23/Feb/25 15:03,29/Aug/25 21:29,08/Dec/25 08:12,18/Mar/25 18:44,,,,,,,,,3.10.0,3.8.5,3.9.4,,,,,0,pull-request-available,,,"h3. *Details of the Issue*
 * {*}CVE ID{*}: [CVE-2025-24970|https://nvd.nist.gov/vuln/detail/CVE-2025-24970] 

 * {*}Affected ZooKeeper Version{*}: 3.9.3

 * {*}Vulnerable Dependency{*}: Netty 4.1.113

 * {*}Impact{*}: When a special crafted packet is received via SslHandler it doesn't correctly handle validation of such a packet in all cases which can lead to a native crash.

 * {*}Fix{*}: Upgrade Netty to *4.1.118.Final* (or the version addressing this CVE).",,"helloworld28 opened a new pull request, #2225:
URL: https://github.com/apache/zookeeper/pull/2225

   (no comment)


;24/Feb/25 10:06;githubbot;600","helloworld28 closed pull request #2225: ZOOKEEPER-4897 Upgrade Netty to 4.1.118.Final for fix CVE-2025-24970 
URL: https://github.com/apache/zookeeper/pull/2225


;24/Feb/25 10:34;githubbot;600","helloworld28 opened a new pull request, #2226:
URL: https://github.com/apache/zookeeper/pull/2226

   (no comment)


;24/Feb/25 10:39;githubbot;600","tisonkun commented on PR #2226:
URL: https://github.com/apache/zookeeper/pull/2226#issuecomment-2682143913

   @helloworld28 I noticed that this patch is against branch-3.9. Shall we apply for master also?


;25/Feb/25 14:22;githubbot;600","helloworld28 commented on PR #2226:
URL: https://github.com/apache/zookeeper/pull/2226#issuecomment-2682269393

   > @helloworld28 I noticed that this patch is against branch-3.9. Shall we apply for master also?
   
   OK, I will create another branch and PR for master, as current branch is based on branch-3.9, right?


;25/Feb/25 14:56;githubbot;600","tisonkun commented on PR #2226:
URL: https://github.com/apache/zookeeper/pull/2226#issuecomment-2682332593

   Yes, correct.


;25/Feb/25 15:14;githubbot;600","helloworld28 commented on PR #2226:
URL: https://github.com/apache/zookeeper/pull/2226#issuecomment-2684562229

   > Yes, correct.
   I have created another [PR ](https://github.com/apache/zookeeper/pull/2227)for master, could you help review it together? BTW, may I know when we will have a new version ? 


;26/Feb/25 10:31;githubbot;600","eolivelli commented on PR #2227:
URL: https://github.com/apache/zookeeper/pull/2227#issuecomment-2690189451

   Can you please update (just rename) the License files?


;28/Feb/25 09:43;githubbot;600","tisonkun commented on PR #2227:
URL: https://github.com/apache/zookeeper/pull/2227#issuecomment-2690196040

   @eolivelli where is the file? I may forget it and I can't find it now.


;28/Feb/25 09:45;githubbot;600","tisonkun commented on PR #2227:
URL: https://github.com/apache/zookeeper/pull/2227#issuecomment-2691836382

   Thanks for pointing this out @cnauroth!
   
   I've pushed a new commit to fix it, as well as adopting @kezhuw's suggestion to use 4.1.119.Final.


;01/Mar/25 01:56;githubbot;600","tisonkun merged PR #2227:
URL: https://github.com/apache/zookeeper/pull/2227


;02/Mar/25 00:30;githubbot;600","tisonkun commented on PR #2227:
URL: https://github.com/apache/zookeeper/pull/2227#issuecomment-2692488958

   Thanks for your review @cnauroth! You may take a look at the backport PR https://github.com/apache/zookeeper/pull/2226 also.
   
   Thank @helloworld28 for your contribution!


;02/Mar/25 00:32;githubbot;600","zack-johnson5455 commented on PR #2226:
URL: https://github.com/apache/zookeeper/pull/2226#issuecomment-2715416839

   Any ETA on this PR getting merged and released? Running 3.9.3 and would love to able to avoid reports of this CVE


;11/Mar/25 18:59;githubbot;600","cnauroth merged PR #2226:
URL: https://github.com/apache/zookeeper/pull/2226


;11/Mar/25 19:22;githubbot;600","cnauroth commented on PR #2226:
URL: https://github.com/apache/zookeeper/pull/2226#issuecomment-2715468963

   @zack-johnson5455 , thanks for the comment. I didn't realize this one was still waiting to get merged to branch-3.9. I have done that now.
   
   There is no timeline established yet for a new 3.9 release. I recommend watching the dev@zookeeper.apache.org mailing list for updates.


;11/Mar/25 19:24;githubbot;600","cnauroth commented on PR #2227:
URL: https://github.com/apache/zookeeper/pull/2227#issuecomment-2715477699

   @helloworld28 , do you have an ASF JIRA ID? Can you please let me know it, so I can assign [ZOOKEEPER-4897](https://issues.apache.org/jira/browse/ZOOKEEPER-4897) and close it? If you don't have an ID, you can request one here:
   
   https://selfserve.apache.org/jira-account.html
   
   Please mention that you fixed ZOOKEEPER-4897 in the request.
   
   Thank you.


;11/Mar/25 19:28;githubbot;600","helloworld28 commented on PR #2227:
URL: https://github.com/apache/zookeeper/pull/2227#issuecomment-2721163435

   > @helloworld28 , do you have an ASF JIRA ID? Can you please let me know it, so I can assign [ZOOKEEPER-4897](https://issues.apache.org/jira/browse/ZOOKEEPER-4897) and close it? If you don't have an ID, you can request one here:
   > 
   > https://selfserve.apache.org/jira-account.html
   > 
   > Please mention that you fixed [ZOOKEEPER-4897](https://issues.apache.org/jira/browse/ZOOKEEPER-4897) in the request.
   > 
   > Thank you.
   
   thanks for merging this PR, I already have a ASF account, the JIRA is created by me, you can assign it to me


;13/Mar/25 12:55;githubbot;600","helloworld28 commented on PR #2227:
URL: https://github.com/apache/zookeeper/pull/2227#issuecomment-2724465493

   > @helloworld28 , do you have an ASF JIRA ID? Can you please let me know it, so I can assign [ZOOKEEPER-4897](https://issues.apache.org/jira/browse/ZOOKEEPER-4897) and close it? If you don't have an ID, you can request one here:
   > 
   > https://selfserve.apache.org/jira-account.html
   > 
   > Please mention that you fixed [ZOOKEEPER-4897](https://issues.apache.org/jira/browse/ZOOKEEPER-4897) in the request.
   > 
   > Thank you.
   
   
   
   > > @helloworld28 , do you have an ASF JIRA ID? Can you please let me know it, so I can assign [ZOOKEEPER-4897](https://issues.apache.org/jira/browse/ZOOKEEPER-4897) and close it? If you don't have an ID, you can request one here:
   > > https://selfserve.apache.org/jira-account.html
   > > Please mention that you fixed [ZOOKEEPER-4897](https://issues.apache.org/jira/browse/ZOOKEEPER-4897) in the request.
   > > Thank you.
   > 
   > thanks for merging this PR, I already have a ASF account, the JIRA is created by me, you can assign it to me
   
   @cnauroth could you help assign the the task to me(jimqin)? let me close it


;14/Mar/25 11:57;githubbot;600","cnauroth commented on PR #2227:
URL: https://github.com/apache/zookeeper/pull/2227#issuecomment-2734373774

   @helloworld28 , I assigned the JIRA issue and closed it. Thank you again!


;18/Mar/25 18:44;githubbot;600","anmolnar opened a new pull request, #2285:
URL: https://github.com/apache/zookeeper/pull/2285

   Second patch to upgrade Netty to latest **4.1.119.Final**.
   Fixes licenses files as well.


;30/Jul/25 18:51;githubbot;600","anmolnar merged PR #2285:
URL: https://github.com/apache/zookeeper/pull/2285


;31/Jul/25 18:36;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,0,12600,,,0,12600,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,Reviewed,,,,,Sun May 25 04:35:19 UTC 2025,,,,,,,,,,"0|z1udvc:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"14/Mar/25 11:55;jimqin;The issue has been resolved, and waiting for the new version ;;;","14/May/25 04:57;dpramod;[~jimqin] Could you please let me know the expected release date for ZooKeeper 3.9.4?;;;","25/May/25 04:35;jimqin;[~dpramod] I have asked the main zookeeper contributor for this, no expected release date for 3.9.4 for now ;;;",,,,,,,,,
Introduce a helper function for C client to generate password for SASL authentication,ZOOKEEPER-4895,13607832,,New Feature,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,wangdan,wangdan,wangdan,08/Feb/25 04:21,29/Aug/25 21:28,08/Dec/25 08:12,25/Mar/25 10:13,,,,,,,,,3.10.0,3.9.4,,c client,security,,,0,pull-request-available,,,"C client has provided zoo_sasl_make_basic_callbacks() function to help users initialize SASL callbacks with the password in the specified file. The client would use this password directly for SASL authentication.

However, considering the security of the production environment, the password in a file is usually encrypted. Also, security software also scans files in the system and will issue an alert if it detects an unencrypted password. Therefore, we need a mechanism to read the encrypted text from the file and decrypt it to obtain the real password.

To achieve this, a helper function is introduced to decrypt the encrypted text in the file using a user-provided custom callback. A handback object is also introduced to provide necessary information for the decryption.",,"empiredan opened a new pull request, #2223:
URL: https://github.com/apache/zookeeper/pull/2223

   C client has provided zoo_sasl_make_basic_callbacks() function to help users initialize SASL callbacks with the password in the specified file. The client would use this password directly for SASL authentication.
   
   However, considering the security of the production environment, the password in a file is usually encrypted. Also, security software also scans files in the system and will issue an alert if it detects an unencrypted password. Therefore, we need a mechanism to read the encrypted text from the file and decrypt it to obtain the real password.
   
   To achieve this, a helper function is introduced to decrypt the encrypted text in the file using a user-provided custom callback. A handback object is also introduced to provide necessary information for the decryption.


;08/Feb/25 04:23;githubbot;600","empiredan commented on PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223#issuecomment-2656334222

   Hi @ztzg @kezhuw please help review the code, much appreciated !


;13/Feb/25 11:39;githubbot;600","cnauroth commented on code in PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223#discussion_r1989809880


##########
zookeeper-client/zookeeper-client-c/src/zk_sasl.c:
##########
@@ -451,41 +453,87 @@ struct zsasl_secret_ctx {
 static int _zsasl_getsecret(sasl_conn_t *conn, void *context, int id,
                             sasl_secret_t **psecret)
 {
+    const size_t MAX_PASSWORD_LEN = 1023;
     struct zsasl_secret_ctx *secret_ctx = (struct zsasl_secret_ctx *)context;
-    char buf[1024];
-    char *password;
-    size_t len;
+    char buf[MAX_PASSWORD_LEN + 1];
+    char *password = NULL;
+    size_t len = 0;
+    int res = 0;
+    char new_passwd[MAX_PASSWORD_LEN + 1];
+    char *p = NULL;
     sasl_secret_t *x;
 
     /* paranoia check */
-    if (!conn || !psecret || id != SASL_CB_PASS)
+    if (!conn || !psecret || id != SASL_CB_PASS) {
         return SASL_BADPARAM;
+    }
 
     if (secret_ctx->password_file) {
-        char *p;
         FILE *fh = fopen(secret_ctx->password_file, ""rt"");
-        if (!fh)
+        if (!fh) {
             return SASL_FAIL;
+        }
 
-        if (!fgets(buf, sizeof(buf), fh)) {
+        /*
+         * The file's content may be the encrypted password with binary characters,
+         * thus use fread().
+         */
+        len = fread(buf, sizeof(buf[0]), MAX_PASSWORD_LEN, fh);
+        if (ferror(fh)) {
             fclose(fh);
             return SASL_FAIL;
         }
 
         fclose(fh);
+        fh = NULL;
+
+        /*
+         * Write the null terminator immediately after the last character of the
+         * content since it would be used as a null-terminated string once it is
+         * the actual password.
+         */
+        buf[len] = '\0';
+        password = buf;
+    }
 
-        p = strrchr(buf, '\n');
-        if (p)
-            *p = '\0';
+    if (secret_ctx->callback) {
+        if (!password) {
+            /*
+             * The callback takes effect only when password_file is provided.
+             */
+            return SASL_BADPARAM;
+        }
 
-        password = buf;
+        res = secret_ctx->callback(password, len, secret_ctx->context,
+            new_passwd, sizeof(new_passwd));
+        if (res != SASL_OK) {
+            return res;
+        }
+
+        memset(password, 0, len);
+
+        password = new_passwd;
+    } else if (secret_ctx->password_file) {
+        /*
+         * The file's content is the actual password, which must consist only of
+         * text characters (i.e., without null terminator). The first line would
+         * be read as the password once there are multiple lines in the file.
+         */
+        p = strchr(password, '\n');

Review Comment:
   I think there is a subtle change in behavior here from `strrchr` (find last occurrence) to `strchr` (find first occurrence). Is my understanding correct? This doesn't seem to be directly related to the new callback functionality, but it seems like a good bug fix.



##########
zookeeper-client/zookeeper-client-c/CMakeLists.txt:
##########
@@ -249,6 +249,7 @@ set(test_sources
   tests/ThreadingUtil.cc
   tests/TestZookeeperInit.cc
   tests/TestZookeeperClose.cc
+  tests/TestSASLAuth.cc

Review Comment:
   Great catch! This test suite has not been running regularly in our CI.



##########
zookeeper-client/zookeeper-client-c/src/zk_sasl.c:
##########
@@ -451,41 +453,87 @@ struct zsasl_secret_ctx {
 static int _zsasl_getsecret(sasl_conn_t *conn, void *context, int id,
                             sasl_secret_t **psecret)
 {
+    const size_t MAX_PASSWORD_LEN = 1023;
     struct zsasl_secret_ctx *secret_ctx = (struct zsasl_secret_ctx *)context;
-    char buf[1024];
-    char *password;
-    size_t len;
+    char buf[MAX_PASSWORD_LEN + 1];
+    char *password = NULL;
+    size_t len = 0;
+    int res = 0;
+    char new_passwd[MAX_PASSWORD_LEN + 1];
+    char *p = NULL;
     sasl_secret_t *x;
 
     /* paranoia check */
-    if (!conn || !psecret || id != SASL_CB_PASS)
+    if (!conn || !psecret || id != SASL_CB_PASS) {
         return SASL_BADPARAM;
+    }
 
     if (secret_ctx->password_file) {
-        char *p;
         FILE *fh = fopen(secret_ctx->password_file, ""rt"");
-        if (!fh)
+        if (!fh) {
             return SASL_FAIL;
+        }
 
-        if (!fgets(buf, sizeof(buf), fh)) {
+        /*
+         * The file's content may be the encrypted password with binary characters,
+         * thus use fread().
+         */
+        len = fread(buf, sizeof(buf[0]), MAX_PASSWORD_LEN, fh);
+        if (ferror(fh)) {
             fclose(fh);
             return SASL_FAIL;
         }
 
         fclose(fh);
+        fh = NULL;

Review Comment:
   Is this line necessary? It seems like `fh` is unused after this and will go out of scope.



;11/Mar/25 17:47;githubbot;600","empiredan commented on code in PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223#discussion_r1997890812


##########
zookeeper-client/zookeeper-client-c/src/zk_sasl.c:
##########
@@ -451,41 +453,87 @@ struct zsasl_secret_ctx {
 static int _zsasl_getsecret(sasl_conn_t *conn, void *context, int id,
                             sasl_secret_t **psecret)
 {
+    const size_t MAX_PASSWORD_LEN = 1023;
     struct zsasl_secret_ctx *secret_ctx = (struct zsasl_secret_ctx *)context;
-    char buf[1024];
-    char *password;
-    size_t len;
+    char buf[MAX_PASSWORD_LEN + 1];
+    char *password = NULL;
+    size_t len = 0;
+    int res = 0;
+    char new_passwd[MAX_PASSWORD_LEN + 1];
+    char *p = NULL;
     sasl_secret_t *x;
 
     /* paranoia check */
-    if (!conn || !psecret || id != SASL_CB_PASS)
+    if (!conn || !psecret || id != SASL_CB_PASS) {
         return SASL_BADPARAM;
+    }
 
     if (secret_ctx->password_file) {
-        char *p;
         FILE *fh = fopen(secret_ctx->password_file, ""rt"");
-        if (!fh)
+        if (!fh) {
             return SASL_FAIL;
+        }
 
-        if (!fgets(buf, sizeof(buf), fh)) {
+        /*
+         * The file's content may be the encrypted password with binary characters,
+         * thus use fread().
+         */
+        len = fread(buf, sizeof(buf[0]), MAX_PASSWORD_LEN, fh);
+        if (ferror(fh)) {
             fclose(fh);
             return SASL_FAIL;
         }
 
         fclose(fh);
+        fh = NULL;

Review Comment:
   Indeed, as you mentioned, since the `fh` pointer will no longer be used later, there is no need to assign it to `null`. The reason for handling it this way is to prevent [**dangling pointer**](https://en.wikipedia.org/wiki/Dangling_pointer) issues; for example, we have similar handling in other parts of our code:  https://github.com/apache/zookeeper/blame/master/zookeeper-client/zookeeper-client-c/src/zk_sasl.c#L541.



;17/Mar/25 03:48;githubbot;600","empiredan commented on code in PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223#discussion_r1997890950


##########
zookeeper-client/zookeeper-client-c/src/zk_sasl.c:
##########
@@ -451,41 +453,87 @@ struct zsasl_secret_ctx {
 static int _zsasl_getsecret(sasl_conn_t *conn, void *context, int id,
                             sasl_secret_t **psecret)
 {
+    const size_t MAX_PASSWORD_LEN = 1023;
     struct zsasl_secret_ctx *secret_ctx = (struct zsasl_secret_ctx *)context;
-    char buf[1024];
-    char *password;
-    size_t len;
+    char buf[MAX_PASSWORD_LEN + 1];
+    char *password = NULL;
+    size_t len = 0;
+    int res = 0;
+    char new_passwd[MAX_PASSWORD_LEN + 1];
+    char *p = NULL;
     sasl_secret_t *x;
 
     /* paranoia check */
-    if (!conn || !psecret || id != SASL_CB_PASS)
+    if (!conn || !psecret || id != SASL_CB_PASS) {
         return SASL_BADPARAM;
+    }
 
     if (secret_ctx->password_file) {
-        char *p;
         FILE *fh = fopen(secret_ctx->password_file, ""rt"");
-        if (!fh)
+        if (!fh) {
             return SASL_FAIL;
+        }
 
-        if (!fgets(buf, sizeof(buf), fh)) {
+        /*
+         * The file's content may be the encrypted password with binary characters,
+         * thus use fread().
+         */
+        len = fread(buf, sizeof(buf[0]), MAX_PASSWORD_LEN, fh);
+        if (ferror(fh)) {
             fclose(fh);
             return SASL_FAIL;
         }
 
         fclose(fh);
+        fh = NULL;
+
+        /*
+         * Write the null terminator immediately after the last character of the
+         * content since it would be used as a null-terminated string once it is
+         * the actual password.
+         */
+        buf[len] = '\0';
+        password = buf;
+    }
 
-        p = strrchr(buf, '\n');
-        if (p)
-            *p = '\0';
+    if (secret_ctx->callback) {
+        if (!password) {
+            /*
+             * The callback takes effect only when password_file is provided.
+             */
+            return SASL_BADPARAM;
+        }
 
-        password = buf;
+        res = secret_ctx->callback(password, len, secret_ctx->context,
+            new_passwd, sizeof(new_passwd));
+        if (res != SASL_OK) {
+            return res;
+        }
+
+        memset(password, 0, len);
+
+        password = new_passwd;
+    } else if (secret_ctx->password_file) {
+        /*
+         * The file's content is the actual password, which must consist only of
+         * text characters (i.e., without null terminator). The first line would
+         * be read as the password once there are multiple lines in the file.
+         */
+        p = strchr(password, '\n');

Review Comment:
   You understood it very accurately! The reason for this modification is mainly based on the comment in https://github.com/apache/zookeeper/blame/master/zookeeper-client/zookeeper-client-c/include/zookeeper.h#L661:  
   `\param password_file the name of a file whose first line is read in response to \c SASL_CB_PASS, or NULL for none.`
   Therefore, I replaced `strrchr` with `strchr`.  
   
   Do you think this modification is appropriate? If so, should I open a new pull request as a bug fix?



;17/Mar/25 03:48;githubbot;600","empiredan commented on PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223#issuecomment-2728057511

   > @empiredan , thank you for the patch. I entered just a few minor comments.
   
   @cnauroth Thank you so much for taking the time to review the code! I have tried to respond to your comments, and I’d be happy to continue the discussion if you have any further questions.


;17/Mar/25 03:51;githubbot;600","cnauroth commented on code in PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223#discussion_r2001790171


##########
zookeeper-client/zookeeper-client-c/src/zk_sasl.c:
##########
@@ -451,41 +453,87 @@ struct zsasl_secret_ctx {
 static int _zsasl_getsecret(sasl_conn_t *conn, void *context, int id,
                             sasl_secret_t **psecret)
 {
+    const size_t MAX_PASSWORD_LEN = 1023;
     struct zsasl_secret_ctx *secret_ctx = (struct zsasl_secret_ctx *)context;
-    char buf[1024];
-    char *password;
-    size_t len;
+    char buf[MAX_PASSWORD_LEN + 1];
+    char *password = NULL;
+    size_t len = 0;
+    int res = 0;
+    char new_passwd[MAX_PASSWORD_LEN + 1];
+    char *p = NULL;
     sasl_secret_t *x;
 
     /* paranoia check */
-    if (!conn || !psecret || id != SASL_CB_PASS)
+    if (!conn || !psecret || id != SASL_CB_PASS) {
         return SASL_BADPARAM;
+    }
 
     if (secret_ctx->password_file) {
-        char *p;
         FILE *fh = fopen(secret_ctx->password_file, ""rt"");
-        if (!fh)
+        if (!fh) {
             return SASL_FAIL;
+        }
 
-        if (!fgets(buf, sizeof(buf), fh)) {
+        /*
+         * The file's content may be the encrypted password with binary characters,
+         * thus use fread().
+         */
+        len = fread(buf, sizeof(buf[0]), MAX_PASSWORD_LEN, fh);
+        if (ferror(fh)) {
             fclose(fh);
             return SASL_FAIL;
         }
 
         fclose(fh);
+        fh = NULL;

Review Comment:
   Understood, we can keep this for extra safety.



##########
zookeeper-client/zookeeper-client-c/src/zk_sasl.c:
##########
@@ -451,41 +453,87 @@ struct zsasl_secret_ctx {
 static int _zsasl_getsecret(sasl_conn_t *conn, void *context, int id,
                             sasl_secret_t **psecret)
 {
+    const size_t MAX_PASSWORD_LEN = 1023;
     struct zsasl_secret_ctx *secret_ctx = (struct zsasl_secret_ctx *)context;
-    char buf[1024];
-    char *password;
-    size_t len;
+    char buf[MAX_PASSWORD_LEN + 1];
+    char *password = NULL;
+    size_t len = 0;
+    int res = 0;
+    char new_passwd[MAX_PASSWORD_LEN + 1];
+    char *p = NULL;
     sasl_secret_t *x;
 
     /* paranoia check */
-    if (!conn || !psecret || id != SASL_CB_PASS)
+    if (!conn || !psecret || id != SASL_CB_PASS) {
         return SASL_BADPARAM;
+    }
 
     if (secret_ctx->password_file) {
-        char *p;
         FILE *fh = fopen(secret_ctx->password_file, ""rt"");
-        if (!fh)
+        if (!fh) {
             return SASL_FAIL;
+        }
 
-        if (!fgets(buf, sizeof(buf), fh)) {
+        /*
+         * The file's content may be the encrypted password with binary characters,
+         * thus use fread().
+         */
+        len = fread(buf, sizeof(buf[0]), MAX_PASSWORD_LEN, fh);
+        if (ferror(fh)) {
             fclose(fh);
             return SASL_FAIL;
         }
 
         fclose(fh);
+        fh = NULL;
+
+        /*
+         * Write the null terminator immediately after the last character of the
+         * content since it would be used as a null-terminated string once it is
+         * the actual password.
+         */
+        buf[len] = '\0';
+        password = buf;
+    }
 
-        p = strrchr(buf, '\n');
-        if (p)
-            *p = '\0';
+    if (secret_ctx->callback) {
+        if (!password) {
+            /*
+             * The callback takes effect only when password_file is provided.
+             */
+            return SASL_BADPARAM;
+        }
 
-        password = buf;
+        res = secret_ctx->callback(password, len, secret_ctx->context,
+            new_passwd, sizeof(new_passwd));
+        if (res != SASL_OK) {
+            return res;
+        }
+
+        memset(password, 0, len);
+
+        password = new_passwd;
+    } else if (secret_ctx->password_file) {
+        /*
+         * The file's content is the actual password, which must consist only of
+         * text characters (i.e., without null terminator). The first line would
+         * be read as the password once there are multiple lines in the file.
+         */
+        p = strchr(password, '\n');

Review Comment:
   Thanks for confirming! I think it's fine to keep the change as part of this patch.



;18/Mar/25 18:58;githubbot;600","kezhuw commented on code in PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223#discussion_r2008788390


##########
zookeeper-client/zookeeper-client-c/include/zookeeper.h:
##########
@@ -667,6 +667,69 @@ ZOOAPI zhandle_t *zookeeper_init_sasl(const char *host, watcher_fn fn,
 ZOOAPI sasl_callback_t *zoo_sasl_make_basic_callbacks(const char *user,
   const char *realm, const char* password_file);
 
+/**
+ * \brief signature of the callback function for SASL password.
+ *
+ * This callback is defined by user to decrypt the content of password file with
+ * context into the actual password.
+ *
+ * \param content the string read from the password file.
+ * \param content_len the size of the content in bytes.
+ * \param context the handback object that will be associated with the password
+ *   file. The object is not used by zookeeper internally and can be null.
+ * \param buf the buffer where the resulting actual password is saved, NOTE that
+ *   this callback must write the null terminator immediately after the last
+ *   character of the actual password, otherwise the behaviour is undefined.

Review Comment:
   Is it better to shape the callback to type `int (*zoo_sasl_password_callback_t)(const char *content, size_t content_len, void *context, char *password_buf, size_t *password_buf_len)` for the decryption to pass back password len ? Fail to do so will result in sasl auth failure instead of `undefined`.



;22/Mar/25 15:12;githubbot;600","empiredan commented on PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223#issuecomment-2748850389

   > Looks good except possible `undefined` in `zoo_sasl_password_callback_t`. I think we probably should avoid `undefined` path from caller side.
   
   @kezhuw Thank you very much for helping review the code ! I completely agree that we should avoid undefined behavior.  
   
   Instead of requiring users to remember to manually add a null terminator at the end, returning the actual password length is more user-friendly, helps draw attention, and prevents potential undefined behavior.  
   
   As for the `buf_len` parameter, how about keeping it ? It mainly to remind users within the callback function that the buffer has a size limit and should not be accessed out of bounds.  
   
   The stack memory allocation approach is still retained because:  
   1. Stack allocation is faster than heap allocation.  
   2. A length of 1023 is more than sufficient for SASL passwords.


;24/Mar/25 17:12;githubbot;600","kezhuw commented on code in PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223#discussion_r2010704219


##########
zookeeper-client/zookeeper-client-c/include/zookeeper.h:
##########
@@ -667,6 +667,74 @@ ZOOAPI zhandle_t *zookeeper_init_sasl(const char *host, watcher_fn fn,
 ZOOAPI sasl_callback_t *zoo_sasl_make_basic_callbacks(const char *user,
   const char *realm, const char* password_file);
 
+/**
+ * \brief signature of the callback function for SASL password.
+ *
+ * This callback is defined by user to decrypt the content of password file with
+ * context into the actual password.
+ *
+ * \param content the string read from the password file.
+ * \param content_len the size of the content in bytes.
+ * \param context the handback object that will be associated with the password
+ *   file. The object is not used by zookeeper internally and can be null.
+ * \param buf the buffer where the resulting actual password is saved, NOTE that
+ *   this callback must write the null terminator immediately after the last
+ *   character of the actual password, otherwise the behaviour is undefined.
+ * \param buf_len the size of buf in bytes, is also the max allowed length of
+ *   the actual password (excluding the null terminator), which is 1023. The
+ *   1-byte difference from 1024 accounts for the null (\0) terminator. A length
+ *   of 1023 is sufficient for storing the password.

Review Comment:
   Is here too many implementation details ?
   
   I think the contract is much clear now:
   1. The max allowed password len is `buf_len`.
   2. 1023 is indeed the max password length, but I think it does not deserve too much attention in api doc, as we have `buf_len`. 
   
   Besides, after checked https://linux.die.net/man/3/sasl_getsecret_t, I think the null terminator does not actually matter. I think we can keep it, but again, does not deserve too much strokes.



;24/Mar/25 18:48;githubbot;600","empiredan commented on PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223#issuecomment-2749996853

   > @empiredan Thank you for your contribution! I checked the refined `zoo_sasl_password_callback_t`, I think it is better than what I suggested.
   > 
   > I left a comment about api doc. The rest looks good to me.
   
   Got it! Indeed, over-explaining could cause confusion for users, so simplifying the documentation makes sense.  
   
   The `sasl_secret_t` structure does not strictly require the `data` field to be null-terminated, but we are keeping it for the following reasons:
   ```c
   typedef struct sasl_secret {
       unsigned long len;
       unsigned char data[1];		/* variable sized */
   } sasl_secret_t;
   ```
   
   1. There may be existing code that directly uses string functions to process the `data` field.  
   2. The `unsigned char data[1];` flexible array provides a natural way to store the null terminator.  
   3. The previous implementation used `strcpy((char *) x->data, password);` for copying, which inherently includes a `\0` at the end. Therefore, it makes sense to preserve the null terminator.


;25/Mar/25 03:50;githubbot;600","kezhuw merged PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223


;25/Mar/25 10:12;githubbot;600","kezhuw commented on PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223#issuecomment-2750767248

   @empiredan Thank you for your contribution! Merged to master and backported to branch-3.9 for security enhancement.


;25/Mar/25 10:18;githubbot;600","empiredan commented on PR #2223:
URL: https://github.com/apache/zookeeper/pull/2223#issuecomment-2750895788

   @cnauroth @kezhuw Thank you both very much !


;25/Mar/25 11:05;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,8400,,,0,8400,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Tue Mar 25 10:13:49 UTC 2025,,,,,,,,,,"0|z1u3ps:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"08/Feb/25 04:24;wangdan;For the pull request please see https://github.com/apache/zookeeper/pull/2223.;;;","25/Mar/25 10:13;kezhuw;Issue resolved by pull request 2223
[https://github.com/apache/zookeeper/pull/2223];;;",,,,,,,,,,
Update logback to 1.3.15 to fix CVE-2024-12798.,ZOOKEEPER-4891,13605684,,Improvement,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,cnauroth,ananysin,ananysin,21/Jan/25 06:32,29/Aug/25 21:29,08/Dec/25 08:12,14/Feb/25 18:01,,,,,,,,,3.10.0,3.8.5,3.9.4,,,,,0,pull-request-available,,,"This is addressed in Logback 1.3.15:

[https://nvd.nist.gov/vuln/detail/CVE-2024-12798]",,"cnauroth opened a new pull request, #2221:
URL: https://github.com/apache/zookeeper/pull/2221

   (no comment)


;04/Feb/25 19:34;githubbot;600","basapuram-kumar commented on PR #2221:
URL: https://github.com/apache/zookeeper/pull/2221#issuecomment-2634915357

   The latest version is 1.5.16, could it be possible to consider this.?


;04/Feb/25 19:47;githubbot;600","cnauroth commented on PR #2221:
URL: https://github.com/apache/zookeeper/pull/2221#issuecomment-2634936364

   Hello @basapuram-kumar . I haven't investigated any potential backward-compatibility concerns between 1.3 and 1.5. This is targeted to the master branch/future ZooKeeper 3.10 though, so let's give it a try. I pushed up a change to use 1.5.16, and we'll see what CI reports.


;04/Feb/25 19:58;githubbot;600","basapuram-kumar commented on PR #2221:
URL: https://github.com/apache/zookeeper/pull/2221#issuecomment-2634953141

   Hello @cnauroth 
   Seems CI reported for java compatibility, this pipeline runs using java-8, but logback-1.5.16 was compiled with java-11, so failed with ""class file has wrong version 55.0, should be 52.0"".
   Lets make it 1.3.15, which is compatible to java-8.


;04/Feb/25 20:07;githubbot;600","cnauroth commented on PR #2221:
URL: https://github.com/apache/zookeeper/pull/2221#issuecomment-2634960139

   Unfortunately, no, it looks like 1.5.16 isn't built for Java 8, so ZooKeeper compilation with Java 8 failed. I switched back to 1.3.15. I think if upgrading to 1.5.16 is important, then we'd need a wider discussion on dev@zookeeper.apache.org about release plans for cutting Java 8 support.


;04/Feb/25 20:11;githubbot;600","basapuram-kumar commented on PR #2221:
URL: https://github.com/apache/zookeeper/pull/2221#issuecomment-2635052876

   I have verified the same on jdk11 Runtime, it works fine. Offcourse, agreed on the point of wider discussions to move it to higher JDK version.


;04/Feb/25 20:53;githubbot;600","basapuram-kumar commented on PR #2221:
URL: https://github.com/apache/zookeeper/pull/2221#issuecomment-2635627246

   LGTM


;05/Feb/25 03:34;githubbot;600","cnauroth commented on PR #2221:
URL: https://github.com/apache/zookeeper/pull/2221#issuecomment-2644322951

   @anmolnar , are you able to review this dependency upgrade?


;07/Feb/25 23:32;githubbot;600","cnauroth commented on PR #2221:
URL: https://github.com/apache/zookeeper/pull/2221#issuecomment-2657230313

   Hi @eolivelli . Are you able to review this dependency upgrade? Thank you.


;13/Feb/25 17:04;githubbot;600","cnauroth closed pull request #2221: ZOOKEEPER-4891: Update logback to 1.3.15 to fix CVE-2024-12798.
URL: https://github.com/apache/zookeeper/pull/2221


;14/Feb/25 18:00;githubbot;600","cnauroth commented on PR #2221:
URL: https://github.com/apache/zookeeper/pull/2221#issuecomment-2659952900

   I committed this to master. @anmolnar , thanks for the review!


;14/Feb/25 18:01;githubbot;600","anmolnar commented on PR #2221:
URL: https://github.com/apache/zookeeper/pull/2221#issuecomment-2672050880

   Thanks @cnauroth . We provide security fixes on all major branches. Do we need to backport this?


;20/Feb/25 16:40;githubbot;600","cnauroth commented on PR #2221:
URL: https://github.com/apache/zookeeper/pull/2221#issuecomment-2672832086

   Hi @anmolnar . I held back, because it's a sub-minor upgrade on master, but a minor upgrade on branch-3.9 and branch-3.8. I haven't investigated any backward compatibility concerns. LMK your thoughts, and I'd be happy to do some backports next week.


;20/Feb/25 22:27;githubbot;600","cnauroth commented on PR #2221:
URL: https://github.com/apache/zookeeper/pull/2221#issuecomment-2683523257

   > Hi @anmolnar . I held back, because it's a sub-minor upgrade on master, but a minor upgrade on branch-3.9 and branch-3.8. I haven't investigated any backward compatibility concerns. LMK your thoughts, and I'd be happy to do some backports next week.
   
   I do see there was some prior discussion on #2162 and a decision to only upgrade to Logback 1.3 on the master branch.


;25/Feb/25 23:30;githubbot;600","anmolnar opened a new pull request, #2290:
URL: https://github.com/apache/zookeeper/pull/2290

   Attempt to upgrade logback and slf4j on branch-3.9


;01/Aug/25 22:37;githubbot;600","anmolnar commented on PR #2290:
URL: https://github.com/apache/zookeeper/pull/2290#issuecomment-3145935170

   @ctubbsii I see you've raised concerns in #2162 about doing this change in branches other than the `master`. Do you have any idea what to do instead to suspend failing OWASP reports? Shall we just add another Owasp supression for logback?


;01/Aug/25 22:40;githubbot;600","ctubbsii commented on PR #2290:
URL: https://github.com/apache/zookeeper/pull/2290#issuecomment-3145955665

   My concern was based on the potential incompatibility and potential breakage for existing users using the older series of logging dependencies. I think users can mitigate this by making their own decisions in their deployments about which logging dependencies to use at runtime. Ultimately, users are responsible for their own class paths. Any particular application can only make a best effort approach at a particular point in time when releasing, but those decisions can quickly become out of date after release, so it's users who decide what's on a deployed system. As such, I don't think these warnings are very useful to users, and upstream devs in ZK should only take them as advisories. I would just ignore the OWASP checks during the build, and not make it a release blocker, since upstream logback and slf4j don't have updates for these versions. Then, just advise users to consider newer logging dependencies, or a newer version of ZK.
   
   In short, 1) check if there's a compatible update to these versions upstream, 2) if not, suppress the build error and include a note in the release notes to advise users.


;01/Aug/25 22:59;githubbot;600","phunt commented on PR #2290:
URL: https://github.com/apache/zookeeper/pull/2290#issuecomment-3168882983

   +1 lgtm.


;08/Aug/25 18:00;githubbot;600","anmolnar commented on PR #2290:
URL: https://github.com/apache/zookeeper/pull/2290#issuecomment-3168902287

   I'll merge this patch to `branch-3.9` only in order to resolve the security issues related to logback, but not backporting it to `branch-3.8`. With 3.8 we have other options that we can discuss in the mailing list. We could either replace **logback** with a simpler implementation like `slf4j-simple` or just remove the **logback** artifact complete or EoL the 3.8.x release line and create 3.10.x releases. 


;08/Aug/25 18:07;githubbot;600","anmolnar merged PR #2290:
URL: https://github.com/apache/zookeeper/pull/2290


;08/Aug/25 18:14;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,0,12000,,,0,12000,,,,,ZOOKEEPER-4894,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,Reviewed,,,,,Fri Feb 14 18:01:52 UTC 2025,,,,,,,,,,"0|z1tqgw:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"14/Feb/25 18:01;cnauroth;I have committed this to master.;;;",,,,,,,,,,,
Update Netty to fix CVE-2024-47535,ZOOKEEPER-4890,13599957,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,robsonselzelin,robsonselzelin,robsonselzelin,25/Nov/24 19:53,29/Aug/25 21:29,08/Dec/25 08:12,25/Aug/25 20:27,,,,,,,,,3.10.0,3.9.4,,server,,,,0,pull-request-available,,,"Please, upgrade Jetty version to 4.1.115.Final in order to fix CVE-2024-47535.

Pull request: [https://github.com/apache/zookeeper/pull/2212]

 ",,"robsonselzelin commented on PR #2212:
URL: https://github.com/apache/zookeeper/pull/2212#issuecomment-2498922182

   @anmolnar here it is the Jira ticket: ZOOKEEPER-4890


;25/Nov/24 20:02;githubbot;600","robsonselzelin commented on PR #2212:
URL: https://github.com/apache/zookeeper/pull/2212#issuecomment-2498946975

   > can you please update the license files ? it is usually a matter of renaming the files
   
   Done.


;25/Nov/24 20:16;githubbot;600","anmolnar merged PR #2212:
URL: https://github.com/apache/zookeeper/pull/2212


;26/Nov/24 20:32;githubbot;600","anmolnar commented on PR #2212:
URL: https://github.com/apache/zookeeper/pull/2212#issuecomment-2501873537

   Merged to `master` and `branch-3.9` branches.
   Cherry-picking to `branch-3.8` shows some conflict, would you please create a separate PR for the backport?


;26/Nov/24 20:34;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2024-11-25 19:53:16.0,,,,,,,,,,"0|z1srdc:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Fallback to DIGEST-MD5 auth mech should be disabled in Fips mode,ZOOKEEPER-4889,13599833,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,andor,andor,andor,24/Nov/24 15:54,29/Aug/25 21:29,08/Dec/25 08:12,26/Nov/24 15:55,3.8.4,3.9.3,,,,,,,3.10.0,3.8.5,3.9.4,java client,security,server,,0,FIPS,pull-request-available,SASL,"FIPS doesn't allow using MD5 algorithm, so it should be disabled at all times. When we create SASL client there's a fallback code path: if Kerberos doesn't work for some reason, we try to use DIGEST-MD5 mech instead. We already have a fips-mode property, so let's disable this code patch if the property is enabled.",,"anmolnar opened a new pull request, #2213:
URL: https://github.com/apache/zookeeper/pull/2213

   Disable DIGEST-MD5 mech in Fips mode. I had to modify lots of unit tests, because fips mode is enabled by default on the master branch and unit tests heavily rely on using DIGEST-MD5 for Sasl authentication.


;24/Nov/24 18:56;githubbot;600","anmolnar commented on PR #2213:
URL: https://github.com/apache/zookeeper/pull/2213#issuecomment-2496213325

   We should have a common base class for SASL auth tests.


;24/Nov/24 20:21;githubbot;600","eolivelli merged PR #2213:
URL: https://github.com/apache/zookeeper/pull/2213


;25/Nov/24 06:28;githubbot;600","anmolnar commented on PR #2213:
URL: https://github.com/apache/zookeeper/pull/2213#issuecomment-2498223894

   > LGTM
   > 
   > shouldn't we mention this to the documentation somewhere? (I don't think this would really be a backward compatibility issue, as I guess noone is considering digest MD5 in a FIPS environment - yet still this is a change in the current behaviour)
   
   That's very good point. You submitted a bit fast, but let me create an addendum patch.
   It also needs to be backported to other branches `branch-3.9` and `branch-3.8`, I'm not sure what to do with the addendum in this case, can I just backport in a single patch?


;25/Nov/24 14:47;githubbot;600","anmolnar opened a new pull request, #2214:
URL: https://github.com/apache/zookeeper/pull/2214

   @eolivelli @symat 


;25/Nov/24 17:03;githubbot;600","anmolnar commented on PR #2213:
URL: https://github.com/apache/zookeeper/pull/2213#issuecomment-2498569312

   @eolivelli @symat Please see the addendum here: #2214 


;25/Nov/24 17:04;githubbot;600","anmolnar commented on PR #2213:
URL: https://github.com/apache/zookeeper/pull/2213#issuecomment-2498573285

   > shouldn't we mention this to the documentation somewhere? (I don't think this would really be a backward compatibility issue, as I guess noone is considering digest MD5 in a FIPS environment - yet still this is a change in the current behaviour)
   
   It's not about consideration, FIPS doesn't allow using MD5 anywhere in the running code. If ever the code runs on that code patch, runtime exception will be thrown and JVM halts. This change is backward compatible.


;25/Nov/24 17:06;githubbot;600","anmolnar commented on PR #2213:
URL: https://github.com/apache/zookeeper/pull/2213#issuecomment-2498578523

   I've backported the patch to `branch-3.9`, will open separate PR for `branch-3.8`.


;25/Nov/24 17:08;githubbot;600","anmolnar opened a new pull request, #2215:
URL: https://github.com/apache/zookeeper/pull/2215

   Backported from #2213 and #2214 


;25/Nov/24 17:36;githubbot;600","anmolnar commented on PR #2215:
URL: https://github.com/apache/zookeeper/pull/2215#issuecomment-2499685507

   > > Custom trust manager (`ZKTrustManager`) that is used for hostname verification will be disabled. As a consequence,  hostname verification is not available in the Quorum protocol, but still can be set in client-server communication.
   > 
   > Is this a incident(a.k.a bug) in implementation or a requirement from FIPS ?
   
   It should be a limitation of how Quorum SSL has been implemented, can't remember the details. Essentially [this method](https://github.com/apache/zookeeper/blob/master/zookeeper-server/src/main/java/org/apache/zookeeper/common/ClientX509Util.java#L141) is not available or doesn't work with Quorum SSL for some reason.


;26/Nov/24 05:21;githubbot;600","anmolnar merged PR #2214:
URL: https://github.com/apache/zookeeper/pull/2214


;26/Nov/24 15:54;githubbot;600","anmolnar merged PR #2215:
URL: https://github.com/apache/zookeeper/pull/2215


;26/Nov/24 15:55;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,7200,,,0,7200,,,,,,,,,,ZOOKEEPER-4832,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Tue Nov 26 15:55:57 UTC 2024,,,,,,,,,,"0|z1sqls:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"26/Nov/24 15:55;andor;Issue resolved by pull request 2215
[https://github.com/apache/zookeeper/pull/2215];;;",,,,,,,,,,,
observer with small myid can't join SASL quorum,ZOOKEEPER-4886,13598708,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Blocker,Fixed,zichen,zichen,zichen,14/Nov/24 02:57,29/Aug/25 21:29,08/Dec/25 08:12,20/Apr/25 16:41,3.6.4,3.7.2,3.8.4,3.9.3,,,,,3.10.0,3.8.5,3.9.4,quorum,,,,0,pull-request-available,,,"When SASL Quorum like:
server.11=localhost:11223:11224:participant
server.21=localhost:11226:11227:participant
server.1=localhost:11229:11230:observer

The server.1 can't join quorum.",https://github.com/apache/zookeeper/pull/2211,"kezhuw commented on code in PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211#discussion_r1894555028


##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/auth/QuorumAuthObserverTest.java:
##########
@@ -0,0 +1,98 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.server.quorum.auth;
+
+import java.util.HashMap;
+import java.util.Map;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZooDefs.Ids;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.test.ClientBase;
+import org.apache.zookeeper.test.ClientBase.CountdownWatcher;
+import org.junit.jupiter.api.AfterAll;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+
+/**
+ * ZOOKEEPER-4886：myid small observer can't join quorum, so need use getView()
+ * SASL Quorum:
+ * server.11=localhost:11223:11224:participant
+ * server.21=localhost:11226:11227:participant
+ * server.1=localhost:11229:11230:observer
+ *
+ * The server.1 can't join quorum.
+ */
+public class QuorumAuthObserverTest extends QuorumAuthTestBase {
+
+    static {
+        String jaasEntries = ""QuorumServer {\n""
+                             + ""       org.apache.zookeeper.server.auth.DigestLoginModule required\n""
+                             + ""       user_test=\""mypassword\"";\n""
+                             + ""};\n""
+                             + ""QuorumLearner {\n""
+                             + ""       org.apache.zookeeper.server.auth.DigestLoginModule required\n""
+                             + ""       username=\""test\""\n""
+                             + ""       password=\""mypassword\"";\n""
+                             + ""};\n"";
+        setupJaasConfig(jaasEntries);
+    }
+
+    @AfterEach
+    @Override
+    public void tearDown() throws Exception {
+        shutdownAll();
+        super.tearDown();
+    }
+
+    @AfterAll
+    public static void cleanup() {
+        cleanupJaasConfig();
+    }
+
+    /**
+     * Test to myid small observer join quorum.

Review Comment:
   ```suggestion
        * Test to ensure observer with small myid can join SASL quorum.
        *
   ```



##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumCnxManager.java:
##########
@@ -502,8 +502,9 @@ private boolean startConnection(Socket sock, Long sid) throws IOException {
             return false;
         }
 
+        // ZOOKEEPER-4886: small observer can't join quorum, so need use getView()

Review Comment:
   ```suggestion
   ```
   
   This does not look helpful after this merged.



##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/auth/QuorumAuthObserverTest.java:
##########
@@ -0,0 +1,98 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.server.quorum.auth;
+
+import java.util.HashMap;
+import java.util.Map;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZooDefs.Ids;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.test.ClientBase;
+import org.apache.zookeeper.test.ClientBase.CountdownWatcher;
+import org.junit.jupiter.api.AfterAll;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+
+/**
+ * ZOOKEEPER-4886：myid small observer can't join quorum, so need use getView()
+ * SASL Quorum:
+ * server.11=localhost:11223:11224:participant
+ * server.21=localhost:11226:11227:participant
+ * server.1=localhost:11229:11230:observer
+ *
+ * The server.1 can't join quorum.
+ */

Review Comment:
   ```suggestion
   ```



;21/Dec/24 04:46;githubbot;600","kezhuw closed pull request #2211: ZOOKEEPER-4886: Fix observer with small myid can't join SASL quorum
URL: https://github.com/apache/zookeeper/pull/2211


;21/Dec/24 04:59;githubbot;600","zichen-gan opened a new pull request, #2211:
URL: https://github.com/apache/zookeeper/pull/2211

   ZK BUG Like QuorumAuthObserverTest#testSmallObserverJoinSASLQuorum
   When SASL Quorum like:
   server.11=localhost:11223:11224:participant
   server.21=localhost:11226:11227:participant
   server.1=localhost:11229:11230:observer
   
   The server.1 can't join quorum.


;21/Dec/24 05:00;githubbot;600","anmolnar commented on code in PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211#discussion_r1902196456


##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/auth/QuorumAuthObserverTest.java:
##########
@@ -0,0 +1,98 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.server.quorum.auth;
+
+import java.util.HashMap;
+import java.util.Map;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZooDefs.Ids;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.test.ClientBase;
+import org.apache.zookeeper.test.ClientBase.CountdownWatcher;
+import org.junit.jupiter.api.AfterAll;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+
+/**
+ * ZOOKEEPER-4886：myid small observer can't join quorum, so need use getView()
+ * SASL Quorum:
+ * server.11=localhost:11223:11224:participant
+ * server.21=localhost:11226:11227:participant
+ * server.1=localhost:11229:11230:observer
+ *
+ * The server.1 can't join quorum.
+ */

Review Comment:
   Why do you want this to be removed?



;03/Jan/25 21:55;githubbot;600","kezhuw commented on code in PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211#discussion_r1902602330


##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/auth/QuorumAuthObserverTest.java:
##########
@@ -0,0 +1,98 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.server.quorum.auth;
+
+import java.util.HashMap;
+import java.util.Map;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZooDefs.Ids;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.test.ClientBase;
+import org.apache.zookeeper.test.ClientBase.CountdownWatcher;
+import org.junit.jupiter.api.AfterAll;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+
+/**
+ * ZOOKEEPER-4886：myid small observer can't join quorum, so need use getView()
+ * SASL Quorum:
+ * server.11=localhost:11223:11224:participant
+ * server.21=localhost:11226:11227:participant
+ * server.1=localhost:11229:11230:observer
+ *
+ * The server.1 can't join quorum.
+ */

Review Comment:
   I think the comments on method is enough. Also tests are authored per-method, so class level comments are easy to be outdated.



;04/Jan/25 06:52;githubbot;600","zichen-gan commented on PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211#issuecomment-2606195545

   DONE @anmolnar @kezhuw 


;22/Jan/25 03:13;githubbot;600","kezhuw commented on code in PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211#discussion_r1926827909


##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/auth/QuorumAuthObserverTest.java:
##########
@@ -0,0 +1,89 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.server.quorum.auth;
+
+import java.util.HashMap;
+import java.util.Map;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZooDefs.Ids;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.test.ClientBase;
+import org.apache.zookeeper.test.ClientBase.CountdownWatcher;
+import org.junit.jupiter.api.AfterAll;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+
+public class QuorumAuthObserverTest extends QuorumAuthTestBase {
+
+    static {
+        String jaasEntries = ""QuorumServer {\n""
+                             + ""       org.apache.zookeeper.server.auth.DigestLoginModule required\n""
+                             + ""       user_test=\""mypassword\"";\n""
+                             + ""};\n""
+                             + ""QuorumLearner {\n""
+                             + ""       org.apache.zookeeper.server.auth.DigestLoginModule required\n""
+                             + ""       username=\""test\""\n""
+                             + ""       password=\""mypassword\"";\n""
+                             + ""};\n"";
+        setupJaasConfig(jaasEntries);
+    }
+
+    @AfterEach
+    @Override
+    public void tearDown() throws Exception {
+        shutdownAll();
+        super.tearDown();
+    }
+
+    @AfterAll
+    public static void cleanup() {
+        cleanupJaasConfig();
+    }
+
+    /**
+     * Test to ensure observer with small myid can join SASL quorum.
+     * peer0 myid：11 participant
+     * peer1 myid：21 participant
+     * peer2 myid：1 observer
+     */
+    @Test
+    @Timeout(value = 30)
+    public void testSmallObserverJoinSASLQuorum() throws Exception {
+        Map<String, String> authConfigs = new HashMap<>();
+        authConfigs.put(QuorumAuth.QUORUM_SASL_AUTH_ENABLED, ""true"");
+        authConfigs.put(QuorumAuth.QUORUM_SERVER_SASL_AUTH_REQUIRED, ""true"");
+        authConfigs.put(QuorumAuth.QUORUM_LEARNER_SASL_AUTH_REQUIRED, ""true"");
+
+        // create quorum
+        StringBuilder connectStringBuilder = new StringBuilder();
+        int[] myidList = {11, 21, 1};
+        String[] roleList = {""participant"", ""participant"", ""observer""};
+        int[] clientPorts = startQuorum(3, connectStringBuilder, authConfigs, 3, false, myidList, roleList);
+
+        // small observer can't join quorum

Review Comment:
   ```suggestion
           // observer with small myid should have joined the quorum
   ```



##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/auth/QuorumAuthObserverTest.java:
##########
@@ -0,0 +1,89 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.server.quorum.auth;
+
+import java.util.HashMap;
+import java.util.Map;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZooDefs.Ids;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.test.ClientBase;
+import org.apache.zookeeper.test.ClientBase.CountdownWatcher;
+import org.junit.jupiter.api.AfterAll;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+
+public class QuorumAuthObserverTest extends QuorumAuthTestBase {
+
+    static {
+        String jaasEntries = ""QuorumServer {\n""
+                             + ""       org.apache.zookeeper.server.auth.DigestLoginModule required\n""
+                             + ""       user_test=\""mypassword\"";\n""
+                             + ""};\n""
+                             + ""QuorumLearner {\n""
+                             + ""       org.apache.zookeeper.server.auth.DigestLoginModule required\n""
+                             + ""       username=\""test\""\n""
+                             + ""       password=\""mypassword\"";\n""
+                             + ""};\n"";
+        setupJaasConfig(jaasEntries);
+    }
+
+    @AfterEach
+    @Override
+    public void tearDown() throws Exception {
+        shutdownAll();
+        super.tearDown();
+    }
+
+    @AfterAll
+    public static void cleanup() {
+        cleanupJaasConfig();
+    }
+
+    /**
+     * Test to ensure observer with small myid can join SASL quorum.
+     * peer0 myid：11 participant
+     * peer1 myid：21 participant
+     * peer2 myid：1 observer
+     */
+    @Test
+    @Timeout(value = 30)

Review Comment:
   ```suggestion
   ```
   
   Let's rely on `watcher.waitForConnected(ClientBase.CONNECTION_TIMEOUT)`.



;23/Jan/25 11:32;githubbot;600","kezhuw commented on code in PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211#discussion_r1926835156


##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/quorum/auth/QuorumAuthObserverTest.java:
##########
@@ -0,0 +1,88 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.server.quorum.auth;
+
+import java.util.HashMap;
+import java.util.Map;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZooDefs.Ids;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.test.ClientBase;
+import org.apache.zookeeper.test.ClientBase.CountdownWatcher;
+import org.junit.jupiter.api.AfterAll;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;

Review Comment:
   ```suggestion
   ```
   
   Fix the checkstyle error.



;23/Jan/25 11:36;githubbot;600","anmolnar commented on PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211#issuecomment-2707866949

   retest


;08/Mar/25 01:30;githubbot;600","anmolnar commented on PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211#issuecomment-2707867886

   @zichen-gan Sorry for the delay. I cannot retrigger the tests. Could you please rebase on latest master?


;08/Mar/25 01:31;githubbot;600","kezhuw closed pull request #2211: ZOOKEEPER-4886: Fix observer with small myid can't join SASL quorum
URL: https://github.com/apache/zookeeper/pull/2211


;08/Mar/25 13:35;githubbot;600","zichen-gan opened a new pull request, #2211:
URL: https://github.com/apache/zookeeper/pull/2211

   ZK BUG Like QuorumAuthObserverTest#testSmallObserverJoinSASLQuorum
   When SASL Quorum like:
   server.11=localhost:11223:11224:participant
   server.21=localhost:11226:11227:participant
   server.1=localhost:11229:11230:observer
   
   The server.1 can't join quorum.


;08/Mar/25 13:35;githubbot;600","kezhuw commented on PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211#issuecomment-2767099499

   I think the test is flaky somehow.


;31/Mar/25 18:43;githubbot;600","kezhuw commented on PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211#issuecomment-2817082510

   Rebased this to latest master to verify flakyness.


;20/Apr/25 09:24;githubbot;600","kezhuw commented on PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211#issuecomment-2817230656

   The test failed once due to flakyness of `ZooKeeperServerMaxCnxnsTest`.
   
   https://github.com/apache/zookeeper/actions/runs/14560136021/job/40842324999?pr=2211#step:6:494


;20/Apr/25 15:51;githubbot;600","kezhuw merged PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211


;20/Apr/25 16:40;githubbot;600","kezhuw opened a new pull request, #2250:
URL: https://github.com/apache/zookeeper/pull/2250

   (no comment)


;20/Apr/25 17:02;githubbot;600","kezhuw commented on PR #2250:
URL: https://github.com/apache/zookeeper/pull/2250#issuecomment-2817269687

   Jenkins ci succeeded. https://ci-hadoop.apache.org/job/zookeeper-precommit-github-pr/job/PR-2250/
   
   I am going to merge this as branch-3.8 ci is failed.


;20/Apr/25 17:42;githubbot;600","kezhuw merged PR #2250:
URL: https://github.com/apache/zookeeper/pull/2250


;20/Apr/25 17:43;githubbot;600","kezhuw commented on PR #2211:
URL: https://github.com/apache/zookeeper/pull/2211#issuecomment-2817270584

   Merged and backported to 3.9, 3.8.
   
   @zichen-gan Thank you for your contribution!


;20/Apr/25 17:44;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,43200,31200,12000,27%,43200,31200,12000,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,java,,Sun Apr 20 16:41:11 UTC 2025,,,,,,,,,,"0|z1sjq0:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"20/Apr/25 16:41;kezhuw;Issue resolved by pull request 2211
[https://github.com/apache/zookeeper/pull/2211];;;",,,,,,,,,,,
Generate comments from zookeeper.jute into code,ZOOKEEPER-4880,13596328,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,luozongle01,luozongle01,luozongle01,22/Oct/24 12:52,07/Dec/24 06:03,08/Dec/25 08:12,07/Dec/24 05:55,,,,,,,,,3.10.0,,,jute,,,,1,pull-request-available,,,"When I was learning protobuf, I found that the comments in the proto file would be generated into the code. I think this feature is very useful. I wonder if this feature can be added to zookeeper, because in the process of learning zookeeper, we can directly see the attribute comments of the relevant classes generated by jute, and there is no need to check the meaning of the fields in zookeeper.jute. Although I found that there are not many comments in the zookeeper.jute file, I think it would be helpful to generate the comments into the code.

And I studied javacc and found that javacc supports this feature. We can get the comments in zookeeper.jute through SPECIAL_TOKEN.

If possible, I hope to contribute a PR.",,"luozongle01 opened a new pull request, #2206:
URL: https://github.com/apache/zookeeper/pull/2206

   Generate comments from zookeeper.jute into code: https://issues.apache.org/jira/browse/ZOOKEEPER-4880
   
   ## Brief Description
   Support generating end-of-line comments and class comments in `zookeeper.jute` into code.
   
   
   ## How to test this change
   1. By comparing the `zookeeper-jute/target/generated-sources/java/org/apache/zookeeper` and `zookeeper-client/zookeeper-client-c/generated` directories before and after the modification, there are no other differences except the comments.
   <img width=""1440"" alt=""image"" src=""https://github.com/user-attachments/assets/9bd4b5da-f969-4cbe-b77c-d8b16385d4ec"">
   <img width=""1440"" alt=""image"" src=""https://github.com/user-attachments/assets/eb4c764d-d1b7-4c41-97ee-27221bf13229"">
   
   <br>
   <br>
   2. When the test class has multiple lines of comments, the comments can be generated normally.
   <img width=""1440"" alt=""image"" src=""https://github.com/user-attachments/assets/a9decd1d-9717-4eaa-8c9a-85762899469c"">
   
   <br>
   <br>
   3. Testing vector type properties can generate comments normally.
   <img width=""1386"" alt=""image"" src=""https://github.com/user-attachments/assets/89f7db00-252f-4f0c-85cd-68d6e87d2c77"">
   
   <br>
   <br>
   4. Testing class type properties can generate comments normally
   <img width=""1407"" alt=""image"" src=""https://github.com/user-attachments/assets/0d094349-f47b-4425-9426-378156599d85"">
   
   <br>
   <br>
   5. Testing comments that do not meet expectations will not generate comments and will not affect the generation of normal code.
   <img width=""1401"" alt=""image"" src=""https://github.com/user-attachments/assets/f5f47605-9faa-4a89-ac80-2c7e3f1e1535"">
   


;23/Oct/24 15:04;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2432773020

   @kezhuw  Could you help me take a look? Thanks.
   
   


;23/Oct/24 16:19;githubbot;600","kezhuw commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1818339448


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +780,30 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    protected String getRecordComments() {
+        if (mRecordToken == null || mRecordToken.specialToken == null) {
+            return null;
+        }
+
+        StringJoiner joiner = new StringJoiner(""\n * "", ""/**\n * "", ""\n */\n"");
+        Token tmpTkn = mRecordToken.specialToken;
+        while (tmpTkn.specialToken != null) {
+            tmpTkn = tmpTkn.specialToken;
+        }
+
+        while (tmpTkn != null) {
+            String image = tmpTkn.image.trim();
+            tmpTkn = tmpTkn.next;
+            if (image.startsWith(""//"")) {

Review Comment:
   The capture does not shaped well for directly usage. I tasted the following capture, and it captured a complete line comment. This way we can output whatever it captured without post work.
   
   ```
   SPECIAL_TOKEN :
   {
     <SINGLE_LINE_COMMENT: ""//"" (~[""\n"",""\r""])* (""\n""|""\r""|""\r\n"")>
   }
   ```
   
   See also https://javacc.github.io/javacc/tutorials/token-manager.html



;28/Oct/24 03:56;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1818365785


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +780,30 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    protected String getRecordComments() {
+        if (mRecordToken == null || mRecordToken.specialToken == null) {
+            return null;
+        }
+
+        StringJoiner joiner = new StringJoiner(""\n * "", ""/**\n * "", ""\n */\n"");
+        Token tmpTkn = mRecordToken.specialToken;
+        while (tmpTkn.specialToken != null) {
+            tmpTkn = tmpTkn.specialToken;
+        }
+
+        while (tmpTkn != null) {
+            String image = tmpTkn.image.trim();
+            tmpTkn = tmpTkn.next;
+            if (image.startsWith(""//"")) {

Review Comment:
   Thank you very much for your comment. I will make some further modifications.😆



;28/Oct/24 04:40;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2445635303

   Hi, @kezhuw, I made some modifications, thank you for your review last time. I feel much better now than last time. 
   I hope you can help me look again.
   
   Currently, multi-line comments and single-line comments are supported.
   
   I put `JField` or `JRecord` into a `TreeSet`, so that I can get the `line` or `column` information of the previous or next element. According to the `beginLine`, `beginColumn`, `endLine`, `endColumn` information, I determine the range of my comment area, and then format the output in line number order.
   
   Here is my testing process.
   1. Verify that the modification only affects the comments and does not affect the normal code.
   
   2. When verifying that each JField is on its own line, multi-line comments and single-line comments are generated normally.
   <img width=""1317"" alt=""image"" src=""https://github.com/user-attachments/assets/28f797ca-f474-46d0-b178-f3a7abb5faf4"">
   <img width=""1388"" alt=""image"" src=""https://github.com/user-attachments/assets/4e9fce69-3c38-4698-ac90-24882eea6196"">
   
   3. If the attributes are on the same line, the comment should belong to the previous Field.
   <img width=""1402"" alt=""image"" src=""https://github.com/user-attachments/assets/77120d53-9f8b-4323-9cad-485d58f97aef"">
   
   


;30/Oct/24 01:35;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1821739303


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +780,30 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    protected String getRecordComments() {
+        if (mRecordToken == null || mRecordToken.specialToken == null) {
+            return null;
+        }
+
+        StringJoiner joiner = new StringJoiner(""\n * "", ""/**\n * "", ""\n */\n"");
+        Token tmpTkn = mRecordToken.specialToken;
+        while (tmpTkn.specialToken != null) {
+            tmpTkn = tmpTkn.specialToken;
+        }
+
+        while (tmpTkn != null) {
+            String image = tmpTkn.image.trim();
+            tmpTkn = tmpTkn.next;
+            if (image.startsWith(""//"")) {

Review Comment:
   > The capture does not shaped well for directly usage. I tasted the following capture, and it captured a complete line comment. This way we can output whatever it captured without post work.
   > 
   > ```
   > SPECIAL_TOKEN :
   > {
   >   <SINGLE_LINE_COMMENT: ""//"" (~[""\n"",""\r""])* (""\n""|""\r""|""\r\n"")>
   > }
   > ```
   > 
   > See also https://javacc.github.io/javacc/tutorials/token-manager.html
   
   It seems like there's no need to change this now, because I get all the comments，then I use and distinguished them by line numbe. 😂😂



;30/Oct/24 01:42;githubbot;600","kezhuw commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1832126265


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +790,53 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    private String getJavaFieldComments(JField jField) {
+        StringJoiner javaFieldCommentsJoiner =
+                new StringJoiner(""\n   * "", ""  /**\n   * "", ""\n   */\n"").setEmptyValue("""");
+        return getFieldComments(jField, javaFieldCommentsJoiner);
+    }
+
+    private String getCFieldComments(JField jField) {
+        StringJoiner cFieldCommentsJoiner =
+                new StringJoiner(""\n     * "", ""    /**\n     * "", ""\n     */\n"").setEmptyValue("""");
+        return getFieldComments(jField, cFieldCommentsJoiner);
+    }
+
+    private String getFieldComments(JField jField, StringJoiner fieldCommentsJoiner) {
+        List<String> fieldSpecialToken = jCommentGenerator.getFieldCommentsList(jField);
+        return getComments(fieldCommentsJoiner, fieldSpecialToken);
+    }
+
+    private String getRecordComments() {
+        List<String> classSpecialToken = jCommentGenerator.getRecordCommentsList(this);
+
+        StringJoiner recordCommentsJoiner =
+                new StringJoiner(""\n * "", ""/**\n * "", ""\n */\n"").setEmptyValue("""");
+        return getComments(recordCommentsJoiner, classSpecialToken);
+    }
+
+    private static String getComments(StringJoiner commentsJoiner, List<String> commentList) {
+        if (commentList == null || commentList.isEmpty()) {
+            return commentsJoiner.toString();
+        }
+
+        for (String commentMulti : commentList) {
+            if (commentMulti == null || commentMulti.isEmpty()) {
+                continue;
+            }
+
+            String[] commentArray = commentMulti.split(""\n"");
+            for (String comment : commentArray) {
+
+                comment = comment.replaceAll(""//|/\\*\\*|/\\*|\\*\\*/|\\*/"", """")
+                        .replaceAll(""^[* ]+"", """").trim();
+
+                if (!comment.isEmpty()) {

Review Comment:
   The generated comments has no empty line which is not good.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +790,53 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    private String getJavaFieldComments(JField jField) {
+        StringJoiner javaFieldCommentsJoiner =
+                new StringJoiner(""\n   * "", ""  /**\n   * "", ""\n   */\n"").setEmptyValue("""");
+        return getFieldComments(jField, javaFieldCommentsJoiner);
+    }
+
+    private String getCFieldComments(JField jField) {
+        StringJoiner cFieldCommentsJoiner =
+                new StringJoiner(""\n     * "", ""    /**\n     * "", ""\n     */\n"").setEmptyValue("""");
+        return getFieldComments(jField, cFieldCommentsJoiner);
+    }
+
+    private String getFieldComments(JField jField, StringJoiner fieldCommentsJoiner) {
+        List<String> fieldSpecialToken = jCommentGenerator.getFieldCommentsList(jField);
+        return getComments(fieldCommentsJoiner, fieldSpecialToken);
+    }
+
+    private String getRecordComments() {
+        List<String> classSpecialToken = jCommentGenerator.getRecordCommentsList(this);
+
+        StringJoiner recordCommentsJoiner =
+                new StringJoiner(""\n * "", ""/**\n * "", ""\n */\n"").setEmptyValue("""");
+        return getComments(recordCommentsJoiner, classSpecialToken);
+    }
+
+    private static String getComments(StringJoiner commentsJoiner, List<String> commentList) {
+        if (commentList == null || commentList.isEmpty()) {
+            return commentsJoiner.toString();
+        }
+
+        for (String commentMulti : commentList) {
+            if (commentMulti == null || commentMulti.isEmpty()) {
+                continue;
+            }
+
+            String[] commentArray = commentMulti.split(""\n"");
+            for (String comment : commentArray) {
+
+                comment = comment.replaceAll(""//|/\\*\\*|/\\*|\\*\\*/|\\*/"", """")

Review Comment:
   I do think people will want to maintain this kind of code.



;07/Nov/24 06:44;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2461577162

   > @luozongle01 Thank you for your work!
   > 
   > It might be late, I am sorry for this, but I think we probably should align on how comments from jute should be formatted in generated sources ? I see two approaches.
   > 
   > 1. Keep it in origin format.
   > 2. Transfer comments from one format to another.
   > 
   > I saw this pr is going on the second approach. I am good to unify the generated comment format. But I think it could be challenge, as we should escape between two formats which could make generated comments strange/inaccurate.
   > 
   > ```
   >     // /**
   >     //  * Some dead comments.
   >     //  */
   >     //
   >     // Things changed. We are going ..
   > ```
   > 
   > Currently, the generated comments blindly strip some special strings. I don't think it is a good thing.
   > 
   > I suggest we keep it simple and don't touch comment content, this is also a safe path. If we want javadoc style comments, I think it is ok to convert them manually.
   
   
   
   > @luozongle01 Thank you for your work!
   > 
   > It might be late, I am sorry for this, but I think we probably should align on how comments from jute should be formatted in generated sources ? I see two approaches.
   > 
   > 1. Keep it in origin format.
   > 2. Transfer comments from one format to another.
   > 
   > I saw this pr is going on the second approach. I am good to unify the generated comment format. But I think it could be challenge, as we should escape between two formats which could make generated comments strange/inaccurate.
   > 
   > ```
   >     // /**
   >     //  * Some dead comments.
   >     //  */
   >     //
   >     // Things changed. We are going ..
   > ```
   > 
   > Currently, the generated comments blindly strip some special strings. I don't think it is a good thing.
   > 
   > I suggest we keep it simple and don't touch comment content, this is also a safe path. If we want javadoc style comments, I think it is ok to convert them manually.
   
   Thank you very much for your review. I really didn't consider that 😂😂.   I will keep the original format output.
   ﻿
   However, for the end-of-line comments, should I continue to keep them at the end of the line or is it better to move them above the code?


;07/Nov/24 08:10;githubbot;600","kezhuw commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2462189756

   > for the end-of-line comments, should I continue to keep them at the end of the line or is it better to move them above the code?
   
   I prefer to move them above the code.


;07/Nov/24 13:04;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2462204400

   > > for the end-of-line comments, should I continue to keep them at the end of the line or is it better to move them above the code?
   > 
   > I prefer to move them above the code.
   
   Thanks, I thought so too, I'll modify the code.


;07/Nov/24 13:11;githubbot;600","kezhuw commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1832739515


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +790,53 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    private String getJavaFieldComments(JField jField) {
+        StringJoiner javaFieldCommentsJoiner =
+                new StringJoiner(""\n   * "", ""  /**\n   * "", ""\n   */\n"").setEmptyValue("""");
+        return getFieldComments(jField, javaFieldCommentsJoiner);
+    }
+
+    private String getCFieldComments(JField jField) {
+        StringJoiner cFieldCommentsJoiner =
+                new StringJoiner(""\n     * "", ""    /**\n     * "", ""\n     */\n"").setEmptyValue("""");
+        return getFieldComments(jField, cFieldCommentsJoiner);
+    }
+
+    private String getFieldComments(JField jField, StringJoiner fieldCommentsJoiner) {
+        List<String> fieldSpecialToken = jCommentGenerator.getFieldCommentsList(jField);
+        return getComments(fieldCommentsJoiner, fieldSpecialToken);
+    }
+
+    private String getRecordComments() {
+        List<String> classSpecialToken = jCommentGenerator.getRecordCommentsList(this);
+
+        StringJoiner recordCommentsJoiner =
+                new StringJoiner(""\n * "", ""/**\n * "", ""\n */\n"").setEmptyValue("""");
+        return getComments(recordCommentsJoiner, classSpecialToken);
+    }
+
+    private static String getComments(StringJoiner commentsJoiner, List<String> commentList) {
+        if (commentList == null || commentList.isEmpty()) {
+            return commentsJoiner.toString();
+        }
+
+        for (String commentMulti : commentList) {
+            if (commentMulti == null || commentMulti.isEmpty()) {
+                continue;
+            }
+
+            String[] commentArray = commentMulti.split(""\n"");
+            for (String comment : commentArray) {
+
+                comment = comment.replaceAll(""//|/\\*\\*|/\\*|\\*\\*/|\\*/"", """")

Review Comment:
   s/do/don't/



;07/Nov/24 14:06;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1832790508


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +790,53 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    private String getJavaFieldComments(JField jField) {
+        StringJoiner javaFieldCommentsJoiner =
+                new StringJoiner(""\n   * "", ""  /**\n   * "", ""\n   */\n"").setEmptyValue("""");
+        return getFieldComments(jField, javaFieldCommentsJoiner);
+    }
+
+    private String getCFieldComments(JField jField) {
+        StringJoiner cFieldCommentsJoiner =
+                new StringJoiner(""\n     * "", ""    /**\n     * "", ""\n     */\n"").setEmptyValue("""");
+        return getFieldComments(jField, cFieldCommentsJoiner);
+    }
+
+    private String getFieldComments(JField jField, StringJoiner fieldCommentsJoiner) {
+        List<String> fieldSpecialToken = jCommentGenerator.getFieldCommentsList(jField);
+        return getComments(fieldCommentsJoiner, fieldSpecialToken);
+    }
+
+    private String getRecordComments() {
+        List<String> classSpecialToken = jCommentGenerator.getRecordCommentsList(this);
+
+        StringJoiner recordCommentsJoiner =
+                new StringJoiner(""\n * "", ""/**\n * "", ""\n */\n"").setEmptyValue("""");
+        return getComments(recordCommentsJoiner, classSpecialToken);
+    }
+
+    private static String getComments(StringJoiner commentsJoiner, List<String> commentList) {
+        if (commentList == null || commentList.isEmpty()) {
+            return commentsJoiner.toString();
+        }
+
+        for (String commentMulti : commentList) {
+            if (commentMulti == null || commentMulti.isEmpty()) {
+                continue;
+            }
+
+            String[] commentArray = commentMulti.split(""\n"");
+            for (String comment : commentArray) {
+
+                comment = comment.replaceAll(""//|/\\*\\*|/\\*|\\*\\*/|\\*/"", """")

Review Comment:
   > I do think people will want to maintain this kind of code.
   I'll amend that and I won't touch the comments so they're not needed here.



;07/Nov/24 14:36;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2462444410

   Hi @kezhuw , I made some changes, could you take a look at it for me?


;07/Nov/24 14:56;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2462473973

   Hi @kezhuw  ,  I made some changes, could you take a look at it for me?
   
   I won't touch the annotation content now.
   
   > But I still formatted it a little bit here, because for example, field needs a few spaces, class does not need spaces, and the number of spaces in java and c is also different.
   ```java
     private static String getComments(String space, List<String> commentList) {
         if (commentList == null || commentList.isEmpty()) {
             return """";
         }
   
         String comments = String.join("""", commentList);
   
         StringBuilder formatBuilder = new StringBuilder();
         for (String s : comments.split(""\r?\n"")) {
             formatBuilder.append(""\n"")
                     .append(space)
                     .append(s.replaceAll(""^[ \t]+"", """"));
         }
   
         return formatBuilder.append(""\n"").toString();
     }
   ````
   
   Now the comment is like this
   <img width=""1343"" alt=""image"" src=""https://github.com/user-attachments/assets/d018d3cf-d30f-49b3-a4fd-90008f0e7f06"">
   <img width=""1256"" alt=""image"" src=""https://github.com/user-attachments/assets/38ba86f4-cc0b-4156-8bc7-6540abe3b20e"">
   


;07/Nov/24 15:07;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2475347667

   Hi @kezhuw, These days, I have researched how JavaParser and Protobuf handle comments again。


;14/Nov/24 03:39;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2475410906

   Hi @kezhuw, These days, I have researched how JavaParser and Protobuf handle comments again.
   
   The [Comment#content](https://github.com/javaparser/javaparser/blob/master/javaparser-core/src/main/java/com/github/javaparser/ast/comments/Comment.java) method of Javaparser can retrieve the content inside the comment, which will remove the first layer`/**   */` or `/*   */` or `//` .  
   I think I might also be able to obtain the internal content of comments in this way for formatting purposes.
   
   The creatCommentFromToken method is the process of handling content
   https://github.com/javaparser/javaparser/blob/master/javaparser-core/src/main/javacc-support/com/github/javaparser/GeneratedJavaParserTokenManagerBase.java
   
   <br>
   Then I also tested the process of protobuf handling comments.
   
   protobuf will format `/**  */` or `/*  */` or `//` as `/**  */`. 
   <img width=""1338"" alt=""image"" src=""https://github.com/user-attachments/assets/dfd81b38-a7e8-46a1-a75a-9c6d50339808"">
   
   Will convert multi line comments nested within single line comments into `Html Entity`. (Because multi line comments cannot be nested within each other)
   
   <img width=""1367"" alt=""image"" src=""https://github.com/user-attachments/assets/eae37bd6-dbc4-4e1a-8083-c49be44e7b4e"">
   
   <img width=""1342"" alt=""image"" src=""https://github.com/user-attachments/assets/a7b62be8-128b-4eac-8f9d-a4c9c61b697c"">
   
   So I think I just need to handle the following single line comments and a few situations
   ```text
   /*       /*        /**         /**
             *                     *
             *                     *
   */        */        */          */
   ```
   For internal comments, I only need to convert`/*` and `*/` to `HTML Entity` (because multi line comments cannot be nested)
   
   So can I make further modifications this way or are there any issues I haven't thought of?


;14/Nov/24 04:50;githubbot;600","kezhuw commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1847720246


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JCommentGenerator.java:
##########
@@ -0,0 +1,183 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.jute.compiler;
+
+import java.util.ArrayList;
+import java.util.Collections;
+import java.util.Iterator;
+import java.util.List;
+import java.util.Map;
+import java.util.NavigableMap;
+import java.util.Optional;
+import java.util.TreeMap;
+import java.util.TreeSet;
+import org.apache.jute.compiler.generated.Token;
+
+public class JCommentGenerator {
+
+    /**
+     * {fieldCommentsBeginLineNumber : {fieldCommentsBeginColumn : fieldCommentsToken}}.
+     */
+    private final TreeMap<Integer, TreeMap<Integer, Token>> fieldCommentsTokenMap = new TreeMap<>();
+
+    /**
+     * {recordCommentsBeginLineNumber : {recordCommentsBeginColumn : recordCommentsToken}}.
+     */
+    private final TreeMap<Integer, TreeMap<Integer, Token>> recordCommentsTokenMap = new TreeMap<>();
+
+    private final TreeSet<RangeInfo> jFieldTreeSet = new TreeSet<>();
+
+    private final TreeSet<RangeInfo> jRecordTreeSet = new TreeSet<>();
+
+    public void addJRecord(JRecord jRecord) {
+        jRecordTreeSet.add(jRecord);
+    }
+
+    public void addJField(JField jField) {
+        jFieldTreeSet.add(jField);
+    }
+
+    public void putFieldSpecialToken(Token fieldToken) {
+        putSpecialToken(fieldToken, fieldCommentsTokenMap);
+    }
+
+    public void putRecordSpecialToken(Token recordToken) {
+        putSpecialToken(recordToken, recordCommentsTokenMap);
+    }
+
+    private static void putSpecialToken(Token classToken, TreeMap<Integer, TreeMap<Integer, Token>> commentsTokenMap) {
+        if (classToken == null || classToken.specialToken == null || commentsTokenMap == null) {
+            return;
+        }
+
+        Token tmp = classToken;
+        while ((tmp = tmp.specialToken) != null && tmp.image != null) {
+            commentsTokenMap.computeIfAbsent(tmp.beginLine, key -> new TreeMap<>())
+                    .putIfAbsent(tmp.beginColumn, tmp);
+        }
+    }
+
+    public List<String> getRecordCommentsList(JRecord jRecord) {
+        return getCommentsList(jRecord, jRecordTreeSet, recordCommentsTokenMap);
+    }
+
+    public List<String> getFieldCommentsList(JField jField) {
+        return getCommentsList(jField, jFieldTreeSet, fieldCommentsTokenMap);
+    }
+
+    private static List<String> getCommentsList(RangeInfo rangeInfo,

Review Comment:
   I expect this should be much clear. Given that we support only comments in three places:
   1. Comments before `class` for record types.
   2. Comments before fields.
   3. Line ending comments for fields.
   
   For the first, we could extract comments from `Token::specialToken`. For the second, similar to the first, but we have to drop comments(could be in either `//` or `/* */` form) belong to previous field. For the third, additional lookup is required, also drop comments belong to next field.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JCommentGenerator.java:
##########
@@ -0,0 +1,183 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.jute.compiler;
+
+import java.util.ArrayList;
+import java.util.Collections;
+import java.util.Iterator;
+import java.util.List;
+import java.util.Map;
+import java.util.NavigableMap;
+import java.util.Optional;
+import java.util.TreeMap;
+import java.util.TreeSet;
+import org.apache.jute.compiler.generated.Token;
+
+public class JCommentGenerator {
+
+    /**
+     * {fieldCommentsBeginLineNumber : {fieldCommentsBeginColumn : fieldCommentsToken}}.
+     */
+    private final TreeMap<Integer, TreeMap<Integer, Token>> fieldCommentsTokenMap = new TreeMap<>();
+
+    /**
+     * {recordCommentsBeginLineNumber : {recordCommentsBeginColumn : recordCommentsToken}}.
+     */
+    private final TreeMap<Integer, TreeMap<Integer, Token>> recordCommentsTokenMap = new TreeMap<>();
+
+    private final TreeSet<RangeInfo> jFieldTreeSet = new TreeSet<>();
+
+    private final TreeSet<RangeInfo> jRecordTreeSet = new TreeSet<>();
+
+    public void addJRecord(JRecord jRecord) {
+        jRecordTreeSet.add(jRecord);
+    }
+
+    public void addJField(JField jField) {
+        jFieldTreeSet.add(jField);

Review Comment:
   `extends RangeInfo` is aggressive. `addCommentRange(JXyz jXyz, RangeInfo rangeInfo)` should be sufficient.



;19/Nov/24 06:55;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1847769128


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JCommentGenerator.java:
##########
@@ -0,0 +1,183 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.jute.compiler;
+
+import java.util.ArrayList;
+import java.util.Collections;
+import java.util.Iterator;
+import java.util.List;
+import java.util.Map;
+import java.util.NavigableMap;
+import java.util.Optional;
+import java.util.TreeMap;
+import java.util.TreeSet;
+import org.apache.jute.compiler.generated.Token;
+
+public class JCommentGenerator {
+
+    /**
+     * {fieldCommentsBeginLineNumber : {fieldCommentsBeginColumn : fieldCommentsToken}}.
+     */
+    private final TreeMap<Integer, TreeMap<Integer, Token>> fieldCommentsTokenMap = new TreeMap<>();
+
+    /**
+     * {recordCommentsBeginLineNumber : {recordCommentsBeginColumn : recordCommentsToken}}.
+     */
+    private final TreeMap<Integer, TreeMap<Integer, Token>> recordCommentsTokenMap = new TreeMap<>();
+
+    private final TreeSet<RangeInfo> jFieldTreeSet = new TreeSet<>();
+
+    private final TreeSet<RangeInfo> jRecordTreeSet = new TreeSet<>();
+
+    public void addJRecord(JRecord jRecord) {
+        jRecordTreeSet.add(jRecord);
+    }
+
+    public void addJField(JField jField) {
+        jFieldTreeSet.add(jField);

Review Comment:
   OK, I will modify it



;19/Nov/24 07:25;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2491334165

   Hi @kezhuw,  Thank you for your review last time. The code feels much more concise now.
   Could you take another look at it for me?


;21/Nov/24 14:17;githubbot;600","kezhuw commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1857737011


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +793,88 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = getComments(jField.getTypeToken().specialToken);
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token tmpToken = jField.getNextToken();
+        while (tmpToken.specialToken != null) {
+
+            if (jField.getTypeToken().beginLine == tmpToken.specialToken.beginLine) {
+                Token endLineComments = tmpToken.specialToken;
+                tmpToken.specialToken = null;
+                comments.addAll(getComments(endLineComments));
+                break;
+            }
+
+            tmpToken = tmpToken.specialToken;
+        }
+
+        return formatComments(space, comments);
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        return formatComments("""", getComments(getRecordToken().specialToken));
+    }
+
+    private static String formatComments(String space, List<String> commentList) {
+        if (commentList == null || commentList.isEmpty()) {
+            return """";
+        }
+
+        String comments = String.join("""", commentList);
+
+        StringBuilder formatBuilder = new StringBuilder();
+        for (String s : comments.split(""\r?\n"")) {
+            formatBuilder.append(""\n"")
+                    .append(space)
+                    .append(s.replaceAll(""^[ \t]+"", """"));
+        }
+
+        return formatBuilder.append(""\n"").toString();
+    }
+
+    private static List<String> getComments(Token token) {

Review Comment:
   Currently, all leading spaces in mult-line comment are dropped in generation. Can we reconstruct these for multi-line comment ?
   
   Or how about `<MULTI_LINE_COMMENT: ""/*"" (~[""*""])* ""*"" (~[""*"",""/""] (~[""*""])* ""*"" | ""*"")* ""/"">` ? (https://stackoverflow.com/questions/34550579/multiline-comments-in-javacc)
   
   I find no hole despite there is one comment say that  ""not correct with respect to the language definition"".
   
   I think it is easy to reconstruct original format if multi-line comment is captured into one token.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/generated/rcc.jj:
##########
@@ -111,17 +119,7 @@ SKIP :
 
 SPECIAL_TOKEN :
 {
-  ""//"" : WithinOneLineComment
-}
-
-<WithinOneLineComment> SPECIAL_TOKEN :
-{
-  <(""\n"" | ""\r"" | ""\r\n"" )> : DEFAULT
-}
-
-<WithinOneLineComment> MORE :
-{
-  <~[]>
+  <WithinOneLineComment: ""//"" (~[""\n"",""\r""])* (""\n""|""\r""|""\r\n"")>

Review Comment:
   Should be ""ONE_LINE_COMMENT"" ? It is as a ""Token.kind"" constant in generated in ""RccConstants"".



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +793,88 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {

Review Comment:
   s/space/indent/ ?



;26/Nov/24 04:03;githubbot;600","kezhuw commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1857740621


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +793,88 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = getComments(jField.getTypeToken().specialToken);
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token tmpToken = jField.getNextToken();
+        while (tmpToken.specialToken != null) {
+
+            if (jField.getTypeToken().beginLine == tmpToken.specialToken.beginLine) {
+                Token endLineComments = tmpToken.specialToken;
+                tmpToken.specialToken = null;
+                comments.addAll(getComments(endLineComments));
+                break;
+            }
+
+            tmpToken = tmpToken.specialToken;
+        }
+
+        return formatComments(space, comments);
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        return formatComments("""", getComments(getRecordToken().specialToken));
+    }
+
+    private static String formatComments(String space, List<String> commentList) {
+        if (commentList == null || commentList.isEmpty()) {
+            return """";
+        }
+
+        String comments = String.join("""", commentList);
+
+        StringBuilder formatBuilder = new StringBuilder();
+        for (String s : comments.split(""\r?\n"")) {
+            formatBuilder.append(""\n"")
+                    .append(space)
+                    .append(s.replaceAll(""^[ \t]+"", """"));
+        }
+
+        return formatBuilder.append(""\n"").toString();
+    }
+
+    private static List<String> getComments(Token token) {

Review Comment:
   > all leading spaces in mult-line comment are dropped in generation
   
   ```
   /**
    ** Something.
    **/
   ```
   
   For example, above comment will be formatted as following.
    
   ```
   /**
   ** Something.
   **/
   ```



;26/Nov/24 04:07;githubbot;600","kezhuw commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1857741746


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +793,88 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = getComments(jField.getTypeToken().specialToken);
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token tmpToken = jField.getNextToken();
+        while (tmpToken.specialToken != null) {
+
+            if (jField.getTypeToken().beginLine == tmpToken.specialToken.beginLine) {
+                Token endLineComments = tmpToken.specialToken;
+                tmpToken.specialToken = null;
+                comments.addAll(getComments(endLineComments));
+                break;
+            }
+
+            tmpToken = tmpToken.specialToken;
+        }
+
+        return formatComments(space, comments);
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        return formatComments("""", getComments(getRecordToken().specialToken));
+    }
+
+    private static String formatComments(String space, List<String> commentList) {
+        if (commentList == null || commentList.isEmpty()) {
+            return """";
+        }
+
+        String comments = String.join("""", commentList);
+
+        StringBuilder formatBuilder = new StringBuilder();
+        for (String s : comments.split(""\r?\n"")) {
+            formatBuilder.append(""\n"")
+                    .append(space)
+                    .append(s.replaceAll(""^[ \t]+"", """"));
+        }
+
+        return formatBuilder.append(""\n"").toString();
+    }
+
+    private static List<String> getComments(Token token) {

Review Comment:
   > Or how about <MULTI_LINE_COMMENT: ""/*"" (~[""*""])* ""*"" (~[""*"",""/""] (~[""*""])* ""*"" | ""*"")* ""/""> ? (https://stackoverflow.com/questions/34550579/multiline-comments-in-javacc)
   
   > I think it is easy to reconstruct original format if multi-line comment is captured into one token.
   
   I am not sure the `LOOKAHEAD` could help here. I tasted and did not succeed.



;26/Nov/24 04:09;githubbot;600","kezhuw commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1857741746


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +793,88 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = getComments(jField.getTypeToken().specialToken);
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token tmpToken = jField.getNextToken();
+        while (tmpToken.specialToken != null) {
+
+            if (jField.getTypeToken().beginLine == tmpToken.specialToken.beginLine) {
+                Token endLineComments = tmpToken.specialToken;
+                tmpToken.specialToken = null;
+                comments.addAll(getComments(endLineComments));
+                break;
+            }
+
+            tmpToken = tmpToken.specialToken;
+        }
+
+        return formatComments(space, comments);
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        return formatComments("""", getComments(getRecordToken().specialToken));
+    }
+
+    private static String formatComments(String space, List<String> commentList) {
+        if (commentList == null || commentList.isEmpty()) {
+            return """";
+        }
+
+        String comments = String.join("""", commentList);
+
+        StringBuilder formatBuilder = new StringBuilder();
+        for (String s : comments.split(""\r?\n"")) {
+            formatBuilder.append(""\n"")
+                    .append(space)
+                    .append(s.replaceAll(""^[ \t]+"", """"));
+        }
+
+        return formatBuilder.append(""\n"").toString();
+    }
+
+    private static List<String> getComments(Token token) {

Review Comment:
   > Or how about <MULTI_LINE_COMMENT: ""/*"" (~[""*""])* ""*"" (~[""*"",""/""] (~[""*""])* ""*"" | ""*"")* ""/""> ? (https://stackoverflow.com/questions/34550579/multiline-comments-in-javacc)
   
   > I think it is easy to reconstruct original format if multi-line comment is captured into one token.
   
   I am not sure the `LOOKAHEAD` could help here. I tried but did not succeed.



;26/Nov/24 04:10;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1857758636


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +793,88 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {

Review Comment:
   > s/space/indent/ ?
   
   This is because ` org.apache.jute.compiler JType # genCDecl ` also contains spaces, so I also used spaces. 😂



;26/Nov/24 04:39;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1857758636


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +793,88 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {

Review Comment:
   > s/space/indent/ ?
   
   This is because `org.apache.jute.compiler.JType#genCDecl` also contains spaces, so I also used spaces. 😂



;26/Nov/24 04:50;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1857769822


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +793,88 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = getComments(jField.getTypeToken().specialToken);
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token tmpToken = jField.getNextToken();
+        while (tmpToken.specialToken != null) {
+
+            if (jField.getTypeToken().beginLine == tmpToken.specialToken.beginLine) {
+                Token endLineComments = tmpToken.specialToken;
+                tmpToken.specialToken = null;
+                comments.addAll(getComments(endLineComments));
+                break;
+            }
+
+            tmpToken = tmpToken.specialToken;
+        }
+
+        return formatComments(space, comments);
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        return formatComments("""", getComments(getRecordToken().specialToken));
+    }
+
+    private static String formatComments(String space, List<String> commentList) {
+        if (commentList == null || commentList.isEmpty()) {
+            return """";
+        }
+
+        String comments = String.join("""", commentList);
+
+        StringBuilder formatBuilder = new StringBuilder();
+        for (String s : comments.split(""\r?\n"")) {
+            formatBuilder.append(""\n"")
+                    .append(space)
+                    .append(s.replaceAll(""^[ \t]+"", """"));
+        }
+
+        return formatBuilder.append(""\n"").toString();
+    }
+
+    private static List<String> getComments(Token token) {

Review Comment:
   Oh, then I'll research and see if I can capture multi line comments as one token.



;26/Nov/24 04:55;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1857771645


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/generated/rcc.jj:
##########
@@ -111,17 +119,7 @@ SKIP :
 
 SPECIAL_TOKEN :
 {
-  ""//"" : WithinOneLineComment
-}
-
-<WithinOneLineComment> SPECIAL_TOKEN :
-{
-  <(""\n"" | ""\r"" | ""\r\n"" )> : DEFAULT
-}
-
-<WithinOneLineComment> MORE :
-{
-  <~[]>
+  <WithinOneLineComment: ""//"" (~[""\n"",""\r""])* (""\n""|""\r""|""\r\n"")>

Review Comment:
   > Should be ""ONE_LINE_COMMENT"" ? It is as a ""Token.kind"" constant in generated in ""RccConstants"".
   
   Yes, I'll make some modifications here.



;26/Nov/24 04:57;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1857886486


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +793,88 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = getComments(jField.getTypeToken().specialToken);
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token tmpToken = jField.getNextToken();
+        while (tmpToken.specialToken != null) {
+
+            if (jField.getTypeToken().beginLine == tmpToken.specialToken.beginLine) {
+                Token endLineComments = tmpToken.specialToken;
+                tmpToken.specialToken = null;
+                comments.addAll(getComments(endLineComments));
+                break;
+            }
+
+            tmpToken = tmpToken.specialToken;
+        }
+
+        return formatComments(space, comments);
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        return formatComments("""", getComments(getRecordToken().specialToken));
+    }
+
+    private static String formatComments(String space, List<String> commentList) {
+        if (commentList == null || commentList.isEmpty()) {
+            return """";
+        }
+
+        String comments = String.join("""", commentList);
+
+        StringBuilder formatBuilder = new StringBuilder();
+        for (String s : comments.split(""\r?\n"")) {
+            formatBuilder.append(""\n"")
+                    .append(space)
+                    .append(s.replaceAll(""^[ \t]+"", """"));
+        }
+
+        return formatBuilder.append(""\n"").toString();
+    }
+
+    private static List<String> getComments(Token token) {

Review Comment:
   > Currently, all leading spaces in mult-line comment are dropped in generation. Can we reconstruct these for multi-line comment ?
   > 
   > Or how about `<MULTI_LINE_COMMENT: ""/*"" (~[""*""])* ""*"" (~[""*"",""/""] (~[""*""])* ""*"" | ""*"")* ""/"">` ? (https://stackoverflow.com/questions/34550579/multiline-comments-in-javacc)
   > 
   > I find no hole despite there is one comment say that ""not correct with respect to the language definition"".
   > 
   > I think it is easy to reconstruct original format if multi-line comment is captured into one token.
   
   
   This way, multiple lines of comments can be obtained into one token.
   ```
   MORE :
   {
     <ENTER_JAVADOC_COMMENT: ""/**"" ~[""/""]> { input_stream.backup(1); } : IN_JAVADOC_COMMENT
   |
     <ENTER_MULTILINE_COMMENT: ""/*""> : IN_MULTI_LINE_COMMENT
   }
   
   <IN_JAVADOC_COMMENT>
   SPECIAL_TOKEN :
   {
     <JAVADOC_COMMENT: ""*/"" > : DEFAULT
   }
   
   <IN_MULTI_LINE_COMMENT>
   SPECIAL_TOKEN :
   {
     <MULTI_LINE_COMMENT: ""*/"" > : DEFAULT
   }
   
   <IN_JAVADOC_COMMENT, IN_MULTI_LINE_COMMENT>
   MORE :
   {
     <COMMENT_CONTENT: ~[] >
   }
   ```
   
   But there is still a small issue, it seems that there is no way to remove the space at the beginning of each middle line, and there is no space before the first line of multi line comments. 😂😂
   <img width=""863"" alt=""image"" src=""https://github.com/user-attachments/assets/6c47a123-e595-4608-9146-b8d196e876e6"">
   <img width=""729"" alt=""image"" src=""https://github.com/user-attachments/assets/9eee459f-f946-47b8-b119-701fe0b72b9f"">
   



;26/Nov/24 06:41;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2503012842

   Hi @kezhuw , Thank you for providing the example. 
   I didn't expect this to reconstruct the style of the judge. 😂  This is much better than before. I have made modifications based on your example and tested it.


;27/Nov/24 06:29;githubbot;600","kezhuw commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1860576159


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +795,122 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = extractLeadingComments(jField.getTypeToken().specialToken);
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token tmpToken = jField.getNextToken();
+        while (tmpToken.specialToken != null) {
+
+            if (jField.getTypeToken().beginLine == tmpToken.specialToken.beginLine) {
+                Token endLineComments = tmpToken.specialToken;
+                tmpToken.specialToken = null;
+                comments.addAll(extractLeadingComments(endLineComments));
+                break;
+            }
+
+            tmpToken = tmpToken.specialToken;
+        }
+
+        return formatComments(space, comments);
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        return formatComments("""", extractLeadingComments(getRecordToken().specialToken));
+    }
+
+    private static String formatComments(String indent, List<String> commentLines) {
+        if (commentLines == null || commentLines.isEmpty()) {
+            return """";
+        }
+
+        StringBuilder builder = new StringBuilder();
+        for (String line : commentLines) {
+            if (!line.isEmpty()) {
+                builder.append(indent).append(line);
+            }
+            builder.append(System.lineSeparator());
+        }
+
+        return builder.toString();
+    }
+
+    /**
+     * Extracts leading comments with indentation and line separator trimmed.
+     *
+     * <p>Empty line is represented as empty string.
+     */
+    private static List<String> extractLeadingComments(Token token) {
+        List<String> comments = new ArrayList<>();
+
+        if (token == null) {
+            return comments;
+        }
+
+        Token tmpToken = token;
+        while (tmpToken.specialToken != null) {
+            tmpToken = tmpToken.specialToken;
+        }

Review Comment:
   Add a method `getCommentToken` ? There is a similar loop in `getFieldComments`.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/generated/rcc.jj:
##########
@@ -274,22 +261,37 @@ JRecord Record() :
     ArrayList<JField> flist = new ArrayList<JField>();
     Token t;
     JField f;
+    // Get the comments on the class token
+    Token recordTkn;
+    Token rbraceTkn;
 }
 {
-    <RECORD_TKN>
+    recordTkn = <RECORD_TKN>
     t = <IDENT_TKN>
     { rname = t.image; }
     <LBRACE_TKN>
     (
         f = Field()

Review Comment:
   I think [`getToken(1)`](https://www.cs.purdue.edu/homes/hosking/javacc/doc/apiroutines.html#getToken) could help you eliminating most intrusive code.
   
   ```jj
   { typeToken = getToken(1) }
   ```
   
   Then most changes should resides in `Record()`.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +793,88 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {

Review Comment:
   Sorry for the confusion! I means it should be better to rename variable `space`  to `indent`.



;27/Nov/24 12:30;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1860637296


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/generated/rcc.jj:
##########
@@ -274,22 +261,37 @@ JRecord Record() :
     ArrayList<JField> flist = new ArrayList<JField>();
     Token t;
     JField f;
+    // Get the comments on the class token
+    Token recordTkn;
+    Token rbraceTkn;
 }
 {
-    <RECORD_TKN>
+    recordTkn = <RECORD_TKN>
     t = <IDENT_TKN>
     { rname = t.image; }
     <LBRACE_TKN>
     (
         f = Field()

Review Comment:
   > I think [`getToken(1)`](https://www.cs.purdue.edu/homes/hosking/javacc/doc/apiroutines.html#getToken) could help you eliminating most intrusive code.
   > 
   > ```
   > { typeToken = getToken(1) }
   > ```
   > 
   > Then most changes should resides in `Record()`.
   
   Oh, I've been searching for a long time before. I was looking for an API that could traverse tokens, but I couldn't find it. I didn't expect to find such an API. I'll give it a try. 



;27/Nov/24 13:11;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1860644349


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +793,88 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {

Review Comment:
   > Sorry for the confusion! I means it should be better to rename variable `space` to `indent`.
   
   Okay, I will make some modifications here.



;27/Nov/24 13:16;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1860645336


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +795,122 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String space) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = extractLeadingComments(jField.getTypeToken().specialToken);
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token tmpToken = jField.getNextToken();
+        while (tmpToken.specialToken != null) {
+
+            if (jField.getTypeToken().beginLine == tmpToken.specialToken.beginLine) {
+                Token endLineComments = tmpToken.specialToken;
+                tmpToken.specialToken = null;
+                comments.addAll(extractLeadingComments(endLineComments));
+                break;
+            }
+
+            tmpToken = tmpToken.specialToken;
+        }
+
+        return formatComments(space, comments);
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        return formatComments("""", extractLeadingComments(getRecordToken().specialToken));
+    }
+
+    private static String formatComments(String indent, List<String> commentLines) {
+        if (commentLines == null || commentLines.isEmpty()) {
+            return """";
+        }
+
+        StringBuilder builder = new StringBuilder();
+        for (String line : commentLines) {
+            if (!line.isEmpty()) {
+                builder.append(indent).append(line);
+            }
+            builder.append(System.lineSeparator());
+        }
+
+        return builder.toString();
+    }
+
+    /**
+     * Extracts leading comments with indentation and line separator trimmed.
+     *
+     * <p>Empty line is represented as empty string.
+     */
+    private static List<String> extractLeadingComments(Token token) {
+        List<String> comments = new ArrayList<>();
+
+        if (token == null) {
+            return comments;
+        }
+
+        Token tmpToken = token;
+        while (tmpToken.specialToken != null) {
+            tmpToken = tmpToken.specialToken;
+        }

Review Comment:
   > Add a method `getCommentToken` ? There is a similar loop in `getFieldComments`.
   
   Okay, I'll make some changes here.



;27/Nov/24 13:17;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2505151135

   Hi @kezhuw , I have completed the modifications and testing, can you help me take a look again


;28/Nov/24 02:39;githubbot;600","kezhuw commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1861950607


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/generated/rcc.jj:
##########
@@ -274,22 +257,38 @@ JRecord Record() :
     ArrayList<JField> flist = new ArrayList<JField>();
     Token t;
     JField f;
+    // Get the comments on the class token
+    Token recordTkn;
+    Token rbraceTkn;
+    Token typeTkn;
 }
 {
-    <RECORD_TKN>
+    recordTkn = <RECORD_TKN>
     t = <IDENT_TKN>
     { rname = t.image; }
     <LBRACE_TKN>
     (
+        {typeTkn = getToken(1);}
         f = Field()
-        { flist.add(f); }
+        {
+            flist.add(f);
+        }
         <SEMICOLON_TKN>
+        {
+            f.setTypeToken(typeTkn);
+            prevFieldSetNextTkn(typeTkn);
+            prevField = f;

Review Comment:
   `prevField` is not used outside `Record`, it should be a local also.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/generated/rcc.jj:
##########
@@ -274,22 +257,38 @@ JRecord Record() :
     ArrayList<JField> flist = new ArrayList<JField>();
     Token t;
     JField f;
+    // Get the comments on the class token
+    Token recordTkn;
+    Token rbraceTkn;
+    Token typeTkn;
 }
 {
-    <RECORD_TKN>
+    recordTkn = <RECORD_TKN>
     t = <IDENT_TKN>
     { rname = t.image; }
     <LBRACE_TKN>
     (
+        {typeTkn = getToken(1);}
         f = Field()
-        { flist.add(f); }
+        {
+            flist.add(f);
+        }
         <SEMICOLON_TKN>
+        {
+            f.setTypeToken(typeTkn);
+            prevFieldSetNextTkn(typeTkn);
+            prevField = f;

Review Comment:
   How about replace `nextToken` with `semicolonToken` ? I think it is suitable:
   1. Semicolon is the end of field declaration.
   2. `semicolonToken.next` is the next token. We can extract possible end of line comments from there.
   
   This way we don't need `prevField` anymore.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +795,127 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = extractLeadingComments(getCommentToken(jField.getTypeToken().specialToken));
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token commentToken = getCommentToken(jField.getNextToken().specialToken);
+        if (commentToken != null && jField.getTypeToken().beginLine == commentToken.beginLine) {
+
+            if (jField.getNextToken().specialToken == commentToken) {
+                jField.getNextToken().specialToken = null;
+            }
+
+            if (commentToken.next != null) {
+                commentToken.next.specialToken = null;
+                commentToken.next = null;
+            }
+            comments.addAll(extractLeadingComments(commentToken));
+        }
+
+        return formatComments(indent, comments);
+    }
+
+    private Token getCommentToken(Token token) {

Review Comment:
   How about accept normal token as input ? I saw pattern `getCommentToken(xzyToken.specialToken)`.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +795,127 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = extractLeadingComments(getCommentToken(jField.getTypeToken().specialToken));
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token commentToken = getCommentToken(jField.getNextToken().specialToken);
+        if (commentToken != null && jField.getTypeToken().beginLine == commentToken.beginLine) {
+
+            if (jField.getNextToken().specialToken == commentToken) {
+                jField.getNextToken().specialToken = null;
+            }
+
+            if (commentToken.next != null) {
+                commentToken.next.specialToken = null;
+                commentToken.next = null;

Review Comment:
   Also `extractLeadingComments` could take a `sentinelToken` to limit end-line comment traversal without changing `Token.next` field.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +795,127 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = extractLeadingComments(getCommentToken(jField.getTypeToken().specialToken));
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token commentToken = getCommentToken(jField.getNextToken().specialToken);
+        if (commentToken != null && jField.getTypeToken().beginLine == commentToken.beginLine) {
+
+            if (jField.getNextToken().specialToken == commentToken) {
+                jField.getNextToken().specialToken = null;
+            }
+
+            if (commentToken.next != null) {
+                commentToken.next.specialToken = null;
+                commentToken.next = null;

Review Comment:
   I am thinking whether we should have a `previousToken`. This way `getCommentToken` can skip end-line comment for previous entry without modifying things in code generation. I expect code generation is reproducible.



;28/Nov/24 11:51;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1862056149


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +795,127 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = extractLeadingComments(getCommentToken(jField.getTypeToken().specialToken));
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token commentToken = getCommentToken(jField.getNextToken().specialToken);
+        if (commentToken != null && jField.getTypeToken().beginLine == commentToken.beginLine) {
+
+            if (jField.getNextToken().specialToken == commentToken) {
+                jField.getNextToken().specialToken = null;
+            }
+
+            if (commentToken.next != null) {
+                commentToken.next.specialToken = null;
+                commentToken.next = null;
+            }
+            comments.addAll(extractLeadingComments(commentToken));
+        }
+
+        return formatComments(indent, comments);
+    }
+
+    private Token getCommentToken(Token token) {

Review Comment:
   > How about accept normal token as input ? I saw pattern `getCommentToken(xzyToken.specialToken)`.
   
   Sure, I'll make some changes here



;28/Nov/24 12:02;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1862093585


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/generated/rcc.jj:
##########
@@ -274,22 +257,38 @@ JRecord Record() :
     ArrayList<JField> flist = new ArrayList<JField>();
     Token t;
     JField f;
+    // Get the comments on the class token
+    Token recordTkn;
+    Token rbraceTkn;
+    Token typeTkn;
 }
 {
-    <RECORD_TKN>
+    recordTkn = <RECORD_TKN>
     t = <IDENT_TKN>
     { rname = t.image; }
     <LBRACE_TKN>
     (
+        {typeTkn = getToken(1);}
         f = Field()
-        { flist.add(f); }
+        {
+            flist.add(f);
+        }
         <SEMICOLON_TKN>
+        {
+            f.setTypeToken(typeTkn);
+            prevFieldSetNextTkn(typeTkn);
+            prevField = f;

Review Comment:
   > How about replace `nextToken` with `semicolonToken` ? I think it is suitable:
   > 
   > 1. Semicolon is the end of field declaration.
   > 2. `semicolonToken.next` is the next token. We can extract possible end of line comments from there.
   > 
   > This way we don't need `prevField` anymore.
   
   Ah, I see. Sorry I didn't think of writing this before.🤣🤣



;28/Nov/24 12:32;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1862113457


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +795,127 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        List<String> comments = extractLeadingComments(getCommentToken(jField.getTypeToken().specialToken));
+
+        // get the end-of-line comments of fields
+        // If the current field and the next field are on the same line,
+        // the leading field comment of the next field should be discarded
+        Token commentToken = getCommentToken(jField.getNextToken().specialToken);
+        if (commentToken != null && jField.getTypeToken().beginLine == commentToken.beginLine) {
+
+            if (jField.getNextToken().specialToken == commentToken) {
+                jField.getNextToken().specialToken = null;
+            }
+
+            if (commentToken.next != null) {
+                commentToken.next.specialToken = null;
+                commentToken.next = null;

Review Comment:
   > I am thinking whether we should have a `previousToken`. This way `getCommentToken` can skip end-line comment for previous entry without modifying things in code generation. I expect code generation is reproducible.
   
   That makes sense, I understand, I'll change it.



;28/Nov/24 12:45;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2506432669

   Hi @kezhuw , I have finished the revision. Thank you very much for your review. Since I may not have much work experience, there may be many small problems in my code. Thank you for pointing out where I can improve.😆


;28/Nov/24 16:03;githubbot;600","kezhuw commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1863085617


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +795,135 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        Token beforeTheLineCommentToken = getCommentToken(jField.getPreviousToken(), jField.getTypeToken());
+        List<String> comments = extractLeadingComments(beforeTheLineCommentToken, null);
+
+        Token endOfLineCommentToken = getCommentToken(null, jField.getNextToken());
+        if (endOfLineCommentToken != null && jField.getTypeToken().beginLine == endOfLineCommentToken.beginLine) {
+
+            comments.addAll(extractLeadingComments(endOfLineCommentToken, endOfLineCommentToken.next));
+        }
+
+        return formatComments(indent, comments);
+    }
+
+    private Token getCommentToken(Token previousToken, Token token) {
+        if (token == null || token.specialToken == null || belongsToThePreviousToken(previousToken, token.specialToken)) {
+            return null;
+        }
+
+        Token tmpToken = token.specialToken;
+        while (tmpToken.specialToken != null) {
+
+            if (belongsToThePreviousToken(previousToken, tmpToken.specialToken)) {

Review Comment:
   ```java
   Token commentToken = token.specialToken;
   while (commentToken.specialToken != null) {
       commentToken = commentToken.specialToken;
   }
   // Skip end of line comment belong to previous token.
   if (previousToken != null && commentToken.beginLine == previousToken.endLine) {
       commentToken = commentToken.next;
   }
   ```
   
   Is this sufficient ?



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +795,135 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        Token beforeTheLineCommentToken = getCommentToken(jField.getPreviousToken(), jField.getTypeToken());
+        List<String> comments = extractLeadingComments(beforeTheLineCommentToken, null);
+
+        Token endOfLineCommentToken = getCommentToken(null, jField.getNextToken());
+        if (endOfLineCommentToken != null && jField.getTypeToken().beginLine == endOfLineCommentToken.beginLine) {
+
+            comments.addAll(extractLeadingComments(endOfLineCommentToken, endOfLineCommentToken.next));
+        }
+
+        return formatComments(indent, comments);
+    }
+
+    private Token getCommentToken(Token previousToken, Token token) {
+        if (token == null || token.specialToken == null || belongsToThePreviousToken(previousToken, token.specialToken)) {
+            return null;
+        }
+
+        Token tmpToken = token.specialToken;
+        while (tmpToken.specialToken != null) {
+
+            if (belongsToThePreviousToken(previousToken, tmpToken.specialToken)) {
+                return tmpToken;
+            }
+            tmpToken = tmpToken.specialToken;
+        }
+        return tmpToken;
+    }
+
+    /**
+     * Determine whether the current commentToken belongs to the previousToken.
+     *
+     * @return true: If the current commentToken should belong to the previousToken.
+     */
+    private boolean belongsToThePreviousToken(Token previousToken, Token commentToken) {
+        if (previousToken == null || commentToken == null) {
+            return false;
+        }
+
+        return previousToken.beginLine == commentToken.beginLine;
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        Token beforeTheClassToken = getCommentToken(null, getRecordToken());

Review Comment:
   ```suggestion
           Token commentToken = getCommentToken(getRecordToken(), null);
   ```
   
   I think `commentToken` is good enough. Also I suggest renaming `extractLeadingComments` to simple `extractComments`.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/generated/rcc.jj:
##########
@@ -274,21 +250,33 @@ JRecord Record() :
     ArrayList<JField> flist = new ArrayList<JField>();
     Token t;
     JField f;
+    // Get the comments on the class token
+    Token recordTkn;
+    Token typeTkn;
+    Token previousToken = null;
 }
 {
-    <RECORD_TKN>
+    recordTkn = <RECORD_TKN>
     t = <IDENT_TKN>
     { rname = t.image; }
     <LBRACE_TKN>
     (
+        {typeTkn = getToken(1);}
         f = Field()
         { flist.add(f); }
         <SEMICOLON_TKN>
+        {
+            f.setTypeToken(typeTkn);
+            f.setPreviousToken(previousToken);
+            f.setNextToken(getToken(1));
+            previousToken = typeTkn;

Review Comment:
   Not a big deal. But I think the `previousToken` should be `<SEMICOLON_TKN>`.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +795,135 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        Token beforeTheLineCommentToken = getCommentToken(jField.getPreviousToken(), jField.getTypeToken());
+        List<String> comments = extractLeadingComments(beforeTheLineCommentToken, null);
+
+        Token endOfLineCommentToken = getCommentToken(null, jField.getNextToken());
+        if (endOfLineCommentToken != null && jField.getTypeToken().beginLine == endOfLineCommentToken.beginLine) {
+
+            comments.addAll(extractLeadingComments(endOfLineCommentToken, endOfLineCommentToken.next));
+        }
+
+        return formatComments(indent, comments);
+    }
+
+    private Token getCommentToken(Token previousToken, Token token) {

Review Comment:
   ```suggestion
       private Token getCommentToken(Token token, Token previousToken) {
   ```
   
   I think `previousToken` is an assistant parameter and prabably don't deserve the main focus.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +795,135 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        Token beforeTheLineCommentToken = getCommentToken(jField.getPreviousToken(), jField.getTypeToken());
+        List<String> comments = extractLeadingComments(beforeTheLineCommentToken, null);
+
+        Token endOfLineCommentToken = getCommentToken(null, jField.getNextToken());
+        if (endOfLineCommentToken != null && jField.getTypeToken().beginLine == endOfLineCommentToken.beginLine) {
+
+            comments.addAll(extractLeadingComments(endOfLineCommentToken, endOfLineCommentToken.next));
+        }
+
+        return formatComments(indent, comments);
+    }
+
+    private Token getCommentToken(Token previousToken, Token token) {
+        if (token == null || token.specialToken == null || belongsToThePreviousToken(previousToken, token.specialToken)) {
+            return null;
+        }
+
+        Token tmpToken = token.specialToken;

Review Comment:
   ```suggestion
           Token commentToken = token.specialToken;
   ```
   
   I think `commentToken` is better than `tmpToken`.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/generated/rcc.jj:
##########
@@ -274,21 +250,33 @@ JRecord Record() :
     ArrayList<JField> flist = new ArrayList<JField>();
     Token t;
     JField f;
+    // Get the comments on the class token
+    Token recordTkn;
+    Token typeTkn;
+    Token previousToken = null;
 }
 {
-    <RECORD_TKN>
+    recordTkn = <RECORD_TKN>
     t = <IDENT_TKN>
     { rname = t.image; }
     <LBRACE_TKN>

Review Comment:
   ```suggestion
       previousToken = <LBRACE_TKN>
   ```



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -436,10 +455,19 @@ public void genJavaCode(File outputDirectory) throws IOException {
             jj.write(""import org.apache.jute.*;\n"");
             jj.write(""import org.apache.jute.Record; // JDK14 needs explicit import due to clash with java.lang.Record\n"");
             jj.write(""import org.apache.yetus.audience.InterfaceAudience;\n"");
+            String recordComments = getRecordComments();
+            if (recordComments != null && !recordComments.isEmpty()) {
+                jj.write(recordComments);
+            }
             jj.write(""@InterfaceAudience.Public\n"");
             jj.write(""public class "" + getName() + "" implements Record {\n"");
             for (Iterator<JField> i = mFields.iterator(); i.hasNext(); ) {
                 JField jf = i.next();
+

Review Comment:
   ```suggestion
   ```



;29/Nov/24 08:10;githubbot;600","luozongle01 commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1863136846


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +795,135 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        Token beforeTheLineCommentToken = getCommentToken(jField.getPreviousToken(), jField.getTypeToken());
+        List<String> comments = extractLeadingComments(beforeTheLineCommentToken, null);
+
+        Token endOfLineCommentToken = getCommentToken(null, jField.getNextToken());
+        if (endOfLineCommentToken != null && jField.getTypeToken().beginLine == endOfLineCommentToken.beginLine) {
+
+            comments.addAll(extractLeadingComments(endOfLineCommentToken, endOfLineCommentToken.next));
+        }
+
+        return formatComments(indent, comments);
+    }
+
+    private Token getCommentToken(Token previousToken, Token token) {
+        if (token == null || token.specialToken == null || belongsToThePreviousToken(previousToken, token.specialToken)) {
+            return null;
+        }
+
+        Token tmpToken = token.specialToken;
+        while (tmpToken.specialToken != null) {
+
+            if (belongsToThePreviousToken(previousToken, tmpToken.specialToken)) {
+                return tmpToken;
+            }
+            tmpToken = tmpToken.specialToken;
+        }
+        return tmpToken;
+    }
+
+    /**
+     * Determine whether the current commentToken belongs to the previousToken.
+     *
+     * @return true: If the current commentToken should belong to the previousToken.
+     */
+    private boolean belongsToThePreviousToken(Token previousToken, Token commentToken) {
+        if (previousToken == null || commentToken == null) {
+            return false;
+        }
+
+        return previousToken.beginLine == commentToken.beginLine;
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        Token beforeTheClassToken = getCommentToken(null, getRecordToken());

Review Comment:
   > I think `commentToken` is good enough. Also I suggest renaming `extractLeadingComments` to simple `extractComments`.
   
   Oh, that's true



;29/Nov/24 08:31;githubbot;600","kezhuw commented on code in PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#discussion_r1865098118


##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -208,8 +217,18 @@ public void genCCode(FileWriter h, FileWriter c) throws IOException {
             }
         }
         String recName = getName();
+
+        String recordComments = getRecordComments();
+        if (recordComments != null && !recordComments.isEmpty()) {
+            h.write(recordComments);
+        }
         h.write(""struct "" + recName + "" {\n"");
         for (JField f : mFields) {
+

Review Comment:
   ```suggestion
   ```



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +794,122 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        Token beforeTheLineCommentToken = getCommentToken(jField.getTypeToken(), jField.getPreviousToken());
+        List<String> comments = extractComments(beforeTheLineCommentToken, null);

Review Comment:
   ```suggestion
           List<String> comments = extractComments(beforeTheLineCommentToken, Integer.MAX_VALUE);
   ```



##########
zookeeper-jute/src/test/java/org/apache/jute/compiler/JRecordTest.java:
##########
@@ -0,0 +1,191 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.jute.compiler;
+
+import static org.junit.jupiter.api.Assertions.assertEquals;
+import java.io.StringReader;
+import java.lang.reflect.Field;
+import java.util.List;
+import org.apache.jute.compiler.generated.ParseException;
+import org.apache.jute.compiler.generated.Rcc;
+import org.junit.jupiter.api.Test;
+
+@SuppressWarnings({""unchecked"", ""SameParameterValue""})
+public class JRecordTest {
+
+    @Test
+    public void testEndOfLineComments() throws ParseException, NoSuchFieldException, IllegalAccessException {
+        String juteStr = ""module org.apache.zookeeper.data {\n""
+                + ""    // information explicitly stored by the server persistently\n""
+                + ""    class StatPersisted {\n""
+                + ""        long czxid;      // created zxid\n""
+                + ""        long mzxid;      // last modified zxid\n""
+                + ""        long ctime;      // created\n""
+                + ""        long mtime;      // last modified\n""
+                + ""    }\n""
+                + ""}"";
+
+        try (StringReader stringReader = new StringReader(juteStr)) {
+            Rcc parser = new Rcc(stringReader);
+            JFile jFile = parser.Input();
+            List<JRecord> mRecords = getField(jFile, ""mRecords"", List.class);
+            assertEquals(1, mRecords.size());
+
+            JRecord jRecord = mRecords.get(0);
+            assertEquals(""StatPersisted"", jRecord.getName());
+            List<JField> fields = jRecord.getFields();
+            assertFiled(fields);
+
+            assertEquals(""// information explicitly stored by the server persistently\n"", jRecord.getRecordComments());
+            assertEquals(""  // created zxid\n"", jRecord.getJavaFieldComments(fields.get(0)));
+            assertEquals(""  // last modified zxid\n"", jRecord.getJavaFieldComments(fields.get(1)));
+            assertEquals(""  // created\n"", jRecord.getJavaFieldComments(fields.get(2)));
+            assertEquals(""  // last modified\n"", jRecord.getJavaFieldComments(fields.get(3)));
+        }
+    }
+
+    @Test
+    public void testCommentBeforeLineAndEndOfLine() throws ParseException, NoSuchFieldException, IllegalAccessException {
+        String juteStr = ""module org.apache.zookeeper.data {\n""
+                + ""    // information explicitly stored by the server persistently\n""
+                + ""    class StatPersisted {\n""
+                + ""        // created zxid\n""
+                + ""        long czxid; // created zxid comment2\n""
+                + ""        // last modified zxid\n""
+                + ""        long mzxid; // last modified zxid comment2\n""
+                + ""        // created\n""
+                + ""        long ctime; // created comment2\n""
+                + ""        // last modified\n""
+                + ""        long mtime; // last modified comment2\n""
+                + ""    }\n""
+                + ""}"";
+        try (StringReader stringReader = new StringReader(juteStr)) {
+            Rcc parser = new Rcc(stringReader);
+            JFile jFile = parser.Input();
+            List<JRecord> mRecords = getField(jFile, ""mRecords"", List.class);
+            assertEquals(1, mRecords.size());
+
+            JRecord jRecord = mRecords.get(0);
+            assertEquals(""StatPersisted"", jRecord.getName());
+            List<JField> fields = jRecord.getFields();
+            assertFiled(fields);
+
+            assertEquals(""// information explicitly stored by the server persistently\n"", jRecord.getRecordComments());
+            assertEquals(""  // created zxid\n  // created zxid comment2\n"", jRecord.getJavaFieldComments(fields.get(0)));
+            assertEquals(""  // last modified zxid\n  // last modified zxid comment2\n"", jRecord.getJavaFieldComments(fields.get(1)));
+            assertEquals(""  // created\n  // created comment2\n"", jRecord.getJavaFieldComments(fields.get(2)));
+            assertEquals(""  // last modified\n  // last modified comment2\n"", jRecord.getJavaFieldComments(fields.get(3)));
+        }
+    }
+
+    @Test
+    public void testCommentBeforeLine() throws ParseException, NoSuchFieldException, IllegalAccessException {
+        String juteStr = ""module org.apache.zookeeper.data {\n""
+                + ""    // information explicitly stored by the server persistently\n""
+                + ""    class StatPersisted {\n""
+                + ""        // created zxid\n""
+                + ""        long czxid;\n""
+                + ""        // last modified zxid\n""
+                + ""        long mzxid;\n""
+                + ""        // created\n""
+                + ""        long ctime;\n""
+                + ""        // last modified\n""
+                + ""        long mtime;\n""
+                + ""    }\n""
+                + ""}"";
+        try (StringReader stringReader = new StringReader(juteStr)) {
+            Rcc parser = new Rcc(stringReader);
+            JFile jFile = parser.Input();
+            List<JRecord> mRecords = getField(jFile, ""mRecords"", List.class);
+            assertEquals(1, mRecords.size());
+
+            JRecord jRecord = mRecords.get(0);
+            assertEquals(""StatPersisted"", jRecord.getName());
+            List<JField> fields = jRecord.getFields();
+            assertFiled(fields);
+
+            assertEquals(""// information explicitly stored by the server persistently\n"", jRecord.getRecordComments());
+            assertEquals(""  // created zxid\n"", jRecord.getJavaFieldComments(fields.get(0)));
+            assertEquals(""  // last modified zxid\n"", jRecord.getJavaFieldComments(fields.get(1)));
+            assertEquals(""  // created\n"", jRecord.getJavaFieldComments(fields.get(2)));
+            assertEquals(""  // last modified\n"", jRecord.getJavaFieldComments(fields.get(3)));
+        }
+    }
+
+    @Test
+    public void testMultiLineComments() throws ParseException, NoSuchFieldException, IllegalAccessException {
+        String juteStr = ""module org.apache.zookeeper.data {\n""
+                + ""    // information explicitly stored by the server persistently\n""
+                + ""    class StatPersisted {\n""
+                + ""        /**\n""
+                + ""         * created zxid\n""
+                + ""         */\n""
+                + ""        long czxid;\n""
+                + ""        /* last modified zxid */\n""
+                + ""        long mzxid;\n""
+                + ""        /*\n""
+                + ""         * created\n""
+                + ""         */\n""
+                + ""        long ctime;\n""
+                + ""        /*\n""
+                + ""         last modified\n""
+                + ""         */""

Review Comment:
   How about adding more cases to verify more multi-line captures ?
   ```
   /**
    ** Consecutive star signs.
    **/
   int version; /* multi-line end of line */
   
   int cversion; /* A multi-line end of line comment. */ /* Another multi-line end of line commnet. */ /* Yet another
   end of line comment. */ /* Comment belong to new field */
   long ephemeralOwner;
   ```



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +794,122 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        Token beforeTheLineCommentToken = getCommentToken(jField.getTypeToken(), jField.getPreviousToken());
+        List<String> comments = extractComments(beforeTheLineCommentToken, null);
+
+        Token endOfLineCommentToken = getCommentToken(jField.getNextToken(), null);
+        if (endOfLineCommentToken != null && jField.getTypeToken().beginLine == endOfLineCommentToken.beginLine) {
+
+            comments.addAll(extractComments(endOfLineCommentToken, endOfLineCommentToken.next));
+        }
+
+        return formatComments(indent, comments);
+    }
+
+    private Token getCommentToken(Token token, Token previousToken) {
+        if (token == null || token.specialToken == null) {
+            return null;
+        }
+
+        Token commentToken = token.specialToken;
+        while (commentToken.specialToken != null) {
+            commentToken = commentToken.specialToken;
+        }
+        // Skip end of line comment belong to previous token.
+        if (previousToken != null && commentToken.beginLine == previousToken.endLine) {
+            commentToken = commentToken.next;
+        }
+        return commentToken;
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        Token commentToken = getCommentToken(getRecordToken(), null);
+        return formatComments("""", extractComments(commentToken, null));
+    }
+
+    private static String formatComments(String indent, List<String> commentLines) {
+        if (commentLines == null || commentLines.isEmpty()) {
+            return """";
+        }
+
+        StringBuilder builder = new StringBuilder();
+        for (String line : commentLines) {
+            if (!line.isEmpty()) {
+                builder.append(indent).append(line);
+            }
+            builder.append(System.lineSeparator());
+        }
+
+        return builder.toString();
+    }
+
+    /**
+     * Extracts comments with indentation and line separator trimmed.
+     *
+     * <p>Empty line is represented as empty string.
+     */
+    private static List<String> extractComments(Token token, Token sentinelToken) {

Review Comment:
   ```suggestion
       private static List<String> extractComments(Token token, int endLine) {
   ```



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +794,122 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        Token beforeTheLineCommentToken = getCommentToken(jField.getTypeToken(), jField.getPreviousToken());
+        List<String> comments = extractComments(beforeTheLineCommentToken, null);
+
+        Token endOfLineCommentToken = getCommentToken(jField.getNextToken(), null);
+        if (endOfLineCommentToken != null && jField.getTypeToken().beginLine == endOfLineCommentToken.beginLine) {
+
+            comments.addAll(extractComments(endOfLineCommentToken, endOfLineCommentToken.next));
+        }
+
+        return formatComments(indent, comments);
+    }
+
+    private Token getCommentToken(Token token, Token previousToken) {
+        if (token == null || token.specialToken == null) {
+            return null;
+        }
+
+        Token commentToken = token.specialToken;
+        while (commentToken.specialToken != null) {
+            commentToken = commentToken.specialToken;
+        }
+        // Skip end of line comment belong to previous token.
+        if (previousToken != null && commentToken.beginLine == previousToken.endLine) {
+            commentToken = commentToken.next;
+        }
+        return commentToken;
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        Token commentToken = getCommentToken(getRecordToken(), null);
+        return formatComments("""", extractComments(commentToken, null));
+    }
+
+    private static String formatComments(String indent, List<String> commentLines) {
+        if (commentLines == null || commentLines.isEmpty()) {
+            return """";
+        }
+
+        StringBuilder builder = new StringBuilder();
+        for (String line : commentLines) {
+            if (!line.isEmpty()) {
+                builder.append(indent).append(line);
+            }
+            builder.append(System.lineSeparator());
+        }
+
+        return builder.toString();
+    }
+
+    /**
+     * Extracts comments with indentation and line separator trimmed.
+     *
+     * <p>Empty line is represented as empty string.
+     */
+    private static List<String> extractComments(Token token, Token sentinelToken) {
+        List<String> comments = new ArrayList<>();
+
+        if (token == null) {
+            return comments;
+        }
+
+        int nextLine = token.beginLine;
+        while (token != null && token != sentinelToken) {

Review Comment:
   ```suggestion
           while (token != null && token.beginLine <= endLine) {
   ```



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/generated/rcc.jj:
##########
@@ -274,21 +250,33 @@ JRecord Record() :
     ArrayList<JField> flist = new ArrayList<JField>();
     Token t;
     JField f;
+    // Get the comments on the class token
+    Token recordTkn;
+    Token typeTkn;
+    Token previousToken = null;
 }
 {
-    <RECORD_TKN>
+    recordTkn = <RECORD_TKN>
     t = <IDENT_TKN>
     { rname = t.image; }
-    <LBRACE_TKN>
+    previousToken = <LBRACE_TKN>
     (
+        {typeTkn = getToken(1);}
         f = Field()
         { flist.add(f); }
         <SEMICOLON_TKN>
+        {
+            f.setTypeToken(typeTkn);
+            f.setPreviousToken(previousToken);
+            f.setNextToken(getToken(1));
+            previousToken = typeTkn;
+        }
     )+
     <RBRACE_TKN>
     {
+        previousToken = null;

Review Comment:
   ```suggestion
   ```



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +794,122 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        Token beforeTheLineCommentToken = getCommentToken(jField.getTypeToken(), jField.getPreviousToken());
+        List<String> comments = extractComments(beforeTheLineCommentToken, null);
+
+        Token endOfLineCommentToken = getCommentToken(jField.getNextToken(), null);
+        if (endOfLineCommentToken != null && jField.getTypeToken().beginLine == endOfLineCommentToken.beginLine) {
+
+            comments.addAll(extractComments(endOfLineCommentToken, endOfLineCommentToken.next));
+        }
+
+        return formatComments(indent, comments);
+    }
+
+    private Token getCommentToken(Token token, Token previousToken) {
+        if (token == null || token.specialToken == null) {
+            return null;
+        }
+
+        Token commentToken = token.specialToken;
+        while (commentToken.specialToken != null) {
+            commentToken = commentToken.specialToken;
+        }
+        // Skip end of line comment belong to previous token.
+        if (previousToken != null && commentToken.beginLine == previousToken.endLine) {

Review Comment:
   ```suggestion
           while (previousToken != null && commentToken != null && commentToken.beginLine == previousToken.endLine) {
   ```
   
   It is possible that multiple multi-line comments could resides in one line.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +794,122 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        Token beforeTheLineCommentToken = getCommentToken(jField.getTypeToken(), jField.getPreviousToken());
+        List<String> comments = extractComments(beforeTheLineCommentToken, null);
+
+        Token endOfLineCommentToken = getCommentToken(jField.getNextToken(), null);
+        if (endOfLineCommentToken != null && jField.getTypeToken().beginLine == endOfLineCommentToken.beginLine) {
+
+            comments.addAll(extractComments(endOfLineCommentToken, endOfLineCommentToken.next));
+        }
+
+        return formatComments(indent, comments);
+    }
+
+    private Token getCommentToken(Token token, Token previousToken) {
+        if (token == null || token.specialToken == null) {
+            return null;
+        }
+
+        Token commentToken = token.specialToken;
+        while (commentToken.specialToken != null) {
+            commentToken = commentToken.specialToken;
+        }
+        // Skip end of line comment belong to previous token.
+        if (previousToken != null && commentToken.beginLine == previousToken.endLine) {
+            commentToken = commentToken.next;
+        }
+        return commentToken;
+    }
+
+    public String getRecordComments() {
+        if (getRecordToken() == null || getRecordToken().specialToken == null) {
+            return """";
+        }
+
+        // get the comments before the class
+        Token commentToken = getCommentToken(getRecordToken(), null);
+        return formatComments("""", extractComments(commentToken, null));

Review Comment:
   ```suggestion
           return formatComments("""", extractComments(commentToken, Integer.MAX_VALUE));
   ```



##########
zookeeper-jute/src/test/java/org/apache/jute/compiler/JRecordTest.java:
##########
@@ -0,0 +1,191 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.jute.compiler;
+
+import static org.junit.jupiter.api.Assertions.assertEquals;
+import java.io.StringReader;
+import java.lang.reflect.Field;
+import java.util.List;
+import org.apache.jute.compiler.generated.ParseException;
+import org.apache.jute.compiler.generated.Rcc;
+import org.junit.jupiter.api.Test;
+
+@SuppressWarnings({""unchecked"", ""SameParameterValue""})
+public class JRecordTest {
+
+    @Test
+    public void testEndOfLineComments() throws ParseException, NoSuchFieldException, IllegalAccessException {
+        String juteStr = ""module org.apache.zookeeper.data {\n""
+                + ""    // information explicitly stored by the server persistently\n""
+                + ""    class StatPersisted {\n""
+                + ""        long czxid;      // created zxid\n""
+                + ""        long mzxid;      // last modified zxid\n""
+                + ""        long ctime;      // created\n""
+                + ""        long mtime;      // last modified\n""
+                + ""    }\n""
+                + ""}"";
+
+        try (StringReader stringReader = new StringReader(juteStr)) {
+            Rcc parser = new Rcc(stringReader);
+            JFile jFile = parser.Input();
+            List<JRecord> mRecords = getField(jFile, ""mRecords"", List.class);
+            assertEquals(1, mRecords.size());
+
+            JRecord jRecord = mRecords.get(0);
+            assertEquals(""StatPersisted"", jRecord.getName());
+            List<JField> fields = jRecord.getFields();
+            assertFiled(fields);
+
+            assertEquals(""// information explicitly stored by the server persistently\n"", jRecord.getRecordComments());
+            assertEquals(""  // created zxid\n"", jRecord.getJavaFieldComments(fields.get(0)));
+            assertEquals(""  // last modified zxid\n"", jRecord.getJavaFieldComments(fields.get(1)));
+            assertEquals(""  // created\n"", jRecord.getJavaFieldComments(fields.get(2)));
+            assertEquals(""  // last modified\n"", jRecord.getJavaFieldComments(fields.get(3)));
+        }
+    }
+
+    @Test
+    public void testCommentBeforeLineAndEndOfLine() throws ParseException, NoSuchFieldException, IllegalAccessException {
+        String juteStr = ""module org.apache.zookeeper.data {\n""
+                + ""    // information explicitly stored by the server persistently\n""
+                + ""    class StatPersisted {\n""
+                + ""        // created zxid\n""
+                + ""        long czxid; // created zxid comment2\n""
+                + ""        // last modified zxid\n""
+                + ""        long mzxid; // last modified zxid comment2\n""
+                + ""        // created\n""
+                + ""        long ctime; // created comment2\n""
+                + ""        // last modified\n""
+                + ""        long mtime; // last modified comment2\n""
+                + ""    }\n""
+                + ""}"";
+        try (StringReader stringReader = new StringReader(juteStr)) {
+            Rcc parser = new Rcc(stringReader);
+            JFile jFile = parser.Input();
+            List<JRecord> mRecords = getField(jFile, ""mRecords"", List.class);
+            assertEquals(1, mRecords.size());
+
+            JRecord jRecord = mRecords.get(0);
+            assertEquals(""StatPersisted"", jRecord.getName());
+            List<JField> fields = jRecord.getFields();
+            assertFiled(fields);
+
+            assertEquals(""// information explicitly stored by the server persistently\n"", jRecord.getRecordComments());
+            assertEquals(""  // created zxid\n  // created zxid comment2\n"", jRecord.getJavaFieldComments(fields.get(0)));
+            assertEquals(""  // last modified zxid\n  // last modified zxid comment2\n"", jRecord.getJavaFieldComments(fields.get(1)));
+            assertEquals(""  // created\n  // created comment2\n"", jRecord.getJavaFieldComments(fields.get(2)));
+            assertEquals(""  // last modified\n  // last modified comment2\n"", jRecord.getJavaFieldComments(fields.get(3)));
+        }
+    }
+
+    @Test
+    public void testCommentBeforeLine() throws ParseException, NoSuchFieldException, IllegalAccessException {
+        String juteStr = ""module org.apache.zookeeper.data {\n""
+                + ""    // information explicitly stored by the server persistently\n""
+                + ""    class StatPersisted {\n""
+                + ""        // created zxid\n""
+                + ""        long czxid;\n""
+                + ""        // last modified zxid\n""
+                + ""        long mzxid;\n""
+                + ""        // created\n""
+                + ""        long ctime;\n""
+                + ""        // last modified\n""
+                + ""        long mtime;\n""
+                + ""    }\n""
+                + ""}"";
+        try (StringReader stringReader = new StringReader(juteStr)) {
+            Rcc parser = new Rcc(stringReader);
+            JFile jFile = parser.Input();
+            List<JRecord> mRecords = getField(jFile, ""mRecords"", List.class);
+            assertEquals(1, mRecords.size());
+
+            JRecord jRecord = mRecords.get(0);
+            assertEquals(""StatPersisted"", jRecord.getName());
+            List<JField> fields = jRecord.getFields();
+            assertFiled(fields);
+
+            assertEquals(""// information explicitly stored by the server persistently\n"", jRecord.getRecordComments());
+            assertEquals(""  // created zxid\n"", jRecord.getJavaFieldComments(fields.get(0)));
+            assertEquals(""  // last modified zxid\n"", jRecord.getJavaFieldComments(fields.get(1)));
+            assertEquals(""  // created\n"", jRecord.getJavaFieldComments(fields.get(2)));
+            assertEquals(""  // last modified\n"", jRecord.getJavaFieldComments(fields.get(3)));
+        }
+    }
+
+    @Test
+    public void testMultiLineComments() throws ParseException, NoSuchFieldException, IllegalAccessException {
+        String juteStr = ""module org.apache.zookeeper.data {\n""
+                + ""    // information explicitly stored by the server persistently\n""

Review Comment:
   How about changing this to multi-line comment ? There is no test for multi-line comment for `class`.



##########
zookeeper-jute/src/main/java/org/apache/jute/compiler/JRecord.java:
##########
@@ -767,4 +794,122 @@ public static String getCsharpFQName(String name) {
         }
         return fQName.toString();
     }
+
+    public String getJavaFieldComments(JField jField) {
+        return getFieldComments(jField, ""  "");
+    }
+
+    public String getCFieldComments(JField jField) {
+        return getFieldComments(jField, ""    "");
+    }
+
+    private String getFieldComments(JField jField, String indent) {
+        if (jField == null || jField.getTypeToken() == null || jField.getNextToken() == null) {
+            return """";
+        }
+
+        // get the comment before the line
+        Token beforeTheLineCommentToken = getCommentToken(jField.getTypeToken(), jField.getPreviousToken());
+        List<String> comments = extractComments(beforeTheLineCommentToken, null);
+
+        Token endOfLineCommentToken = getCommentToken(jField.getNextToken(), null);
+        if (endOfLineCommentToken != null && jField.getTypeToken().beginLine == endOfLineCommentToken.beginLine) {
+
+            comments.addAll(extractComments(endOfLineCommentToken, endOfLineCommentToken.next));

Review Comment:
   ```suggestion
               comments.addAll(extractComments(endOfLineCommentToken, endOfLineCommentToken.beginLine));
   ```



;02/Dec/24 02:04;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2510630046

   > ```
   > int field; /* A multi-line comment. */ /* Another multi-line comment. */
   > ```
   > 
   > I find that we are not handing above case. I left comment about this.
   
   Your testing is incredibly thorough! I hadn’t considered these cases before. I’m sorry that my code had so many issues and caused you so much extra work. 😂😂😂
   I added a few more test cases.


;02/Dec/24 05:44;githubbot;600","luozongle01 commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2513496556

   > LGTM
   > 
   > Could you squash this pr to one commit ?
   
   Thanks, I have already squash it to one commit.
   


;03/Dec/24 03:59;githubbot;600","kezhuw merged PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206


;07/Dec/24 05:54;githubbot;600","kezhuw commented on PR #2206:
URL: https://github.com/apache/zookeeper/pull/2206#issuecomment-2524956933

   @luozongle01 Thank you for your contribution! Merged!


;07/Dec/24 06:03;githubbot;600",,0,27600,,,0,27600,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Sat Dec 07 05:55:30 UTC 2024,,,,,,,,,,"0|z1s53k:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"23/Oct/24 09:23;kezhuw;+1

Look forward to this.;;;","07/Dec/24 05:55;kezhuw;Issue resolved by pull request 2206
[https://github.com/apache/zookeeper/pull/2206];;;",,,,,,,,,,
Fix log arguments typo,ZOOKEEPER-4879,13596020,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Trivial,Fixed,luozongle01,luozongle01,luozongle01,18/Oct/24 16:40,27/Nov/24 02:12,08/Dec/25 08:12,27/Nov/24 02:12,,,,,,,,,3.10.0,,,server,,,,0,pull-request-available,,,"fix log arguments typo, exception stack does not need placeholder.",,"luozongle01 opened a new pull request, #2205:
URL: https://github.com/apache/zookeeper/pull/2205

   fix log arguments typo, exception stack does not need placeholder.
   
   https://issues.apache.org/jira/browse/ZOOKEEPER-4879


;18/Oct/24 16:48;githubbot;600","kezhuw commented on code in PR #2205:
URL: https://github.com/apache/zookeeper/pull/2205#discussion_r1818350322


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java:
##########
@@ -2375,7 +2375,7 @@ public boolean authWriteRequest(Request request) {
                 try {
                     request.cnxn.sendResponse(rh, null, null);
                 } catch (IOException e) {
-                    LOG.error(""IOException : {}"", e);
+                    LOG.error(""IOException"", e);

Review Comment:
   ```suggestion
                       LOG.warn(""IOException"", e);
   ```
   
   `error` with exception stacktrace panics, a client connection io error does not deserve that.
   
   Currently, the handling of `sendResponse` is not consistent. I checked the code, and found no `IOException`. We probably should revise and figure out how to handle client connection error in a consistent way.



;28/Oct/24 04:11;githubbot;600","luozongle01 commented on code in PR #2205:
URL: https://github.com/apache/zookeeper/pull/2205#discussion_r1818368399


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java:
##########
@@ -2375,7 +2375,7 @@ public boolean authWriteRequest(Request request) {
                 try {
                     request.cnxn.sendResponse(rh, null, null);
                 } catch (IOException e) {
-                    LOG.error(""IOException : {}"", e);
+                    LOG.error(""IOException"", e);

Review Comment:
   Yes, you looked very carefully and indeed there won't be any `IOException`.😂



;28/Oct/24 04:44;githubbot;600","kezhuw merged PR #2205:
URL: https://github.com/apache/zookeeper/pull/2205


;27/Nov/24 02:06;githubbot;600","kezhuw commented on PR #2205:
URL: https://github.com/apache/zookeeper/pull/2205#issuecomment-2502503413

   @luozongle01 Thank you! Merged.


;27/Nov/24 02:07;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3000,,,0,3000,,,,,,,,,,,,,,,,,,,"18/Oct/24 16:37;luozongle01;image-2024-10-19-00-36-58-711.png;https://issues.apache.org/jira/secure/attachment/13072297/image-2024-10-19-00-36-58-711.png","18/Oct/24 16:37;luozongle01;image-2024-10-19-00-37-55-084.png;https://issues.apache.org/jira/secure/attachment/13072296/image-2024-10-19-00-37-55-084.png",,,,,2.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Nov 27 02:12:53 UTC 2024,,,,,,,,,,"0|z1s374:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"27/Nov/24 02:12;kezhuw;master: 5664ce11c98cfdd9348b2e32f74307582b7a1dda;;;",,,,,,,,,,,
Fix typos,ZOOKEEPER-4877,13595900,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Trivial,Fixed,luozongle,luozongle01,luozongle01,18/Oct/24 01:55,18/Oct/24 16:40,08/Dec/25 08:12,18/Oct/24 15:36,3.9.2,,,,,,,,3.10.0,,,server,,,,0,pull-request-available,,,"Fix typos.

1. !image-2024-10-18-09-53-46-914.png!

 

 

2. !image-2024-10-18-09-54-06-318.png!

 

3. !image-2024-10-18-09-54-26-149.png!

 

4. !image-2024-10-18-09-54-49-783.png!

 

 

5. !image-2024-10-18-09-55-17-835.png!",,"luozongle01 opened a new pull request, #2203:
URL: https://github.com/apache/zookeeper/pull/2203

   Fix typos: https://issues.apache.org/jira/projects/ZOOKEEPER/issues/ZOOKEEPER-4877?filter=reportedbyme


;18/Oct/24 02:05;githubbot;600","kezhuw commented on code in PR #2203:
URL: https://github.com/apache/zookeeper/pull/2203#discussion_r1806042121


##########
zookeeper-server/src/main/java/org/apache/zookeeper/metrics/MetricsProviderLifeCycleException.java:
##########
@@ -19,7 +19,7 @@
 package org.apache.zookeeper.metrics;
 
 /**
- * A generic exception thrown during the licecycle of a MetricsProvider.
+ * A generic exception thrown during the life cycle of a MetricsProvider.

Review Comment:
   ```suggestion
    * A generic exception thrown during the lifecycle of a MetricsProvider.
   ```
   
   I think both are correct, but I saw multiple usages of ""lifecycle"" but no ""life cycle"".



;18/Oct/24 07:50;githubbot;600","luozongle01 commented on code in PR #2203:
URL: https://github.com/apache/zookeeper/pull/2203#discussion_r1806059166


##########
zookeeper-server/src/main/java/org/apache/zookeeper/metrics/MetricsProviderLifeCycleException.java:
##########
@@ -19,7 +19,7 @@
 package org.apache.zookeeper.metrics;
 
 /**
- * A generic exception thrown during the licecycle of a MetricsProvider.
+ * A generic exception thrown during the life cycle of a MetricsProvider.

Review Comment:
   Thank you, maybe I haven't seen much, you're right



;18/Oct/24 08:00;githubbot;600","kezhuw merged PR #2203:
URL: https://github.com/apache/zookeeper/pull/2203


;18/Oct/24 15:35;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,,,,,,,,,,,,,,,,,"18/Oct/24 01:53;luozongle01;image-2024-10-18-09-53-46-914.png;https://issues.apache.org/jira/secure/attachment/13072278/image-2024-10-18-09-53-46-914.png","18/Oct/24 01:54;luozongle01;image-2024-10-18-09-54-06-318.png;https://issues.apache.org/jira/secure/attachment/13072277/image-2024-10-18-09-54-06-318.png","18/Oct/24 01:54;luozongle01;image-2024-10-18-09-54-26-149.png;https://issues.apache.org/jira/secure/attachment/13072276/image-2024-10-18-09-54-26-149.png","18/Oct/24 01:54;luozongle01;image-2024-10-18-09-54-49-783.png;https://issues.apache.org/jira/secure/attachment/13072275/image-2024-10-18-09-54-49-783.png","18/Oct/24 01:55;luozongle01;image-2024-10-18-09-55-17-835.png;https://issues.apache.org/jira/secure/attachment/13072274/image-2024-10-18-09-55-17-835.png",,5.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Oct 18 15:36:04 UTC 2024,,,,,,,,,,"0|z1s2gg:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"18/Oct/24 15:36;kezhuw;Issue resolved by pull request 2203
[https://github.com/apache/zookeeper/pull/2203];;;",,,,,,,,,,,
jetty-http-9.4.53.v20231009.jar: CVE-2024-6763(3.7),ZOOKEEPER-4876,13595736,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,andor,andor,andor,16/Oct/24 23:12,07/Jul/25 14:24,08/Dec/25 08:12,17/Oct/24 23:05,3.8.4,3.9.2,,,,,,,3.10.0,3.8.5,3.9.3,server,,,,0,pull-request-available,,,,,"anmolnar opened a new pull request, #2202:
URL: https://github.com/apache/zookeeper/pull/2202

   (no comment)


;17/Oct/24 15:15;githubbot;600","anmolnar merged PR #2202:
URL: https://github.com/apache/zookeeper/pull/2202


;17/Oct/24 18:42;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1200,,,0,1200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Thu Oct 17 15:15:27 UTC 2024,,,,,,,,,,"0|z1s1gg:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"17/Oct/24 08:55;ddiederen;I looked into this, and bumping the dependency to the latest release of Jetty advertised on [https://jetty.org/download.html], {{{}9.4.56.v20240826{}}}, apparently resolves a fresh {{{}CVE-2024-8184{}}}, but *not* {{{}CVE-2024-6763{}}}—both having been published on 2024-10-14.

Worse, still, this comment says:

[https://github.com/jetty/jetty.project/pull/12012#issuecomment-2416450253]
{quote}This will not be backported to an End of Community Support version of Jetty.
{quote}
On the other hand, it continues with:
{quote}As stated in [CVE-2024-6763|https://github.com/advisories/GHSA-qh8g-58pp-2wxh], the use of Jetty server, or Jetty client, does not make you vulnerable to that CVE.
{quote}
The linked report itself explains:
{quote}The impact of this vulnerability is limited to developers that use the Jetty HttpURI directly. Example: your project implemented a blocklist to block on some hosts based on HttpURI's handling of authority section.
{quote}
So: should we upgrade to 9.4.56 and suppress CVE-2024-6763? (Note that I haven't performed an analysis of the affected source code!)

WDYT?;;;","17/Oct/24 15:01;andor;{quote}So: should we upgrade to 9.4.56 and suppress CVE-2024-6763? 
{quote}
Yes, I think that's what we should do. I did a quick grep in source code for {{HttpURI}} and we don't use it, so I believe we can suppress that CVE.

I bumped Jetty version and build is successful. Let me create a PR.;;;","17/Oct/24 15:15;andor;https://github.com/apache/zookeeper/pull/2202;;;",,,,,,,,,
SnapshotCommand should not perform fastForwardFromEdits ,ZOOKEEPER-4872,13594841,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,liwang,li4wang,li4wang,10/Oct/24 00:28,29/Aug/25 21:29,08/Dec/25 08:12,27/Nov/24 01:19,3.9.1,3.9.2,3.9.3,,,,,,3.10.0,3.9.4,,server,,,,0,pull-request-available,,,,,"li4wang opened a new pull request, #2210:
URL: https://github.com/apache/zookeeper/pull/2210

   Author: Li Wang <liwang@apple.com>


;04/Nov/24 06:57;githubbot;600","li4wang commented on PR #2210:
URL: https://github.com/apache/zookeeper/pull/2210#issuecomment-2455894354

   @kezhuw @eolivelli @phunt  can someone review the PR? Thanks.


;04/Nov/24 23:16;githubbot;600","kezhuw merged PR #2210:
URL: https://github.com/apache/zookeeper/pull/2210


;27/Nov/24 01:13;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1800,,,0,1800,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Nov 27 01:19:20 UTC 2024,,,,,,,,,,"0|z1rvxs:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"10/Oct/24 00:31;li4wang;To avoid the potential of getting into data inconsistent state, SnapshotCommand should just take a snapshot from the data tree, instead of applying the txns recorded in the txn log and then taking snapshot.;;;","04/Nov/24 23:06;li4wang;
{code:java}
 LOG.error(""{}(highestZxid) > {}(next log) for type {}"", highestZxid, hdr.getZxid(), hdr.getType());
{code}

This is to fix the error that can happen when snapshot is taken while txns are processed and appended to the txn log.  ;;;","27/Nov/24 01:19;kezhuw;master: 3e02328048a9c753624d44aba51ac70cab60619a
branch-3.9: da1fc515611dfce7b846a4aef2b362f1b238a266;;;",,,,,,,,,
ZooKeeper python module (zkpython) is incompatible with Python 3.12,ZOOKEEPER-4871,13594826,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,andor,andor,andor,09/Oct/24 21:11,17/Sep/25 20:51,08/Dec/25 08:12,17/Sep/25 20:51,3.10.0,,,,,,,,3.10.0,3.9.5,,contrib-bindings,,,,0,pull-request-available,,,"I've tried to  run zk-smoktest.py on latest Ubuntu 24.04 and with Python 3.12 and run into the following issue:
{noformat}
$ python zk-smoketest.py -h
Traceback (most recent call last):
  File ""/home/andor/git/zk-smoketest/zk-smoketest.py"", line 22, in <module>
    import zkclient
  File ""/home/andor/git/zk-smoketest/zkclient.py"", line 17, in <module>
    import zookeeper, time, threading
ImportError: /usr/local/lib/python3.12/dist-packages/ZooKeeper-0.4-py3.12-linux-x86_64.egg/zookeeper.cpython-312-x86_64-linux-gnu.so: undefined symbol: PyIOBase_Type
{noformat}
It turned out that *PyIOBase_Type* is deprecated and not available in Python 3.12.

Found the following workaround in a different project which might be useful for *zkpython* too.

[https://github.com/inspired-solutions/pygraphviz/pull/1/files]

 ",,"anmolnar opened a new pull request, #2199:
URL: https://github.com/apache/zookeeper/pull/2199

   From: https://github.com/inspired-solutions/pygraphviz/pull/1/files
   


;09/Oct/24 21:28;githubbot;600","anmolnar commented on code in PR #2199:
URL: https://github.com/apache/zookeeper/pull/2199#discussion_r1794279440


##########
zookeeper-contrib/zookeeper-contrib-zkpython/src/c/zookeeper.c:
##########
@@ -1477,8 +1491,11 @@ PyObject *pyzoo_set_log_stream(PyObject *self, PyObject *args)
   }
   
 #if PY_MAJOR_VERSION >= 3
-  extern PyTypeObject PyIOBase_Type;
-  if (!PyObject_IsInstance(pystream, (PyObject *)&PyIOBase_Type)) {
+  if (init_file_emulator() < 0) {
+    return NULL;
+  }

Review Comment:
   I'm not sure about it's at the right place. Init should only be called once, but now it will be called every time somebody sets the log stream, which usually happens once, still must be a better place for this.



;09/Oct/24 21:44;githubbot;600","phunt commented on PR #2199:
URL: https://github.com/apache/zookeeper/pull/2199#issuecomment-3304522130

   +1 lgtm


;17/Sep/25 20:49;githubbot;600","anmolnar merged PR #2199:
URL: https://github.com/apache/zookeeper/pull/2199


;17/Sep/25 20:51;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Sep 17 20:51:45 UTC 2025,,,,,,,,,,"0|z1rvug:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"17/Sep/25 20:51;andor;Issue resolved by pull request 2199
[https://github.com/apache/zookeeper/pull/2199];;;",,,,,,,,,,,
Update doc of Supporting for Multiple Time Units in autopurge.purgeInterval Configuration,ZOOKEEPER-4869,13594564,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Implemented,puru,puru,puru,08/Oct/24 01:11,15/Oct/24 06:57,08/Dec/25 08:12,15/Oct/24 06:57,,,,,,,,,3.10.0,,,documentation,,,,0,pull-request-available,,,,,"tisonkun commented on PR #2195:
URL: https://github.com/apache/zookeeper/pull/2195#issuecomment-2400218739

   @purushah would you please link the feature PR here?


;08/Oct/24 15:49;githubbot;600","purushah commented on PR #2195:
URL: https://github.com/apache/zookeeper/pull/2195#issuecomment-2400347084

   @tisonkun  https://issues.apache.org/jira/browse/ZOOKEEPER-4829


;08/Oct/24 16:37;githubbot;600","kezhuw commented on code in PR #2195:
URL: https://github.com/apache/zookeeper/pull/2195#discussion_r1798186990


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -772,6 +772,10 @@ property, when available, is noted below.
     time interval in hours for which the purge task has to
     be triggered. Set to a positive integer (1 and above)
     to enable the auto purging. Defaults to 0.
+    **Suffix support added in 3.10.0:** The interval is specified as an integer with an optional suffix to indicate the time unit.
+    Supported suffixes are: ""ms"" for milliseconds, `s` for seconds, `m` for minutes, `h` for hours, and `d` for days.

Review Comment:
   nit: ""ms"" vs `s` vs `m` vs `h` vs `d` Should be one style at least in one line ?



;13/Oct/24 09:11;githubbot;600","kezhuw merged PR #2195:
URL: https://github.com/apache/zookeeper/pull/2195


;15/Oct/24 06:44;githubbot;600","kezhuw commented on PR #2195:
URL: https://github.com/apache/zookeeper/pull/2195#issuecomment-2413028323

   @purushah Thank you for your contribution! Merged.


;15/Oct/24 06:45;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3000,,,0,3000,,,,,,,,,,ZOOKEEPER-4829,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2024-10-08 01:11:59.0,,,,,,,,,,"0|z1ru8g:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Bump commons-io library to 2.14.0,ZOOKEEPER-4868,13594530,,Task,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,tison,jotamartos,jotamartos,07/Oct/24 15:50,24/Oct/24 20:09,08/Dec/25 08:12,08/Oct/24 19:08,3.8.4,3.9.2,,,,,,,3.10.0,3.8.5,3.9.3,server,,,,0,pull-request-available,,,"CVE-2024-47554 is fixed in that version of the library. Could please you confirm whether Zookeeper is affected by this vulnerability and if so, are there any plans to update the dependency?

{code}
Java (jar)
==========
Total: 1 (UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: 1, CRITICAL: 0)
┌───────────────────────────────────────────────┬────────────────┬──────────┬────────┬───────────────────┬───────────────┬─────────────────────────────────────────────────────────┐
│                    Library                    │ Vulnerability  │ Severity │ Status │ Installed Version │ Fixed Version │                          Title                          │
├───────────────────────────────────────────────┼────────────────┼──────────┼────────┼───────────────────┼───────────────┼─────────────────────────────────────────────────────────┤
│ commons-io:commons-io (commons-io-2.11.0.jar) │ CVE-2024-47554 │ HIGH     │ fixed  │ 2.11.0            │ 2.14.0        │ apache-commons-io: Possible denial of service attack on │
│                                               │                │          │        │                   │               │ untrusted input to XmlStreamReader                      │
│                                               │                │          │        │                   │               │ https://avd.aquasec.com/nvd/cve-2024-47554              │
└───────────────────────────────────────────────┴────────────────┴──────────┴────────┴───────────────────┴───────────────┴─────────────────────────────────────────────────────────┘ 
{code}
h4. Steps to reproduce
{code}
trivy image zookeeper:3.9
{code}

",,"tisonkun opened a new pull request, #2196:
URL: https://github.com/apache/zookeeper/pull/2196

   (no comment)


;08/Oct/24 15:27;githubbot;600","tisonkun commented on PR #2196:
URL: https://github.com/apache/zookeeper/pull/2196#issuecomment-2400346502

   Merging .. I'll create the backport PR for 3.8 and 3.9 then.


;08/Oct/24 16:37;githubbot;600","tisonkun merged PR #2196:
URL: https://github.com/apache/zookeeper/pull/2196


;08/Oct/24 16:37;githubbot;600","tisonkun opened a new pull request, #2197:
URL: https://github.com/apache/zookeeper/pull/2197

   (no comment)


;08/Oct/24 16:39;githubbot;600","tisonkun opened a new pull request, #2198:
URL: https://github.com/apache/zookeeper/pull/2198

   backport #2196


;08/Oct/24 16:40;githubbot;600","tisonkun merged PR #2198:
URL: https://github.com/apache/zookeeper/pull/2198


;08/Oct/24 19:05;githubbot;600","anmolnar merged PR #2197:
URL: https://github.com/apache/zookeeper/pull/2197


;08/Oct/24 19:08;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,4200,,,0,4200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Oct 09 06:39:31 UTC 2024,,,,,,,,,,"0|z1ru0w:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"08/Oct/24 19:08;andor;Issue resolved by pull request 2197
[https://github.com/apache/zookeeper/pull/2197];;;","08/Oct/24 21:19;tison;FYI, ZK isn't affected by this CVE. But bump version to reduce friction is valuable so we bump it and make scanners happy.;;;","09/Oct/24 06:39;jotamartos;Thank you for confirming the solution is not affected and for updating the dependency too. ;;;",,,,,,,,,
TxnLogToolkit dump multi to unrecognized chars.,ZOOKEEPER-4864,13593325,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,luoxin,luoxin,luoxin,26/Sep/24 09:27,15/Oct/24 07:04,08/Dec/25 08:12,15/Oct/24 07:04,,,,,,,,,3.10.0,,,,,,,0,pull-request-available,,,!https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17056839/1727342763883-20799ce6-7595-461b-bb77-bb49261cdee6.png?x-oss-process=image%2Fformat%2Cwebp!,,"luoxiner opened a new pull request, #2192:
URL: https://github.com/apache/zookeeper/pull/2192

   Currently, the TxnLogToolkit only decodes error transactions to recognized strings. This PR seeks to enhance the toolkit to decode other types of transactions into a better format.
   
   Assotiate jira issue [ZOOKEEPER-4864](https://issues.apache.org/jira/browse/ZOOKEEPER-4864) 


;27/Sep/24 10:37;githubbot;600","kezhuw commented on code in PR #2192:
URL: https://github.com/apache/zookeeper/pull/2192#discussion_r1779466279


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/TxnLogToolkit.java:
##########
@@ -361,6 +371,40 @@ static String getFormattedTxnStr(Record txn) {
         return txnData.toString();
     }
 
+    private static Record deserializeTxn(Txn txn) throws IOException {
+        ByteBuffer bb = ByteBuffer.wrap(txn.getData());

Review Comment:
   This is not used until the last statement. Better to move until usage.



##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/persistence/TxnLogToolkitTest.java:
##########
@@ -95,27 +106,33 @@ public void testInitMissingFile() throws FileNotFoundException, TxnLogToolkit.Tx
 
     @Test
     public void testMultiTxnDecode() throws IOException {
-        //MultiTxn with four ops, and the first op error.
+        //MultiTxn with multi ops, the first op is error and the others are normal
         List<Txn> txns = new ArrayList<>();
-        int type = -1;
-        for (int i = 0; i < 4; i++) {
-            ErrorTxn txn;
-            if (i == 0) {
-                txn = new ErrorTxn(KeeperException.Code.NONODE.intValue());
-            } else {
-                txn = new ErrorTxn(KeeperException.Code.RUNTIMEINCONSISTENCY.intValue());
-            }
+        Map<Record, Integer> records = new HashMap<>();
+        records.put(new ErrorTxn(KeeperException.Code.NONODE.intValue()), ZooDefs.OpCode.error);
+        records.put(new ErrorTxn(KeeperException.Code.RUNTIMEINCONSISTENCY.intValue()), -1);
+        records.put(new CreateTxn(""/test"", ""test-data"".getBytes(StandardCharsets.UTF_8), ZooDefs.Ids.OPEN_ACL_UNSAFE, true, 1), ZooDefs.OpCode.create);
+        records.put(new CreateContainerTxn(""/test_container"", ""test-data"".getBytes(StandardCharsets.UTF_8), ZooDefs.Ids.OPEN_ACL_UNSAFE, 2), ZooDefs.OpCode.createContainer);
+        records.put(new CreateTTLTxn(""/test_container"", ""test-data"".getBytes(StandardCharsets.UTF_8), ZooDefs.Ids.OPEN_ACL_UNSAFE, 2, 20), ZooDefs.OpCode.createTTL);
+        records.put(new SetDataTxn(""/test_set_data"", ""test-data"".getBytes(StandardCharsets.UTF_8), 4), ZooDefs.OpCode.setData);
+        records.put(new DeleteTxn(""/test_delete""), ZooDefs.OpCode.delete);
+        records.put(new CheckVersionTxn(""/test_check_version"", 5), ZooDefs.OpCode.check);
+
+        for (Map.Entry<Record, Integer> recordEntry : records.entrySet()) {
             try (ByteArrayOutputStream baos = new ByteArrayOutputStream()) {
                 BinaryOutputArchive boa = BinaryOutputArchive.getArchive(baos);
-                txn.serialize(boa, ""request"");
+                recordEntry.getKey().serialize(boa, ""request"");
                 ByteBuffer bb = ByteBuffer.wrap(baos.toByteArray());
-                txns.add(new Txn(type, bb.array()));
+                txns.add(new Txn(recordEntry.getValue(), bb.array()));
             }
         }

Review Comment:
   How about adding a helper method, say `newSubTxn(type, record)`, to construct `Txn` ? This way we can add test case using `txns.add` sequentially.



##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/TxnLogToolkit.java:
##########
@@ -361,6 +371,40 @@ static String getFormattedTxnStr(Record txn) {
         return txnData.toString();
     }
 
+    private static Record deserializeTxn(Txn txn) throws IOException {

Review Comment:
   Rename to `deserializeSubTxn` ? I was confused until comparing it with `SerializeUtils.deserializeTxn`.



##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/TxnLogToolkit.java:
##########
@@ -361,6 +371,40 @@ static String getFormattedTxnStr(Record txn) {
         return txnData.toString();
     }
 
+    private static Record deserializeTxn(Txn txn) throws IOException {
+        ByteBuffer bb = ByteBuffer.wrap(txn.getData());
+        Record record;
+        switch (txn.getType()) {
+            case ZooDefs.OpCode.create:
+            case ZooDefs.OpCode.create2:
+                record = new CreateTxn();
+                break;
+            case ZooDefs.OpCode.createTTL:
+                record = new CreateTTLTxn();
+                break;
+            case ZooDefs.OpCode.createContainer:
+                record = new CreateContainerTxn();
+                break;
+            case ZooDefs.OpCode.delete:
+            case ZooDefs.OpCode.deleteContainer:
+                record = new DeleteTxn();
+                break;
+            case ZooDefs.OpCode.setData:
+                record = new SetDataTxn();
+                break;
+            case ZooDefs.OpCode.error:
+                record = new ErrorTxn();
+                break;
+            case ZooDefs.OpCode.check:
+                record = new CheckVersionTxn();
+                break;
+            default:
+                return null;

Review Comment:
   We should also throw exception here, just like `SerializeUtils.deserializeTxn`. Silence is not good in dumping.



##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/persistence/TxnLogToolkitTest.java:
##########
@@ -95,27 +106,33 @@ public void testInitMissingFile() throws FileNotFoundException, TxnLogToolkit.Tx
 
     @Test
     public void testMultiTxnDecode() throws IOException {
-        //MultiTxn with four ops, and the first op error.
+        //MultiTxn with multi ops, the first op is error and the others are normal

Review Comment:
   ```suggestion
           // MultiTxn with multi ops including errors
   ```



;28/Sep/24 11:49;githubbot;600","luoxiner commented on PR #2192:
URL: https://github.com/apache/zookeeper/pull/2192#issuecomment-2380752282

   @kezhuw thanks for your review ! I push a new commit, please take a look. 


;28/Sep/24 16:32;githubbot;600","tisonkun merged PR #2192:
URL: https://github.com/apache/zookeeper/pull/2192


;15/Oct/24 07:03;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,,,,,,,,,,,,,,,,,"26/Sep/24 09:24;luoxin;image-2024-09-26-17-23-54-269.png;https://issues.apache.org/jira/secure/attachment/13071790/image-2024-09-26-17-23-54-269.png","27/Sep/24 05:52;luoxin;image-2024-09-27-13-52-45-301.png;https://issues.apache.org/jira/secure/attachment/13071828/image-2024-09-27-13-52-45-301.png",,,,,2.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Tue Oct 15 07:04:07 UTC 2024,,,,,,,,,,"0|z1rmlk:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"26/Sep/24 09:34;luoxin;Currently, the TxnLogToolkit dumps the multi-txn using new String(txn.getData(),StandardCharsets.UTF_8), but the transaction bytes cannot be converted to a string directly by UTF-8 decoding. We should dump the transaction in a multi-transaction case-by-case manner. ;;;","26/Sep/24 09:34;luoxin;I will submit a pr to resolve it.;;;","26/Sep/24 12:10;kezhuw;Does this solved by ZOOKEEPER-4607 ?;;;","27/Sep/24 05:52;luoxin;It seems only error will be decoded.

!image-2024-09-27-13-52-45-301.png!;;;","27/Sep/24 06:03;luoxin;After building zookeeper with the latest code, I found that the problem still persists with other transactions in multi-txn (such as checkVersion, setData, etc.).;;;","27/Sep/24 10:43;luoxin;Hi, [~kezhuw] 

I submit a pr to solve it, can you take a look?;;;","15/Oct/24 07:04;tison;master via https://github.com/apache/zookeeper/commit/b99714543db86ca081a5d648c565f0d9cb4c82c2;;;",,,,,
Doc for Secure prometheus support,ZOOKEEPER-4862,13592990,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Implemented,puru,puru,puru,23/Sep/24 19:01,29/Sep/24 02:04,08/Dec/25 08:12,29/Sep/24 02:03,,,,,,,,,3.10.0,,,documentation,,,,0,pull-request-available,,,,,"purushah opened a new pull request, #2190:
URL: https://github.com/apache/zookeeper/pull/2190

   (no comment)


;23/Sep/24 19:08;githubbot;600","tisonkun commented on code in PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190#discussion_r1774306595


##########
zookeeper-docs/src/main/resources/markdown/zookeeperMonitor.md:
##########
@@ -41,11 +41,48 @@ All the metrics are included in the `ServerMetrics.java`.
 
 <a name=""Prometheus""></a>
 
+
+### Pre-requisites:
+- Enable the `Prometheus MetricsProvider` by setting the following in `zoo.cfg`:
+  ```bash
+  metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
+  ```

Review Comment:
   ````suggestion
   ### Pre-requisites:
   
   - Enable the Prometheus MetricsProvider by setting the following in `zoo.cfg`:
   
     ```conf 
    
    metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
     ```
   ````



;25/Sep/24 02:09;githubbot;600","tisonkun commented on code in PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190#discussion_r1774306903


##########
zookeeper-docs/src/main/resources/markdown/zookeeperMonitor.md:
##########
@@ -41,11 +41,48 @@ All the metrics are included in the `ServerMetrics.java`.
 
 <a name=""Prometheus""></a>
 
+
+### Pre-requisites:
+- Enable the `Prometheus MetricsProvider` by setting the following in `zoo.cfg`:
+  ```bash
+  metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
+  ```
+
+- The port for Prometheus metrics can be configured using:
+  ```bash
+  metricsProvider.httpPort=7000  # Default port is 7000
+  ```

Review Comment:
   ````suggestion
   - The port for Prometheus metrics can be configured using (default to 7000):
     ```conf
     metricsProvider.httpPort=7000
     ```
   ````



;25/Sep/24 02:09;githubbot;600","tisonkun commented on code in PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190#discussion_r1774307400


##########
zookeeper-docs/src/main/resources/markdown/zookeeperMonitor.md:
##########
@@ -41,11 +41,48 @@ All the metrics are included in the `ServerMetrics.java`.
 
 <a name=""Prometheus""></a>
 
+
+### Pre-requisites:
+- Enable the `Prometheus MetricsProvider` by setting the following in `zoo.cfg`:
+  ```bash
+  metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
+  ```
+
+- The port for Prometheus metrics can be configured using:
+  ```bash
+  metricsProvider.httpPort=7000  # Default port is 7000
+  ```
+
+#### Enabling HTTPS for Prometheus Metrics:
+ZooKeeper also supports SSL for Prometheus metrics, which provides secure data transmission. To enable this, configure an HTTPS port and set up SSL certificates as follows:
+
+- Define the HTTPS port:
+  ```bash
+  metricsProvider.httpPorts=4443
+  ```
+
+- Configure the SSL key store (holds the server’s private key and certificates):
+  ```bash
+  metricsProvider.ssl.keyStore.location=/path/to/keystore.jks
+  metricsProvider.ssl.keyStore.password=your_keystore_password
+  metricsProvider.ssl.keyStore.type=jks  # Default is JKS
+  ```
+
+- Configure the SSL trust store (used to verify client certificates):
+  ```bash
+  metricsProvider.ssl.trustStore.location=/path/to/truststore.jks
+  metricsProvider.ssl.trustStore.password=your_truststore_password
+  metricsProvider.ssl.trustStore.type=jks  # Default is JKS
+  ```
+
+- **Note**: You can enable both HTTP and HTTPS simultaneously by defining both ports:
+  ```bash
+  metricsProvider.httpPorts=7000
+  metricsProvider.httpsPorts=4443
+  ```

Review Comment:
   ````suggestion
   - You can enable HTTP and HTTPS simultaneously by defining both ports:
     ```conf
     metricsProvider.httpPorts=7000
     metricsProvider.httpsPorts=4443
     ```
   ````



;25/Sep/24 02:10;githubbot;600","tisonkun commented on code in PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190#discussion_r1774307513


##########
zookeeper-docs/src/main/resources/markdown/zookeeperMonitor.md:
##########
@@ -41,11 +41,48 @@ All the metrics are included in the `ServerMetrics.java`.
 
 <a name=""Prometheus""></a>
 
+
+### Pre-requisites:
+- Enable the `Prometheus MetricsProvider` by setting the following in `zoo.cfg`:
+  ```bash
+  metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
+  ```
+
+- The port for Prometheus metrics can be configured using:
+  ```bash
+  metricsProvider.httpPort=7000  # Default port is 7000
+  ```
+
+#### Enabling HTTPS for Prometheus Metrics:
+ZooKeeper also supports SSL for Prometheus metrics, which provides secure data transmission. To enable this, configure an HTTPS port and set up SSL certificates as follows:
+
+- Define the HTTPS port:
+  ```bash

Review Comment:
   ````suggestion
     ```conf
   ````



;25/Sep/24 02:10;githubbot;600","tisonkun commented on code in PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190#discussion_r1774307717


##########
zookeeper-docs/src/main/resources/markdown/zookeeperMonitor.md:
##########
@@ -41,11 +41,48 @@ All the metrics are included in the `ServerMetrics.java`.
 
 <a name=""Prometheus""></a>
 
+
+### Pre-requisites:
+- Enable the `Prometheus MetricsProvider` by setting the following in `zoo.cfg`:
+  ```bash
+  metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
+  ```
+
+- The port for Prometheus metrics can be configured using:
+  ```bash
+  metricsProvider.httpPort=7000  # Default port is 7000
+  ```
+
+#### Enabling HTTPS for Prometheus Metrics:
+ZooKeeper also supports SSL for Prometheus metrics, which provides secure data transmission. To enable this, configure an HTTPS port and set up SSL certificates as follows:

Review Comment:
   ```suggestion
   #### Enabling HTTPS for Prometheus Metrics:
   
   ZooKeeper supports SSL for Prometheus metrics, which provides secure data transmission. To enable this, configure an HTTPS port and set up SSL certificates as follows:
   ```



;25/Sep/24 02:11;githubbot;600","tisonkun commented on code in PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190#discussion_r1774307857


##########
zookeeper-docs/src/main/resources/markdown/zookeeperMonitor.md:
##########
@@ -41,11 +41,48 @@ All the metrics are included in the `ServerMetrics.java`.
 
 <a name=""Prometheus""></a>
 
+
+### Pre-requisites:
+- Enable the `Prometheus MetricsProvider` by setting the following in `zoo.cfg`:
+  ```bash
+  metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
+  ```
+
+- The port for Prometheus metrics can be configured using:
+  ```bash
+  metricsProvider.httpPort=7000  # Default port is 7000
+  ```
+
+#### Enabling HTTPS for Prometheus Metrics:
+ZooKeeper also supports SSL for Prometheus metrics, which provides secure data transmission. To enable this, configure an HTTPS port and set up SSL certificates as follows:
+
+- Define the HTTPS port:
+  ```bash
+  metricsProvider.httpPorts=4443
+  ```
+
+- Configure the SSL key store (holds the server’s private key and certificates):
+  ```bash

Review Comment:
   ```suggestion
     ```conf
   ```



;25/Sep/24 02:11;githubbot;600","tisonkun commented on code in PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190#discussion_r1774308075


##########
zookeeper-docs/src/main/resources/markdown/zookeeperMonitor.md:
##########
@@ -41,11 +41,48 @@ All the metrics are included in the `ServerMetrics.java`.
 
 <a name=""Prometheus""></a>
 
+
+### Pre-requisites:
+- Enable the `Prometheus MetricsProvider` by setting the following in `zoo.cfg`:
+  ```bash
+  metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
+  ```
+
+- The port for Prometheus metrics can be configured using:
+  ```bash
+  metricsProvider.httpPort=7000  # Default port is 7000
+  ```
+
+#### Enabling HTTPS for Prometheus Metrics:
+ZooKeeper also supports SSL for Prometheus metrics, which provides secure data transmission. To enable this, configure an HTTPS port and set up SSL certificates as follows:
+
+- Define the HTTPS port:
+  ```bash
+  metricsProvider.httpPorts=4443
+  ```
+
+- Configure the SSL key store (holds the server’s private key and certificates):
+  ```bash
+  metricsProvider.ssl.keyStore.location=/path/to/keystore.jks
+  metricsProvider.ssl.keyStore.password=your_keystore_password
+  metricsProvider.ssl.keyStore.type=jks  # Default is JKS
+  ```
+
+- Configure the SSL trust store (used to verify client certificates):
+  ```bash

Review Comment:
   ```suggestion
     ```conf
   ```



;25/Sep/24 02:11;githubbot;600","purushah commented on PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190#issuecomment-2375239078

   @tisonkun, I have addressed your comments.


;25/Sep/24 20:54;githubbot;600","kezhuw commented on code in PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190#discussion_r1777909664


##########
zookeeper-docs/src/main/resources/markdown/zookeeperMonitor.md:
##########
@@ -41,11 +41,49 @@ All the metrics are included in the `ServerMetrics.java`.
 
 <a name=""Prometheus""></a>
 
+
+### Pre-requisites:
+- Enable the `Prometheus MetricsProvider` by setting the following in `zoo.cfg`:
+  ```conf
+  metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
+  ```
+
+- The port for Prometheus metrics can be configured using:
+  ```conf
+  metricsProvider.httpPort=7000  # Default port is 7000
+  ```
+
+#### Enabling HTTPS for Prometheus Metrics:
+
+ZooKeeper also supports SSL for Prometheus metrics, which provides secure data transmission. To enable this, configure an HTTPS port and set up SSL certificates as follows:
+
+- Define the HTTPS port:
+  ```conf
+  metricsProvider.httpPorts=4443
+  ```
+
+- Configure the SSL key store (holds the server’s private key and certificates):
+  ```conf
+  metricsProvider.ssl.keyStore.location=/path/to/keystore.jks
+  metricsProvider.ssl.keyStore.password=your_keystore_password
+  metricsProvider.ssl.keyStore.type=jks  # Default is JKS
+  ```
+
+- Configure the SSL trust store (used to verify client certificates):
+  ```conf
+  metricsProvider.ssl.trustStore.location=/path/to/truststore.jks
+  metricsProvider.ssl.trustStore.password=your_truststore_password
+  metricsProvider.ssl.trustStore.type=jks  # Default is JKS
+  ```
+
+- **Note**: You can enable both HTTP and HTTPS simultaneously by defining both ports:
+  ```conf
+  metricsProvider.httpPorts=7000
+  metricsProvider.httpsPorts=4443

Review Comment:
   ```suggestion
     metricsProvider.httpPort=7000
     metricsProvider.httpsPort=4443
   ```



##########
zookeeper-docs/src/main/resources/markdown/zookeeperMonitor.md:
##########
@@ -41,11 +41,49 @@ All the metrics are included in the `ServerMetrics.java`.
 
 <a name=""Prometheus""></a>
 
+
+### Pre-requisites:
+- Enable the `Prometheus MetricsProvider` by setting the following in `zoo.cfg`:
+  ```conf
+  metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
+  ```
+
+- The port for Prometheus metrics can be configured using:
+  ```conf
+  metricsProvider.httpPort=7000  # Default port is 7000
+  ```
+
+#### Enabling HTTPS for Prometheus Metrics:
+
+ZooKeeper also supports SSL for Prometheus metrics, which provides secure data transmission. To enable this, configure an HTTPS port and set up SSL certificates as follows:
+
+- Define the HTTPS port:
+  ```conf
+  metricsProvider.httpPorts=4443

Review Comment:
   ```suggestion
     metricsProvider.httpsPort=4443
   ```



##########
zookeeper-docs/src/main/resources/markdown/zookeeperMonitor.md:
##########
@@ -41,11 +41,49 @@ All the metrics are included in the `ServerMetrics.java`.
 
 <a name=""Prometheus""></a>
 
+
+### Pre-requisites:
+- Enable the `Prometheus MetricsProvider` by setting the following in `zoo.cfg`:
+  ```conf
+  metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
+  ```
+
+- The port for Prometheus metrics can be configured using:
+  ```conf
+  metricsProvider.httpPort=7000  # Default port is 7000
+  ```
+
+#### Enabling HTTPS for Prometheus Metrics:
+
+ZooKeeper also supports SSL for Prometheus metrics, which provides secure data transmission. To enable this, configure an HTTPS port and set up SSL certificates as follows:
+
+- Define the HTTPS port:
+  ```conf
+  metricsProvider.httpPorts=4443
+  ```
+
+- Configure the SSL key store (holds the server’s private key and certificates):
+  ```conf
+  metricsProvider.ssl.keyStore.location=/path/to/keystore.jks
+  metricsProvider.ssl.keyStore.password=your_keystore_password
+  metricsProvider.ssl.keyStore.type=jks  # Default is JKS

Review Comment:
   backlog: I think we cloud detect this by filename just as `zookeeper.ssl.keyStore.type`.



;27/Sep/24 01:45;githubbot;600","purushah commented on code in PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190#discussion_r1777968778


##########
zookeeper-docs/src/main/resources/markdown/zookeeperMonitor.md:
##########
@@ -41,11 +41,49 @@ All the metrics are included in the `ServerMetrics.java`.
 
 <a name=""Prometheus""></a>
 
+
+### Pre-requisites:
+- Enable the `Prometheus MetricsProvider` by setting the following in `zoo.cfg`:
+  ```conf
+  metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
+  ```
+
+- The port for Prometheus metrics can be configured using:
+  ```conf
+  metricsProvider.httpPort=7000  # Default port is 7000
+  ```
+
+#### Enabling HTTPS for Prometheus Metrics:
+
+ZooKeeper also supports SSL for Prometheus metrics, which provides secure data transmission. To enable this, configure an HTTPS port and set up SSL certificates as follows:
+
+- Define the HTTPS port:
+  ```conf
+  metricsProvider.httpPorts=4443
+  ```
+
+- Configure the SSL key store (holds the server’s private key and certificates):
+  ```conf
+  metricsProvider.ssl.keyStore.location=/path/to/keystore.jks
+  metricsProvider.ssl.keyStore.password=your_keystore_password
+  metricsProvider.ssl.keyStore.type=jks  # Default is JKS
+  ```
+
+- Configure the SSL trust store (used to verify client certificates):
+  ```conf
+  metricsProvider.ssl.trustStore.location=/path/to/truststore.jks
+  metricsProvider.ssl.trustStore.password=your_truststore_password
+  metricsProvider.ssl.trustStore.type=jks  # Default is JKS
+  ```
+
+- **Note**: You can enable both HTTP and HTTPS simultaneously by defining both ports:
+  ```conf
+  metricsProvider.httpPorts=7000
+  metricsProvider.httpsPorts=4443

Review Comment:
   Thanks for catching that, @kezhuw. That was a simple oversight on my part.
   
   
   
   
   
   
   



;27/Sep/24 03:40;githubbot;600","purushah commented on code in PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190#discussion_r1777969311


##########
zookeeper-docs/src/main/resources/markdown/zookeeperMonitor.md:
##########
@@ -41,11 +41,49 @@ All the metrics are included in the `ServerMetrics.java`.
 
 <a name=""Prometheus""></a>
 
+
+### Pre-requisites:
+- Enable the `Prometheus MetricsProvider` by setting the following in `zoo.cfg`:
+  ```conf
+  metricsProvider.className=org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider
+  ```
+
+- The port for Prometheus metrics can be configured using:
+  ```conf
+  metricsProvider.httpPort=7000  # Default port is 7000
+  ```
+
+#### Enabling HTTPS for Prometheus Metrics:
+
+ZooKeeper also supports SSL for Prometheus metrics, which provides secure data transmission. To enable this, configure an HTTPS port and set up SSL certificates as follows:
+
+- Define the HTTPS port:
+  ```conf
+  metricsProvider.httpPorts=4443
+  ```
+
+- Configure the SSL key store (holds the server’s private key and certificates):
+  ```conf
+  metricsProvider.ssl.keyStore.location=/path/to/keystore.jks
+  metricsProvider.ssl.keyStore.password=your_keystore_password
+  metricsProvider.ssl.keyStore.type=jks  # Default is JKS

Review Comment:
   Yes, if needed, we can do it. 



;27/Sep/24 03:41;githubbot;600","kezhuw merged PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190


;29/Sep/24 02:02;githubbot;600","kezhuw commented on PR #2190:
URL: https://github.com/apache/zookeeper/pull/2190#issuecomment-2381063130

   Merged. @purushah Thank you for your contribution!


;29/Sep/24 02:03;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,8400,,,0,8400,,,,,,,,,,,,ZOOKEEPER-4798,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Sun Sep 29 02:04:37 UTC 2024,,,,,,,,,,"0|z1rkj4:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"29/Sep/24 02:04;kezhuw;master: 1880fc0d0a092b2c4e518bc45d5c4e8a77ca4abc;;;",,,,,,,,,,,
Disable X-Forwarded-For in IPAuthenticationProvider by default,ZOOKEEPER-4860,13592123,,Improvement,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,andor,andor,andor,13/Sep/24 20:17,24/Oct/24 20:09,08/Dec/25 08:12,17/Sep/24 15:38,3.9.2,,,,,,,,3.10.0,3.9.3,,security,server,,,0,pull-request-available,,,"Disable *X-Forwarded-For* header check in *IPAuthenticationProvider* by default to improve reliability in client IP address detection. 

X-Forwarded-For is not a standard header, it's not required and not needed unless ZooKeeper is behind a proxy server. Relying on that when detecting client IP address should be the exception, not the standard behaviour. Therefore we should disable it by defult.",,"anmolnar opened a new pull request, #2187:
URL: https://github.com/apache/zookeeper/pull/2187

   (no comment)


;13/Sep/24 20:41;githubbot;600","purushah commented on PR #2187:
URL: https://github.com/apache/zookeeper/pull/2187#issuecomment-2353444893

   Looks good. Considering that [ZOOKEEPER-4851](https://issues.apache.org/jira/browse/ZOOKEEPER-4851) didn't make it into any release, otherwise, it could have caused a backward compatibility issue. 
   @anmolnar We should update ZOOKEEPER-4851 accordingly.


;16/Sep/24 16:57;githubbot;600","anmolnar commented on PR #2187:
URL: https://github.com/apache/zookeeper/pull/2187#issuecomment-2354443999

   @purushah 
   Thanks for the review. No, we haven't released [ZOOKEEPER-4851](https://issues.apache.org/jira/browse/ZOOKEEPER-4851) yet, hence I think this patch should work as it is. What update do you mean on the ticket?


;17/Sep/24 03:42;githubbot;600","purushah commented on PR #2187:
URL: https://github.com/apache/zookeeper/pull/2187#issuecomment-2356073512

   Hi @anmolnar 
   ZOOKEEPER-4851 currently has Fix Version/s: 3.10.0, 3.9.3. Since the commit was overwritten, we should remove these release versions to prevent any confusion. Additionally, I suggest marking the ticket as ""Closed"" instead of ""Resolved"" to accurately reflect its current status.
   
   Let me know what you think.


;17/Sep/24 14:42;githubbot;600","anmolnar commented on PR #2187:
URL: https://github.com/apache/zookeeper/pull/2187#issuecomment-2356245424

   @purushah 
   
   Oh, I see your concern now, but I don't see it a problem: previous ticket is about making the header checking optional and this one is about making it off by default. They're not contradicting.


;17/Sep/24 15:28;githubbot;600","anmolnar merged PR #2187:
URL: https://github.com/apache/zookeeper/pull/2187


;17/Sep/24 15:34;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3600,,,0,3600,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Tue Sep 17 15:38:28 UTC 2024,,,,,,,,,,"0|z1rf6w:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"17/Sep/24 15:38;andor;ping [~liwang] ;;;",,,,,,,,,,,
C client tests hang to be cancelled quite often,ZOOKEEPER-4859,13591716,,Test,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,kezhuw,kezhuw,kezhuw,11/Sep/24 02:38,24/Oct/24 20:09,08/Dec/25 08:12,20/Sep/24 03:15,,,,,,,,,3.10.0,3.8.5,3.9.3,c client,tests,,,0,pull-request-available,,,"CPPUNIT tests runs sequentially. By comparing logs with successful run, I think it could be {{{}Zookeeper_readOnly::testReadOnlyWithSSL{}}}.

Logs from failed run.
{noformat}
     [exec] Zookeeper_multi::testWatch : elapsed 2005 : OK
     [exec] Zookeeper_multi::testSequentialNodeCreateInAsyncMulti : elapsed 2001 : OK
     [exec] Zookeeper_multi::testBigAsyncMulti : elapsed 3003 : OK
     [exec] Zookeeper_operations::testAsyncWatcher1 : elapsed 54 : OK
     [exec] Zookeeper_operations::testAsyncGetOperation : elapsed 54 : OK
     [exec] Zookeeper_operations::testOperationsAndDisconnectConcurrently1 : elapsed 382 : OK
     [exec] Zookeeper_operations::testOperationsAndDisconnectConcurrently2 : elapsed 0 : OK
     [exec] Zookeeper_operations::testConcurrentOperations1 : elapsed 21127 : OK
     [exec] Zookeeper_readOnly::testReadOnly ZooKeeper server started ZooKeeper server started : elapsed 12214 : OK
{noformat}
Logs from successful run.
{noformat}
     [exec] Zookeeper_multi::testWatch : elapsed 2006 : OK
     [exec] Zookeeper_multi::testSequentialNodeCreateInAsyncMulti : elapsed 2001 : OK
     [exec] Zookeeper_multi::testBigAsyncMulti : elapsed 3003 : OK
     [exec] Zookeeper_operations::testAsyncWatcher1 : elapsed 54 : OK
     [exec] Zookeeper_operations::testAsyncGetOperation : elapsed 54 : OK
     [exec] Zookeeper_operations::testOperationsAndDisconnectConcurrently1 : elapsed 387 : OK
     [exec] Zookeeper_operations::testOperationsAndDisconnectConcurrently2 : elapsed 0 : OK
     [exec] Zookeeper_operations::testConcurrentOperations1 : elapsed 22459 : OK
     [exec] Zookeeper_readOnly::testReadOnly ZooKeeper server started ZooKeeper server started : elapsed 15515 : OK
     [exec] Zookeeper_readOnly::testReadOnlyWithSSL ZooKeeper server started ZooKeeper server started : elapsed 14865 : OK
{noformat}
 ",,"kezhuw opened a new pull request, #2186:
URL: https://github.com/apache/zookeeper/pull/2186

   Github is providing us hostnames with more than 64 characters quite often now.
   
   Say:
   
   * `fv-az1272-448.grsihaubamwerhiryzjrxtypna.phxx.internal.cloudapp.net` (67 characters)
   * `fv-az1383-210.ikz3ofujitfebmhnxoyjuylfjd.ex.internal.cloudapp.net` (65 characters)
   
   This fails tls certs generation in cppunit tests.


;12/Sep/24 14:48;githubbot;600","kezhuw commented on PR #2186:
URL: https://github.com/apache/zookeeper/pull/2186#issuecomment-2349288371

   @anmolnar @tisonkun @eolivelli @maoling Wound you mind take a look ? It fails CI quite often those days and shadows other cppunit tests.


;13/Sep/24 16:01;githubbot;600","anmolnar merged PR #2186:
URL: https://github.com/apache/zookeeper/pull/2186


;19/Sep/24 16:00;githubbot;600","anmolnar commented on PR #2186:
URL: https://github.com/apache/zookeeper/pull/2186#issuecomment-2361423330

   @kezhuw Given that it's a CI only fix, I'm not sure if we only need this on the master branch or need backports too.


;19/Sep/24 16:02;githubbot;600","kezhuw commented on PR #2186:
URL: https://github.com/apache/zookeeper/pull/2186#issuecomment-2362686155

   @anmolnar Thank you for reminding! I have backported it to both 3.8 and 3.9. Besides, I backported more for 3.8 to fix ci errors, see #2189.


;20/Sep/24 03:28;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3000,,,0,3000,,,,,,,,,,,,,,,ZOOKEEPER-4746,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Thu Sep 19 14:46:11 UTC 2024,,,,,,,,,,"0|z1rcog:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"12/Sep/24 14:49;kezhuw;Shit happens.

Github is providing us hostnames with more than 64 characters quite often now.
{noformat}
fv-az1272-448.grsihaubamwerhiryzjrxtypna.phxx.internal.cloudapp.net
fv-az1383-210.ikz3ofujitfebmhnxoyjuylfjd.ex.internal.cloudapp.net
{noformat}

And openssl refuses to generate certs for ssl tests when hostname length is greater than 64. 

I found these from {{gencerts.stderr}} (output by {{gencerts.sh}}).

{noformat}
Error making certificate request
404703E6897F0000:error:06800097:asn1 encoding routines:ASN1_mbstring_ncopy:string too long:../crypto/asn1/a_mbstr.c:106:maxsize=64
{noformat}

;;;","19/Sep/24 14:46;kezhuw;I have reported this to https://github.com/actions/runner-images/issues/10650. I was guided to there from Github Support.;;;",,,,,,,,,,
Remove the lock contention between snapshotting and the sync operation,ZOOKEEPER-4858,13591355,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,li4wang,li4wang,li4wang,07/Sep/24 01:49,29/Aug/25 21:29,08/Dec/25 08:12,21/Dec/24 04:15,3.9.0,3.9.1,3.9.2,3.9.3,,,,,3.10.0,3.9.4,,server,,,,0,pull-request-available,,,"Remove the synchronized keyword from Zookeeper.takeSnapshot() and  ZookeeperServer.restoreFromSnapshot() API, as it causes lock contention on the ZookeeperServer object with the sync operation. 

In ZookeeperServer.java, we have the following
{code:java}

 public synchronized File takeSnapshot(boolean syncSnap, boolean isSevere, boolean fastForwardFromEdits) throws IOException {
....
}
{code}

In ObserverZookeeperServer.java and FollowerZookeeperServer.java, we have the following
       
{code:java}
public synchronized void sync() {
     ...
    }

{code}


",,"li4wang opened a new pull request, #2185:
URL: https://github.com/apache/zookeeper/pull/2185

   Author: Li Wang <liwang@apple.com>


;07/Sep/24 02:14;githubbot;600","li4wang commented on PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2345059508

   @eolivelli can I get a review for this? Thanks


;12/Sep/24 01:11;githubbot;600","li4wang commented on PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2415607518

   Thanks for reviewing it, @anmolnar.
   
   Yes, we would still want exclusive locking between snapshot and restore to make sure data tree is not replaced by restoring  operation while snapshotting is in progress.
   
   


;16/Oct/24 02:40;githubbot;600","li4wang commented on PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2415612268

   added a specific lock just for snapshot and restore operations. @anmolnar would you mind taking a look at it. Thanks.


;16/Oct/24 02:45;githubbot;600","li4wang commented on PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2427279513

   @anmolnar I've addressed your comment. Can you take a quick look at it? Thanks.


;21/Oct/24 17:08;githubbot;600","anmolnar commented on PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2529146395

   Are you sure that we don't need to synchronize between snapshotting and `sync()`?


;09/Dec/24 19:13;githubbot;600","anmolnar commented on code in PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#discussion_r1876538751


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java:
##########
@@ -618,9 +622,10 @@ public synchronized long restoreFromSnapshot(final InputStream inputStream) thro
         restoreLatch = new CountDownLatch(1);
 
         try {
-            // set to the new zkDatabase
-            setZKDatabase(newZKDatabase);
-
+            synchronized (snapshotAndRestoreLock) {
+                // set to the new zkDatabase
+                setZKDatabase(newZKDatabase);
+            }

Review Comment:
   I think you better extend the scope of sync block to `createSessionTracker()` call.



;09/Dec/24 19:14;githubbot;600","anmolnar commented on PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2529152144

   @kezhuw Thoughts?


;09/Dec/24 19:16;githubbot;600","li4wang commented on code in PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#discussion_r1876700215


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java:
##########
@@ -618,9 +622,10 @@ public synchronized long restoreFromSnapshot(final InputStream inputStream) thro
         restoreLatch = new CountDownLatch(1);
 
         try {
-            // set to the new zkDatabase
-            setZKDatabase(newZKDatabase);
-
+            synchronized (snapshotAndRestoreLock) {
+                // set to the new zkDatabase
+                setZKDatabase(newZKDatabase);
+            }

Review Comment:
   ```
       protected void createSessionTracker() {
           sessionTracker = new SessionTrackerImpl(this, zkDb.getSessionWithTimeOuts(), tickTime, createSessionTrackerServerId, getZooKeeperServerListener());
       }
   ```
   
   ```
    public File takeSnapshot(boolean syncSnap, boolean isSevere) throws IOException {
           try {
               synchronized (snapshotAndRestoreLock) {
                   snapFile = txnLogFactory.save(zkDb.getDataTree(), zkDb.getSessionWithTimeOuts(), syncSnap);
               }
           } catch (IOException e) {
   ```
   
   ```
     public ConcurrentHashMap<Long, Integer> getSessionWithTimeOuts() {
           return sessionsWithTimeouts;
       }
   ```
   
   
   `takeSapshot()` and `createSessionTracker() ` of `resore()` just read data from the sessionsWithTimeouts ConcurrentHashMap, any reason the sync block need to include it?
   



;09/Dec/24 20:16;githubbot;600","li4wang commented on code in PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#discussion_r1876700215


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java:
##########
@@ -618,9 +622,10 @@ public synchronized long restoreFromSnapshot(final InputStream inputStream) thro
         restoreLatch = new CountDownLatch(1);
 
         try {
-            // set to the new zkDatabase
-            setZKDatabase(newZKDatabase);
-
+            synchronized (snapshotAndRestoreLock) {
+                // set to the new zkDatabase
+                setZKDatabase(newZKDatabase);
+            }

Review Comment:
   ```
       protected void createSessionTracker() {
           sessionTracker = new SessionTrackerImpl(this, zkDb.getSessionWithTimeOuts(), tickTime, createSessionTrackerServerId, getZooKeeperServerListener());
       }
   ```
   
   ```
    public File takeSnapshot(boolean syncSnap, boolean isSevere) throws IOException {
           try {
               synchronized (snapshotAndRestoreLock) {
                   snapFile = txnLogFactory.save(zkDb.getDataTree(), zkDb.getSessionWithTimeOuts(), syncSnap);
               }
           } catch (IOException e) {
   ```
   
   ```
     public ConcurrentHashMap<Long, Integer> getSessionWithTimeOuts() {
           return sessionsWithTimeouts;
       }
   ```
   
   
   `takeSapshot()` and `createSessionTracker() ` of `resore()` both read data from the sessionsWithTimeouts ConcurrentHashMap, any reason the sync block need to include it?
   



;09/Dec/24 20:17;githubbot;600","li4wang commented on code in PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#discussion_r1876700215


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java:
##########
@@ -618,9 +622,10 @@ public synchronized long restoreFromSnapshot(final InputStream inputStream) thro
         restoreLatch = new CountDownLatch(1);
 
         try {
-            // set to the new zkDatabase
-            setZKDatabase(newZKDatabase);
-
+            synchronized (snapshotAndRestoreLock) {
+                // set to the new zkDatabase
+                setZKDatabase(newZKDatabase);
+            }

Review Comment:
   ```
       protected void createSessionTracker() {
           sessionTracker = new SessionTrackerImpl(this, zkDb.getSessionWithTimeOuts(), tickTime, createSessionTrackerServerId, getZooKeeperServerListener());
       }
   ```
   
   ```
    public File takeSnapshot(boolean syncSnap, boolean isSevere) throws IOException {
           try {
               synchronized (snapshotAndRestoreLock) {
                   snapFile = txnLogFactory.save(zkDb.getDataTree(), zkDb.getSessionWithTimeOuts(), syncSnap);
               }
           } catch (IOException e) {
   ```
   
   ```
     public ConcurrentHashMap<Long, Integer> getSessionWithTimeOuts() {
           return sessionsWithTimeouts;
       }
   ```
   
   `takeSapshot()` and `createSessionTracker() ` of `resore()` both read data from the sessionsWithTimeouts ConcurrentHashMap, any reason the sync block need to include it? 
   
   `createSessionTracker() ` is a post process after swapping the ZkDatabase object of a ZookeeperServer instance. `sessionsWithTimeouts` is part of `ZkDatabase` object and read/write sync is already covered by the sync block.
   



;09/Dec/24 20:26;githubbot;600","anmolnar commented on code in PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#discussion_r1876716261


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/ZooKeeperServer.java:
##########
@@ -618,9 +622,10 @@ public synchronized long restoreFromSnapshot(final InputStream inputStream) thro
         restoreLatch = new CountDownLatch(1);
 
         try {
-            // set to the new zkDatabase
-            setZKDatabase(newZKDatabase);
-
+            synchronized (snapshotAndRestoreLock) {
+                // set to the new zkDatabase
+                setZKDatabase(newZKDatabase);
+            }

Review Comment:
   To be on the safe side. `Learner` calls it within a sync block: https://github.com/apache/zookeeper/blob/master/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java#L610



;09/Dec/24 20:31;githubbot;600","anmolnar commented on PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2537053559

   > We ran into perf issue when had sync on the ZookeeperServer object. Whenever snapshot was taken, the sync operations were queued up in the outstanding request queue and the sync() operation latency was largely increased. (edited) 
   > There was no synchronize between snapshotting and sync() before.
   > The intention of adding the synchronized was to takeSnapshot() and restore() was to sync between the two operations. I didn’t realize the sync() call also requires ZookeeperServer object lock.
   
   When has synchronized been added to take/restore snapshot?
   Are you saying that `sync()` was already synchronized which should prevent multiple sync's running at the same time, but accidentally you introduced snapshotting into this lock?


;11/Dec/24 20:24;githubbot;600","li4wang commented on PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2539818003

   > When has synchronized been added to take/restore snapshot?
   synchronized on the ZookeeperServer object  was added when we introduced remote backup and restore feature, specifically https://github.com/apache/zookeeper/pull/1943
   


;12/Dec/24 19:14;githubbot;600","anmolnar commented on PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2555077971

   > LGTM
   > 
   > > it causes lock contention on the ZookeeperServer object with the sync operation.
   > 
   > Does anyone have any cue about why `sync` get `synchronized` ? I saw that `sync` is called only in one thread and `pendingSyncs` is concurrent safe.
   
   I have no idea either. I think we could remove synchronize from `sync()` too. Or remove it only from `sync()`.


;19/Dec/24 16:54;githubbot;600","anmolnar commented on PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2555094540

   [ZOOKEEPER-136](https://issues.apache.org/jira/browse/ZOOKEEPER-136) added synchronized to sync()


;19/Dec/24 16:57;githubbot;600","li4wang commented on PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2557852989

   Thanks @anmolnar and @kezhuw 
   
   > > I saw that sync is called only in one thread and pendingSyncs is concurrent safe.
   > I think we could remove synchronize from sync() too. Or remove it only from sync().
   
   `sync()` is synchronized on the `ZookeeperServer` object, which is accessed by multiple-threads.  Through inheritance and composition, the sync() operation is currently synchronized with following API calls. 
   
   ```
   ZookeeperServer.enqueueRequest(), 
   ZookeeperServer.submitRequestNow()
   ZookeeperServer.startup()
   ZookeeperServer.shutdown()
   Learner.syncWithLeader()
   ```
   
   `sync()` is used for strong consistency of not getting stale data in the read after write scenario. Not sure if it's safe to remove `synchronization` from it.
   


;20/Dec/24 22:50;githubbot;600","li4wang commented on PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185#issuecomment-2557855341

   @anmolnar @kezhuw The PR is good for merge now, right?


;20/Dec/24 22:54;githubbot;600","kezhuw merged PR #2185:
URL: https://github.com/apache/zookeeper/pull/2185


;21/Dec/24 04:14;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,11400,,,0,11400,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Sat Dec 21 04:15:52 UTC 2024,,,,,,,,,,"0|z1ragw:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"07/Sep/24 01:54;li4wang;Will submit a patch for it.;;;","21/Dec/24 04:15;kezhuw;Issue resolved by pull request 2185
[https://github.com/apache/zookeeper/pull/2185];;;",,,,,,,,,,
erroneous assertion in ZooKeeperQuotaTest#testQuota,ZOOKEEPER-4853,13590003,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,,kezhuw,kezhuw,26/Aug/24 04:10,27/Aug/24 13:12,08/Dec/25 08:12,26/Aug/24 04:13,3.9.2,,,,,,,,3.10.0,,,tests,,,,0,pull-request-available,,,"Created for https://github.com/apache/zookeeper/pull/2169.

{code:java}
assertNotNull(server.getZKDatabase().getDataTree().getMaxPrefixWithQuota(path) != null, ""Quota is still set"");
{code}

The above equation test evaluates to a non null boolean value, so always pass.",,"kezhuw merged PR #2169:
URL: https://github.com/apache/zookeeper/pull/2169


;26/Aug/24 04:13;githubbot;600","kezhuw commented on PR #2169:
URL: https://github.com/apache/zookeeper/pull/2169#issuecomment-2309272899

   @1neverknow Thank you for your contribution! Merged.


;26/Aug/24 04:14;githubbot;600","1neverknow commented on PR #2169:
URL: https://github.com/apache/zookeeper/pull/2169#issuecomment-2311009261

   Thanks for the update!
   However, I just noticed that there's still a typo in the fixed statement. It should be written as:
   ```java
   assertNotNull(""Quota is still set"", server.getZKDatabase().getDataTree().getMaxPrefixWithQuota(path));
   ```
   The first argument of `assertNotNull` is the error message, while the second one is the actual ""notnull"" object""


;26/Aug/24 20:17;githubbot;600","1neverknow opened a new pull request, #2182:
URL: https://github.com/apache/zookeeper/pull/2182

   The first argument of `assertNotNull` is the error message, while the second one is the actual ""notnull"" object"".


;26/Aug/24 20:30;githubbot;600","kezhuw commented on PR #2169:
URL: https://github.com/apache/zookeeper/pull/2169#issuecomment-2311393877

   https://junit.org/junit5/docs/5.0.1/api/org/junit/jupiter/api/Assertions.html#assertNotNull-java.lang.Object-java.lang.String-
   
   ```java
   public static void assertNotNull(Object actual, String message)
   ```
   
   I think it is not. @1neverknow 


;27/Aug/24 01:27;githubbot;600","1neverknow commented on PR #2169:
URL: https://github.com/apache/zookeeper/pull/2169#issuecomment-2312526998

   > https://junit.org/junit5/docs/5.0.1/api/org/junit/jupiter/api/Assertions.html#assertNotNull-java.lang.Object-java.lang.String-
   > 
   > ```java
   > public static void assertNotNull(Object actual, String message)
   > ```
   > 
   > I think it is not. @1neverknow
   
   You're right; placing the message at first is a convention from JUnit 4. Thanks for pointing that out.


;27/Aug/24 13:12;githubbot;600","1neverknow closed pull request #2182: Amendment to pull request #2169 (ZOOKEEPER-4853)
URL: https://github.com/apache/zookeeper/pull/2182


;27/Aug/24 13:12;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,4200,,,0,4200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Mon Aug 26 04:13:51 UTC 2024,,,,,,,,,,"0|z1r24w:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"26/Aug/24 04:13;kezhuw;Issue resolved by pull request 2169
[https://github.com/apache/zookeeper/pull/2169];;;",,,,,,,,,,,
"Fix the bad ""*uuuuu"" mark in the ASF license",ZOOKEEPER-4852,13589587,,Improvement,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Trivial,Fixed,,maoling,maoling,21/Aug/24 09:37,29/Aug/25 21:29,08/Dec/25 08:12,29/Oct/24 02:27,3.8.4,3.9.3,,,,,,,3.10.0,3.8.5,3.9.4,documentation,,,,0,beginner-friendly,pull-request-available,,"we have four java files have this issue. e.g. 

 
{code:java}
/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * ""License""); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *uuuuu
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an ""/RequuuAS IS"" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.apache.zookeeper.server;
import java.io.IOException;
import java.nio.ByteBuffer;
import java.util.function.Supplier;
import org.apache.jute.Record;
public interface RequestRecord {
{code}
 ",,"kezhuw merged PR #2207:
URL: https://github.com/apache/zookeeper/pull/2207


;29/Oct/24 02:17;githubbot;600","kezhuw commented on PR #2207:
URL: https://github.com/apache/zookeeper/pull/2207#issuecomment-2443041952

   Merged after applying commit suggests from my side as it is simple and affects no code.
   
   Also, backported to branch-3.9 and branch-3.8(after conflict resolved).
   
   @aditya0yadav Thank you for your contribution!


;29/Oct/24 02:32;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1200,,,0,1200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Tue Oct 29 02:28:45 UTC 2024,,,,,,,,,,"0|z1qzko:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"29/Oct/24 02:28;kezhuw;master: 9d522642a9c78dafb7084952f9807beb205478c3
branch-3.9: 3ca20f8a867c63255d212035287eac1c8dbad750
branch-3.8: 758a0d2e621b38c4531c88520f9564778e547e50 (after conflict resolved);;;",,,,,,,,,,,
Honor X-Forwarded-For optionally in IPAuthenticationProvider,ZOOKEEPER-4851,13589494,,Improvement,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,andor,andor,andor,20/Aug/24 17:54,24/Oct/24 20:09,08/Dec/25 08:12,03/Sep/24 20:08,3.9.2,,,,,,,,3.10.0,3.9.3,,server,,,,0,pull-request-available,,,"Introduce a feature flag in *IPAuthenticationProvider* to toggle reading of *X-Forwarded-For* header from HTTP requests, because there're some use cases when it's not needed.",,"anmolnar opened a new pull request, #2181:
URL: https://github.com/apache/zookeeper/pull/2181

   (no comment)


;22/Aug/24 16:08;githubbot;600","anmolnar commented on PR #2181:
URL: https://github.com/apache/zookeeper/pull/2181#issuecomment-2310669196

   Thanks @kezhuw for the review.
   Anyone else take a look @eolivelli @li4wang ?


;26/Aug/24 17:06;githubbot;600","anmolnar merged PR #2181:
URL: https://github.com/apache/zookeeper/pull/2181


;03/Sep/24 20:04;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1800,,,0,1800,,,,,,,,,,ZOOKEEPER-4570,ZOOKEEPER-4639,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Tue Aug 20 19:03:01 UTC 2024,,,,,,,,,,"0|z1qz00:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"20/Aug/24 19:03;andor;ping [~liwang] ;;;",,,,,,,,,,,
Enhance zkCli Tool to Support Reading and Writing Binary Data,ZOOKEEPER-4850,13589149,,Improvement,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,shawyeok,shawyeok,shawyeok,17/Aug/24 03:42,24/Oct/24 20:09,08/Dec/25 08:12,18/Sep/24 20:44,,,,,,,,,3.10.0,3.8.5,3.9.3,tools,,,,0,pull-request-available,,,"Currently, the `get` and `set` commands in the zkCli tool only support reading and writing text data. However, znode data can be an arbitrary byte array. It would be useful to read and write binary data in base64 or hexdump format.",,"Shawyeok opened a new pull request, #2180:
URL: https://github.com/apache/zookeeper/pull/2180

   Currently, the `get` and `set` commands in the zkCli tool only support reading and writing text data. However, znode data can be an arbitrary byte array. It would be useful to read and write binary data in base64 or hexdump format.
   
   This PR provides two options for the `get` command:
   - `get -b /foo`: Outputs data in base64 format.
   - `get -x /foo`: Outputs data in hexdump format.
   
   Additionally, it provides a `-b` option for the `set` command to allow users to set binary data for a znode. For instance: `set -b /foo em9va2VlcGVy`.


;17/Aug/24 03:46;githubbot;600","Shawyeok commented on PR #2180:
URL: https://github.com/apache/zookeeper/pull/2180#issuecomment-2294613630

   @tisonkun Feel free to take a look, thanks.


;17/Aug/24 04:02;githubbot;600","ctubbsii commented on code in PR #2180:
URL: https://github.com/apache/zookeeper/pull/2180#discussion_r1720812598


##########
zookeeper-server/src/main/java/org/apache/zookeeper/cli/SetCommand.java:
##########
@@ -38,10 +39,11 @@ public class SetCommand extends CliCommand {
     static {
         options.addOption(""s"", false, ""stats"");
         options.addOption(""v"", true, ""version"");
+        options.addOption(""b"", false, ""base64"");
     }
 
     public SetCommand() {
-        super(""set"", ""[-s] [-v version] path data"");
+        super(""set"", ""[-s] [-v version] [-b] path data"");

Review Comment:
   No hex option here?



##########
zookeeper-server/src/main/java/org/apache/zookeeper/cli/GetCommand.java:
##########
@@ -38,10 +37,12 @@ public class GetCommand extends CliCommand {
     static {
         options.addOption(""s"", false, ""stats"");
         options.addOption(""w"", false, ""watch"");
+        options.addOption(""b"", false, ""base64"");
+        options.addOption(""x"", false, ""hexdump"");
     }
 
     public GetCommand() {
-        super(""get"", ""[-s] [-w] path"");
+        super(""get"", ""[-s] [-w] [-b] [-x] path"");

Review Comment:
   single character flags that have no description aren't very useful. -b64 and -hex would be easier to immediately understand



;17/Aug/24 18:16;githubbot;600","Shawyeok commented on code in PR #2180:
URL: https://github.com/apache/zookeeper/pull/2180#discussion_r1720942890


##########
zookeeper-server/src/main/java/org/apache/zookeeper/cli/SetCommand.java:
##########
@@ -38,10 +39,11 @@ public class SetCommand extends CliCommand {
     static {
         options.addOption(""s"", false, ""stats"");
         options.addOption(""v"", true, ""version"");
+        options.addOption(""b"", false, ""base64"");
     }
 
     public SetCommand() {
-        super(""set"", ""[-s] [-v version] path data"");
+        super(""set"", ""[-s] [-v version] [-b] path data"");

Review Comment:
   Yes, hexdump only provided to reading binary data, since it's output in multiline, it is not appropriate support directly in single line command here.
   
   Below is a hexdump output example:
   ```
   get -x /foo
            +-------------------------------------------------+
            |  0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f |
   +--------+-------------------------------------------------+----------------+
   |00000000| 7a 6f 6f 6b 65 65 70 65 72                      |zookeeper       |
   +--------+-------------------------------------------------+----------------+
   ```



;18/Aug/24 10:16;githubbot;600","Shawyeok commented on code in PR #2180:
URL: https://github.com/apache/zookeeper/pull/2180#discussion_r1720944567


##########
zookeeper-server/src/main/java/org/apache/zookeeper/cli/GetCommand.java:
##########
@@ -38,10 +37,12 @@ public class GetCommand extends CliCommand {
     static {
         options.addOption(""s"", false, ""stats"");
         options.addOption(""w"", false, ""watch"");
+        options.addOption(""b"", false, ""base64"");
+        options.addOption(""x"", false, ""hexdump"");
     }
 
     public GetCommand() {
-        super(""get"", ""[-s] [-w] path"");
+        super(""get"", ""[-s] [-w] [-b] [-x] path"");

Review Comment:
   > Single character flags that have no description aren't very useful.
   
   Yes, I agree. The current Zookeeper CLI command usage isn't very appropriate. Maybe we could improve it in another PR.
   
   > -b64 and -hex would be easier to immediately understand
   
   I kept the short option naming convention here and just improved the `get` and `set` command usage with additional option descriptions. Here is the `get` command usage after the change:
   ```
   get [-s] [-w] [-b] [-x] path
    -b   Output data in base64 format
    -s   Print znode stats additionally
    -w   Watch for changes on the znode
    -x   Output data in hexdump format
   
   ```



;18/Aug/24 10:25;githubbot;600","Shawyeok commented on PR #2180:
URL: https://github.com/apache/zookeeper/pull/2180#issuecomment-2295227001

   Thanks for reviewing. I replied inline here:
   
   > had to deal with encoding quirks of different terminals,
   
   Could you explain more about this? IMO, `base64` or `hexdump` are just different view of the byte array, it should not involve any encoding problem (a terminal not support ascii?).
   
   > user requests for even more different kinds of serialization, custom formats, etc.
   
   IMO, domain-related serialization or formatting is beyound the general support area of the Zookeeper CLI.
   
   > I can understand how adding this seems like it would be a useful addition. However, in my experience, all it is likely to do is allow users with specific binary requirements to start depending on the zkcli tool for more than simple triage and troubleshooting, and will run into a lot of edge cases when they start to rely on it more. That will increase the maintenance burden and code complexity, without a lot of actual benefit to users.
   
   In my senario, I need to see the actual znode data when troubleshooting with application build around Apache Zookeeper e.g. Apache Pulsar, I do it by now is write an one-time only program to get znode data and print it in base64. If zookeeper cli supports it, it should provides convience with troubleshooting with binary znode data.
   
   > As an alternative, I suggest users who want to use binary data be directed to solutions like jshell, a built in Java utility that allows them to write simple custom Java scripts on the fly to interact with ZooKeeper. This keeps the maintenance burden for ZooKeeper low, and puts the responsibility for any custom binary formats directly on the users who have those requirements without introducing any complexity for users who do not.
   
   `jshell` is an interesting solution for a Java command-line program. I'll try it in the next use case. Thanks for bringing it to my attention. However, `jshell` requires Java 9, while ZooKeeper currently supports Java 8 and later.


;18/Aug/24 11:26;githubbot;600","ctubbsii commented on PR #2180:
URL: https://github.com/apache/zookeeper/pull/2180#issuecomment-2295300826

   > @ctubbsii Thanks for reviewing. I replied inline here:
   > 
   > > had to deal with encoding quirks of different terminals,
   > 
   > Could you explain more about this? IMO, `base64` or `hexdump` are just different view of the byte array, it should not involve any encoding problem (a terminal not support ascii?).
   
   The encoding problems I was referring to aren't with base64 or hex, but with String encoding, which is not part of your PR, but already assumed by zkCli. (For example, some terminals allow you to type in non-printable characters or multi-byte unicode characters, which JLine can mangle if its settings don't match your terminal settings.) The problem isn't really the addition of base64 or hex, but the addition of more code paths for the user to consider, making it harder for users to predict the behavior of zkCli. Users may be able to deal with the quirks of one code path, but when multiple are added, it becomes harder to predict what the actual underlying bytes are going to be.
   
   For example, while I mentioned some specific quirks with JLine mangling unicode characters if terminal settings don't match in the String entry case, the base64 entry adds addition quirks, because there isn't a single base64 encoding scheme. There are **many** base64 encoding schemes. See https://en.wikipedia.org/wiki/Base64#Variants_summary_table . There are also different hex encoding schemes https://en.wikipedia.org/wiki/Hexadecimal
   
   > 
   > > user requests for even more different kinds of serialization, custom formats, etc.
   > 
   > IMO, domain-related serialization or formatting is beyound the general support area of the Zookeeper CLI.
   
   I agree. That was kind of my point. I'd consider binary data to fall into the category of domain-specific serialization.
   
   > 
   > > I can understand how adding this seems like it would be a useful addition. However, in my experience, all it is likely to do is allow users with specific binary requirements to start depending on the zkcli tool for more than simple triage and troubleshooting, and will run into a lot of edge cases when they start to rely on it more. That will increase the maintenance burden and code complexity, without a lot of actual benefit to users.
   > 
   > In my scenario, I need to see the actual znode data when troubleshooting with application build around Apache Zookeeper e.g. Apache Pulsar, I do it by now is write an one-time only program to get znode data and print it in base64. If zookeeper cli supports it, it should provides convience with troubleshooting with binary znode data.
   
   My preference would be to not modify the zkCli interactive shell. Instead, I would prefer a better tool that can interact directly with the user's terminal. So, if you need base64 encoding or hexdump, you can do something like `bin/zk get /path/to/node | base64` or `<something.bin bin/zk set /path/to/node --digest-auth ""secret""`. That way, instead of baking in new features into the zkCli, users can more easily take full advantage of the wide variety of existing tools available to them on the command-line.
   


;18/Aug/24 15:26;githubbot;600","Shawyeok commented on PR #2180:
URL: https://github.com/apache/zookeeper/pull/2180#issuecomment-2295672361

   @ctubbsii 
   
   > The problem isn't really the addition of base64 or hex, but the addition of more code paths for the user to consider, making it harder for users to predict the behavior of zkCli.
   >
   > My preference would be to not modify the zkCli interactive shell. Instead, I would prefer a better tool that can interact directly with the user's terminal. So, if you need base64 encoding or hexdump, you can do something like bin/zk get /path/to/node | base64 or <something.bin bin/zk set /path/to/node --digest-auth ""secret"". That way, instead of baking in new features into the zkCli, users can more easily take full advantage of the wide variety of existing tools available to them on the command-line.
   
   The default behavior of the get or set command isn't changed; users may not even notice any difference if they just rely on plain text data. I understand what you aim for: making the zkCli tool simple and stupid, letting it connect with other tools via pipe, which is a bit like the Unix philosophy. The reality is that the zkCli tool is more of an interactive CLI tool, not designed for pipe connections. It prints a lot of stuff on stdout, such as logs, connecting messages, and watchers. Here is an example of a simple get command output on stdout:
   ```
   # bin/zkCli.sh -server 172.17.5.175 2>/dev/null get /foo 2>/dev/null
   Connecting to 172.17.5.175
   2024-08-19 01:53:30,575 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:zookeeper.version=3.10.0-SNAPSHOT-a78341b1e7b48d85ce4eb9d9dd7ce4089b437db6-dirty, built on 2024-08-18 10:08 UTC
   2024-08-19 01:53:30,579 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:host.name=macbook.lan
   2024-08-19 01:53:30,579 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:java.version=1.8.0_351
   2024-08-19 01:53:30,579 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:java.vendor=Oracle Corporation
   2024-08-19 01:53:30,579 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:java.home=/Library/Java/JavaVirtualMachines/jdk1.8.0_351.jdk/Contents/Home/jre
   2024-08-19 01:53:30,579 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:java.class.path=<ELLIPSIS>
   2024-08-19 01:53:30,580 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:java.library.path=<ELLIPSIS>
   2024-08-19 01:53:30,580 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:java.io.tmpdir=/var/folders/cp/bcjqx5q56h7gp_3kts42xglm0000gp/T/
   2024-08-19 01:53:30,580 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:java.compiler=<NA>
   2024-08-19 01:53:30,580 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:os.name=Mac OS X
   2024-08-19 01:53:30,580 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:os.arch=x86_64
   2024-08-19 01:53:30,580 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:os.version=14.5
   2024-08-19 01:53:30,580 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:user.name=<ELLIPSIS>
   2024-08-19 01:53:30,580 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:user.home=<ELLIPSIS>
   2024-08-19 01:53:30,580 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:user.dir=<ELLIPSIS>
   2024-08-19 01:53:30,580 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:jvm.memory.free=226MB
   2024-08-19 01:53:30,580 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:jvm.memory.max=245MB
   2024-08-19 01:53:30,580 [myid:] - INFO  [main:o.a.z.Environment@98] - Client environment:jvm.memory.total=245MB
   2024-08-19 01:53:30,581 [myid:] - INFO  [main:o.a.z.ZooKeeper@1082] - Initiating client connection, connectString=172.17.5.175 sessionTimeout=30000 watcher=org.apache.zookeeper.ZooKeeperMain$MyWatcher@44c8afef
   2024-08-19 01:53:30,588 [myid:] - INFO  [main:o.a.z.c.X509Util@88] - Setting -D jdk.tls.rejectClientInitiatedRenegotiation=true to disable client-initiated TLS renegotiation
   2024-08-19 01:53:30,929 [myid:] - INFO  [main:o.a.z.c.X509Util@110] - Default TLS protocol is TLSv1.3, supported TLS protocols are [TLSv1.3, TLSv1.2, TLSv1.1, TLSv1, SSLv3, SSLv2Hello]
   2024-08-19 01:53:30,941 [myid:] - INFO  [main:o.a.z.ClientCnxnSocket@233] - jute.maxbuffer value is 1048575 Bytes
   2024-08-19 01:53:30,951 [myid:] - INFO  [main:o.a.z.ClientCnxn@1677] - zookeeper.request.timeout value is 0. feature enabled=false
   2024-08-19 01:53:31,023 [myid:172.17.5.175:2181] - INFO  [main-SendThread(172.17.5.175:2181):o.a.z.ClientCnxn$SendThread@1113] - Opening socket connection to server 172.17.5.175/172.17.5.175:2181.
   2024-08-19 01:53:31,024 [myid:172.17.5.175:2181] - INFO  [main-SendThread(172.17.5.175:2181):o.a.z.ClientCnxn$SendThread@1115] - SASL config status: Will not attempt to authenticate using SASL (unknown error)
   2024-08-19 01:53:31,047 [myid:172.17.5.175:2181] - INFO  [main-SendThread(172.17.5.175:2181):o.a.z.ClientCnxn$SendThread@966] - Socket connection established, initiating session, client: /10.7.1.242:58827, server: 172.17.5.175/172.17.5.175:2181
   2024-08-19 01:53:31,084 [myid:172.17.5.175:2181] - INFO  [main-SendThread(172.17.5.175:2181):o.a.z.ClientCnxn$SendThread@1383] - Session establishment complete on server 172.17.5.175/172.17.5.175:2181, session id = 0x40ef32da9020099, negotiated timeout = 30000
   
   WATCHER::
   
   WatchedEvent state:SyncConnected type:None path:null zxid: -1
   zookeeper
   2024-08-19 01:53:31,105 [myid:] - INFO  [main:o.a.z.u.ServiceUtils@45] - Exiting JVM with code 0
   ```
   
   Filtering with grep -v ' - INFO ', you still get:
   ```
   Connecting to 172.17.5.175
   
   WATCHER::
   
   WatchedEvent state:SyncConnected type:None path:null zxid: -1
   zookeeper
   ```
   
   It's hard to write a command in the `bin/zk get /path/to/node | base64` format, at least in the current implementation of the zkCli tool.
   
   > I'd consider binary data to fall into the category of domain-specific serialization.
   
   Binary data is a first-class primitive in ZooKeeper. All the setData and getData methods exchange data via byte arrays, not text. Therefore, binary data should not be considered domain-specific serialization.
   
   
   In conclusion, what you aim for seems to require a brand new tool similar to `etcdctl`. I believe it is not appropriate to implement this in this small feature PR.


;19/Aug/24 05:00;githubbot;600","ctubbsii commented on PR #2180:
URL: https://github.com/apache/zookeeper/pull/2180#issuecomment-2295812874

   @Shawyeok wrote:
   > The reality is that the zkCli tool is more of an interactive CLI tool, not designed for pipe connections.
   
   I think you misunderstood me. I agree that zkCli is interactive and not suitable for pipes. I am not suggesting zkCli be used that way (which is why I avoided using ""zkCli"" in my example). My suggestion was to provide a simpler non-interactive tool that would make it unnecessary to modify zkCli at all and still support the same use cases.
   
   > Binary data is a first-class primitive in ZooKeeper. All the setData and getData methods exchange data via byte arrays, not text. Therefore, binary data should not be considered domain-specific serialization.
   
   That's fair. I believe this to be the strongest argument in favor of adding these features to zkCli - so it can handle ZK's basic data type. That said, it has always been limited to Strings before, and users have managed to make things work without binary data in zkCli. If the alternative tool I'm suggesting did exist, there probably wouldn't be a need to add it to zkCli.
   
   > In conclusion, what you aim for seems to require a brand new tool similar to `etcdctl`. I believe it is not appropriate to implement this in this small feature PR.
   
   I'm not familiar with `etcdctl` at all. The alternative I was suggesting would be small, too (maybe even smaller than this PR... the actual ZK code is only a line or two, so most of it would be just parsing the command-line options for the connection string and client config, and dealing with the STDIN/STDOUT streams).
   
   If these changes are added to zkCli, that's fine with me. I may still pursue the alternate suggestion in the future, though, because I think there'd still be room for such a tool.


;19/Aug/24 07:03;githubbot;600","ztzg merged PR #2180:
URL: https://github.com/apache/zookeeper/pull/2180


;19/Aug/24 11:08;githubbot;600","ztzg commented on PR #2180:
URL: https://github.com/apache/zookeeper/pull/2180#issuecomment-2296329306

   Merged into `master`, `branch-3.9` and `branch-3.8`, as suggested by @eolivelli:
   
   > This is a compatible change that will be very useful to many users. I would cherry pick it to also some active branches
   
   Thanks!
   
   
   


;19/Aug/24 11:18;githubbot;600","anmolnar commented on PR #2180:
URL: https://github.com/apache/zookeeper/pull/2180#issuecomment-2359371712

   @ztzg Please don't forget to resolve the jira next time. `zk-merge-pr.py` is your friend.


;18/Sep/24 20:44;githubbot;600","ztzg commented on PR #2180:
URL: https://github.com/apache/zookeeper/pull/2180#issuecomment-2419006792

   > @ztzg Please don't forget to resolve the jira next time. `zk-merge-pr.py` is your friend.
   
   Sorry!  I usually rely on the merge script; not sure why the ticket was not closed.  I guess it refused to be my friend on that day :)


;17/Oct/24 09:18;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,7800,,,0,7800,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Sat Aug 17 18:19:11 UTC 2024,,,,,,,,,,"0|z1qwww:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"17/Aug/24 18:19;ctubbsii;I don't think this is worth it. See my comments on the PR ;;;",,,,,,,,,,,
Possible stack overflow in setup_random,ZOOKEEPER-4848,13588088,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,,kezhuw,kezhuw,07/Aug/24 06:06,29/Aug/25 21:29,08/Dec/25 08:12,18/Oct/24 01:45,3.8.4,3.9.2,,,,,,,3.10.0,3.9.4,,c client,,,,0,pull-request-available,,,"Created for https://github.com/apache/zookeeper/pull/2097.

{code:c}
        int seed_len = 0;
        /* Enter a loop to fill in seed with random data from /dev/urandom.
         * This is done in a loop so that we can safely handle short reads
         * which can happen due to signal interruptions.
         */
        while (seed_len < sizeof(seed)) {
            /* Assert we either read something or we were interrupted due to a
             * signal (errno == EINTR) in which case we need to retry.
             */
            int rc = read(fd, &seed + seed_len, sizeof(seed) - seed_len);
            assert(rc > 0 || errno == EINTR);
            if (rc > 0) {
                seed_len += rc;
            }
        }
{code}

Above code will overflow {{seed}} in case of a short read.",,"kezhuw commented on PR #2097:
URL: https://github.com/apache/zookeeper/pull/2097#issuecomment-2310339076

   @ztzg Would you mind take another look ?


;26/Aug/24 14:20;githubbot;600","kezhuw merged PR #2097:
URL: https://github.com/apache/zookeeper/pull/2097


;18/Oct/24 01:44;githubbot;600","kezhuw commented on PR #2097:
URL: https://github.com/apache/zookeeper/pull/2097#issuecomment-2421066933

   Merged! @yarthur1 Thank you for your contribution!
   
   


;18/Oct/24 01:49;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1800,,,0,1800,,,,,,,ZOOKEEPER-2311,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Oct 18 01:45:04 UTC 2024,,,,,,,,,,"0|z1qqc8:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"18/Oct/24 01:45;kezhuw;Issue resolved by pull request 2097
[https://github.com/apache/zookeeper/pull/2097];;;",,,,,,,,,,,
Failure to reload database due to missing ACL,ZOOKEEPER-4846,13587121,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Blocker,Fixed,ztzg,ztzg,ztzg,28/Jul/24 10:51,29/Aug/25 21:28,08/Dec/25 08:12,11/Feb/25 16:49,,,,,,,,,3.10.0,3.8.5,3.9.4,,,,,0,pull-request-available,,,"ZooKeeper snapshots are {_}fuzzy{_}, as the server does not stop processing requests while ACLs and nodes are being streamed to disk.

ACLs, notably, are streamed {_}first{_}, as a mapping between the full serialized ACL and an ""ACL ID"" referenced by the node.

Consequently, a snapshot can very well contain ACL IDs which do not exist in the mapping. Prior to ZOOKEEPER-4799, such situations would produce harmless (if annoying) ""Ignoring acl XYZ as it does not exist in the cache"" INFO entries in the server logs.

With ZOOKEEPER-4799, we started ""eagerly"" fetching the referenced ACLs in {{DataTree}} operations such as {{{}createNode{}}}, {{{}deleteNode{}}}, etc.—as opposed to just fetching them from request processors.

This can result in fatal errors during the {{fastForwardFromEdits}} phase of restoring a database, when transactions are processed on top of an inconsistent data tree—preventing the server from starting.

The errors are thrown in this code path:
{code:java}
// ReferenceCountedACLCache.java:90
List<ACL> acls = longKeyMap.get(longVal);
if (acls == null) {
    LOG.error(""ERROR: ACL not available for long {}"", longVal);
    throw new RuntimeException(""Failed to fetch acls for "" + longVal);
}
{code}
Here is a scenario leading to such a failure:
 * An existing node {{{}/foo{}}}, sporting an unique ACL, is deleted. This is recorded in transaction log {{{}$SNAP-1{}}}; said ACL is also deallocated;
 * Snapshot {{$SNAP}} is started;
 * The ACL map is serialized to {{{}$SNAP{}}};
 * A new node {{/foo}} sporting the same unique ACL is created in a portion of the data tree which still has to be serialized;
 * Node {{/foo}} is serialized to {{{}$SNAP{}}}—but its ACL isn't;
 * The server is restarted;
 * The {{DataTree}} is initialized from {{{}$SNAP{}}}, including node {{/foo}} with a dangling ACL reference;
 * Transaction log {{$SNAP-1}} is being replayed, leading to a {{{}deleteNode(""/foo""){}}};
 * {{getACL(node)}} panics, preventing a successful restart.",,"ztzg opened a new pull request, #2183:
URL: https://github.com/apache/zookeeper/pull/2183

   ZooKeeper snapshots are *fuzzy*, as the server does not stop processing requests while ACLs and nodes are being streamed to disk.
   
   ACLs, notably, are streamed *first*, as a mapping between the full serialized ACL and an ""ACL ID"" referenced by the node.
   
   Consequently, a snapshot can very well contain ACL IDs which do not exist in the mapping. Prior to ZOOKEEPER-4799, such situations would produce harmless (if annoying) ""Ignoring acl XYZ as it does not exist in the cache"" INFO entries in the server logs.
   
   With ZOOKEEPER-4799, we started ""eagerly"" fetching the referenced ACLs in `DataTree` operations such as `createNode`, `deleteNode`, etc.—as opposed to just fetching them from request processors.
   
   This can result in fatal errors during the `fastForwardFromEdits` phase of restoring a database, when transactions are processed on top of an inconsistent data tree—preventing the server from starting.
   
   The errors are thrown in this code path:
   
   ``` java
   // ReferenceCountedACLCache.java:90
   List<ACL> acls = longKeyMap.get(longVal);
   if (acls == null) {
       LOG.error(""ERROR: ACL not available for long {}"", longVal);
       throw new RuntimeException(""Failed to fetch acls for "" + longVal);
   }
   ```
   
   Here is a scenario leading to such a failure:
   
   - An existing node `/foo`, sporting an unique ACL, is deleted. This is recorded in transaction log `$SNAP-1`; said ACL is also deallocated;
   - Snapshot `$SNAP` is started;
   - The ACL map is serialized to `$SNAP`;
   - A new node `/foo` sporting the same unique ACL is created in a portion of the data tree which still has to be serialized;
   - Node `/foo` is serialized to `$SNAP`—but its ACL isn't;
   - The server is restarted;
   - The `DataTree` is initialized from `$SNAP`, including node `/foo` with a dangling ACL reference;
   - Transaction log `$SNAP-1` is being replayed, leading to a `deleteNode(""/foo"")`;
   - `getACL(node)` panics.
   


;28/Aug/24 12:10;githubbot;600","anmolnar commented on PR #2183:
URL: https://github.com/apache/zookeeper/pull/2183#issuecomment-2638033144

   hi @ztzg , are u still working on this patch?
   


;05/Feb/25 21:12;githubbot;600","ztzg commented on PR #2183:
URL: https://github.com/apache/zookeeper/pull/2183#issuecomment-2639396703

   Hi @anmolnar,
   
   > hi @ztzg , are u still working on this patch?
   
   We have been using it for a while without adverse effects.  I am not working on it, but some decisions in the patch are perhaps a bit controversial. I will ""undraft"" if it helps getting more reviews & comments :)


;06/Feb/25 10:18;githubbot;600","anmolnar commented on PR #2183:
URL: https://github.com/apache/zookeeper/pull/2183#issuecomment-2641341655

   I've found the soluton. PTAL my comment in the Jira:
   
   https://issues.apache.org/jira/browse/ZOOKEEPER-4846?focusedCommentId=17924725&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17924725
   


;06/Feb/25 23:25;githubbot;600","anmolnar opened a new pull request, #2222:
URL: https://github.com/apache/zookeeper/pull/2222

   In the scenario when ZooKeeper restore from fuzzy snapshot, there's possibility that we have a znode in the snapshot, but the attached ACL is missing from the ACL cache. In this case ZK will fast forward to the createTxn and replays is and while we skip re-creating the existing znode, we have a chance to fix the potentially wrong ACL reference.


;07/Feb/25 21:23;githubbot;600","anmolnar commented on PR #2183:
URL: https://github.com/apache/zookeeper/pull/2183#issuecomment-2644155384

   Apols @ztzg , I quickly created the alternate patch to get feedback as soon as possible: #2222 
   Don't wanna take the credit, so we should commit as yours eventually once we have agreement.


;07/Feb/25 21:24;githubbot;600","anmolnar commented on PR #2222:
URL: https://github.com/apache/zookeeper/pull/2222#issuecomment-2644156194

   ping @ztzg @cnauroth 


;07/Feb/25 21:25;githubbot;600","ztzg commented on code in PR #2222:
URL: https://github.com/apache/zookeeper/pull/2222#discussion_r1950277286


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/DataTree.java:
##########
@@ -462,8 +462,9 @@ public void createNode(final String path, byte[] data, List<ACL> acl, long ephem
             // we did for the global sessions.
             Long acls = aclCache.convertAcls(acl);
 
-            Set<String> children = parent.getChildren();
-            if (children.contains(childName)) {
+            DataNode existingChild = nodes.get(path);
+            if (existingChild != null) {
+                existingChild.acl = acls;

Review Comment:
   I have not had a chance to play with this, but: this means we are relying on `PrepRequestProcessor` to prevent `OpCode.create*` operations from being abused as `OpCode.setACL`, right? (Just thinking out loud.)



;11/Feb/25 06:10;githubbot;600","anmolnar commented on code in PR #2222:
URL: https://github.com/apache/zookeeper/pull/2222#discussion_r1951123453


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/DataTree.java:
##########
@@ -462,8 +462,9 @@ public void createNode(final String path, byte[] data, List<ACL> acl, long ephem
             // we did for the global sessions.
             Long acls = aclCache.convertAcls(acl);
 
-            Set<String> children = parent.getChildren();
-            if (children.contains(childName)) {
+            DataNode existingChild = nodes.get(path);
+            if (existingChild != null) {
+                existingChild.acl = acls;

Review Comment:
   I'm not sure to be honest and not sure if I understand your question.



;11/Feb/25 15:58;githubbot;600","anmolnar merged PR #2222:
URL: https://github.com/apache/zookeeper/pull/2222


;11/Feb/25 16:43;githubbot;600","anmolnar closed pull request #2183: ZOOKEEPER-4846: Failure to reload database due to missing ACL
URL: https://github.com/apache/zookeeper/pull/2183


;11/Feb/25 16:49;githubbot;600","anmolnar commented on PR #2183:
URL: https://github.com/apache/zookeeper/pull/2183#issuecomment-2651428917

   Superseded by #2222 


;11/Feb/25 16:49;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,7200,,,0,7200,,,,,,,,,,ZOOKEEPER-4874,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Tue Feb 11 16:49:08 UTC 2025,,,,,,,,,,"0|z1qkdc:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"06/Feb/25 19:49;andor;Example stack trace.
{noformat}
2025-02-05 16:07:20,312 ERROR org.apache.zookeeper.server.ZooKeeperServerMain: Unexpected exception, exiting abnormally
java.lang.RuntimeException: Failed to fetch acls for 7382
        at org.apache.zookeeper.server.ReferenceCountedACLCache.convertLong(ReferenceCountedACLCache.java:93)
        at org.apache.zookeeper.server.DataTree.getACL(DataTree.java:801)
        at org.apache.zookeeper.server.DataTree.createNode(DataTree.java:455)
        at org.apache.zookeeper.server.DataTree.processTxn(DataTree.java:881)
        at org.apache.zookeeper.server.DataTree.processTxn(DataTree.java:864)
        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.processTransaction(FileTxnSnapLog.java:442)
        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.fastForwardFromEdits(FileTxnSnapLog.java:350)
        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.lambda$restore$0(FileTxnSnapLog.java:267)
        at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:312)
        at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:285)
        at org.apache.zookeeper.server.ZooKeeperServer.loadData(ZooKeeperServer.java:531)
        at org.apache.zookeeper.server.ZooKeeperServer.startdata(ZooKeeperServer.java:704)
        at org.apache.zookeeper.server.NettyServerCnxnFactory.startup(NettyServerCnxnFactory.java:745)
        at org.apache.zookeeper.server.ServerCnxnFactory.startup(ServerCnxnFactory.java:130)
        at org.apache.zookeeper.server.ZooKeeperServerMain.runFromConfig(ZooKeeperServerMain.java:161)
        at org.apache.zookeeper.server.ZooKeeperServerMain.initializeAndRun(ZooKeeperServerMain.java:113)
        at org.apache.zookeeper.server.ZooKeeperServerMain.main(ZooKeeperServerMain.java:68)
        at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:141)
        at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:91){noformat}
It indicates that problem happens when trying to execute createTxn a znode whose *parent* doesn't have a valid ACL.;;;","06/Feb/25 23:21;andor;Found a solution. It's super simple. ZooKeeper actually doesn't lose that txn gap, it's in the previous logfile and it iterates over it.

Look at this log snippet: 
{noformat}
2025-02-06 17:12:40,818 [myid:] - INFO  [main:FileSnap@85] - Reading snapshot /home/andor/tmp/zookeeper/version-2/snapshot.674c0
2025-02-06 17:12:40,845 [myid:] - INFO  [main:ReferenceCountedACLCache@174] - Ignoring acl 7382 as it does not exist in the cache
2025-02-06 17:12:40,847 [myid:] - INFO  [main:DataTree@1719] - The digest in the snapshot has digest version of 2, with zxid as 0x674c1, and digest value as 8282470946294
2025-02-06 17:12:40,858 [myid:] - INFO  [main:FileTxnLog$FileTxnIterator@693] - Going to next log file /home/andor/tmp/zookeeper/version-2/log.5a1df
2025-02-06 17:12:40,924 [myid:] - INFO  [main:FileTxnSnapLog@351] - Processing zxid 0x674c1: 0x674c1
2025-02-06 17:12:40,924 [myid:] - INFO  [main:DataTree@469] - Creating node /cloudera_manager_zookeeper_canary with acl 6
2025-02-06 17:12:40,928 [myid:] - INFO  [main:FileTxnLog$FileTxnIterator@693] - Going to next log file /home/andor/tmp/zookeeper/version-2/log.674c2
2025-02-06 17:12:40,928 [myid:] - INFO  [main:FileTxnSnapLog@351] - Processing zxid 0x674c2: 0x674c2
2025-02-06 17:12:40,928 [myid:] - INFO  [main:FileTxnSnapLog@351] - Processing zxid 0x674c3: 0x674c3
2025-02-06 17:12:40,929 [myid:] - ERROR [main:ReferenceCountedACLCache@92] - ERROR: ACL not available for long 7382
2025-02-06 17:12:40,929 [myid:] - ERROR [main:ZooKeeperServerMain@91] - Unexpected exception, exiting abnormally
java.lang.RuntimeException: Failed to fetch acls for 7382
        at org.apache.zookeeper.server.ReferenceCountedACLCache.convertLong(ReferenceCountedACLCache.java:93)
{noformat}
Snapshot zxid is {*}0x674c0{*}, so ZK goes to txn logfile *0x5a1df* first and fast forward to txn zxid {*}0x674c1{*}, so actually processing the txn where the parent znode was created. Clearly the ACL id is different in the cache and the data tree: 6 <> 7382

Look at the code where we process the txn:
{code:java}
synchronized (parent) {
    parentAcl = getACL(parent);    // Add the ACL to ACL cache first, to avoid the ACL not being
    // created race condition during fuzzy snapshot sync.
    //
    // This is the simplest fix, which may add ACL reference count
    // again if it's already counted in in the ACL map of fuzzy
    // snapshot, which might also happen for deleteNode txn, but
    // at least it won't cause the ACL not exist issue.
    //
    // Later we can audit and delete all non-referenced ACLs from
    // ACL map when loading the snapshot/txns from disk, like what
    // we did for the global sessions.
    Long longval = aclCache.convertAcls(acl);   <---- we re-create the ACL in the ACL cache, but potentially with different id             
    Set<String> children = parent.getChildren();
    if (children.contains(childName)) {
        throw new KeeperException.NodeExistsException();    <---- znode already exists in DataTree, so we skip
    }
...  {code}
The only thing that we need to do here is to get a reference to the existing znode and fix the ACL reference.
{code:java}
if (children.contains(childName)) {
    DataNode child = nodes.get(path);
    child.acl = longval;
    throw new KeeperException.NodeExistsException();
} {code}
or maybe something more elegant.

We don't lose the ACL information.;;;","07/Feb/25 16:36;cnauroth;[~andor] , nice, I think that makes sense!;;;","11/Feb/25 16:49;andor;Issue resolved by pull request 2222
[https://github.com/apache/zookeeper/pull/2222];;;",,,,,,,,
Encountering an 'Unreasonable Length' error when configuring jute.maxbuffer to 1GB or more,ZOOKEEPER-4843,13584819,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,arshad.mohammad,arshad.mohammad,arshad.mohammad,05/Jul/24 11:56,24/Oct/24 20:09,08/Dec/25 08:12,20/Sep/24 18:49,3.8.4,3.9.2,,,,,,,3.10.0,3.8.5,3.9.3,,,,,0,pull-request-available,,,"*Problem:*
Encountering an 'Unreasonable Length' error when configuring jute.maxbuffer to 1GB or more
{code:java}
2024-07-04 11:55:41,806 [myid:localhost:2181] - WARN  [main-SendThread(localhost:2181):o.a.z.ClientCnxn$SendThread@1300] - Session 0x0 for server localhost/127.0.0.1:2181, Closing socket connection.
Attempting reconnect except it is a SessionExpiredException.
java.io.IOException: Unreasonable length = 16
        at org.apache.jute.BinaryInputArchive.checkLength(BinaryInputArchive.java:166)
        at org.apache.jute.BinaryInputArchive.readBuffer(BinaryInputArchive.java:127)
        at org.apache.zookeeper.proto.ConnectResponse.deserialize(ConnectResponse.java:80)
        at org.apache.zookeeper.ClientCnxnSocket.readConnectResult(ClientCnxnSocket.java:141)
        at org.apache.zookeeper.ClientCnxnSocketNIO.doIO(ClientCnxnSocketNIO.java:86)
        at org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:350)
        at org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1289)
2024-07-04 11:55:42,567 [myid:] - INFO  [main:o.a.z.u.ServiceUtils@45] - Exiting JVM with code 0
{code}

*Analysis:*
If jute.maxbuffer is set to 1GB (equivalent to 1073741824 bytes), this means that both maxBufferSize and extraMaxBufferSize are also set to 1073741824.
Even when the response size (denoted as 'len') is minimal, the following condition check still fails:
{code:java}
if (len < 0 || len > maxBufferSize + extraMaxBufferSize) {
    throw new IOException(UNREASONBLE_LENGTH + len);
}
{code}
It is because (maxBufferSize + extraMaxBufferSize) overflow int MAX_VALUE and the result is a negative number.

*Solution:*
Configure jute.maxbuffer.extrasize explicitly and give a reasonable value, so that the sum of maxBufferSize and extraMaxBufferSize is less than Integer.MAX_VALUE.

*Improvement:*
While setting jute.maxbuffer to 1GB may seem unreasonable, it would be better to validate the maxBuffer and extraMaxBufferSize configuration.
If the sum of these two values is greater than Integer.MAX_VALUE, it should be handled gracefully by setting the sum to Integer.MAX_VALUE


",,"arshadmohammad opened a new pull request, #2175:
URL: https://github.com/apache/zookeeper/pull/2175

   This jira is related to ZOOKEEPER-3496: Transaction larger than jute.maxbuffer makes ZooKeeper service unavailable


;05/Jul/24 18:25;githubbot;600","frederiko commented on PR #2175:
URL: https://github.com/apache/zookeeper/pull/2175#issuecomment-2299272065

   Just out of curiosity: isn't that what's expected per https://zookeeper.apache.org/doc/r3.6.2/zookeeperAdmin.html#Unsafe+Options ? 
   Which indicates a mismatch of values in the client vs server side JVM configuration?


;20/Aug/24 16:28;githubbot;600","anmolnar commented on PR #2175:
URL: https://github.com/apache/zookeeper/pull/2175#issuecomment-2364123134

   @kezhuw @eolivelli @ztzg @li4wang PTAL.
   
   I'd like to get this in both 3.8 and 3.9. 


;20/Sep/24 16:45;githubbot;600","anmolnar merged PR #2175:
URL: https://github.com/apache/zookeeper/pull/2175


;20/Sep/24 18:15;githubbot;600","anmolnar commented on PR #2175:
URL: https://github.com/apache/zookeeper/pull/2175#issuecomment-2364282908

   @arshadmohammad 
   
   Cherry-pick is not clean to `branch-3.8`. Would you please create another PR for that?


;20/Sep/24 18:19;githubbot;600","arshadmohammad commented on PR #2175:
URL: https://github.com/apache/zookeeper/pull/2175#issuecomment-2377449837

   Thanks @anmolnar @kezhuw @frederiko for reviewing and merging this PR. 
   sure, I will raise PR for branch-3.8


;26/Sep/24 16:41;githubbot;600","arshadmohammad opened a new pull request, #2191:
URL: https://github.com/apache/zookeeper/pull/2191

   This is a branch-3.8 specific pull request for the original PR: https://github.com/apache/zookeeper/pull/2175


;26/Sep/24 17:00;githubbot;600","anmolnar merged PR #2191:
URL: https://github.com/apache/zookeeper/pull/2191


;26/Sep/24 21:24;githubbot;600","anmolnar commented on PR #2191:
URL: https://github.com/apache/zookeeper/pull/2191#issuecomment-2377966855

   Merged. Thanks @arshadmohammad !


;26/Sep/24 21:25;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,5400,,,0,5400,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Sep 20 16:34:42 UTC 2024,,,,,,,,,,"0|z1q668:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"20/Sep/24 16:25;andor;[~arshad.mohammad] 
{quote}If jute.maxbuffer is set to 1GB (equivalent to 1073741824 bytes), this means that both maxBufferSize and extraMaxBufferSize are also set to 1073741824.
{quote}
Why do you say that?

These're 2 different and independent settings. If I set jute.maxbuffer to 1GB only, extraMaxBufferSize will be the default value 1,024. Is that correct?;;;","20/Sep/24 16:34;andor;[~arshad.mohammad] 

Ignore my previous comment, I see it now:
{noformat}
final Integer configuredExtraMaxBuffer =
    Integer.getInteger(""zookeeper.jute.maxbuffer.extrasize"", maxBuffer);
{noformat}
Let me commit your fix, thank you.

 ;;;",,,,,,,,,,
"When DigestMD5 is used to enable mandatory client authentication,Users that do not exist can log in",ZOOKEEPER-4839,13582975,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,luoxin,wstcjmg,wstcjmg,18/Jun/24 03:27,24/Oct/24 20:09,08/Dec/25 08:12,25/Sep/24 00:47,3.5.10,3.9.2,,,,,,,3.10.0,3.9.3,,security,server,,,0,pull-request-available,,,"When DigestMD5 is used to enable mandatory client authentication. Consider the following scenario: After successfully logging in with the correct user and password for the first time, change the user to keep the correct password for the last time, and you can still log in normally. I looked at both versions 3.5.10 and 3.9.2. See the class SaslServerCallbackHandler server-side code. A global private variable called userName is defined, but in the handleNameCallback method, if the given user name is not configured, it simply returns without updating userName. This results in the handlePasswordCallback method still using the userName of the last successful login to retrieve, and naturally can find the last password, and the comparison is correct.",,"luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2227632688

   @maoling Can you take a look on this fix


;15/Jul/24 03:10;githubbot;600","kezhuw commented on code in PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#discussion_r1704913717


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/auth/SaslServerCallbackHandler.java:
##########
@@ -90,6 +90,11 @@ private void handleNameCallback(NameCallback nc) {
         // check to see if this user is in the user password database.
         if (credentials.get(nc.getDefaultName()) == null) {
             LOG.warn(""User '{}' not found in list of DIGEST-MD5 authenticateable users."", nc.getDefaultName());
+            // ZOOKEEPER-4839
+            // Incorrect usernames also need to be stored
+            // in order to clear the usernames of previously
+            // successfully logged-in users.
+            userName = nc.getDefaultName();

Review Comment:
   I saw one `SaslServerCallbackHandler` was shared among multiple concurrent `ServerCnxn`s. I think we probably should resort to some form of copy/clone to not share mutable state among multiple `ServerCnxn`s.
   
   This applies to `SaslQuorumServerCallbackHandler` too.



##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/auth/SaslServerCallbackHandlerTest.java:
##########
@@ -0,0 +1,43 @@
+package org.apache.zookeeper.server.auth;
+
+import static org.mockito.ArgumentMatchers.eq;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.times;
+import static org.mockito.Mockito.verify;
+import static org.mockito.Mockito.when;
+import java.io.IOException;
+import java.util.HashMap;
+import java.util.Map;
+import javax.security.auth.callback.Callback;
+import javax.security.auth.callback.NameCallback;
+import javax.security.auth.callback.PasswordCallback;
+import javax.security.auth.callback.UnsupportedCallbackException;
+import javax.security.auth.login.AppConfigurationEntry;
+import javax.security.auth.login.AppConfigurationEntry.LoginModuleControlFlag;
+import javax.security.auth.login.Configuration;
+import org.junit.Test;
+
+public class SaslServerCallbackHandlerTest {
+
+    @Test
+    public void wrongUserNameShouldClearUserCredential() throws IOException, UnsupportedCallbackException {
+        Configuration configuration = mock(Configuration.class);
+        Map<String, String> userCredentials = new HashMap<>();
+        userCredentials.put(""user_exist_user"", ""password"");
+        AppConfigurationEntry appConfigurationEntry = new AppConfigurationEntry(""test-module"", LoginModuleControlFlag.REQUIRED, userCredentials);
+        when(configuration.getAppConfigurationEntry(""Server"")).thenReturn(new AppConfigurationEntry[]{appConfigurationEntry});

Review Comment:
   It would be nice to avoid mock. I saw multiple ""Sasl*Test"". I think they might be helpful.



;06/Aug/24 05:18;githubbot;600","luoxiner commented on code in PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#discussion_r1706551114


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/auth/SaslServerCallbackHandler.java:
##########
@@ -90,6 +90,11 @@ private void handleNameCallback(NameCallback nc) {
         // check to see if this user is in the user password database.
         if (credentials.get(nc.getDefaultName()) == null) {
             LOG.warn(""User '{}' not found in list of DIGEST-MD5 authenticateable users."", nc.getDefaultName());
+            // ZOOKEEPER-4839
+            // Incorrect usernames also need to be stored
+            // in order to clear the usernames of previously
+            // successfully logged-in users.
+            userName = nc.getDefaultName();

Review Comment:
   Thank you for your review. I have some ideas about your comments.
   
   1. It would be better for the `Login` to store a factory object that can supply `SaslServerCallbackHandler`, in order to avoid the `SaslServerCallbackHandler` being shared among multiple concurrent `ServerCnxn`s.
   2. We should apply the change to the `SaslQuorumServerCallbackHandler`.
   
   Is it correct?



;07/Aug/24 07:52;githubbot;600","luoxiner commented on code in PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#discussion_r1706552769


##########
zookeeper-server/src/test/java/org/apache/zookeeper/server/auth/SaslServerCallbackHandlerTest.java:
##########
@@ -0,0 +1,43 @@
+package org.apache.zookeeper.server.auth;
+
+import static org.mockito.ArgumentMatchers.eq;
+import static org.mockito.Mockito.mock;
+import static org.mockito.Mockito.times;
+import static org.mockito.Mockito.verify;
+import static org.mockito.Mockito.when;
+import java.io.IOException;
+import java.util.HashMap;
+import java.util.Map;
+import javax.security.auth.callback.Callback;
+import javax.security.auth.callback.NameCallback;
+import javax.security.auth.callback.PasswordCallback;
+import javax.security.auth.callback.UnsupportedCallbackException;
+import javax.security.auth.login.AppConfigurationEntry;
+import javax.security.auth.login.AppConfigurationEntry.LoginModuleControlFlag;
+import javax.security.auth.login.Configuration;
+import org.junit.Test;
+
+public class SaslServerCallbackHandlerTest {
+
+    @Test
+    public void wrongUserNameShouldClearUserCredential() throws IOException, UnsupportedCallbackException {
+        Configuration configuration = mock(Configuration.class);
+        Map<String, String> userCredentials = new HashMap<>();
+        userCredentials.put(""user_exist_user"", ""password"");
+        AppConfigurationEntry appConfigurationEntry = new AppConfigurationEntry(""test-module"", LoginModuleControlFlag.REQUIRED, userCredentials);
+        when(configuration.getAppConfigurationEntry(""Server"")).thenReturn(new AppConfigurationEntry[]{appConfigurationEntry});

Review Comment:
   I'll give it a try.



;07/Aug/24 07:53;githubbot;600","kezhuw commented on code in PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#discussion_r1706693861


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/auth/SaslServerCallbackHandler.java:
##########
@@ -90,6 +90,11 @@ private void handleNameCallback(NameCallback nc) {
         // check to see if this user is in the user password database.
         if (credentials.get(nc.getDefaultName()) == null) {
             LOG.warn(""User '{}' not found in list of DIGEST-MD5 authenticateable users."", nc.getDefaultName());
+            // ZOOKEEPER-4839
+            // Incorrect usernames also need to be stored
+            // in order to clear the usernames of previously
+            // successfully logged-in users.
+            userName = nc.getDefaultName();

Review Comment:
   Sounds viable to me.



;07/Aug/24 09:31;githubbot;600","luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2330529339

   Hi, @kezhuw 
   I push a new commit to resolve the CallbackHandler shared in multiple connections, can you give me some feed backs.


;05/Sep/24 03:35;githubbot;600","kezhuw commented on code in PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#discussion_r1746588998


##########
zookeeper-server/src/main/java/org/apache/zookeeper/util/SecurityUtils.java:
##########
@@ -36,10 +42,14 @@
 import org.ietf.jgss.GSSName;
 import org.ietf.jgss.Oid;
 import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
 
 public final class SecurityUtils {
 
+    private static final Logger LOG = LoggerFactory.getLogger(SecurityUtils.class);
+
     public static final String QUORUM_HOSTNAME_PATTERN = ""_HOST"";
+    private static final String USER_PREFIX = ""user_"";

Review Comment:
   How about `DIGEST_MD5_USER_PREFIX` ?



##########
zookeeper-server/src/main/java/org/apache/zookeeper/util/SecurityUtils.java:
##########
@@ -254,15 +264,67 @@ public SaslServer run() {
         return null;
     }
 
+    /**
+     * get specific section from configuration or thrown
+     * an IOException when no section exists in configuration
+     *
+     * @param configuration Configuration instance
+     * @param section section name
+     * @return AppConfigurationEntry list
+     */
+    public static AppConfigurationEntry[] getAppConfigurationEntryWithSection(Configuration configuration, String section) throws IOException {
+        AppConfigurationEntry[] configurationEntries = configuration.getAppConfigurationEntry(section);
+        if (configurationEntries == null) {
+            String errorMessage = ""Could not find a '"" + section + ""' entry in this configuration: Server cannot start."";
+            LOG.error(errorMessage);
+            throw new IOException(errorMessage);
+        }
+        return configurationEntries;
+    }
+
+
+     /**
+     * make server credentials map from configuration's server section.
+     * @param configuration Configuration instance
+     * @return Server credentials map
+     */
+    public static Map<String, String> getServerCredentials(Configuration configuration) throws IOException {

Review Comment:
   How about naming it ""getDigestMd5Credentials"" ?



##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/SaslAuthRequiredMultiClientTest.java:
##########
@@ -0,0 +1,102 @@
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import static org.junit.jupiter.api.Assertions.fail;
+import javax.security.auth.login.Configuration;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.KeeperException;
+import org.apache.zookeeper.ZooDefs.Ids;
+import org.apache.zookeeper.ZooKeeper;
+import org.junit.jupiter.api.AfterAll;
+import org.junit.jupiter.api.BeforeAll;
+import org.junit.jupiter.api.Test;
+
+public class SaslAuthRequiredMultiClientTest extends ClientBase {
+
+    @BeforeAll
+    public static void setUpBeforeClass() {
+        System.setProperty(SaslTestUtil.requireSASLAuthProperty, ""true"");
+        System.setProperty(SaslTestUtil.authProviderProperty, SaslTestUtil.authProvider);
+        System.setProperty(SaslTestUtil.jaasConfig, SaslTestUtil.createJAASConfigFile(""jaas.conf"", ""test""));
+    }
+
+    @AfterAll
+    public static void tearDownAfterClass() {
+        System.clearProperty(SaslTestUtil.requireSASLAuthProperty);
+        System.clearProperty(SaslTestUtil.authProviderProperty);
+        System.clearProperty(SaslTestUtil.jaasConfig);
+    }
+
+    @Test
+    public void testClientOpWithInvalidSASLUserAuthAfterSuccessLogin() throws Exception {
+        resetJaasConfiguration(""jaas.conf"", ""super"", ""test"");
+        ZooKeeper zk = null;
+        CountdownWatcher watcher = new CountdownWatcher();
+        try {
+            zk = createClient(watcher);
+            zk.create(""/foobar"", null, Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);
+        } catch (KeeperException e) {
+            fail(""Client operation should succeed with valid SASL configuration."");
+        } finally {
+            if (zk != null) {
+                zk.close();
+            }
+        }

Review Comment:
   ```suggestion
           try  (ZooKeeper zk = createClient()) {
               zk.create(""/foobar"", null, Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);
           } catch (KeeperException e) {
               fail(""Client operation should succeed with valid SASL configuration."");
           }
   ```
   
   Much of ZooKeeper codes are written in decade ago. I think we can avoid old style in new age.



##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/SaslAuthRequiredMultiClientTest.java:
##########
@@ -0,0 +1,102 @@
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import static org.junit.jupiter.api.Assertions.fail;
+import javax.security.auth.login.Configuration;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.KeeperException;
+import org.apache.zookeeper.ZooDefs.Ids;
+import org.apache.zookeeper.ZooKeeper;
+import org.junit.jupiter.api.AfterAll;
+import org.junit.jupiter.api.BeforeAll;
+import org.junit.jupiter.api.Test;
+
+public class SaslAuthRequiredMultiClientTest extends ClientBase {
+
+    @BeforeAll
+    public static void setUpBeforeClass() {
+        System.setProperty(SaslTestUtil.requireSASLAuthProperty, ""true"");
+        System.setProperty(SaslTestUtil.authProviderProperty, SaslTestUtil.authProvider);
+        System.setProperty(SaslTestUtil.jaasConfig, SaslTestUtil.createJAASConfigFile(""jaas.conf"", ""test""));
+    }
+
+    @AfterAll
+    public static void tearDownAfterClass() {
+        System.clearProperty(SaslTestUtil.requireSASLAuthProperty);
+        System.clearProperty(SaslTestUtil.authProviderProperty);
+        System.clearProperty(SaslTestUtil.jaasConfig);
+    }
+
+    @Test
+    public void testClientOpWithInvalidSASLUserAuthAfterSuccessLogin() throws Exception {
+        resetJaasConfiguration(""jaas.conf"", ""super"", ""test"");
+        ZooKeeper zk = null;
+        CountdownWatcher watcher = new CountdownWatcher();
+        try {
+            zk = createClient(watcher);
+            zk.create(""/foobar"", null, Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);
+        } catch (KeeperException e) {
+            fail(""Client operation should succeed with valid SASL configuration."");
+        } finally {
+            if (zk != null) {
+                zk.close();
+            }
+        }
+
+        resetJaasConfiguration(""jaas.conf"", ""super_wrong"", ""test"");
+        ZooKeeper wrongUserZk = null;
+        CountdownWatcher wrongUserZkWatch = new CountdownWatcher();
+        try {
+            wrongUserZk = createClient(wrongUserZkWatch);
+            wrongUserZk.create(""/bar"", null, Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);
+            fail(""Client with wrong SASL config should not pass SASL authentication."");
+        } catch (KeeperException e) {
+            assertTrue(e.code() == KeeperException.Code.AUTHFAILED);

Review Comment:
   ```suggestion
               assertEquals(KeeperException.Code.AUTHFAILED, e.code());
   ```



##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/SaslAuthRequiredMultiClientTest.java:
##########
@@ -0,0 +1,102 @@
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import static org.junit.jupiter.api.Assertions.fail;
+import javax.security.auth.login.Configuration;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.KeeperException;
+import org.apache.zookeeper.ZooDefs.Ids;
+import org.apache.zookeeper.ZooKeeper;
+import org.junit.jupiter.api.AfterAll;
+import org.junit.jupiter.api.BeforeAll;
+import org.junit.jupiter.api.Test;
+
+public class SaslAuthRequiredMultiClientTest extends ClientBase {
+
+    @BeforeAll
+    public static void setUpBeforeClass() {
+        System.setProperty(SaslTestUtil.requireSASLAuthProperty, ""true"");
+        System.setProperty(SaslTestUtil.authProviderProperty, SaslTestUtil.authProvider);
+        System.setProperty(SaslTestUtil.jaasConfig, SaslTestUtil.createJAASConfigFile(""jaas.conf"", ""test""));
+    }
+
+    @AfterAll
+    public static void tearDownAfterClass() {
+        System.clearProperty(SaslTestUtil.requireSASLAuthProperty);
+        System.clearProperty(SaslTestUtil.authProviderProperty);
+        System.clearProperty(SaslTestUtil.jaasConfig);
+    }
+
+    @Test
+    public void testClientOpWithInvalidSASLUserAuthAfterSuccessLogin() throws Exception {
+        resetJaasConfiguration(""jaas.conf"", ""super"", ""test"");
+        ZooKeeper zk = null;
+        CountdownWatcher watcher = new CountdownWatcher();
+        try {
+            zk = createClient(watcher);
+            zk.create(""/foobar"", null, Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);
+        } catch (KeeperException e) {
+            fail(""Client operation should succeed with valid SASL configuration."");
+        } finally {
+            if (zk != null) {
+                zk.close();
+            }
+        }
+
+        resetJaasConfiguration(""jaas.conf"", ""super_wrong"", ""test"");
+        ZooKeeper wrongUserZk = null;
+        CountdownWatcher wrongUserZkWatch = new CountdownWatcher();
+        try {
+            wrongUserZk = createClient(wrongUserZkWatch);
+            wrongUserZk.create(""/bar"", null, Ids.CREATOR_ALL_ACL, CreateMode.PERSISTENT);
+            fail(""Client with wrong SASL config should not pass SASL authentication."");
+        } catch (KeeperException e) {
+            assertTrue(e.code() == KeeperException.Code.AUTHFAILED);
+            // Verify that ""eventually"" this client closes the connection between itself and the server.
+            watcher.waitForDisconnected(SaslTestUtil.CLIENT_DISCONNECT_TIMEOUT);

Review Comment:
   I think we can eliminate this as it is covered by other tests.



##########
zookeeper-server/src/main/java/org/apache/zookeeper/util/SecurityUtils.java:
##########
@@ -254,15 +264,67 @@ public SaslServer run() {
         return null;
     }
 
+    /**
+     * get specific section from configuration or thrown
+     * an IOException when no section exists in configuration
+     *
+     * @param configuration Configuration instance
+     * @param section section name
+     * @return AppConfigurationEntry list
+     */
+    public static AppConfigurationEntry[] getAppConfigurationEntryWithSection(Configuration configuration, String section) throws IOException {
+        AppConfigurationEntry[] configurationEntries = configuration.getAppConfigurationEntry(section);
+        if (configurationEntries == null) {
+            String errorMessage = ""Could not find a '"" + section + ""' entry in this configuration: Server cannot start."";
+            LOG.error(errorMessage);
+            throw new IOException(errorMessage);
+        }
+        return configurationEntries;
+    }
+
+
+     /**
+     * make server credentials map from configuration's server section.
+     * @param configuration Configuration instance
+     * @return Server credentials map
+     */
+    public static Map<String, String> getServerCredentials(Configuration configuration) throws IOException {
+        AppConfigurationEntry[] serverAppConfigurationEntry = getServerAppConfigurationEntry(configuration);
+        Map<String, String> credentials = new HashMap<>();
+        for (AppConfigurationEntry entry : serverAppConfigurationEntry) {
+            Map<String, ?> options = entry.getOptions();
+            // Populate DIGEST-MD5 user -> password map with JAAS configuration entries from the ""Server"" section.

Review Comment:
   backlog: I suspect we should do similar to ZOOKEEPER-4753(https://github.com/apache/zookeeper/commit/e2070bed85d8b0c98a5a0045bf92421f473c412e#diff-04a0c58edb7731a3998fcaa021b8e2190d8c3947dfc87606bfe8f5a0e9423434R71) here, but this should be a separate issue.



##########
zookeeper-server/src/main/java/org/apache/zookeeper/util/SecurityUtils.java:
##########
@@ -55,12 +65,12 @@ public final class SecurityUtils {
      * @throws SaslException
      */
     public static SaslClient createSaslClient(
-        final Subject subject,
-        final String servicePrincipal,
-        final String protocol,
-        final String serverName,
-        final Logger LOG,
-        final String entity) throws SaslException {
+            final Subject subject,
+            final String servicePrincipal,
+            final String protocol,
+            final String serverName,
+            final Logger LOG,
+            final String entity) throws SaslException {

Review Comment:
   It is better to not reformat unrelated code. Same as other places.



;10/Sep/24 00:45;githubbot;600","luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2345427276

   Hi, @kezhuw


;12/Sep/24 07:01;githubbot;600","luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2345430926

   @kezhuw, thanks for your review. I will take a look and push a new commit later.


;12/Sep/24 07:03;githubbot;600","luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2348573923

   Hi, @kezhuw. I push a new commit to improve the codes with your suggestions. Can you take a look.


;13/Sep/24 10:12;githubbot;600","luoxiner commented on code in PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#discussion_r1758593177


##########
zookeeper-server/src/main/java/org/apache/zookeeper/util/SecurityUtils.java:
##########
@@ -254,15 +264,67 @@ public SaslServer run() {
         return null;
     }
 
+    /**
+     * get specific section from configuration or thrown
+     * an IOException when no section exists in configuration
+     *
+     * @param configuration Configuration instance
+     * @param section section name
+     * @return AppConfigurationEntry list
+     */
+    public static AppConfigurationEntry[] getAppConfigurationEntryWithSection(Configuration configuration, String section) throws IOException {
+        AppConfigurationEntry[] configurationEntries = configuration.getAppConfigurationEntry(section);
+        if (configurationEntries == null) {
+            String errorMessage = ""Could not find a '"" + section + ""' entry in this configuration: Server cannot start."";
+            LOG.error(errorMessage);
+            throw new IOException(errorMessage);
+        }
+        return configurationEntries;
+    }
+
+
+     /**
+     * make server credentials map from configuration's server section.
+     * @param configuration Configuration instance
+     * @return Server credentials map
+     */
+    public static Map<String, String> getServerCredentials(Configuration configuration) throws IOException {
+        AppConfigurationEntry[] serverAppConfigurationEntry = getServerAppConfigurationEntry(configuration);
+        Map<String, String> credentials = new HashMap<>();
+        for (AppConfigurationEntry entry : serverAppConfigurationEntry) {
+            Map<String, ?> options = entry.getOptions();
+            // Populate DIGEST-MD5 user -> password map with JAAS configuration entries from the ""Server"" section.

Review Comment:
   I will make a new pull request to resolve it.



;13/Sep/24 10:13;githubbot;600","kezhuw commented on code in PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#discussion_r1758876160


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/auth/SaslQuorumAuthLearner.java:
##########
@@ -62,9 +64,13 @@ public SaslQuorumAuthLearner(
                     ""SASL-authentication failed because the specified JAAS configuration section '%s' could not be found."",
                     loginContext));
             }
+
+            Supplier<CallbackHandler> callBackSupplier = () -> {
+                return new SaslClientCallbackHandler(null, ""QuorumLearner"");
+            };
             this.learnerLogin = new Login(
                 loginContext,
-                new SaslClientCallbackHandler(null, ""QuorumLearner""),
+                callBackSupplier,

Review Comment:
   ```suggestion
                   callbackSupplier,
   ```



##########
zookeeper-server/src/main/java/org/apache/zookeeper/Login.java:
##########
@@ -48,7 +49,7 @@ public class Login {
     private static final String KINIT_COMMAND_DEFAULT = ""/usr/bin/kinit"";
     private static final Logger LOG = LoggerFactory.getLogger(Login.class);
     public static final String SYSTEM_USER = System.getProperty(""user.name"", ""<NA>"");
-    public CallbackHandler callbackHandler;
+    private Supplier<CallbackHandler> callbackHandlerSupplier;

Review Comment:
   ```suggestion
       private final Supplier<CallbackHandler> callbackHandlerSupplier;
   ```



##########
zookeeper-server/src/main/java/org/apache/zookeeper/util/SecurityUtils.java:
##########
@@ -36,10 +42,14 @@
 import org.ietf.jgss.GSSName;
 import org.ietf.jgss.Oid;
 import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
 
 public final class SecurityUtils {
 
+    private static final Logger LOG = LoggerFactory.getLogger(SecurityUtils.class);

Review Comment:
   How about follow the pattern of `createSaslClient`/`createSaslServer` to accept a log parameter ? This will allow callers to log in their contexts.



##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/auth/SaslQuorumAuthLearner.java:
##########
@@ -62,9 +64,13 @@ public SaslQuorumAuthLearner(
                     ""SASL-authentication failed because the specified JAAS configuration section '%s' could not be found."",
                     loginContext));
             }
+
+            Supplier<CallbackHandler> callBackSupplier = () -> {

Review Comment:
   ```suggestion
               Supplier<CallbackHandler> callbackSupplier = () -> {
   ```



;13/Sep/24 13:45;githubbot;600","luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2351004638

   All commonts have been resolved, and fix some spelling and license check errors. Can you take a look? @kezhuw 


;14/Sep/24 14:07;githubbot;600","luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2359836342

   The cpp-unit-test failed and I find an issue maybe associate with the failure [4746](https://issues.apache.org/jira/projects/ZOOKEEPER/issues/ZOOKEEPER-4746?filter=allopenissues&orderby=created+DESC%2C+priority+DESC%2C+updated+DESC). Let me take a look on it.


;19/Sep/24 02:10;githubbot;600","kezhuw commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2360001928

   > The cpp-unit-test failed and I find an issue maybe associate with the failure [ZOOKEEPER-4746](https://issues.apache.org/jira/projects/ZOOKEEPER/issues/ZOOKEEPER-4746?filter=allopenissues&orderby=created+DESC%2C+priority+DESC%2C+updated+DESC). Let me take a look on it.
   
   That does not matter, it will not block this pr. I forgot it entirely and created ZOOKEEPER-4859 with attached log.


;19/Sep/24 05:21;githubbot;600","kezhuw commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2360152099

   @anmolnar @tisonkun @eolivelli Would you mind take a look ?


;19/Sep/24 07:01;githubbot;600","luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2362868693

   > Excellent candidate for 3.9.3 release. Thanks!
   > 
   > Question: why have you moved logic out of the class to static class `SecurityUtils` while you're not using it anywhere else. For instance `getAppConfigurationEntryWithSection()` is only used in `SaslQuorumAuthServer`, so it should be a private method of it.
   
   getAppConfigurationEntryWithSection alway used in SecurityUtils‘s other methods. SecurityUtils::getDigestMd5Credentials -> SecurityUtils::getServerAppConfigurationEntry -> SecurityUtils::getAppConfigurationEntryWithSection. 


;20/Sep/24 05:41;githubbot;600","anmolnar commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2364629073

   > > Excellent candidate for 3.9.3 release. Thanks!
   > > Question: why have you moved logic out of the class to static class `SecurityUtils` while you're not using it anywhere else. For instance `getAppConfigurationEntryWithSection()` is only used in `SaslQuorumAuthServer`, so it should be a private method of it.
   > 
   > getAppConfigurationEntryWithSection is also used in SecurityUtils‘s other methods. SecurityUtils::getDigestMd5Credentials -> SecurityUtils::getServerAppConfigurationEntry -> SecurityUtils::getAppConfigurationEntryWithSection.
   
   Following the call chain it still seems to me that every method is used only in `ServerCnxnFactory` abstract class, but correct me if I'm wrong. All of these methods should belong to there. You can still make them visible for testing.


;20/Sep/24 21:16;githubbot;600","luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2364959646

   > > > Excellent candidate for 3.9.3 release. Thanks!
   > > > Question: why have you moved logic out of the class to static class `SecurityUtils` while you're not using it anywhere else. For instance `getAppConfigurationEntryWithSection()` is only used in `SaslQuorumAuthServer`, so it should be a private method of it.
   > > 
   > > 
   > > getAppConfigurationEntryWithSection is also used in SecurityUtils‘s other methods. SecurityUtils::getDigestMd5Credentials -> SecurityUtils::getServerAppConfigurationEntry -> SecurityUtils::getAppConfigurationEntryWithSection.
   > 
   > Following the call chain it still seems to me that every method is used only in `ServerCnxnFactory` abstract class, but correct me if I'm wrong. All of these methods should belong to there. You can still make them visible for testing.
   
   Thanks for your reply! I find some dup codes in my pr, let me fix it.


;21/Sep/24 02:53;githubbot;600","luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2365007130

   Hi, @kezhuw @anmolnar  I find something confused me.
   
   [[SaslQuorumServerCallbackHandler](https://github.com/apache/zookeeper/blob/bc9afbf8ef1bc6156643d3d05c87fcf8411e9d8f/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/auth/SaslQuorumServerCallbackHandler.java#L82)](https://github.com/apache/zookeeper/blob/bc9afbf8ef1bc6156643d3d05c87fcf8411e9d8f/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/auth/SaslQuorumServerCallbackHandler.java#L82)
   
   The codes here are correct ?
   
   I think if a section contains a module that is DigestLoginModule, we can set isDigestAuthn to true.
   
   So i think the correct codes are
   
   ```java
   boolean isDigestAuthn = false;
   for (AppConfigurationEntry entry : configurationEntries) {
   		if (entry.getLoginModuleName().equals(DigestLoginModule.class.getName())) {
         Map<String, ?> options = entry.getOptions();
         // Populate DIGEST-MD5 user -> password map with JAAS configuration entries from the ""QuorumServer"" section.
         // Usernames are distinguished from other options by prefixing the username with a ""user_"" prefix.
         for (Map.Entry<String, ?> pair : options.entrySet()) {
             String key = pair.getKey();
             if (key.startsWith(USER_PREFIX)) {
                 String userName = key.substring(USER_PREFIX.length());
                 credentials.put(userName, (String) pair.getValue());
             }
         }
         isDigestAuthn = true;
      }
   }
   ```
   
    Am I right?


;21/Sep/24 05:18;githubbot;600","kezhuw commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2365065473

   I guess it might express a preference over non DIGEST-MD5 module. But I doubt ZooKeeper will work probably in case of multiple login modules especially client-server authentication. cc @ztzg 
   
   I do noticed the repetition in reviewing(https://github.com/apache/zookeeper/pull/2176#discussion_r1751088413), I am ok for it to be unified somehow. But be careful and don't break ZOOKEEPER-4753.
   
   Some code assumes there is only one login module and most mixes them.
   
   https://github.com/apache/zookeeper/blob/bc9afbf8ef1bc6156643d3d05c87fcf8411e9d8f/zookeeper-server/src/main/java/org/apache/zookeeper/Login.java#L108-L120


;21/Sep/24 08:48;githubbot;600","luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2365437556

   Hi, @kezhuw  @anmolnar  I make some changes. 
   
   1. remove `getAppConfigurationEntryWithSection` and `getServerAppConfigurationEntry` in `SecurityUtils` because the caller alreay have an `AppConfigurationEntry[]` entries in the context, we can use it directly, we don’t need check and get again in the Utils methods.
   
      Codes here:
   
      [[ServerCnxnFactory](https://github.com/apache/zookeeper/blob/bc9afbf8ef1bc6156643d3d05c87fcf8411e9d8f/zookeeper-server/src/main/java/org/apache/zookeeper/server/ServerCnxnFactory.java#L243)](https://github.com/apache/zookeeper/blob/bc9afbf8ef1bc6156643d3d05c87fcf8411e9d8f/zookeeper-server/src/main/java/org/apache/zookeeper/server/ServerCnxnFactory.java#L243)
   
      [[SaslQuorumAuthServer](https://github.com/apache/zookeeper/blob/bc9afbf8ef1bc6156643d3d05c87fcf8411e9d8f/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/auth/SaslQuorumAuthServer.java#L52)](https://github.com/apache/zookeeper/blob/bc9afbf8ef1bc6156643d3d05c87fcf8411e9d8f/zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/auth/SaslQuorumAuthServer.java#L52)
   
   2. move getServerCredentials to ServerCnxnFactory and make it private.
   
   Please take a look and give some feed back, thanks !


;22/Sep/24 03:10;githubbot;600","luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2371532735

   > Please remove this, it's not needed anymore:
   > 
   > https://github.com/apache/zookeeper/pull/2176/files#diff-dc881dad2c11cb59d7c710313e05fff31c098fbfa4cc02d250515e8c883583e5R120
   
   @anmolnar  I have removed it, please take a look.


;24/Sep/24 14:49;githubbot;600","anmolnar merged PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176


;25/Sep/24 00:46;githubbot;600","anmolnar commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2372641997

   Merged. Thanks @luoxiner !


;25/Sep/24 00:47;githubbot;600","anmolnar commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2372642583

   @luoxiner What is your Jira id?


;25/Sep/24 00:47;githubbot;600","luoxiner commented on PR #2176:
URL: https://github.com/apache/zookeeper/pull/2176#issuecomment-2372715070

   > @luoxiner What is your Jira id?
   
   luoxin


;25/Sep/24 01:46;githubbot;600",,,,,,,,,,,,,,,,,,,,,0,16200,,,0,16200,,,,,,,,,,,,,,,,,,,"19/Jun/24 03:04;wstcjmg;image-2024-06-19-11-04-14-140.png;https://issues.apache.org/jira/secure/attachment/13069597/image-2024-06-19-11-04-14-140.png",,,,,,1.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Sep 25 00:47:01 UTC 2024,,,,,,,,,,"0|z1puts:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"19/Jun/24 03:04;wstcjmg;!image-2024-06-19-11-04-14-140.png!;;;","11/Jul/24 02:16;luoxin;There is an uncovered condition when processing users that are not on the credential list. When a user is not contained in the credentials, we should invoke the appropriate method to handle this scenario. we should call the method
{code:java}
pc.clearPassword(); {code}
when user not in credentials. Let me try to fix it!;;;","14/Jul/24 08:17;luoxin;I have created a pr to resolve it.

[Clear user credentials when userName non-exist in sasl login module by luoxiner · Pull Request #2176 · apache/zookeeper (github.com)|https://github.com/apache/zookeeper/pull/2176];;;","25/Sep/24 00:47;andor;Issue resolved by pull request 2176
[https://github.com/apache/zookeeper/pull/2176];;;",,,,,,,,
Introduce Typo CI Check to Apache ZooKeeper,ZOOKEEPER-4834,13580356,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,hezhangjian,hezhangjian,hezhangjian,24/May/24 11:28,22/Aug/25 14:16,08/Dec/25 08:12,16/Jul/24 08:07,,,,,,,,,3.10.0,,,,,,,0,pull-request-available,,,"Hi, I want to introduce new lint tools: typos[1]. This tool is designed to automatically detect and correct typographical errors in our codebase, documentation, and comments. It’s a valuable addition to ensure high-quality contributions and maintain the professional standard of our project.

It has also been used in the Apache OpenDAL and Kvrocks projects.",,"shoothzj opened a new pull request, #2167:
URL: https://github.com/apache/zookeeper/pull/2167

   (no comment)


;24/May/24 12:19;githubbot;600","tisonkun commented on code in PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#discussion_r1615393739


##########
zookeeper-client/zookeeper-client-c/ChangeLog:
##########
@@ -31,12 +31,12 @@ Release 1.1.3
     * get_xid() is not thread-safe (xid initialization race condition 
       in the multi-threaded mode).
     
-    * the I/O thread doesn�t automatically terminate on AUTH_FAILURE and 
+    * the I/O thread doesn't automatically terminate on AUTH_FAILURE and
       SESSION_EXPIRED events.
       
     * all session events should be processed on the completion thread. 
     
-    * PING operation doesn�t atomically enqueue the completion and 
+    * PING operation doesn�t atomically enqueue the completion and 

Review Comment:
   Broken change?



;27/May/24 01:53;githubbot;600","shoothzj commented on code in PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#discussion_r1615406935


##########
zookeeper-client/zookeeper-client-c/ChangeLog:
##########
@@ -31,12 +31,12 @@ Release 1.1.3
     * get_xid() is not thread-safe (xid initialization race condition 
       in the multi-threaded mode).
     
-    * the I/O thread doesn�t automatically terminate on AUTH_FAILURE and 
+    * the I/O thread doesn't automatically terminate on AUTH_FAILURE and
       SESSION_EXPIRED events.
       
     * all session events should be processed on the completion thread. 
     
-    * PING operation doesn�t atomically enqueue the completion and 
+    * PING operation doesn�t atomically enqueue the completion and 

Review Comment:
   @tisonkun Nice catch, Fixed.



;27/May/24 02:25;githubbot;600","shoothzj commented on PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#issuecomment-2136335535

   @eolivelli @maoling @tisonkun PTAL


;29/May/24 01:03;githubbot;600","tisonkun commented on code in PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#discussion_r1618045857


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/watch/WatchManagerOptimized.java:
##########
@@ -349,7 +349,7 @@ public WatchesPathReport getWatchesByPath() {
      * May cause OOM if there are lots of watches, might better to forbid
      * it in this class.
      */
-    public Map<Watcher, Set<String>> getWatcher2PathesMap() {
+    public Map<Watcher, Set<String>> getWatcher2PathsMap() {

Review Comment:
   Public API changed. I wonder if it affects user compatibility.



;29/May/24 01:07;githubbot;600","tisonkun commented on code in PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#discussion_r1618046313


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/watch/WatchManagerOptimized.java:
##########
@@ -349,7 +349,7 @@ public WatchesPathReport getWatchesByPath() {
      * May cause OOM if there are lots of watches, might better to forbid
      * it in this class.
      */
-    public Map<Watcher, Set<String>> getWatcher2PathesMap() {
+    public Map<Watcher, Set<String>> getWatcher2PathsMap() {

Review Comment:
   This should be mostly used internaly. Just point it out here for attentions.



;29/May/24 01:08;githubbot;600","tisonkun commented on code in PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#discussion_r1618049687


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/SnapStream.java:
##########
@@ -51,14 +51,14 @@ public class SnapStream {
 
     private static final Logger LOG = LoggerFactory.getLogger(SnapStream.class);
 
-    public static final String ZOOKEEPER_SHAPSHOT_STREAM_MODE = ""zookeeper.snapshot.compression.method"";
+    public static final String ZOOKEEPER_SNAPSHOT_STREAM_MODE = ""zookeeper.snapshot.compression.method"";

Review Comment:
   This changes public API.



;29/May/24 01:15;githubbot;600","shoothzj commented on code in PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#discussion_r1618394930


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/watch/WatchManagerOptimized.java:
##########
@@ -349,7 +349,7 @@ public WatchesPathReport getWatchesByPath() {
      * May cause OOM if there are lots of watches, might better to forbid
      * it in this class.
      */
-    public Map<Watcher, Set<String>> getWatcher2PathesMap() {
+    public Map<Watcher, Set<String>> getWatcher2PathsMap() {

Review Comment:
   @tisonkun I think we can discuss this in other thread, reverted



;29/May/24 07:55;githubbot;600","shoothzj commented on PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#issuecomment-2136782441

   @tisonkun Thanks for your review. I think we can discuss later in another thread to decide public API changes(not in this PR), I revert it fisrt and add in `.tyops.toml` PTAL again.


;29/May/24 07:58;githubbot;600","shoothzj commented on PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#issuecomment-2138883165

   @eolivelli @maoling PTAL


;30/May/24 07:43;githubbot;600","shoothzj commented on PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#issuecomment-2149753814

   @eolivelli @maoling @kezhuw PTAL


;05/Jun/24 12:42;githubbot;600","shoothzj commented on PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#issuecomment-2162399530

   @eolivelli @maoling @kezhuw PTAL


;12/Jun/24 08:21;githubbot;600","kezhuw commented on code in PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#discussion_r1636205147


##########
zookeeper-contrib/zookeeper-contrib-zkfuse/src/thread.h:
##########
@@ -41,7 +41,7 @@ class Thread {
 
     void Create(void* ctx, ThreadFunc func);
     void Join() {
-        //avoid SEGFAULT because of unitialized mThread
+        //avoid SEGFAULT because of initialized mThread

Review Comment:
   uninitialized ?
   
   In case of uninitialized, `_func` should be `NULL`.
   
   https://github.com/apache/zookeeper/blob/master/zookeeper-contrib/zookeeper-contrib-zkfuse/src/thread.cc#L27-L39



##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:
##########
@@ -295,7 +295,7 @@ protected long nanoTime() {
 
     /**
      * Overridable helper method to simply call sock.connect(). This can be
-     * overriden in tests to fake connection success/failure for connectToLeader.
+     * override in tests to fake connection success/failure for connectToLeader.

Review Comment:
   overridden ?



##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/QuorumUtilTest.java:
##########
@@ -42,7 +42,7 @@ public class QuorumUtilTest extends ZKTestCase {
      * <p>
      * This test ensures that all JXM beans associated to a {@link QuorumPeer}
      * are unregistered when shuted down ({@link QuorumUtil#shutdown(int)}). It
-     * allows a successfull restarting of several zookeeper servers (
+     * allows a successfulrestarting of several zookeeper servers (

Review Comment:
   missing space ?



##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/GetProposalFromTxnTest.java:
##########
@@ -117,7 +117,7 @@ public void testGetProposalFromTxn() throws Exception {
         }
 
         // All zxid should match what we created
-        assertTrue(Arrays.equals(zxids, retrievedZxids.toArray(new Long[0])), ""Zxids missmatches"");
+        assertArrayEquals(zxids, retrievedZxids.toArray(new Long[0]), ""Zxids mismatches"");

Review Comment:
   +1 on this, though not only typos.



##########
zookeeper-contrib/zookeeper-contrib-zooinspector/src/main/java/org/apache/zookeeper/inspector/gui/nodeviewer/NodeSelectionListener.java:
##########
@@ -18,7 +18,7 @@
 package org.apache.zookeeper.inspector.gui.nodeviewer;
 
 /**
- * An interface to be implented by any component that needs notification when a new element
+ * An interface to be implement by any component that needs notification when a new element

Review Comment:
   implemented ?



##########
zookeeper-contrib/zookeeper-contrib-zkfuse/src/zkadapter.h:
##########
@@ -616,7 +616,7 @@ class ZooKeeperAdapter
 
         /**
          * Returns the remaining connect timeout. The timeout resets
-         * to {@link #m_connectTimeout} on a successfull connection to the ZK.
+         * to {@link #m_connectTimeout} on a successfulconnection to the ZK.

Review Comment:
   nit: missing space



;12/Jun/24 10:45;githubbot;600","shoothzj commented on code in PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#discussion_r1637282685


##########
zookeeper-contrib/zookeeper-contrib-zkfuse/src/thread.h:
##########
@@ -41,7 +41,7 @@ class Thread {
 
     void Create(void* ctx, ThreadFunc func);
     void Join() {
-        //avoid SEGFAULT because of unitialized mThread
+        //avoid SEGFAULT because of initialized mThread

Review Comment:
   @kezhuw Thanks, fixed



;13/Jun/24 00:07;githubbot;600","shoothzj commented on code in PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#discussion_r1637283514


##########
zookeeper-contrib/zookeeper-contrib-zkfuse/src/zkadapter.h:
##########
@@ -616,7 +616,7 @@ class ZooKeeperAdapter
 
         /**
          * Returns the remaining connect timeout. The timeout resets
-         * to {@link #m_connectTimeout} on a successfull connection to the ZK.
+         * to {@link #m_connectTimeout} on a successfulconnection to the ZK.

Review Comment:
   @kezhuw Fixed



##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/Learner.java:
##########
@@ -295,7 +295,7 @@ protected long nanoTime() {
 
     /**
      * Overridable helper method to simply call sock.connect(). This can be
-     * overriden in tests to fake connection success/failure for connectToLeader.
+     * override in tests to fake connection success/failure for connectToLeader.

Review Comment:
   @kezhuw Fixed



;13/Jun/24 00:08;githubbot;600","shoothzj commented on code in PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#discussion_r1637283745


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/QuorumUtilTest.java:
##########
@@ -42,7 +42,7 @@ public class QuorumUtilTest extends ZKTestCase {
      * <p>
      * This test ensures that all JXM beans associated to a {@link QuorumPeer}
      * are unregistered when shuted down ({@link QuorumUtil#shutdown(int)}). It
-     * allows a successfull restarting of several zookeeper servers (
+     * allows a successfulrestarting of several zookeeper servers (

Review Comment:
   @kezhuw Thanks, fixed



;13/Jun/24 00:08;githubbot;600","shoothzj commented on PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#issuecomment-2164117222

   @kezhuw Thanks for your thorough review. I have address your comments.
   
   >>  how do we find these typos ? I saw no mvn/ci integration.
   I would like to put it in a separated PR. :)


;13/Jun/24 00:10;githubbot;600","shoothzj commented on code in PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#discussion_r1637332844


##########
zookeeper-contrib/zookeeper-contrib-zooinspector/src/main/java/org/apache/zookeeper/inspector/gui/nodeviewer/NodeSelectionListener.java:
##########
@@ -18,7 +18,7 @@
 package org.apache.zookeeper.inspector.gui.nodeviewer;
 
 /**
- * An interface to be implented by any component that needs notification when a new element
+ * An interface to be implement by any component that needs notification when a new element

Review Comment:
   fixed



;13/Jun/24 01:06;githubbot;600","shoothzj commented on code in PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#discussion_r1637333010


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/GetProposalFromTxnTest.java:
##########
@@ -117,7 +117,7 @@ public void testGetProposalFromTxn() throws Exception {
         }
 
         // All zxid should match what we created
-        assertTrue(Arrays.equals(zxids, retrievedZxids.toArray(new Long[0])), ""Zxids missmatches"");
+        assertArrayEquals(zxids, retrievedZxids.toArray(new Long[0]), ""Zxids mismatches"");

Review Comment:
   Thanks



;13/Jun/24 01:07;githubbot;600","shoothzj commented on PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167#issuecomment-2164224978

   @eolivelli @maoling PTAL, thanks


;13/Jun/24 02:16;githubbot;600","tisonkun merged PR #2167:
URL: https://github.com/apache/zookeeper/pull/2167


;16/Jul/24 08:06;githubbot;600","shoothzj opened a new pull request, #2184:
URL: https://github.com/apache/zookeeper/pull/2184

   (no comment)


;04/Sep/24 05:53;githubbot;600","shoothzj commented on PR #2184:
URL: https://github.com/apache/zookeeper/pull/2184#issuecomment-2328331346

   @tisonkun @kezhuw @eolivelli PTAL, thanks :)


;04/Sep/24 09:12;githubbot;600","shoothzj commented on PR #2184:
URL: https://github.com/apache/zookeeper/pull/2184#issuecomment-2331290315

   @tisonkun @kezhuw @eolivelli PTAL, thanks :)


;05/Sep/24 11:34;githubbot;600","shoothzj commented on PR #2184:
URL: https://github.com/apache/zookeeper/pull/2184#issuecomment-2337451450

   @tisonkun @kezhuw @eolivelli PTAL, thanks :)


;09/Sep/24 08:23;githubbot;600","kezhuw commented on code in PR #2184:
URL: https://github.com/apache/zookeeper/pull/2184#discussion_r1751135832


##########
.github/workflows/ci.yaml:
##########
@@ -86,3 +86,13 @@ jobs:
         name: failsafe-reports-${{ matrix.profile.name }}
         path: ./**/target/failsafe-reports/
         if-no-files-found: ignore
+  typo-check:

Review Comment:
   ~~Is there a way for us to check typos locally against [.typos.toml](https://github.com/apache/zookeeper/pull/2167/files#diff-f4eaaba6f80f920c13375550e7c86add0532f1cbc10516f037a8edd8bdf7cce7) ?~~
   
   Seems that it need external executable to check against "".typos.toml"". How about add a link to typos here for hints to run locally ?



##########
.github/workflows/ci.yaml:
##########
@@ -86,3 +86,13 @@ jobs:
         name: failsafe-reports-${{ matrix.profile.name }}
         path: ./**/target/failsafe-reports/
         if-no-files-found: ignore
+  typo-check:
+    name: Typo Check
+    # only run on pull requests because of security reasons
+    # we shouldn't trust external actions for builds within the repository
+    if: ${{ github.event_name == 'pull_request' }}
+    runs-on: ubuntu-latest
+    steps:
+      - uses: actions/checkout@v4
+      - name: Check typos
+        uses: crate-ci/typos@v1.22.4

Review Comment:
   I think we could add some links(possibly pinned to concrete tag) for:
   * https://github.com/crate-ci/typos/blob/master/docs/reference.md for "".typos.toml"".
   * https://github.com/crate-ci/typos/blob/master/docs/github-action.md (here ?)



;10/Sep/24 02:08;githubbot;600","shoothzj commented on PR #2184:
URL: https://github.com/apache/zookeeper/pull/2184#issuecomment-2339586439

   @kezhuw I added some comments below this action config
   ```
           # To run the typo check locally, you can follow these steps:
           # 1. Install typos locally using cargo:
           #    cargo install typos-cli
           # 2. Run the typo check with the following command:
           #    typos
           # FP is configured in the project root directory in the `.typos.toml` file.
           # You can refer to the `.typos.toml` documentation here:
           # https://github.com/crate-ci/typos/blob/master/docs/reference.md
   ```


;10/Sep/24 04:30;githubbot;600","tisonkun commented on PR #2184:
URL: https://github.com/apache/zookeeper/pull/2184#issuecomment-2339589561

   Thanks for your contribution! Merging ...


;10/Sep/24 04:34;githubbot;600","tisonkun merged PR #2184:
URL: https://github.com/apache/zookeeper/pull/2184


;10/Sep/24 04:34;githubbot;600",,,,,,,,,,,,,,,,,,,0,17400,,,0,17400,,,,,,,,,,,,,,,ZOOKEEPER-2823,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Sep 04 05:53:38 UTC 2024,,,,,,,,,,"0|z1peo8:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"16/Jul/24 08:07;tison;master via 9a2dc253caf5e94ec64bd65a72a35c6bc5e2042c;;;","04/Sep/24 05:53;hezhangjian;still need add github action;;;",,,,,,,,,,
"update slf4j from 1.x to 2.0.13, logback to 1.3.14",ZOOKEEPER-4831,13577587,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Implemented,tison,hezhangjian,hezhangjian,29/Apr/24 14:11,28/Sep/24 14:35,08/Dec/25 08:12,28/Sep/24 14:34,,,,,,,,,3.10.0,,,,,,,0,pull-request-available,,,,,"shoothzj opened a new pull request, #2162:
URL: https://github.com/apache/zookeeper/pull/2162

   Update slf4j to 2.x, logback to 1.3.14. This is a backward-compatible change. 
   
   
   ## slf4j
   SLF4J API version 2.0.0 requires Java 8 and introduces a backward-compatible fluent logging API. By backward-compatible, we mean that existing logging frameworks do not have to be changed in order for the user to benefit from the fluent logging API.
   
   ## logback
   Version 1.3.x supports Java EE, while version 1.4.x supports Jakarta EE. The two versions are feature identical.
   
   Both 1.3.x and 1.4.x series require SLF4J 2.0.x or later.
   
   The 1.3.x series requires Java 8 at runtime.


;29/Apr/24 14:13;githubbot;600","shoothzj commented on PR #2162:
URL: https://github.com/apache/zookeeper/pull/2162#issuecomment-2083992581

   @eolivelli @maoling @tisonkun PTAL :)


;30/Apr/24 00:51;githubbot;600","shoothzj closed pull request #2162: [ZOOKEEPER-4831] update slf4j from 1.x to 2.0.13, logback to 1.3.14
URL: https://github.com/apache/zookeeper/pull/2162


;30/Apr/24 08:31;githubbot;600","shoothzj opened a new pull request, #2162:
URL: https://github.com/apache/zookeeper/pull/2162

   Update slf4j to 2.x, logback to 1.3.14. This is a backward-compatible change. 
   
   
   ## slf4j
   SLF4J API version 2.0.0 requires Java 8 and introduces a backward-compatible fluent logging API. By backward-compatible, we mean that existing logging frameworks do not have to be changed in order for the user to benefit from the fluent logging API.
   
   ## logback
   Version 1.3.x supports Java EE, while version 1.4.x supports Jakarta EE. The two versions are feature identical.
   
   Both 1.3.x and 1.4.x series require SLF4J 2.0.x or later.
   
   The 1.3.x series requires Java 8 at runtime.


;30/Apr/24 08:31;githubbot;600","shoothzj commented on PR #2162:
URL: https://github.com/apache/zookeeper/pull/2162#issuecomment-2091507841

   @eolivelli @maoling @tisonkun PTAL :)


;02/May/24 20:34;githubbot;600","ctubbsii commented on code in PR #2162:
URL: https://github.com/apache/zookeeper/pull/2162#discussion_r1588539152


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -436,7 +436,7 @@ in the unlikely event a recent log has become corrupted). This
 can be run as a cron job on the ZooKeeper server machines to
 clean up the logs daily.
 
-    java -cp zookeeper.jar:lib/slf4j-api-1.7.30.jar:lib/logback-classic-1.2.10.jar:lib/logback-core-1.2.10.jar:conf org.apache.zookeeper.server.PurgeTxnLog <dataDir> <snapDir> -n <count>
+    java -cp zookeeper.jar:lib/slf4j-api-2.0.13.jar:lib/logback-classic-1.2.10.jar:lib/logback-core-1.2.10.jar:conf org.apache.zookeeper.server.PurgeTxnLog <dataDir> <snapDir> -n <count>

Review Comment:
   A few comments about this particular documentation:
   
   1. You updated the slf4j version here, but not the logback version
   2. The documentation should probably be written to not depend on a specific version, so it doesn't need to constantly be updated.
   3. Not related to your change, but people really should stop specifying class paths using `-cp`, because it makes it hard to override via environment config files, and it can result in very long command-lines (sometimes too big for the OS, or for tools like pgrep/pkill). It's better to set the `CLASSPATH` environment instead of the command-line argument, and depending on the context, to append or prepend to any existing value (just like `$PATH`). For here, for the example, it's probably enough to just keep it simple:
   ```suggestion
       CLASSPATH='lib/*:conf' java org.apache.zookeeper.server.PurgeTxnLog <dataDir> <snapDir> -n <count>
   ```
   



##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ReconfigExceptionTest.java:
##########
@@ -48,7 +48,7 @@ public class ReconfigExceptionTest extends ZKTestCase {
     // Use DigestAuthenticationProvider.base64Encode or
     // run ZooKeeper jar with org.apache.zookeeper.server.auth.DigestAuthenticationProvider to generate password.
     // An example:
-    // java -cp zookeeper.jar:lib/slf4j-api-1.7.30.jar:lib/logback-classic-1.2.10.jar:lib/logback-core-1.2.10.jar:conf
+    // java -cp zookeeper.jar:lib/slf4j-api-2.0.13.jar:lib/logback-classic-1.2.10.jar:lib/logback-core-1.2.10.jar:conf

Review Comment:
   Again, don't need the specific versions in the example.
   
   ```suggestion
       // CLASSPATH='lib/*:conf' java
   ```



;03/May/24 04:36;githubbot;600","shoothzj commented on PR #2162:
URL: https://github.com/apache/zookeeper/pull/2162#issuecomment-2092233436

   @ctubbsii Thanks for your review. Fixed.
   
   >> to updating the versions. I would suggest only doing this change in the next release, not in previous bugfixes for earlier branches.
   definitely.


;03/May/24 05:11;githubbot;600","shoothzj commented on PR #2162:
URL: https://github.com/apache/zookeeper/pull/2162#issuecomment-2102027344

   @eolivelli @maoling @tisonkun PTAL, can we merge this into master branch


;09/May/24 06:23;githubbot;600","tisonkun commented on PR #2162:
URL: https://github.com/apache/zookeeper/pull/2162#issuecomment-2102147717

   Thanks for your contribution!


;09/May/24 07:55;githubbot;600","shoothzj commented on PR #2162:
URL: https://github.com/apache/zookeeper/pull/2162#issuecomment-2105408087

   ping @eolivelli @maoling @tisonkun 


;11/May/24 00:31;githubbot;600","eolivelli merged PR #2162:
URL: https://github.com/apache/zookeeper/pull/2162


;11/May/24 07:46;githubbot;600","eolivelli commented on PR #2162:
URL: https://github.com/apache/zookeeper/pull/2162#issuecomment-2105621462

   Merged thanks


;11/May/24 07:46;githubbot;600","DeepikaGiri commented on PR #2162:
URL: https://github.com/apache/zookeeper/pull/2162#issuecomment-2210793418

   Hi @eolivelli @shoothzj , Can you please provide the tentative date for ZooKeeper next release ?Mainly intended for CVE Fix in LogBack  -[ZOOKEEPER-4825](https://issues.apache.org/jira/browse/ZOOKEEPER-4825)


;05/Jul/24 12:30;githubbot;600","eolivelli commented on PR #2162:
URL: https://github.com/apache/zookeeper/pull/2162#issuecomment-2211086125

   Please ask on dev@zookeeeper.apache.org (you would have to subscribe)


;05/Jul/24 15:40;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,8400,,,0,8400,,,,,,,,,,,,,,,ZOOKEEPER-4825,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2024-04-29 14:11:57.0,,,,,,,,,,"0|z1oxn4:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
zk_learners is incorrectly referenced as zk_followers,ZOOKEEPER-4830,13576991,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Trivial,Fixed,tison,nfeinberg,nfeinberg,24/Apr/24 00:33,24/Apr/24 04:10,08/Dec/25 08:12,24/Apr/24 04:10,3.8.4,3.9.2,,,,,,,3.10.0,,,,,,,0,pull-request-available,,,"https://issues.apache.org/jira/browse/ZOOKEEPER-3117 renamed the `zk_followers` metric to `zk_learners`, but some references to `zk_followers` remained in the repo, including in the documentation. These should be corrected.
",,"tisonkun merged PR #2160:
URL: https://github.com/apache/zookeeper/pull/2160


;24/Apr/24 04:10;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,600,0,600,100%,600,0,600,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,https://github.com/apache/zookeeper/pull/2160,,,,,,,,,9223372036854775807,,,,,,Wed Apr 24 04:10:41 UTC 2024,,,,,,,,,,"0|z1ou08:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"24/Apr/24 04:10;tison;master via https://github.com/apache/zookeeper/commit/ee994fbca51f826e4b26d6a105866975d0007f6e.;;;",,,,,,,,,,,
Support DatadirCleanup in minutes,ZOOKEEPER-4829,13576985,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,puru,puru,puru,23/Apr/24 23:14,17/May/25 02:42,08/Dec/25 08:12,27/Aug/24 22:32,,,,,,,,,3.10.0,,,,,,,0,pull-request-available,,,"On the cloud, space can be limited. Currently, the DatadirCleanup only supports hours; we should also support cleanup intervals in minutes.
 
{code:java}
2024-02-20 20:55:28,862 - WARN  [QuorumPeer[myid=5](plain=disabled)(secure=[0:0:0:0:0:0:0:0]:50512):o.a.z.s.q.Follower@131] - Exception when following the leader
java.io.IOException: No space left on device
    at java.base/java.io.FileOutputStream.writeBytes(Native Method)
    at java.base/java.io.FileOutputStream.write(FileOutputStream.java:354)
    at org.apache.zookeeper.common.AtomicFileOutputStream.write(AtomicFileOutputStream.java:72)
    at java.base/sun.nio.cs.StreamEncoder.writeBytes(StreamEncoder.java:233)
    at java.base/sun.nio.cs.StreamEncoder.implFlushBuffer(StreamEncoder.java:312)
    at java.base/sun.nio.cs.StreamEncoder.implFlush(StreamEncoder.java:316)
    at java.base/sun.nio.cs.StreamEncoder.flush(StreamEncoder.java:153)
    at java.base/java.io.OutputStreamWriter.flush(OutputStreamWriter.java:251)
    at java.base/java.io.BufferedWriter.flush(BufferedWriter.java:257)
    at org.apache.zookeeper.common.AtomicFileWritingIdiom.<init>(AtomicFileWritingIdiom.java:72)
    at org.apache.zookeeper.common.AtomicFileWritingIdiom.<init>(AtomicFileWritingIdiom.java:54)
    at org.apache.zookeeper.server.quorum.QuorumPeer.writeLongToFile(QuorumPeer.java:2229)
    at org.apache.zookeeper.server.quorum.QuorumPeer.setAcceptedEpoch(QuorumPeer.java:2258)
    at org.apache.zookeeper.server.quorum.Learner.registerWithLeader(Learner.java:511)
    at org.apache.zookeeper.server.quorum.Follower.followLeader(Follower.java:91)
    at org.apache.zookeeper.server.quorum.QuorumPeer.run(QuorumPeer.java:1551)
2024-02-20 20:55:28,863 - INFO  [QuorumPeer[myid=5](plain=disabled)(secure=[0:0:0:0:0:0:0:0]:50512):o.a.z.s.q.Follower@145]{code}",,"purushah opened a new pull request, #2178:
URL: https://github.com/apache/zookeeper/pull/2178

   (no comment)


;07/Aug/24 00:24;githubbot;600","purushah commented on PR #2178:
URL: https://github.com/apache/zookeeper/pull/2178#issuecomment-2286375221

   Thanks, @tisonkun, for your comment.
   
   I did look into existing libraries that offer similar functionality, but I opted against using them for two reasons:
   
   1. ZooKeeper already has `Time.java`, which contains time-based functions, making it a good place to add `parseTimeInterval`. The logic is straightforward, and I don't anticipate it will need changes in the future.
   
   2. I'm always cautious about adding new libraries (especially since none of the existing ones provide a `parseTimeInterval` API) to the classpath, as it could lead to compatibility issues.
   


;13/Aug/24 14:17;githubbot;600","anmolnar commented on PR #2178:
URL: https://github.com/apache/zookeeper/pull/2178#issuecomment-2312280090

   >     2. I'm always cautious about adding new libraries (especially since none of the existing ones provide a `parseTimeInterval` API) to the classpath, as it could lead to compatibility issues.
   
   Agreed. I don't think we should pull a new dependency for this.
   
   In Jira, I added you to the ZooKeeper project as contributor and assigned the ticket to you.


;27/Aug/24 11:16;githubbot;600","purushah commented on PR #2178:
URL: https://github.com/apache/zookeeper/pull/2178#issuecomment-2312781364

   >My only concern is that changing the default behaviour is dangerous and it's not strictly necessary for this patch to work. I'd keep the original behaviour and parse as hours without a modifier.
   @anmolnar , just to clarify, we are not altering the original behavior. The getPurgeInterval() method is only used in DatadirCleanupManager.java. Could you please elaborate on your concerns? I feel like I might be missing something.


;27/Aug/24 14:49;githubbot;600","anmolnar commented on code in PR #2178:
URL: https://github.com/apache/zookeeper/pull/2178#discussion_r1733148486


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeerConfig.java:
##########
@@ -336,7 +337,11 @@ public void parseProperties(Properties zkProp) throws IOException, ConfigExcepti
             } else if (key.equals(""autopurge.snapRetainCount"")) {
                 snapRetainCount = Integer.parseInt(value);
             } else if (key.equals(""autopurge.purgeInterval"")) {
-                purgeInterval = Integer.parseInt(value);
+                if (Character.isDigit(value.charAt(value.length() - 1))) {
+                    purgeIntervalInMs = Time.parseTimeInterval(value) * Time.HOUR; // default is hours for backward compatibility

Review Comment:
   Oh, tricky. I got it now. You're right, default behaviour is not altered.



;27/Aug/24 16:01;githubbot;600","anmolnar merged PR #2178:
URL: https://github.com/apache/zookeeper/pull/2178


;27/Aug/24 22:32;githubbot;600","kezhuw opened a new pull request, #2258:
URL: https://github.com/apache/zookeeper/pull/2258

   `QuorumPeerConfig` is marked public with `@InterfaceAudience.Public`. Though, I don't think there are much chances for `getPurgeInterval` to be used. But let's keep our promise.
   
   Backward Compatibility: https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=25200595#ReleaseManagement-BackwardCompatibility


;08/May/25 03:53;githubbot;600","kezhuw commented on code in PR #2258:
URL: https://github.com/apache/zookeeper/pull/2258#discussion_r2078850351


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/quorum/QuorumPeerConfig.java:
##########
@@ -903,6 +903,16 @@ public int getSnapRetainCount() {
         return snapRetainCount;
     }
 
+    /**
+     * Use {@link #getPurgeIntervalInMs()} instead.
+     *
+     * @return purge interval in hour unit or 0 if less than one hour.
+     */
+    @Deprecated
+    public int getPurgeInterval() {

Review Comment:
   This is the deleted version. https://github.com/apache/zookeeper/pull/2178/files



##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/DatadirCleanupManager.java:
##########
@@ -75,7 +76,7 @@ public DatadirCleanupManager(File snapDir, File dataLogDir, int snapRetainCount,
         this.snapRetainCount = snapRetainCount;
         this.purgeIntervalInMs = purgeIntervalInMs;
         LOG.info(""autopurge.snapRetainCount set to {}"", snapRetainCount);
-        LOG.info(""autopurge.purgeInterval set to {}"", purgeIntervalInMs);
+        LOG.info(""autopurge.purgeInterval set to {}"", Time.formatTimeIntervalMs(purgeIntervalInMs));

Review Comment:
   Add suffix here so people have little chance to be misguarded by old versions.



;08/May/25 04:10;githubbot;600","kezhuw merged PR #2258:
URL: https://github.com/apache/zookeeper/pull/2258


;09/May/25 14:45;githubbot;600","li4wang commented on PR #2258:
URL: https://github.com/apache/zookeeper/pull/2258#issuecomment-2887306845

   @kezhuw Given this is backward compatible now, would it be possible to back-port this to 3.9.4 release? 


;16/May/25 17:30;githubbot;600","kezhuw commented on PR #2258:
URL: https://github.com/apache/zookeeper/pull/2258#issuecomment-2887978762

   @li4wang I guess you need the release manager's permission to backport to 3.9.4 if not 3.9.5 according to our [What power does the RM yield?](https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=25200595#ReleaseManagement-WhatpowerdoestheRMyield?).
   
   See the voting thread for 3.9.4-rc0: https://lists.apache.org/thread/sq5djdm5ttbscbtdw5ykp5vl4dfb8p56. cc @tisonkun
   
   Besides, ZOOKEEPER-4869 is the doc part of ZOOKEEPER-4829. It need extra attention due to supported version.
   
   https://github.com/apache/zookeeper/blob/aeadf574c0463e7e3db092b588033d8347989d4c/zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md?plain=1#L776
   


;17/May/25 02:19;githubbot;600","purushah commented on PR #2258:
URL: https://github.com/apache/zookeeper/pull/2258#issuecomment-2887993593

   Thanks @kezhuw for making it backward compatible.


;17/May/25 02:42;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,7200,,,0,7200,,,,,ZOOKEEPER-4927,,,,,,,ZOOKEEPER-4869,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Tue Aug 27 22:32:31 UTC 2024,,,,,,,,,,"0|z1otyw:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"24/Apr/24 03:43;eolivelli;Would you like to contribute a patch?

 

 

Side comment: this is a pretty unusual request, I have seeing many installations of ZK in the cloud on k8s and I have heard about such problem.

Did you consider using a bigger disk? Running maintenance top often may impact latency.;;;","24/Apr/24 16:16;puru;I'll be contributing a patch.

Indeed, the problem was resolved by switching to a larger disk. The system generated many snapshots, and with the deletion interval set at one hour, the disk filled up quickly.

However, we only needed a few snapshots. In this case, the larger disk was not necessary.;;;","27/Aug/24 22:32;andor;Issue resolved by pull request 2178
[https://github.com/apache/zookeeper/pull/2178];;;",,,,,,,,,
Bump bouncycastl version from 1.75 to 1.78,ZOOKEEPER-4827,13576021,,Task,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,hezhangjian,hezhangjian,hezhangjian,16/Apr/24 11:53,18/Oct/24 16:51,08/Dec/25 08:12,30/Apr/24 08:35,,,,,,,,,3.10.0,,,,,,,0,pull-request-available,,,"Upgrade Bouncy Castle to 1.78 to address CVEs
https://bouncycastle.org/releasenotes.html#r1rv78

- https://www.cve.org/CVERecord?id=CVE-2024-29857 (reserved)
  - https://security.snyk.io/vuln/SNYK-JAVA-ORGBOUNCYCASTLE-6613079
- https://www.cve.org/CVERecord?id=CVE-2024-30171 (reserved)
  - https://security.snyk.io/vuln/SNYK-JAVA-ORGBOUNCYCASTLE-6613076
- https://www.cve.org/CVERecord?id=CVE-2024-30172 (reserved)
  - https://security.snyk.io/vuln/SNYK-JAVA-ORGBOUNCYCASTLE-6612984",,"shoothzj opened a new pull request, #2158:
URL: https://github.com/apache/zookeeper/pull/2158

   ### Motivation
   
   Upgrade Bouncy Castle to 1.78 to address CVEs
   https://bouncycastle.org/releasenotes.html#r1rv78
   
   - https://www.cve.org/CVERecord?id=CVE-2024-29857 (reserved)
     - https://security.snyk.io/vuln/SNYK-JAVA-ORGBOUNCYCASTLE-6613079
   - https://www.cve.org/CVERecord?id=CVE-2024-30171 (reserved)
     - https://security.snyk.io/vuln/SNYK-JAVA-ORGBOUNCYCASTLE-6613076
   - https://www.cve.org/CVERecord?id=CVE-2024-30172 (reserved)
     - https://security.snyk.io/vuln/SNYK-JAVA-ORGBOUNCYCASTLE-6612984
   
   See also https://github.com/apache/pulsar/pull/22509


;16/Apr/24 11:55;githubbot;600","shoothzj closed pull request #2158: ZOOKEEPER-4827 Bump bouncycastl version from 1.75 to 1.78
URL: https://github.com/apache/zookeeper/pull/2158


;28/Apr/24 08:33;githubbot;600","shoothzj opened a new pull request, #2158:
URL: https://github.com/apache/zookeeper/pull/2158

   ### Motivation
   
   Upgrade Bouncy Castle to 1.78 to address CVEs
   https://bouncycastle.org/releasenotes.html#r1rv78
   
   - https://www.cve.org/CVERecord?id=CVE-2024-29857 (reserved)
     - https://security.snyk.io/vuln/SNYK-JAVA-ORGBOUNCYCASTLE-6613079
   - https://www.cve.org/CVERecord?id=CVE-2024-30171 (reserved)
     - https://security.snyk.io/vuln/SNYK-JAVA-ORGBOUNCYCASTLE-6613076
   - https://www.cve.org/CVERecord?id=CVE-2024-30172 (reserved)
     - https://security.snyk.io/vuln/SNYK-JAVA-ORGBOUNCYCASTLE-6612984
   
   See also https://github.com/apache/pulsar/pull/22509


;28/Apr/24 08:33;githubbot;600","shoothzj commented on PR #2158:
URL: https://github.com/apache/zookeeper/pull/2158#issuecomment-2083993024

   @eolivelli @maoling @tisonkun PTAL :)


;30/Apr/24 00:52;githubbot;600","tisonkun merged PR #2158:
URL: https://github.com/apache/zookeeper/pull/2158


;30/Apr/24 08:34;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3000,,,0,3000,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Tue Apr 30 08:35:18 UTC 2024,,,,,,,,,,"0|z1oo1c:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"30/Apr/24 08:35;tison;master via https://github.com/apache/zookeeper/commit/6ac8edaabbb9b04529b7438ff226d19ec0e40ec9.;;;",,,,,,,,,,,
Reduce unnecessary executable permissions on files,ZOOKEEPER-4826,13575977,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,hezhangjian,hezhangjian,hezhangjian,16/Apr/24 08:04,18/Oct/24 16:52,08/Dec/25 08:12,30/Apr/24 08:13,,,,,,,,,3.10.0,,,,,,,0,pull-request-available,,,"***Summary:*** This patch aims to modify the permissions of various files within the ZooKeeper repository that currently have executable permissions set (755) but do not require such permissions for their operation. Changing these permissions to 644 enhances security and maintains the consistency of file permissions throughout the project. ***Details:*** Several non-executable files (not including scripts or executable binaries) are currently set with executable permissions. This is generally unnecessary and can lead to potential security concerns. This patch will adjust these permissions to a more appropriate setting (644), which is sufficient for reading and writing operations but does not allow execution.",,"shoothzj opened a new pull request, #2157:
URL: https://github.com/apache/zookeeper/pull/2157

   ### Motivation
   
   This patch aims to modify the permissions of various files within the ZooKeeper repository that currently have executable permissions set (755) but do not require such permissions for their operation. Changing these permissions to 644 enhances security and maintains the consistency of file permissions throughout the project.
   
   ### Changes
   
   Change those files below from 755 to 644:
   
   - zookeeper-assembly/pom.xml
   - zookeeper-client/pom.xml
   - zookeeper-client/zookeeper-client-c/pom.xml
   - zookeeper-contrib/pom.xml
   - zookeeper-contrib/zookeeper-contrib-fatjar/pom.xml
   - zookeeper-contrib/zookeeper-contrib-loggraph/pom.xml
   - zookeeper-contrib/zookeeper-contrib-rest/pom.xml
   - zookeeper-contrib/zookeeper-contrib-zooinspector/pom.xml
   - zookeeper-docs/src/main/resources/markdown/images/2pc.jpg
   - zookeeper-docs/src/main/resources/markdown/images/state_dia.dia
   - zookeeper-docs/src/main/resources/markdown/images/state_dia.jpg
   - zookeeper-it/pom.xml
   - zookeeper-jute/pom.xml
   - zookeeper-metrics-providers/pom.xml
   - zookeeper-metrics-providers/zookeeper-prometheus-metrics/pom.xml
   - zookeeper-recipes/pom.xml
   - zookeeper-recipes/zookeeper-recipes-election/pom.xml
   - zookeeper-recipes/zookeeper-recipes-lock/pom.xml
   - zookeeper-recipes/zookeeper-recipes-queue/pom.xml
   - zookeeper-server/pom.xml
   - zookeeper-server/src/main/java/org/apache/zookeeper/ClientCnxnSocketNetty.java


;16/Apr/24 08:12;githubbot;600","shoothzj closed pull request #2157: ZOOKEEPER-4826 Reduce unnecessary executable permissions on files
URL: https://github.com/apache/zookeeper/pull/2157


;28/Apr/24 08:33;githubbot;600","shoothzj opened a new pull request, #2157:
URL: https://github.com/apache/zookeeper/pull/2157

   ### Motivation
   
   This patch aims to modify the permissions of various files within the ZooKeeper repository that currently have executable permissions set (755) but do not require such permissions for their operation. Changing these permissions to 644 enhances security and maintains the consistency of file permissions throughout the project.
   
   ### Changes
   
   Change those files below from 755 to 644:
   
   - zookeeper-assembly/pom.xml
   - zookeeper-client/pom.xml
   - zookeeper-client/zookeeper-client-c/pom.xml
   - zookeeper-contrib/pom.xml
   - zookeeper-contrib/zookeeper-contrib-fatjar/pom.xml
   - zookeeper-contrib/zookeeper-contrib-loggraph/pom.xml
   - zookeeper-contrib/zookeeper-contrib-rest/pom.xml
   - zookeeper-contrib/zookeeper-contrib-zooinspector/pom.xml
   - zookeeper-docs/src/main/resources/markdown/images/2pc.jpg
   - zookeeper-docs/src/main/resources/markdown/images/state_dia.dia
   - zookeeper-docs/src/main/resources/markdown/images/state_dia.jpg
   - zookeeper-it/pom.xml
   - zookeeper-jute/pom.xml
   - zookeeper-metrics-providers/pom.xml
   - zookeeper-metrics-providers/zookeeper-prometheus-metrics/pom.xml
   - zookeeper-recipes/pom.xml
   - zookeeper-recipes/zookeeper-recipes-election/pom.xml
   - zookeeper-recipes/zookeeper-recipes-lock/pom.xml
   - zookeeper-recipes/zookeeper-recipes-queue/pom.xml
   - zookeeper-server/pom.xml
   - zookeeper-server/src/main/java/org/apache/zookeeper/ClientCnxnSocketNetty.java


;28/Apr/24 08:33;githubbot;600","shoothzj closed pull request #2157: ZOOKEEPER-4826 Reduce unnecessary executable permissions on files
URL: https://github.com/apache/zookeeper/pull/2157


;29/Apr/24 00:33;githubbot;600","shoothzj opened a new pull request, #2157:
URL: https://github.com/apache/zookeeper/pull/2157

   ### Motivation
   
   This patch aims to modify the permissions of various files within the ZooKeeper repository that currently have executable permissions set (755) but do not require such permissions for their operation. Changing these permissions to 644 enhances security and maintains the consistency of file permissions throughout the project.
   
   ### Changes
   
   Change those files below from 755 to 644:
   
   - zookeeper-assembly/pom.xml
   - zookeeper-client/pom.xml
   - zookeeper-client/zookeeper-client-c/pom.xml
   - zookeeper-contrib/pom.xml
   - zookeeper-contrib/zookeeper-contrib-fatjar/pom.xml
   - zookeeper-contrib/zookeeper-contrib-loggraph/pom.xml
   - zookeeper-contrib/zookeeper-contrib-rest/pom.xml
   - zookeeper-contrib/zookeeper-contrib-zooinspector/pom.xml
   - zookeeper-docs/src/main/resources/markdown/images/2pc.jpg
   - zookeeper-docs/src/main/resources/markdown/images/state_dia.dia
   - zookeeper-docs/src/main/resources/markdown/images/state_dia.jpg
   - zookeeper-it/pom.xml
   - zookeeper-jute/pom.xml
   - zookeeper-metrics-providers/pom.xml
   - zookeeper-metrics-providers/zookeeper-prometheus-metrics/pom.xml
   - zookeeper-recipes/pom.xml
   - zookeeper-recipes/zookeeper-recipes-election/pom.xml
   - zookeeper-recipes/zookeeper-recipes-lock/pom.xml
   - zookeeper-recipes/zookeeper-recipes-queue/pom.xml
   - zookeeper-server/pom.xml
   - zookeeper-server/src/main/java/org/apache/zookeeper/ClientCnxnSocketNetty.java


;29/Apr/24 00:33;githubbot;600","shoothzj closed pull request #2157: ZOOKEEPER-4826 Reduce unnecessary executable permissions on files
URL: https://github.com/apache/zookeeper/pull/2157


;29/Apr/24 07:15;githubbot;600","shoothzj opened a new pull request, #2157:
URL: https://github.com/apache/zookeeper/pull/2157

   ### Motivation
   
   This patch aims to modify the permissions of various files within the ZooKeeper repository that currently have executable permissions set (755) but do not require such permissions for their operation. Changing these permissions to 644 enhances security and maintains the consistency of file permissions throughout the project.
   
   ### Changes
   
   Change those files below from 755 to 644:
   
   - zookeeper-assembly/pom.xml
   - zookeeper-client/pom.xml
   - zookeeper-client/zookeeper-client-c/pom.xml
   - zookeeper-contrib/pom.xml
   - zookeeper-contrib/zookeeper-contrib-fatjar/pom.xml
   - zookeeper-contrib/zookeeper-contrib-loggraph/pom.xml
   - zookeeper-contrib/zookeeper-contrib-rest/pom.xml
   - zookeeper-contrib/zookeeper-contrib-zooinspector/pom.xml
   - zookeeper-docs/src/main/resources/markdown/images/2pc.jpg
   - zookeeper-docs/src/main/resources/markdown/images/state_dia.dia
   - zookeeper-docs/src/main/resources/markdown/images/state_dia.jpg
   - zookeeper-it/pom.xml
   - zookeeper-jute/pom.xml
   - zookeeper-metrics-providers/pom.xml
   - zookeeper-metrics-providers/zookeeper-prometheus-metrics/pom.xml
   - zookeeper-recipes/pom.xml
   - zookeeper-recipes/zookeeper-recipes-election/pom.xml
   - zookeeper-recipes/zookeeper-recipes-lock/pom.xml
   - zookeeper-recipes/zookeeper-recipes-queue/pom.xml
   - zookeeper-server/pom.xml
   - zookeeper-server/src/main/java/org/apache/zookeeper/ClientCnxnSocketNetty.java


;29/Apr/24 07:15;githubbot;600","shoothzj commented on PR #2157:
URL: https://github.com/apache/zookeeper/pull/2157#issuecomment-2083993306

   @eolivelli @maoling @tisonkun PTAL :)


;30/Apr/24 00:52;githubbot;600","eolivelli merged PR #2157:
URL: https://github.com/apache/zookeeper/pull/2157


;30/Apr/24 08:12;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,5400,,,0,5400,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2024-04-16 08:04:55.0,,,,,,,,,,"0|z1onrk:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
CVE-2023-6378 is present in the current logback version (1.2.13) and hence we need to upgrade to 1.4.12,ZOOKEEPER-4825,13575594,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Duplicate,,bhavyahoda99,bhavyahoda99,12/Apr/24 05:34,28/Sep/24 14:35,08/Dec/25 08:12,28/Sep/24 14:35,,,,,,,,,,,,,,,,0,pull-request-available,,,,,"Vivekgoku20 opened a new pull request, #2159:
URL: https://github.com/apache/zookeeper/pull/2159

   [ZOOKEEPER-4825](https://issues.apache.org/jira/browse/ZOOKEEPER-4825) - updating the logback version to 1.4.12 since the current version(1.2.13) has CVE-2023-6378 vulnerability. 
   Refer - https://logback.qos.ch/news.html for more details on the release notes.
   referred - https://mvnrepository.com/artifact/ch.qos.logback/logback-classic , for vulnerabilities in different versions


;17/Apr/24 17:16;githubbot;600","shoothzj commented on PR #2159:
URL: https://github.com/apache/zookeeper/pull/2159#issuecomment-2083991644

   we can only update to logback 1.3.x, because logback 1.4.x will need java11 :) I created #2162 to fix this issue. PTAL


;30/Apr/24 00:51;githubbot;600","tisonkun commented on PR #2159:
URL: https://github.com/apache/zookeeper/pull/2159#issuecomment-2211248376

   This is superseded by #2162. Thanks for your contribution @Vivekgoku20!


;05/Jul/24 18:14;githubbot;600","tisonkun closed pull request #2159: ZOOKEEPER-4825:Updating logback version from 1.2.13 to 1.4.12
URL: https://github.com/apache/zookeeper/pull/2159


;05/Jul/24 18:14;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,,,,,,,,,,,,ZOOKEEPER-4831,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Jul 05 18:15:46 UTC 2024,,,,,,,,,,"0|z1oleg:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"17/Apr/24 17:19;neti_neti;can this be assigned to me?;;;","05/Jul/24 18:15;tison;master via https://github.com/apache/zookeeper/pull/2162;;;",,,,,,,,,,
fix CVE-2024-29025 in netty package,ZOOKEEPER-4824,13575362,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Abandoned,,nikitapande,nikitapande,10/Apr/24 14:37,28/Sep/24 14:25,08/Dec/25 08:12,28/Sep/24 14:25,,,,,,,,,,,,,,,,0,pull-request-available,,,"[CVE-2024-29025|https://github.com/advisories/GHSA-5jpm-x58v-624v] is the CVE for all netty-codec-http <  4.1.108.Final",,"nikita15p opened a new pull request, #2156:
URL: https://github.com/apache/zookeeper/pull/2156

   (no comment)


;10/Apr/24 14:45;githubbot;600","kezhuw closed pull request #2156: ZOOKEEPER-4824 fix CVE-2024-29025 in netty package
URL: https://github.com/apache/zookeeper/pull/2156


;28/Sep/24 14:24;githubbot;600","kezhuw commented on PR #2156:
URL: https://github.com/apache/zookeeper/pull/2156#issuecomment-2380657043

   #1917 has bumped netty to `4.1.113.Final`. Thank you for your contribution! 


;28/Sep/24 14:24;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1800,,,0,1800,,,,,,,,,,,,,,ZOOKEEPER-4293,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Apr 10 14:39:14 UTC 2024,,,,,,,,,,"0|z1ok08:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"10/Apr/24 14:39;nikitapande;Current version is <netty.version>4.1.105.Final</netty.version>.
Please assign this Jira to me.;;;",,,,,,,,,,,
zookeeper pom leaks logback dependency,ZOOKEEPER-4820,13573558,,Task,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,pkarwasz,fanningpj,fanningpj,27/Mar/24 16:32,24/Oct/24 20:09,08/Dec/25 08:12,19/Sep/24 03:07,,,,,,,,,3.10.0,3.9.3,,java client,,,,0,pull-request-available,,,"Since v3.8.0

https://mvnrepository.com/artifact/org.apache.zookeeper/zookeeper/3.8.0

It's fine that Zookeeper uses Logback on the server side - but users who want to access Zookeeper using client side code also add this zookeeper jar to their classpaths. When zookeeper is used as client side lib, it should ideally not expose a logback dependency - just an slf4j-api jar dependency.

Would it be possible to rework the zookeper pom so that client side users don't have to explicitly exclude logback jars? Many users will have their own preferred logging framework.

Is there another zookeeper client side jar that could be instead of zookeeper.jar?",,"ppkarwasz opened a new pull request, #2155:
URL: https://github.com/apache/zookeeper/pull/2155

   Java libraries should not have `runtime` dependencies on logging backends, since they are often included in third-party applications that might make a different choice of backend.
   
   This PR:
   
   * removes the Logback dependency from the runtime scope of the `zookeeper` artifact and moves it into the `test` Maven scope,
   * adds Logback to `zookeeper-assembly`, which is used to produce the standalone [binary distribution](https://zookeeper.apache.org/releases) available on Zookeeper's site.


;09/Apr/24 21:05;githubbot;600","shoothzj commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2046946911

   maybe we can mark this dependency as runtime optional instead of test?


;10/Apr/24 08:54;githubbot;600","ppkarwasz commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2047451913

   > maybe we can mark this dependency as runtime optional instead of test?
   
   Personally I am not a big fan of `optional` or `provided` dependencies: their role is documentation only. The meaning is pretty much up to each developer to interpret. I interpret `provided` as ""we don't bundle Logback, but you **need** it for Zookeeper to run"". Regarding `optional` I interpret it as ""some Zookeeper features only work with Logback"" (a Logback appender maybe?). I think the message that should be sent to users is ""Zookeeper prefers/recommends Logback, but it will work with whatever SLF4J implementation your provide him"".
   
   Inside the Zookeeper project their usefulness is also somehow limited: the Maven Compiler and Surefire plugins will use them, but the Maven Assembly plugin will not package them in the `tar.gz` archive.
   
   So the only difference between runtime `optional` and `test` is that Logback is available at compilation time. This **is not** an advantage: if Zookeeper fails to compile without Logback, it means that it references some Logback-specific classes.
   
   **Remark**: The way Logback is treated in this PR is similar to the Jetty dependency. Jetty is included in the `tar.gz`, but there are no runtime dependencies on it.


;10/Apr/24 12:48;githubbot;600","ctubbsii commented on code in PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#discussion_r1559857699


##########
zookeeper-server/pom.xml:
##########
@@ -177,6 +169,11 @@
       <artifactId>tools</artifactId>
       <scope>test</scope>
     </dependency>
+    <dependency>
+      <groupId>ch.qos.logback</groupId>
+      <artifactId>logback-classic</artifactId>
+      <scope>test</scope>
+    </dependency>

Review Comment:
   There are two requirements here:
   
   1. Ensure it's available for the tests, which require it, and
   2. Ensure it is excluded by default from any project that depends on this one.
   
   Specifying it as a test scope achieves both of these. And, because runtime scope is included in the test classpath, specifying it as an optional runtime dependency would also achieve both of these.
   
   However, specifying an optional runtime dependency here would be a bit more helpful, because users generally familiar with Java logging frameworks would understand that there's a runtime component that they need to add themselves. This is not clear when it's only added to the test scope.



##########
zookeeper-assembly/pom.xml:
##########
@@ -103,6 +103,10 @@
       <groupId>jline</groupId>
       <artifactId>jline</artifactId>
     </dependency>
+    <dependency>
+      <groupId>ch.qos.logback</groupId>
+      <artifactId>logback-classic</artifactId>
+    </dependency>

Review Comment:
   This is good because it actually is an explicit dependency of the assembly. This project requires it in the bundle it creates. So, regardless of what happens in the other pom.xml, this is correct.



;10/Apr/24 17:52;githubbot;600","ppkarwasz commented on code in PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#discussion_r1559874907


##########
zookeeper-server/pom.xml:
##########
@@ -177,6 +169,11 @@
       <artifactId>tools</artifactId>
       <scope>test</scope>
     </dependency>
+    <dependency>
+      <groupId>ch.qos.logback</groupId>
+      <artifactId>logback-classic</artifactId>
+      <scope>test</scope>
+    </dependency>

Review Comment:
   I don't really have a preference, since functionally the two declarations are the same.
   
   I switched to `optional` in the `runtime` scope.



;10/Apr/24 18:09;githubbot;600","ctubbsii commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2048181083

   > Personally I am not a big fan of `optional` or `provided` dependencies: their role is documentation only.
   
   It affects behavior, so I would not say it's documentation only. But even if it were, there is value in documentation... in communicating intent to downstream consumers of the project.
   
   > The meaning is pretty much up to each developer to interpret. I interpret `provided` as ""we don't bundle Logback, but you **need** it for Zookeeper to run"". Regarding `optional` I interpret it as ""some Zookeeper features only work with Logback"" (a Logback appender maybe?).
   
   Maven [actually defines](https://maven.apache.org/guides/introduction/introduction-to-optional-and-excludes-dependencies.html) the [meaning of these](https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html). I think your interpretation is pretty much correct, because it aligns with these definitions, but I don't think it's as subjective as you suggest. These definitions are what developers use to implement behavioral differences.
   
   Optional just means you have the option to exclude it and that Maven does so by default. It doesn't say anything about what behavioral changes might result or what you might require in its place, though, if you choose to exclude it. For that, you kind of have to know something about what is being excluded and why. A little understanding of Java logging frameworks like slf4j close this gap, though, and it will be clear to most users that the runtime implementation of slf4j is interchangeable, and that's why this implementation is optional. So, I don't think it'd be a problem to mark it as optional.
   
   > I think the message that should be sent to users is ""Zookeeper prefers/recommends Logback, but it will work with whatever SLF4J implementation your provide him"".
   
   I would say ""happens to use"" rather than ""prefers/recommends"", but yes, I think that message is basically the right message. But I think that message can be communicated with optional, and a basic understanding of Java logging frameworks.
   
   > Inside the Zookeeper project their usefulness is also somehow limited: the Maven Compiler and Surefire plugins will use them, but the Maven Assembly plugin will not package them in the `tar.gz` archive.
   > 
   > So the only difference between runtime `optional` and `test` is that Logback is available at compilation time. This **is not** an advantage: if Zookeeper fails to compile without Logback, it means that it references some Logback-specific classes.
   
   This is not true. There's actually no difference here. If it's marked optional alone, but still in the default ""compile"" scope, it will be available at compilation time. However, if it's marked ""runtime"", it is not available at compilation time... only test. That's why ""optional"" is frequently used in conjunction with ""runtime"" scope. So, there's actually no difference in behavior between these... it really just comes down to communicating intent.
   
   > 
   > **Remark**: The way Logback is treated in this PR is similar to the Jetty dependency. Jetty is included in the `tar.gz`, but there are no runtime dependencies on it.
   
   This is a strange comparison, because jetty is actually marked as provided, which puts it on the compile and runtime classpaths. So, contrary to what you just said, there actually *is* a runtime dependency for it. I would actually argue that these should just be regular compile (or runtime) dependencies, though, and not marked provided, since it's probably not expected that jetty will be provided by another project, since it's provided by this one. But that's outside the scope of this change.
   
   In any case, because ZooKeeper does actually have a compile time dependency on logback for its tests, I think marking it as a test dependency is fine, since it achieves the same thing as a runtime optional dependency, but I would still prefer runtime optional over test, because it communicates that something is being omitted from the runtime scope that may need to be added in order to achieve particular functionality (logging).


;10/Apr/24 18:16;githubbot;600","ctubbsii commented on code in PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#discussion_r1559893434


##########
zookeeper-assembly/pom.xml:
##########
@@ -103,6 +103,10 @@
       <groupId>jline</groupId>
       <artifactId>jline</artifactId>
     </dependency>
+    <dependency>
+      <groupId>ch.qos.logback</groupId>
+      <artifactId>logback-classic</artifactId>
+    </dependency>

Review Comment:
   By convention, Apache Accumulo marks all of its assembly dependencies as ""optional"", just in case somebody actually depends on the tarball out of a Maven repository, it won't resolve all the dependencies that were used to build the tarball. We could have used ""provided"" instead for that purpose. But ultimately, it doesn't matter if you're not publishing the assembly to Maven. The conventions for dealing with assemblies in Maven repos kind of break all the norms used for jars. Either way, everything bundled in the assembly should be explicitly listed as a dependency, regardless of whatever other scopes/modifiers you put on them.



;10/Apr/24 18:25;githubbot;600","ppkarwasz commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2048289428

   > > The meaning is pretty much up to each developer to interpret. I interpret `provided` as ""we don't bundle Logback, but you **need** it for Zookeeper to run"". Regarding `optional` I interpret it as ""some Zookeeper features only work with Logback"" (a Logback appender maybe?).
   > 
   > Maven [actually defines](https://maven.apache.org/guides/introduction/introduction-to-optional-and-excludes-dependencies.html) the [meaning of these](https://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html). I think your interpretation is pretty much correct, because it aligns with these definitions, but I don't think it's as subjective as you suggest. These definitions are what developers use to implement behavioral differences.
   
   Inside the Zookeeper project I agree: there are behavioral differences. But if Zookeeper is used as a dependency in another project, the differences fade.
   
   >> I think the message that should be sent to users is ""Zookeeper prefers/recommends Logback, but it will work with whatever SLF4J implementation your provide him"".
   >
   > I would say ""happens to use"" rather than ""prefers/recommends"", but yes, I think that message is basically the right message. But I think that message can be communicated with optional, and a basic understanding of Java logging frameworks.
   
   Yes, it makes sense. I might steal your interpretation and add an optional runtime dependency on Logback to `log4j-to-slf4j`, although the proposal to make Log4j Core an optional runtime dependency of `log4j-slf4j2-impl` in [LOG4J2-3601](https://issues.apache.org/jira/browse/LOG4J2-3601) was not met with a big applause. :stuck_out_tongue_winking_eye: [Disclaimer: I understand that these examples give the user only one serious choice of logging backend, while Zookeeper has two]
   
   > > Inside the Zookeeper project their usefulness is also somehow limited: the Maven Compiler and Surefire plugins will use them, but the Maven Assembly plugin will not package them in the `tar.gz` archive.
   > > So the only difference between runtime `optional` and `test` is that Logback is available at compilation time. This **is not** an advantage: if Zookeeper fails to compile without Logback, it means that it references some Logback-specific classes.
   > 
   > This is not true. There's actually no difference here. If it's marked optional alone, but still in the default ""compile"" scope, it will be available at compilation time. However, if it's marked ""runtime"", it is not available at compilation time... only test. That's why ""optional"" is frequently used in conjunction with ""runtime"" scope. So, there's actually no difference in behavior between these... it really just comes down to communicating intent.
   
   Sorry, I was thinking `compile optional`. Thanks for correcting me.
   
   
   


;10/Apr/24 19:28;githubbot;600","ctubbsii commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2050713619

   > Yes, it makes sense. I might steal your interpretation and add an optional runtime dependency on Logback to `log4j-to-slf4j`, although the proposal to make Log4j Core an optional runtime dependency of `log4j-slf4j2-impl` in [LOG4J2-3601](https://issues.apache.org/jira/browse/LOG4J2-3601) was not met with a big applause. 😜 [Disclaimer: I understand that these examples give the user only one serious choice of logging backend, while Zookeeper has two]
   
   LOG4J2-3601 was a problem because:
   
   1. it was an unexpected change in behavior from `log4j-slf4j-impl` to `log4j-slf4j2-impl` to be more ""flexible"" that nobody asked for and made things inconvenient, and
   2. the new use cases it supported were nonsensical (they added an extra layer of log4j that wasn't needed and adding it for those use cases would have been bad practice)
   
   I suspect adding logback as an optional runtime dependency to `log4j-to-slf4j` is probably not a great idea, but for different reasons. For starters, choosing logback seems arbitrary and a less good default than, say, `slf4j-simple`. slf4j has many runtimes that are all optional, and logback is only one of them. It's not really necessary to list all of them as optional runtimes, or any of them. The website does a better job documenting how to bind runtimes than the XML in a POM would. It's also a different situation than here with ZK, where logback is in a different position because ZK chose logback as its default (and what it ships with). But, ZK also needs to more easily support other runtimes when ZK is used like a library dependency. That's very different than `log4j-to-slf4j` or `slfj-api`, where there is no default runtime selected. In any case, that's a discussion for the log4j community. Feel free to tag me in any discussions of that, though, if you want me to provide a review or an opinion there.


;11/Apr/24 23:29;githubbot;600","ctubbsii commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2050719455

   I did notice that there's a failing test, `zookeeper-contrib/zookeeper-contrib-zooinspector/src/test/java/org/apache/zookeeper/inspector/LoggerTest.java`
   
   I'm not sure if the test was failing before this. But, it doesn't look like a good test. It looks like it's testing the logging framework itself... which is outside the scope of ZK. That's a kind of test I would expect from upstream in the logging library. It makes no sense to be included in the zookeeper inspector contrib tests, since it has nothing to do with ZK or the inspector contrib. I would recommend just deleting the test. It's not needed, and serves no purpose for ZK.


;11/Apr/24 23:37;githubbot;600","ctubbsii commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2050722823

   Sorry, one more comment: looking at this closely, it looks like some updates might be needed to fix the logging dependencies in the contrib poms, too. They might also need similar changes as `zookeeper-server/pom.xml`, but I'm not very familiar with them... one of them, the fatjar one, based on its name, looks like it might need changes similar to the assembly... but I'm not really sure what purpose that contrib project serves, so I can't be certain.


;11/Apr/24 23:41;githubbot;600","kezhuw commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2310336972

   > with this change are you able to see the logs while running the unit tests ?
   
   Yes. I confirmed this. cc @eolivelli 


;26/Aug/24 14:19;githubbot;600","ctubbsii commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2359699808

   This looks like it was done and reviewed favorably, but never actually merged.


;19/Sep/24 00:59;githubbot;600","anmolnar merged PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155


;19/Sep/24 03:06;githubbot;600","anmolnar commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2359886678

   @ctubbsii Cool, thanks for the heads-up. I'm happy to commit patches for the upcoming 3.9.3 release.
   @ppkarwasz Thanks for the contribution, would you please assign the Jira to yourself?


;19/Sep/24 03:08;githubbot;600","ppkarwasz commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2359943237

   @anmolnar,
   
   I don't have enough permissions on JIRA to assign ZOOKEEPER issues. :wink: 


;19/Sep/24 04:18;githubbot;600","anmolnar commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2361310720

   > @anmolnar,
   > 
   > I don't have enough permissions on JIRA to assign ZOOKEEPER issues. 😉
   
   What's your jira id?


;19/Sep/24 15:14;githubbot;600","ppkarwasz commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2361561061

   > > @anmolnar,
   > > I don't have enough permissions on JIRA to assign ZOOKEEPER issues. 😉
   > 
   > What's your jira id?
   
   `pkarwasz` with one `p`.


;19/Sep/24 16:43;githubbot;600","anmolnar commented on PR #2155:
URL: https://github.com/apache/zookeeper/pull/2155#issuecomment-2362016552

   > > > @anmolnar,
   > > > I don't have enough permissions on JIRA to assign ZOOKEEPER issues. 😉
   > > 
   > > 
   > > What's your jira id?
   > 
   > `pkarwasz` with one `p`.
   
   It's done. Thanks!


;19/Sep/24 19:27;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,11400,,,0,11400,,,,,,ZOOKEEPER-4763,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Thu Sep 19 03:07:29 UTC 2024,,,,,,,,,,"0|z1o99k:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"27/Mar/24 17:39;ctubbsii;In case anybody wants to work on this, the right way to do this in Maven is to mark the dependency optional in addition to making it runtime:
{code:xml}
<optional>true</optional>
<scope>runtime</scope>
{code}
However, you have to be careful if you use any build automation that changing the dependency in this way doesn't cause it to be omitted from a distribution assembly, like a .tar.gz, or .zip file. This might happen if you use a maven-assembly-plugin assembly descriptor that bundles dependencies, but omits optional ones, for example. I'm not sure if the default behavior of [includeDependencies|https://maven.apache.org/plugins/maven-assembly-plugin/assembly.html] will include optional ones or not.;;;","27/Mar/24 17:43;fanningpj;or `<scope>provided</scope>`;;;","27/Mar/24 17:54;ctubbsii;Provided scope may achieve the same result for dependency resolution for dependent projects. However, they mean very different things. Provided means it's required, but not expected to be bundled because it is expected to be provided by the destination environment. In this case, we want the opposite: it's not required, but is expected to be bundled. However, there may be times where you need to use provided instead of using optional, because you need it to be handled in a specific way by a Maven plugin during the build, because different plugins do different things with these. For this, the correct way of doing it that communicates the relevant intent is to mark it optional and keep the scope as runtime. However, if provided is needed instead, to make a particular plugin work, you should understand that this may cause other problems downstream, and at the very least, you should add a comment in the POM explaining why provided is used instead, so the intention is clear.

For what it's worth, I think provided dependencies will be excluded by the maven-assembly-plugin, which is not what you want (but may not matter if the plugin is declared explicitly in the assembly descriptor). I'd stick with optional if it works.;;;","09/Apr/24 21:14;pkarwasz;In this case I find both the {{optional}} attribute and the {{provided}} scope inappropriate for the {{zookeeper}} artifact.

If Zookeeper were to have an {{optional}} dependency on Logback, it might suggest that some part of Zookeeper uses Logback *directly*, e.g. to manage and change log levels. AFAIK it is not the case.

If Zookeeper were to have a dependency on Logback in the {{provided}} scope, I would interpret it as a strict requirement to have Logback on the runtime classpath. AFAIK any other logging backend will work as well.;;;","19/Sep/24 03:07;andor;Issue resolved by pull request 2155
[https://github.com/apache/zookeeper/pull/2155];;;",,,,,,,
Can't seek for writable tls server if connected to readonly server,ZOOKEEPER-4819,13573337,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,luoxin,kezhuw,kezhuw,26/Mar/24 12:15,29/Aug/25 21:29,08/Dec/25 08:12,27/Nov/24 01:55,3.8.4,3.9.2,,,,,,,3.10.0,3.9.4,,java client,,,,0,pull-request-available,,,"{{[ClientCnxn::pingRwServer|https://github.com/apache/zookeeper/blob/d12aba599233b0fcba0b9b945ed3d2f45d4016f0/zookeeper-server/src/main/java/org/apache/zookeeper/ClientCnxn.java#L1280]}} uses raw socket to issue ""isro"" 4lw command. This results in unsuccessful handshake to tls server.",,"luoxiner opened a new pull request, #2200:
URL: https://github.com/apache/zookeeper/pull/2200

   ClientCnxn::pingRwServer uses raw socket to issue ""isro"" 4lw command. This results in unsuccessful handshake to tls server. Use SSLSocket when zookeeper.client.secure is set to true.
   
   associated jira issue [ZOOKEEPER-4819](https://issues.apache.org/jira/browse/ZOOKEEPER-4819)


;10/Oct/24 14:39;githubbot;600","kezhuw commented on PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#issuecomment-2408396452

   Great! I think we need tests.


;12/Oct/24 05:18;githubbot;600","luoxiner commented on PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#issuecomment-2408810881

   > Great! I think we need tests.
   
   Hi @kezhuw, I added a test case based on the ReadOnlyModeTest. Please take a look.


;13/Oct/24 04:03;githubbot;600","kezhuw commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1798176480


##########
zookeeper-server/src/main/java/org/apache/zookeeper/ClientCnxn.java:
##########
@@ -1348,6 +1351,28 @@ private void pingRwServer() throws RWServerFoundException {
             }
         }
 
+        private Socket newSocket(InetSocketAddress addr) throws IOException, X509Exception.SSLContextException {
+            boolean useSecure = clientConfig.getBoolean(ZKClientConfig.SECURE_CLIENT);
+            Socket sock;
+            if (useSecure) {
+                try (X509Util util = new ClientX509Util()) {
+                    SSLContext sslContext = util.createSSLContext(clientConfig);
+                    SSLSocketFactory socketFactory = sslContext.getSocketFactory();
+                    SSLSocket sslSock = (SSLSocket) socketFactory.createSocket();
+                    sslSock.connect(addr);

Review Comment:
   This could throw exception and leak `sslSock`.



##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeWithSSLTest.java:
##########
@@ -0,0 +1,135 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper;

Review Comment:
   ```suggestion
   package org.apache.zookeeper.test;
   ```



;13/Oct/24 09:05;githubbot;600","luoxiner commented on PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#issuecomment-2411455245

   @kezhuw  @eolivelli  Thank you for your reply. I have changed my code based on the suggestions. Please take a look.


;14/Oct/24 14:37;githubbot;600","kezhuw commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1800328858


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeWithSSLTest.java:
##########
@@ -0,0 +1,135 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertFalse;
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import java.io.ByteArrayOutputStream;
+import java.io.LineNumberReader;
+import java.io.StringReader;
+import java.util.regex.Pattern;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.client.ZKClientConfig;
+import org.apache.zookeeper.common.ClientX509Util;
+import org.apache.zookeeper.common.StringUtils;
+import org.apache.zookeeper.server.NettyServerCnxnFactory;
+import org.apache.zookeeper.server.ServerCnxnFactory;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.BeforeEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+import org.slf4j.LoggerFactory;
+
+public class ReadOnlyModeWithSSLTest extends ZKTestCase {
+
+    private static final org.slf4j.Logger LOG = LoggerFactory.getLogger(ReadOnlyModeWithSSLTest.class);
+    private static int CONNECTION_TIMEOUT = QuorumBase.CONNECTION_TIMEOUT;
+    private QuorumUtil qu = new QuorumUtil(1);
+    private ClientX509Util clientX509Util;
+
+    @BeforeEach
+    public void setUp() throws Exception {
+        System.setProperty(""readonlymode.enabled"", ""true"");
+        System.setProperty(NettyServerCnxnFactory.PORT_UNIFICATION_KEY, Boolean.TRUE.toString());
+        clientX509Util = new ClientX509Util();
+        String testDataPath = System.getProperty(""test.data.dir"", ""src/test/resources/data"");
+        System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY, ""org.apache.zookeeper.server.NettyServerCnxnFactory"");
+        System.setProperty(ZKClientConfig.ZOOKEEPER_CLIENT_CNXN_SOCKET, ""org.apache.zookeeper.ClientCnxnSocketNetty"");
+        System.setProperty(ZKClientConfig.SECURE_CLIENT, ""true"");
+        System.setProperty(clientX509Util.getSslKeystoreLocationProperty(), testDataPath + ""/ssl/testKeyStore.jks"");

Review Comment:
   These properties are mixed between client and server. I think we should build a `ZKClientConfig` for client usage prior to set them up for server(there is ZOOKEEPER-2139 counterpart in server) as  `ZKClientConfig` will inherit properties from system.
   
   https://github.com/apache/zookeeper/blob/75884ec1f4a680f46bcc0a6257df413955eda4e8/zookeeper-server/src/main/java/org/apache/zookeeper/common/ZKConfig.java#L95-L136



##########
zookeeper-server/src/main/java/org/apache/zookeeper/ClientCnxn.java:
##########
@@ -1301,44 +1300,19 @@ private void cleanAndNotifyState() {
         private void pingRwServer() throws RWServerFoundException {
             String result = null;
             InetSocketAddress addr = hostProvider.next(0);
+            boolean useSecure = clientConfig.getBoolean(ZKClientConfig.SECURE_CLIENT);
 
             LOG.info(""Checking server {} for being r/w. Timeout {}"", addr, pingRwTimeout);
-
-            Socket sock = null;
-            BufferedReader br = null;
             try {
-                sock = new Socket(addr.getHostString(), addr.getPort());
-                sock.setSoLinger(false, -1);
-                sock.setSoTimeout(1000);
-                sock.setTcpNoDelay(true);
-                sock.getOutputStream().write(""isro"".getBytes());
-                sock.getOutputStream().flush();
-                sock.shutdownOutput();
-                br = new BufferedReader(new InputStreamReader(sock.getInputStream()));
-                result = br.readLine();
+                result = FourLetterWordMain.send4LetterWord(addr.getHostString(), addr.getPort(), ""isro"", useSecure, 1000);

Review Comment:
   I think we should add a overloading `send4LetterWord` to accept `ZKConfig`, so we can sure that we are not mixed with external properties. Currently, `send4LetterWord` uses `new ZkConfig` which is not suitable for `ClientCnxn` after ZOOKEEPER-2139.
   
   https://github.com/apache/zookeeper/blob/75884ec1f4a680f46bcc0a6257df413955eda4e8/zookeeper-server/src/main/java/org/apache/zookeeper/common/X509Util.java#L340-L347



;15/Oct/24 02:45;githubbot;600","kezhuw commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1800361169


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeWithSSLTest.java:
##########
@@ -0,0 +1,135 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertFalse;
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import java.io.ByteArrayOutputStream;
+import java.io.LineNumberReader;
+import java.io.StringReader;
+import java.util.regex.Pattern;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.client.ZKClientConfig;
+import org.apache.zookeeper.common.ClientX509Util;
+import org.apache.zookeeper.common.StringUtils;
+import org.apache.zookeeper.server.NettyServerCnxnFactory;
+import org.apache.zookeeper.server.ServerCnxnFactory;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.BeforeEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+import org.slf4j.LoggerFactory;
+
+public class ReadOnlyModeWithSSLTest extends ZKTestCase {
+
+    private static final org.slf4j.Logger LOG = LoggerFactory.getLogger(ReadOnlyModeWithSSLTest.class);
+    private static int CONNECTION_TIMEOUT = QuorumBase.CONNECTION_TIMEOUT;
+    private QuorumUtil qu = new QuorumUtil(1);
+    private ClientX509Util clientX509Util;
+
+    @BeforeEach
+    public void setUp() throws Exception {
+        System.setProperty(""readonlymode.enabled"", ""true"");
+        System.setProperty(NettyServerCnxnFactory.PORT_UNIFICATION_KEY, Boolean.TRUE.toString());
+        clientX509Util = new ClientX509Util();
+        String testDataPath = System.getProperty(""test.data.dir"", ""src/test/resources/data"");
+        System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY, ""org.apache.zookeeper.server.NettyServerCnxnFactory"");
+        System.setProperty(ZKClientConfig.ZOOKEEPER_CLIENT_CNXN_SOCKET, ""org.apache.zookeeper.ClientCnxnSocketNetty"");
+        System.setProperty(ZKClientConfig.SECURE_CLIENT, ""true"");
+        System.setProperty(clientX509Util.getSslKeystoreLocationProperty(), testDataPath + ""/ssl/testKeyStore.jks"");

Review Comment:
   The test passed since `send4LetterWord` will inherit these properties in `setUp` for server side. I would be really good to not populate any properties for this test. But it is not possible currently. I created ZOOKEEPER-4875 instead.



;15/Oct/24 03:05;githubbot;600","kezhuw commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1800361169


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeWithSSLTest.java:
##########
@@ -0,0 +1,135 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertFalse;
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import java.io.ByteArrayOutputStream;
+import java.io.LineNumberReader;
+import java.io.StringReader;
+import java.util.regex.Pattern;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.client.ZKClientConfig;
+import org.apache.zookeeper.common.ClientX509Util;
+import org.apache.zookeeper.common.StringUtils;
+import org.apache.zookeeper.server.NettyServerCnxnFactory;
+import org.apache.zookeeper.server.ServerCnxnFactory;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.BeforeEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+import org.slf4j.LoggerFactory;
+
+public class ReadOnlyModeWithSSLTest extends ZKTestCase {
+
+    private static final org.slf4j.Logger LOG = LoggerFactory.getLogger(ReadOnlyModeWithSSLTest.class);
+    private static int CONNECTION_TIMEOUT = QuorumBase.CONNECTION_TIMEOUT;
+    private QuorumUtil qu = new QuorumUtil(1);
+    private ClientX509Util clientX509Util;
+
+    @BeforeEach
+    public void setUp() throws Exception {
+        System.setProperty(""readonlymode.enabled"", ""true"");
+        System.setProperty(NettyServerCnxnFactory.PORT_UNIFICATION_KEY, Boolean.TRUE.toString());
+        clientX509Util = new ClientX509Util();
+        String testDataPath = System.getProperty(""test.data.dir"", ""src/test/resources/data"");
+        System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY, ""org.apache.zookeeper.server.NettyServerCnxnFactory"");
+        System.setProperty(ZKClientConfig.ZOOKEEPER_CLIENT_CNXN_SOCKET, ""org.apache.zookeeper.ClientCnxnSocketNetty"");
+        System.setProperty(ZKClientConfig.SECURE_CLIENT, ""true"");
+        System.setProperty(clientX509Util.getSslKeystoreLocationProperty(), testDataPath + ""/ssl/testKeyStore.jks"");

Review Comment:
   The test passed since `send4LetterWord` will inherit these properties in `setUp` for server side. It would be really good to not populate any properties for this test. But it is not possible currently. I created ZOOKEEPER-4875 instead.



;15/Oct/24 03:06;githubbot;600","luoxiner commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1800971332


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeWithSSLTest.java:
##########
@@ -0,0 +1,135 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertFalse;
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import java.io.ByteArrayOutputStream;
+import java.io.LineNumberReader;
+import java.io.StringReader;
+import java.util.regex.Pattern;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.client.ZKClientConfig;
+import org.apache.zookeeper.common.ClientX509Util;
+import org.apache.zookeeper.common.StringUtils;
+import org.apache.zookeeper.server.NettyServerCnxnFactory;
+import org.apache.zookeeper.server.ServerCnxnFactory;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.BeforeEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+import org.slf4j.LoggerFactory;
+
+public class ReadOnlyModeWithSSLTest extends ZKTestCase {
+
+    private static final org.slf4j.Logger LOG = LoggerFactory.getLogger(ReadOnlyModeWithSSLTest.class);
+    private static int CONNECTION_TIMEOUT = QuorumBase.CONNECTION_TIMEOUT;
+    private QuorumUtil qu = new QuorumUtil(1);
+    private ClientX509Util clientX509Util;
+
+    @BeforeEach
+    public void setUp() throws Exception {
+        System.setProperty(""readonlymode.enabled"", ""true"");
+        System.setProperty(NettyServerCnxnFactory.PORT_UNIFICATION_KEY, Boolean.TRUE.toString());
+        clientX509Util = new ClientX509Util();
+        String testDataPath = System.getProperty(""test.data.dir"", ""src/test/resources/data"");
+        System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY, ""org.apache.zookeeper.server.NettyServerCnxnFactory"");
+        System.setProperty(ZKClientConfig.ZOOKEEPER_CLIENT_CNXN_SOCKET, ""org.apache.zookeeper.ClientCnxnSocketNetty"");
+        System.setProperty(ZKClientConfig.SECURE_CLIENT, ""true"");
+        System.setProperty(clientX509Util.getSslKeystoreLocationProperty(), testDataPath + ""/ssl/testKeyStore.jks"");

Review Comment:
   Is it preferable to prioritize the use of ClientConfig over system properties？ If the properties are not already set in the ClientConfig, then we can retrieve them from the system properties. We can also maintain backward compatibility and ensure that properties in ClientConfig remain isolated in this manner.



;15/Oct/24 11:16;githubbot;600","kezhuw commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1801233489


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeWithSSLTest.java:
##########
@@ -0,0 +1,135 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertFalse;
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import java.io.ByteArrayOutputStream;
+import java.io.LineNumberReader;
+import java.io.StringReader;
+import java.util.regex.Pattern;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.client.ZKClientConfig;
+import org.apache.zookeeper.common.ClientX509Util;
+import org.apache.zookeeper.common.StringUtils;
+import org.apache.zookeeper.server.NettyServerCnxnFactory;
+import org.apache.zookeeper.server.ServerCnxnFactory;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.BeforeEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+import org.slf4j.LoggerFactory;
+
+public class ReadOnlyModeWithSSLTest extends ZKTestCase {
+
+    private static final org.slf4j.Logger LOG = LoggerFactory.getLogger(ReadOnlyModeWithSSLTest.class);
+    private static int CONNECTION_TIMEOUT = QuorumBase.CONNECTION_TIMEOUT;
+    private QuorumUtil qu = new QuorumUtil(1);
+    private ClientX509Util clientX509Util;
+
+    @BeforeEach
+    public void setUp() throws Exception {
+        System.setProperty(""readonlymode.enabled"", ""true"");
+        System.setProperty(NettyServerCnxnFactory.PORT_UNIFICATION_KEY, Boolean.TRUE.toString());
+        clientX509Util = new ClientX509Util();
+        String testDataPath = System.getProperty(""test.data.dir"", ""src/test/resources/data"");
+        System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY, ""org.apache.zookeeper.server.NettyServerCnxnFactory"");
+        System.setProperty(ZKClientConfig.ZOOKEEPER_CLIENT_CNXN_SOCKET, ""org.apache.zookeeper.ClientCnxnSocketNetty"");
+        System.setProperty(ZKClientConfig.SECURE_CLIENT, ""true"");
+        System.setProperty(clientX509Util.getSslKeystoreLocationProperty(), testDataPath + ""/ssl/testKeyStore.jks"");

Review Comment:
   > Is it preferable to prioritize the use of ClientConfig over system properties？
   
   Client should use `ZKClientConfig` instead system properties after constructed. It not, it is a bug. So, https://github.com/apache/zookeeper/commit/33c19e370d78a7bc0ab4a9e8b085b4cf8191123d#diff-9657d4a14708c9ec1df56fd01581a442e10ef70cae39c7223d4f979b0ae54263R1307 is buggy as it does not use the one in constructor but the `new ZkConfig()`. These two are necessary to have same properties. It should use `ClientCnxn.clientConfig` which means https://github.com/apache/zookeeper/commit/b13e1966efc8006f7b5be813329751939a83c26b#diff-9657d4a14708c9ec1df56fd01581a442e10ef70cae39c7223d4f979b0ae54263R1359 is correct.
   
   https://github.com/apache/zookeeper/blob/b99714543db86ca081a5d648c565f0d9cb4c82c2/zookeeper-server/src/main/java/org/apache/zookeeper/ZooKeeper.java#L1099
   
   > If the properties are not already set in the ClientConfig, then we can retrieve them from the system properties.
   
   This is already done in construction of a `ZKConfig`.



;15/Oct/24 13:59;githubbot;600","kezhuw commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1801233489


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeWithSSLTest.java:
##########
@@ -0,0 +1,135 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertFalse;
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import java.io.ByteArrayOutputStream;
+import java.io.LineNumberReader;
+import java.io.StringReader;
+import java.util.regex.Pattern;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.client.ZKClientConfig;
+import org.apache.zookeeper.common.ClientX509Util;
+import org.apache.zookeeper.common.StringUtils;
+import org.apache.zookeeper.server.NettyServerCnxnFactory;
+import org.apache.zookeeper.server.ServerCnxnFactory;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.BeforeEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+import org.slf4j.LoggerFactory;
+
+public class ReadOnlyModeWithSSLTest extends ZKTestCase {
+
+    private static final org.slf4j.Logger LOG = LoggerFactory.getLogger(ReadOnlyModeWithSSLTest.class);
+    private static int CONNECTION_TIMEOUT = QuorumBase.CONNECTION_TIMEOUT;
+    private QuorumUtil qu = new QuorumUtil(1);
+    private ClientX509Util clientX509Util;
+
+    @BeforeEach
+    public void setUp() throws Exception {
+        System.setProperty(""readonlymode.enabled"", ""true"");
+        System.setProperty(NettyServerCnxnFactory.PORT_UNIFICATION_KEY, Boolean.TRUE.toString());
+        clientX509Util = new ClientX509Util();
+        String testDataPath = System.getProperty(""test.data.dir"", ""src/test/resources/data"");
+        System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY, ""org.apache.zookeeper.server.NettyServerCnxnFactory"");
+        System.setProperty(ZKClientConfig.ZOOKEEPER_CLIENT_CNXN_SOCKET, ""org.apache.zookeeper.ClientCnxnSocketNetty"");
+        System.setProperty(ZKClientConfig.SECURE_CLIENT, ""true"");
+        System.setProperty(clientX509Util.getSslKeystoreLocationProperty(), testDataPath + ""/ssl/testKeyStore.jks"");

Review Comment:
   > Is it preferable to prioritize the use of ClientConfig over system properties？
   
   Client should use `ZKClientConfig` instead system properties after constructed. If not, it is a bug. So, https://github.com/apache/zookeeper/commit/33c19e370d78a7bc0ab4a9e8b085b4cf8191123d#diff-9657d4a14708c9ec1df56fd01581a442e10ef70cae39c7223d4f979b0ae54263R1307 is buggy as it does not use the one in constructor but the `new ZkConfig()`. These two are necessary to have same properties. It should use `ClientCnxn.clientConfig` which means https://github.com/apache/zookeeper/commit/b13e1966efc8006f7b5be813329751939a83c26b#diff-9657d4a14708c9ec1df56fd01581a442e10ef70cae39c7223d4f979b0ae54263R1359 is correct.
   
   https://github.com/apache/zookeeper/blob/b99714543db86ca081a5d648c565f0d9cb4c82c2/zookeeper-server/src/main/java/org/apache/zookeeper/ZooKeeper.java#L1099
   
   > If the properties are not already set in the ClientConfig, then we can retrieve them from the system properties.
   
   This is already done in construction of a `ZKConfig`.



;15/Oct/24 14:00;githubbot;600","kezhuw commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1801233489


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeWithSSLTest.java:
##########
@@ -0,0 +1,135 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertFalse;
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import java.io.ByteArrayOutputStream;
+import java.io.LineNumberReader;
+import java.io.StringReader;
+import java.util.regex.Pattern;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.client.ZKClientConfig;
+import org.apache.zookeeper.common.ClientX509Util;
+import org.apache.zookeeper.common.StringUtils;
+import org.apache.zookeeper.server.NettyServerCnxnFactory;
+import org.apache.zookeeper.server.ServerCnxnFactory;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.BeforeEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+import org.slf4j.LoggerFactory;
+
+public class ReadOnlyModeWithSSLTest extends ZKTestCase {
+
+    private static final org.slf4j.Logger LOG = LoggerFactory.getLogger(ReadOnlyModeWithSSLTest.class);
+    private static int CONNECTION_TIMEOUT = QuorumBase.CONNECTION_TIMEOUT;
+    private QuorumUtil qu = new QuorumUtil(1);
+    private ClientX509Util clientX509Util;
+
+    @BeforeEach
+    public void setUp() throws Exception {
+        System.setProperty(""readonlymode.enabled"", ""true"");
+        System.setProperty(NettyServerCnxnFactory.PORT_UNIFICATION_KEY, Boolean.TRUE.toString());
+        clientX509Util = new ClientX509Util();
+        String testDataPath = System.getProperty(""test.data.dir"", ""src/test/resources/data"");
+        System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY, ""org.apache.zookeeper.server.NettyServerCnxnFactory"");
+        System.setProperty(ZKClientConfig.ZOOKEEPER_CLIENT_CNXN_SOCKET, ""org.apache.zookeeper.ClientCnxnSocketNetty"");
+        System.setProperty(ZKClientConfig.SECURE_CLIENT, ""true"");
+        System.setProperty(clientX509Util.getSslKeystoreLocationProperty(), testDataPath + ""/ssl/testKeyStore.jks"");

Review Comment:
   > Is it preferable to prioritize the use of ClientConfig over system properties？
   
   Client should use `ZKClientConfig` instead system properties after constructed. If not, it is a bug. So, https://github.com/apache/zookeeper/commit/33c19e370d78a7bc0ab4a9e8b085b4cf8191123d#diff-9657d4a14708c9ec1df56fd01581a442e10ef70cae39c7223d4f979b0ae54263R1307 is buggy as it does not use the one in constructor but the `new ZkConfig()`. These two are not necessary to have same properties. It should use `ClientCnxn.clientConfig` which means https://github.com/apache/zookeeper/commit/b13e1966efc8006f7b5be813329751939a83c26b#diff-9657d4a14708c9ec1df56fd01581a442e10ef70cae39c7223d4f979b0ae54263R1359 is correct.
   
   https://github.com/apache/zookeeper/blob/b99714543db86ca081a5d648c565f0d9cb4c82c2/zookeeper-server/src/main/java/org/apache/zookeeper/ZooKeeper.java#L1099
   
   > If the properties are not already set in the ClientConfig, then we can retrieve them from the system properties.
   
   This is already done in construction of a `ZKConfig`.



;15/Oct/24 14:00;githubbot;600","kezhuw commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1801237954


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeWithSSLTest.java:
##########
@@ -0,0 +1,135 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertFalse;
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import java.io.ByteArrayOutputStream;
+import java.io.LineNumberReader;
+import java.io.StringReader;
+import java.util.regex.Pattern;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.client.ZKClientConfig;
+import org.apache.zookeeper.common.ClientX509Util;
+import org.apache.zookeeper.common.StringUtils;
+import org.apache.zookeeper.server.NettyServerCnxnFactory;
+import org.apache.zookeeper.server.ServerCnxnFactory;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.BeforeEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+import org.slf4j.LoggerFactory;
+
+public class ReadOnlyModeWithSSLTest extends ZKTestCase {
+
+    private static final org.slf4j.Logger LOG = LoggerFactory.getLogger(ReadOnlyModeWithSSLTest.class);
+    private static int CONNECTION_TIMEOUT = QuorumBase.CONNECTION_TIMEOUT;
+    private QuorumUtil qu = new QuorumUtil(1);
+    private ClientX509Util clientX509Util;
+
+    @BeforeEach
+    public void setUp() throws Exception {
+        System.setProperty(""readonlymode.enabled"", ""true"");
+        System.setProperty(NettyServerCnxnFactory.PORT_UNIFICATION_KEY, Boolean.TRUE.toString());
+        clientX509Util = new ClientX509Util();
+        String testDataPath = System.getProperty(""test.data.dir"", ""src/test/resources/data"");
+        System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY, ""org.apache.zookeeper.server.NettyServerCnxnFactory"");
+        System.setProperty(ZKClientConfig.ZOOKEEPER_CLIENT_CNXN_SOCKET, ""org.apache.zookeeper.ClientCnxnSocketNetty"");
+        System.setProperty(ZKClientConfig.SECURE_CLIENT, ""true"");
+        System.setProperty(clientX509Util.getSslKeystoreLocationProperty(), testDataPath + ""/ssl/testKeyStore.jks"");

Review Comment:
   > Client should use ZKClientConfig instead system properties after constructed. If not, it is a bug. 
   
   This is the whole point of ZOOKEEPER-2139.



;15/Oct/24 14:02;githubbot;600","luoxiner commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1804038938


##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeWithSSLTest.java:
##########
@@ -0,0 +1,135 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertFalse;
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import java.io.ByteArrayOutputStream;
+import java.io.LineNumberReader;
+import java.io.StringReader;
+import java.util.regex.Pattern;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.client.ZKClientConfig;
+import org.apache.zookeeper.common.ClientX509Util;
+import org.apache.zookeeper.common.StringUtils;
+import org.apache.zookeeper.server.NettyServerCnxnFactory;
+import org.apache.zookeeper.server.ServerCnxnFactory;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.BeforeEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+import org.slf4j.LoggerFactory;
+
+public class ReadOnlyModeWithSSLTest extends ZKTestCase {
+
+    private static final org.slf4j.Logger LOG = LoggerFactory.getLogger(ReadOnlyModeWithSSLTest.class);
+    private static int CONNECTION_TIMEOUT = QuorumBase.CONNECTION_TIMEOUT;
+    private QuorumUtil qu = new QuorumUtil(1);
+    private ClientX509Util clientX509Util;
+
+    @BeforeEach
+    public void setUp() throws Exception {
+        System.setProperty(""readonlymode.enabled"", ""true"");
+        System.setProperty(NettyServerCnxnFactory.PORT_UNIFICATION_KEY, Boolean.TRUE.toString());
+        clientX509Util = new ClientX509Util();
+        String testDataPath = System.getProperty(""test.data.dir"", ""src/test/resources/data"");
+        System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY, ""org.apache.zookeeper.server.NettyServerCnxnFactory"");
+        System.setProperty(ZKClientConfig.ZOOKEEPER_CLIENT_CNXN_SOCKET, ""org.apache.zookeeper.ClientCnxnSocketNetty"");
+        System.setProperty(ZKClientConfig.SECURE_CLIENT, ""true"");
+        System.setProperty(clientX509Util.getSslKeystoreLocationProperty(), testDataPath + ""/ssl/testKeyStore.jks"");

Review Comment:
   Yes, I realize that ZKConfig#init is only called when we construct ZKConfig with empty parameters. I had missed this before. I will fix it based on your comments later.



;17/Oct/24 02:58;githubbot;600","kezhuw commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1804267468


##########
zookeeper-server/src/main/java/org/apache/zookeeper/ClientCnxn.java:
##########
@@ -1303,42 +1302,16 @@ private void pingRwServer() throws RWServerFoundException {
             InetSocketAddress addr = hostProvider.next(0);
 
             LOG.info(""Checking server {} for being r/w. Timeout {}"", addr, pingRwTimeout);
-
-            Socket sock = null;
-            BufferedReader br = null;
             try {
-                sock = new Socket(addr.getHostString(), addr.getPort());
-                sock.setSoLinger(false, -1);
-                sock.setSoTimeout(1000);
-                sock.setTcpNoDelay(true);

Review Comment:
   The other two sock options are also suitable for `send4LetterWord`.



##########
zookeeper-server/src/main/java/org/apache/zookeeper/client/FourLetterWordMain.java:
##########
@@ -94,6 +94,33 @@ public static String send4LetterWord(
         return send4LetterWord(host, port, cmd, secure, timeout, null);
     }
 
+    /**
+     * Send the 4letterword
+     * @param host the destination host
+     * @param port the destination port
+     * @param cmd the 4letterword
+     * @param timeout in milliseconds, maximum time to wait while connecting/reading data
+     * @param clientConfig client config
+     * @return server response
+     * @throws SSLContextException
+     * @throws IOException
+     */
+    public static String send4LetterWord(
+            String host,
+            int port,
+            String cmd,
+            int timeout,
+            ZKClientConfig clientConfig) throws SSLContextException, IOException {

Review Comment:
   Keep `timeout` the last to consistent with `String send4LetterWord(String host, int port, String cmd, boolean secure, int timeout)` ?



##########
zookeeper-server/src/test/java/org/apache/zookeeper/test/ReadOnlyModeWithSSLTest.java:
##########
@@ -0,0 +1,135 @@
+/*
+ * Licensed to the Apache Software Foundation (ASF) under one
+ * or more contributor license agreements.  See the NOTICE file
+ * distributed with this work for additional information
+ * regarding copyright ownership.  The ASF licenses this file
+ * to you under the Apache License, Version 2.0 (the
+ * ""License""); you may not use this file except in compliance
+ * with the License.  You may obtain a copy of the License at
+ *
+ *     http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an ""AS IS"" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package org.apache.zookeeper.test;
+
+import static org.junit.jupiter.api.Assertions.assertFalse;
+import static org.junit.jupiter.api.Assertions.assertTrue;
+import java.io.ByteArrayOutputStream;
+import java.io.LineNumberReader;
+import java.io.StringReader;
+import java.util.regex.Pattern;
+import org.apache.zookeeper.CreateMode;
+import org.apache.zookeeper.ZKTestCase;
+import org.apache.zookeeper.ZooDefs;
+import org.apache.zookeeper.ZooKeeper;
+import org.apache.zookeeper.client.ZKClientConfig;
+import org.apache.zookeeper.common.ClientX509Util;
+import org.apache.zookeeper.common.StringUtils;
+import org.apache.zookeeper.server.NettyServerCnxnFactory;
+import org.apache.zookeeper.server.ServerCnxnFactory;
+import org.junit.jupiter.api.AfterEach;
+import org.junit.jupiter.api.BeforeEach;
+import org.junit.jupiter.api.Test;
+import org.junit.jupiter.api.Timeout;
+import org.slf4j.LoggerFactory;
+
+public class ReadOnlyModeWithSSLTest extends ZKTestCase {
+
+    private static final org.slf4j.Logger LOG = LoggerFactory.getLogger(ReadOnlyModeWithSSLTest.class);
+    private static int CONNECTION_TIMEOUT = QuorumBase.CONNECTION_TIMEOUT;
+    private QuorumUtil qu = new QuorumUtil(1);
+    private ClientX509Util clientX509Util;
+
+    @BeforeEach
+    public void setUp() throws Exception {
+        System.setProperty(""readonlymode.enabled"", ""true"");
+        System.setProperty(NettyServerCnxnFactory.PORT_UNIFICATION_KEY, Boolean.TRUE.toString());
+        clientX509Util = new ClientX509Util();
+        String testDataPath = System.getProperty(""test.data.dir"", ""src/test/resources/data"");
+        System.setProperty(ServerCnxnFactory.ZOOKEEPER_SERVER_CNXN_FACTORY, ""org.apache.zookeeper.server.NettyServerCnxnFactory"");
+        System.setProperty(ZKClientConfig.ZOOKEEPER_CLIENT_CNXN_SOCKET, ""org.apache.zookeeper.ClientCnxnSocketNetty"");
+        System.setProperty(ZKClientConfig.SECURE_CLIENT, ""true"");
+        System.setProperty(clientX509Util.getSslKeystoreLocationProperty(), testDataPath + ""/ssl/testKeyStore.jks"");

Review Comment:
   We can revise here once ZOOKEEPER-4875 delivered.



;17/Oct/24 07:42;githubbot;600","kezhuw commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1809047490


##########
zookeeper-server/src/main/java/org/apache/zookeeper/client/FourLetterWordMain.java:
##########
@@ -137,7 +195,9 @@ public static String send4LetterWord(
                 sock = new Socket();
                 sock.connect(hostaddress, timeout);
             }
+            sock.setSoLinger(soLingerOn, soLinger);
             sock.setSoTimeout(timeout);
+            sock.setTcpNoDelay(tcpNoDelay);

Review Comment:
   ```suggestion
               sock.setSoLinger(false, -1);
               sock.setSoTimeout(timeout);
               sock.setTcpNoDelay(true);
   ```
   
   Sorry for my distractive review comments. I means these two options are suitable for `send4LetterWord` for reasons:
   1. `send4LetterWord` is one-shot, it is better to send request immediately and return immediately once got response to not block caller.
   2. `sock.setTcpNoDelay(true)` tells kernel to not delay any send operations.
   3. `sock.setSoLinger(false, -1)` tells kernel to not block `close`.
   
   I think there is little chance for people to configure them if any.



;21/Oct/24 15:31;githubbot;600","kezhuw commented on code in PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#discussion_r1811842648


##########
zookeeper-server/src/main/java/org/apache/zookeeper/client/FourLetterWordMain.java:
##########
@@ -94,6 +94,33 @@ public static String send4LetterWord(
         return send4LetterWord(host, port, cmd, secure, timeout, null);
     }
 
+    /**
+     * Send the 4letterword
+     * @param host the destination host
+     * @param port the destination port
+     * @param cmd the 4letterword
+     * @param timeout in milliseconds, maximum time to wait while connecting/reading data
+     * @param clientConfig client config

Review Comment:
   ```suggestion
        * @param clientConfig client config
        * @param timeout in milliseconds, maximum time to wait while connecting/reading data
   ```



;23/Oct/24 04:58;githubbot;600","kezhuw commented on PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#issuecomment-2430906324

   Looks good from my side.
   
   @eolivelli Would you want take another look ?


;23/Oct/24 05:00;githubbot;600","kezhuw merged PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200


;27/Nov/24 01:21;githubbot;600","kezhuw commented on PR #2200:
URL: https://github.com/apache/zookeeper/pull/2200#issuecomment-2502487118

   @luoxiner Thank you for your contribution! Merged.


;27/Nov/24 01:55;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,0,12000,,,0,12000,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Nov 27 01:55:21 UTC 2024,,,,,,,,,,"0|z1o7wg:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"30/Sep/24 11:43;luoxin;[~kezhuw]  I can take a look and resolve it. Can you assign this issue to me ?

It seems we should make a socket from SSLSocketFactory with specified trustStore info when zookeeper.client.secure=true;;;","10/Oct/24 14:40;luoxin;Hi [~kezhuw] 

I submit a pr to resolve it, can you take a look?;;;","27/Nov/24 01:55;kezhuw;master: 75f9781ecc3cde9fa5a032fa8cfa8c79b69ef879
branch-3.9: 644dcdbc9ac2b5e4a00dcaca7de4db26e923b59f;;;",,,,,,,,,
Protocol desynchronization after Connect for (some) old clients,ZOOKEEPER-4814,13571158,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,ztzg,ztzg,ztzg,07/Mar/24 15:08,29/May/25 10:43,08/Dec/25 08:12,11/Aug/24 16:14,3.9.0,,,,,,,,3.10.0,3.9.3,,server,,,,0,pull-request-available,,,"Some old clients experience a protocol synchronization after receiving a {{ConnectResponse}} from the server.

This started happening with ZOOKEEPER-4492, ""Merge readOnly field into ConnectRequest and Response,"" which writes overlong responses to clients which do not know about the {{readOnly}} flag.

(One example of such a client is ZooKeeper's own C client library prior to version 3.5!)",,"ztzg opened a new pull request, #2146:
URL: https://github.com/apache/zookeeper/pull/2146

   The `ProtocolManager` class knows whether the client sent a `readOnly` flag as part of the `ConnectRequest`, and can use that information to, in turn, avoid the extra byte when serializing the `ConnectResponse`.


;07/Mar/24 16:59;githubbot;600","kezhuw merged PR #2146:
URL: https://github.com/apache/zookeeper/pull/2146


;11/Aug/24 15:55;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1200,,,0,1200,,,,,,,ZOOKEEPER-4492,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Sun Aug 11 16:15:15 UTC 2024,,,,,,,,,,"0|z1nufs:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"07/Mar/24 16:15;ztzg;Also related: [ClickHouse ticket, ""Incompatibility with Zookeeper 3.9""|https://github.com/ClickHouse/ClickHouse/issues/53749] whose custom (?) client was updated by [patch ""Add support for read-only mode in ZooKeeper""|https://github.com/ClickHouse/ClickHouse/pull/57479/files].
;;;","11/Aug/24 16:15;kezhuw;master: 90f8d835e065ea12dddd8ed9ca20872a4412c78a
branch-3.9: 4d68e3e56fadbee46907213449a0fe6da302e161;;;",,,,,,,,,,
Make zookeeper start successfully when the last log file is dirty during the restore progress,ZOOKEEPER-4813,13571109,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Duplicate,horizonzy,horizonzy,horizonzy,07/Mar/24 07:30,12/Sep/24 15:26,08/Dec/25 08:12,12/Sep/24 15:26,3.9.1,,,,,,,,,,,server,,,,0,pull-request-available,,,"When the zookeeper restarts, it will restore the data from the last valid snapshot file, and replay txn log to append data.
But if the last log file is empty due to some reason, the restore will fail, not make the zookeeper can not restart.

The logs as followings:
{noformat}
14:12:16.023 [main] INFO  org.apache.zookeeper.server.persistence.SnapStream - Invalid snapshot snapshot.188700025d87. len = 761554294, byte = 45
14:12:16.024 [main] INFO  org.apache.zookeeper.server.persistence.FileSnap - Reading snapshot /pulsar/data/zookeeper/version-2/snapshot.188700025a05
14:12:17.350 [main] INFO  org.apache.zookeeper.server.DataTree - The digest in the snapshot has digest version of 2, with zxid as 0x188700025b07, and digest value as 510776662607117
14:12:17.492 [main] ERROR org.apache.zookeeper.server.quorum.QuorumPeer - Unable to load database on disk
java.io.EOFException: null
	at java.io.DataInputStream.readInt(DataInputStream.java:386) ~[?:?]
	at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:96) ~[org.apache.zookeeper-zookeeper-jute-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileHeader.deserialize(FileHeader.java:67) ~[org.apache.zookeeper-zookeeper-jute-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.inStreamCreated(FileTxnLog.java:725) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.createInputArchive(FileTxnLog.java:743) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.goToNextLog(FileTxnLog.java:711) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.next(FileTxnLog.java:792) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnSnapLog.fastForwardFromEdits(FileTxnSnapLog.java:361) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnSnapLog.lambda$restore$0(FileTxnSnapLog.java:267) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:312) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:288) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:1149) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:1135) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:229) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:137) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:91) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
14:12:17.502 [main] INFO  org.apache.zookeeper.metrics.prometheus.PrometheusMetricsProvider - Shutdown executor service with timeout 1000
14:12:17.508 [main] INFO  org.eclipse.jetty.server.AbstractConnector - Stopped ServerConnector@2484f433{HTTP/1.1, (http/1.1)}{0.0.0.0:8000}
14:12:17.510 [main] INFO  org.eclipse.jetty.server.handler.ContextHandler - Stopped o.e.j.s.ServletContextHandler@59a67c3a{/,null,STOPPED}
14:12:17.515 [main] ERROR org.apache.zookeeper.server.quorum.QuorumPeerMain - Unexpected exception, exiting abnormally
java.lang.RuntimeException: Unable to run quorum server 
	at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:1204) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.quorum.QuorumPeer.start(QuorumPeer.java:1135) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.runFromConfig(QuorumPeerMain.java:229) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.initializeAndRun(QuorumPeerMain.java:137) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.quorum.QuorumPeerMain.main(QuorumPeerMain.java:91) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
Caused by: java.io.EOFException
	at java.io.DataInputStream.readInt(DataInputStream.java:386) ~[?:?]
	at org.apache.jute.BinaryInputArchive.readInt(BinaryInputArchive.java:96) ~[org.apache.zookeeper-zookeeper-jute-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileHeader.deserialize(FileHeader.java:67) ~[org.apache.zookeeper-zookeeper-jute-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.inStreamCreated(FileTxnLog.java:725) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.createInputArchive(FileTxnLog.java:743) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.goToNextLog(FileTxnLog.java:711) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnLog$FileTxnIterator.next(FileTxnLog.java:792) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnSnapLog.fastForwardFromEdits(FileTxnSnapLog.java:361) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnSnapLog.lambda$restore$0(FileTxnSnapLog.java:267) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.persistence.FileTxnSnapLog.restore(FileTxnSnapLog.java:312) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.ZKDatabase.loadDataBase(ZKDatabase.java:288) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	at org.apache.zookeeper.server.quorum.QuorumPeer.loadDataBase(QuorumPeer.java:1149) ~[org.apache.zookeeper-zookeeper-3.9.1.jar:3.9.1]
	... 4 more

{noformat}
 

In fact, if the last log file open failed, we can ignore the log file.",,"horizonzy opened a new pull request, #2144:
URL: https://github.com/apache/zookeeper/pull/2144

   (no comment)


;07/Mar/24 07:32;githubbot;600","kezhuw commented on PR #2144:
URL: https://github.com/apache/zookeeper/pull/2144#issuecomment-2310383779

   Duplicate of ZOOKEEPER-2332(#2141).


;26/Aug/24 14:40;githubbot;600","horizonzy commented on PR #2144:
URL: https://github.com/apache/zookeeper/pull/2144#issuecomment-2316582958

   Close via #2141


;29/Aug/24 02:14;githubbot;600","kezhuw commented on code in PR #2144:
URL: https://github.com/apache/zookeeper/pull/2144#discussion_r1751202609


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/persistence/FileTxnLog.java:
##########
@@ -708,7 +708,16 @@ public long getStorageSize() {
         private boolean goToNextLog() throws IOException {
             if (storedFiles.size() > 0) {
                 this.logFile = storedFiles.remove(storedFiles.size() - 1);
-                ia = createInputArchive(this.logFile);
+                try {
+                    ia = createInputArchive(this.logFile);
+                } catch (EOFException e) {
+                    if (storedFiles.isEmpty()) {
+                        LOG.warn(""The last log file {} EOF when create input archive, delete it."", logFile.getName(), e);
+                        logFile.deleteOnExit();

Review Comment:
   This is somewhat risky. It is not guaranteed that the deletion will ever happen. So it is possible this could introduce partially written file in median of log files.



;10/Sep/24 03:38;githubbot;600","kezhuw closed pull request #2144: ZOOKEEPER-4813: Make zookeeper start successfully when the last log file is dirty during the restore progress
URL: https://github.com/apache/zookeeper/pull/2144


;10/Sep/24 03:39;githubbot;600","kezhuw commented on PR #2144:
URL: https://github.com/apache/zookeeper/pull/2144#issuecomment-2339544012

   Closing in favor of https://github.com/apache/zookeeper/pull/2141 as I think `logFile.deleteOnExit()` is not reliable.


;10/Sep/24 03:39;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3600,,,0,3600,,,,,,ZOOKEEPER-2332,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2024-03-07 07:30:04.0,,,,,,,,,,"0|z1nu4w:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Fix data race in format_endpoint_info(),ZOOKEEPER-4810,13569151,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,fanyang,fanyang,fanyang,20/Feb/24 07:30,29/Aug/25 21:29,08/Dec/25 08:12,23/Jun/25 07:33,,,,,,,,,3.10.0,3.9.4,,c client,,,,0,pull-request-available,,,,,"fanyang89 opened a new pull request, #2140:
URL: https://github.com/apache/zookeeper/pull/2140

   format_endpoint_info() is widely called in the IO thread. And the some ZOOAPIs will call this method too: zoo_cycle_next_server() and zoo_get_current_server(). These APIs return the same static buffer read/write by IO thread causes data race.


;20/Feb/24 07:36;githubbot;600","kezhuw commented on code in PR #2140:
URL: https://github.com/apache/zookeeper/pull/2140#discussion_r1730668299


##########
zookeeper-client/zookeeper-client-c/src/zookeeper.c:
##########
@@ -5111,11 +5111,11 @@ int zoo_add_auth(zhandle_t *zh,const char* scheme,const char* cert,
 
 static const char* format_endpoint_info(const struct sockaddr_storage* ep)
 {
-    static char buf[134] = { 0 };
+    static __thread char buf[134] = { 0 };

Review Comment:
   Do we need a macro here to accommodate single thread version and different compilers ?
   
   cc @ztzg 
   



;26/Aug/24 05:01;githubbot;600","fanyang89 commented on code in PR #2140:
URL: https://github.com/apache/zookeeper/pull/2140#discussion_r1732011284


##########
zookeeper-client/zookeeper-client-c/src/zookeeper.c:
##########
@@ -5111,11 +5111,11 @@ int zoo_add_auth(zhandle_t *zh,const char* scheme,const char* cert,
 
 static const char* format_endpoint_info(const struct sockaddr_storage* ep)
 {
-    static char buf[134] = { 0 };
+    static __thread char buf[134] = { 0 };

Review Comment:
   `__thread` will do nothing in st mode, generating the same asm as without it



;27/Aug/24 01:42;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1800,,,0,1800,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Mon Jun 23 07:33:42 UTC 2025,,,,,,,,,,"0|z1ni1s:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"23/Jun/25 07:33;kezhuw;Issue resolved by pull request 2140
[https://github.com/apache/zookeeper/pull/2140];;;",,,,,,,,,,,
do_completion() use-after-free when log level is debug,ZOOKEEPER-4809,13569150,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,fanyang,fanyang,fanyang,20/Feb/24 07:17,17/Feb/25 01:59,08/Dec/25 08:12,02/Aug/24 05:03,3.7.2,3.8.4,3.9.2,,,,,,3.10.0,,,c client,,,,0,pull-request-available,,,"{code:c}
void *do_completion(void *v)
{
    zhandle_t *zh = v;
    // ...
    api_epilog(zh, 0);  // L1
    LOG_DEBUG(LOGCALLBACK(zh), ""completion thread terminated"");  // L2
    return 0;
}
{code}

When the log level is debug, L2 gets the log calback after zookeeper_close(), causes uaf.",,"fanyang89 opened a new pull request, #2139:
URL: https://github.com/apache/zookeeper/pull/2139

   The log callback needs to be obtained from freed zh when the log level is debug, resulting in used-after-free.


;20/Feb/24 07:18;githubbot;600","kezhuw commented on code in PR #2139:
URL: https://github.com/apache/zookeeper/pull/2139#discussion_r1525726768


##########
zookeeper-client/zookeeper-client-c/src/mt_adaptor.c:
##########
@@ -479,8 +480,9 @@ void *do_completion(void *v)
         pthread_mutex_unlock(&zh->completions_to_process.lock);
         process_completions(zh);
     }
-    api_epilog(zh, 0);    
-    LOG_DEBUG(LOGCALLBACK(zh), ""completion thread terminated"");

Review Comment:
   Is it more conventional to swap the two statements ? I saw several `return api_epilog(zh, rc)` patterns. Also, line 460 has same problem.



;15/Mar/24 03:55;githubbot;600","fanyang89 commented on code in PR #2139:
URL: https://github.com/apache/zookeeper/pull/2139#discussion_r1525732277


##########
zookeeper-client/zookeeper-client-c/src/mt_adaptor.c:
##########
@@ -479,8 +480,9 @@ void *do_completion(void *v)
         pthread_mutex_unlock(&zh->completions_to_process.lock);
         process_completions(zh);
     }
-    api_epilog(zh, 0);    
-    LOG_DEBUG(LOGCALLBACK(zh), ""completion thread terminated"");

Review Comment:
   Indeed, it would be conventional to log first and then `api_epilog()`.
   
   But `api_epilog()` does `zookeeper_close()` when the rc is zero, i.e. the completion thread is still running after the ""terminated"" output, which could lead to confusion?



;15/Mar/24 04:02;githubbot;600","eolivelli commented on PR #2139:
URL: https://github.com/apache/zookeeper/pull/2139#issuecomment-2002097035

   @ztzg can you please take a look?


;16/Mar/24 19:21;githubbot;600","kezhuw merged PR #2139:
URL: https://github.com/apache/zookeeper/pull/2139


;02/Aug/24 04:58;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3000,,,0,3000,,,,,ZOOKEEPER-4615,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Aug 02 05:03:13 UTC 2024,,,,,,,,,,"0|z1ni1k:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"02/Aug/24 05:03;kezhuw;master: 4e999c8708656ab18ea466607ee9859b517b680a;;;",,,,,,,,,,,
Fix the log statement in FastLeaderElection,ZOOKEEPER-4808,13568215,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Trivial,Fixed,li4wang,li4wang,li4wang,12/Feb/24 18:19,07/Jul/25 14:21,08/Dec/25 08:12,15/Jun/24 09:44,3.10.0,,,,,,,,3.10.0,,,server,,,,0,pull-request-available,,,"The proposedZxid and proposedEpoch is out of order in the following debug statement.

{code:java}

 LOG.debug(
                ""Sending Notification: {} (n.leader),  0x{} (n.peerEpoch), 0x{} (n.zxid), 0x{} (n.round), {} (recipient),""+underlined text+
                    + "" {} (myid) "",
                proposedLeader,
                Long.toHexString(proposedZxid),
                Long.toHexString(proposedEpoch),
                Long.toHexString(logicalclock.get()),
                sid,
                self.getMyId());

{code}





",,"li4wang opened a new pull request, #2136:
URL: https://github.com/apache/zookeeper/pull/2136

   Fixed the incorrect order of proposedZxid and proposedEpoch in the debug statement.


;12/Feb/24 18:26;githubbot;600","maoling merged PR #2136:
URL: https://github.com/apache/zookeeper/pull/2136


;15/Jun/24 09:43;githubbot;600","maoling commented on PR #2136:
URL: https://github.com/apache/zookeeper/pull/2136#issuecomment-2169249453

   @li4wang  Thanks for your contribution.


;15/Jun/24 09:44;githubbot;600","kezhuw commented on PR #2136:
URL: https://github.com/apache/zookeeper/pull/2136#issuecomment-2380666471

   @anmolnar Should this be backported ?


;28/Sep/24 14:50;githubbot;600","anmolnar commented on PR #2136:
URL: https://github.com/apache/zookeeper/pull/2136#issuecomment-2380833270

   @kezhuw It's already on `branch-3.9` as far as I can see.


;28/Sep/24 16:54;githubbot;600","anmolnar commented on PR #2136:
URL: https://github.com/apache/zookeeper/pull/2136#issuecomment-2380835243

   It's not actually backported, but the log line looks correct on `branch-3.9`, when I try backporting it, the commit becomes empty.


;28/Sep/24 17:01;githubbot;600","kezhuw commented on PR #2136:
URL: https://github.com/apache/zookeeper/pull/2136#issuecomment-2380878745

   @anmolnar  Sorry for taking your time!
   
   I think it is a follow up of #2111 and included in backport #2133. I have updated the affected version to `3.10.0` to reflect this.


;28/Sep/24 19:52;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,4200,,,0,4200,,,,,,,ZOOKEEPER-4785,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2024-02-12 18:19:11.0,,,,,,,,,,"0|z1ncrk:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Add sid for the leader goodbyte log,ZOOKEEPER-4807,13568083,,Wish,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,,horizonzy,horizonzy,09/Feb/24 23:36,07/Jul/25 14:21,08/Dec/25 08:12,15/Jun/24 09:50,3.9.1,,,,,,,,3.10.0,,,server,,,,0,pull-request-available,,,"When a follower disconnects with the leader, the leader will print the remote address.

But if the zookeeper is along with istio, the remote address is not right.

2024-02-05T03:23:54,967+0000 [LearnerHandler-/127.0.0.6:56085] WARN  org.apache.zookeeper.server.quorum.LearnerHandler - ******* GOODBYE /127.0.0.6:56085 ********


We would better print the sid in the goodbye log.

",,"horizonzy opened a new pull request, #2131:
URL: https://github.com/apache/zookeeper/pull/2131

   (no comment)


;09/Feb/24 23:37;githubbot;600","horizonzy closed pull request #2131: ZOOKEEPER-4807: Add sid in the leader goodbyte log.
URL: https://github.com/apache/zookeeper/pull/2131


;11/Feb/24 18:20;githubbot;600","horizonzy opened a new pull request, #2131:
URL: https://github.com/apache/zookeeper/pull/2131

   (no comment)


;11/Feb/24 18:20;githubbot;600","maoling merged PR #2131:
URL: https://github.com/apache/zookeeper/pull/2131


;15/Jun/24 09:49;githubbot;600","maoling commented on PR #2131:
URL: https://github.com/apache/zookeeper/pull/2131#issuecomment-2169252068

   @horizonzy  
   Thanks for your contribution.


;15/Jun/24 09:50;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3000,,,0,3000,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2024-02-09 23:36:37.0,,,,,,,,,,"0|z1nby8:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Commits have to be refreshed after merging,ZOOKEEPER-4806,13568042,13553106,Sub-task,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,szucsvillo,andor,andor,09/Feb/24 16:38,28/Sep/24 14:52,08/Dec/25 08:12,15/Feb/24 13:41,,,,,,,,,3.10.0,,,,,,,0,pull-request-available,,,"The following error occurs if somebody wants to cherry-pick immediately after merge:
{noformat}
All checks have passed on the github.
Pull request #2115 merged. Sha: #18c78cd10bc02d764a46ac1659b263cf69f2671d

Would you like to pick 18c78cd10bc02d764a46ac1659b263cf69f2671d into another branch? (y/n): y
Enter a branch name [branch-3.9]:
git fetch apache
From https://gitbox.apache.org/repos/asf/zookeeper
   72e3d9ce9..e571dd814  master     -> apache/master
git checkout -b PR_TOOL_PICK_PR_2115_BRANCH-3.9 apache/branch-3.9
Switched to a new branch 'PR_TOOL_PICK_PR_2115_BRANCH-3.9'
git cherry-pick -sx 18c78cd10bc02d764a46ac1659b263cf69f2671d
fatal: bad object 18c78cd10bc02d764a46ac1659b263cf69f2671d

Error cherry-picking: Command '['git', 'cherry-pick', '-sx', '18c78cd10bc02d764a46ac1659b263cf69f2671d']' returned non-zero exit status 128.{noformat}
The reason for this is, because the local git repo doesn't know about the new commit yet.

We should do a {{git fetch}} after successfully merged via GitHub.",,"szucsvillo opened a new pull request, #2137:
URL: https://github.com/apache/zookeeper/pull/2137

   Change-Id: I9cc9f4eb49cce34dcb1d416c914f5a94be5f7309


;13/Feb/24 15:07;githubbot;600","anmolnar commented on code in PR #2137:
URL: https://github.com/apache/zookeeper/pull/2137#discussion_r1488146215


##########
zk-merge-pr.py:
##########
@@ -209,9 +209,21 @@ def cherry_pick(pr_num, merge_hash, default_branch):
 
     pick_branch_name = ""%s_PICK_PR_%s_%s"" % (TEMP_BRANCH_PREFIX, pr_num, pick_ref.upper())
 
-    run_cmd(""git fetch %s"" % PUSH_REMOTE_NAME)
+    run_cmd(""git fetch %s"" % PR_REMOTE_NAME)
     run_cmd(""git checkout -b %s %s/%s"" % (pick_branch_name, PUSH_REMOTE_NAME, pick_ref))
 
+    current_attempt = 0
+    max_attempts = 6
+    # Check if the merge hash exists
+    while not run_cmd(""git rev-parse --verify %s"" % merge_hash):
+        if current_attempt >= max_attempts:
+            print(""Error: The commit hash does not exist in the local repository."")
+            exit()
+        current_attempt += 1
+        print(""Waiting for the merge hash to become available...(10 sec)"")
+        time.sleep(10)
+        run_cmd(""git fetch %s"" % PR_REMOTE_NAME)
+

Review Comment:
   As discussed offline I really doubt that this retry logic is needed, since GitHub pushes the new commit to PR_REMOTE_NAME with the default configuration.
   
   But I'm fine with that. Ship it!



;13/Feb/24 16:03;githubbot;600","anmolnar merged PR #2137:
URL: https://github.com/apache/zookeeper/pull/2137


;15/Feb/24 13:40;githubbot;600","anmolnar commented on PR #2137:
URL: https://github.com/apache/zookeeper/pull/2137#issuecomment-1946119757

   Merged. Thanks @szucsvillo !


;15/Feb/24 13:41;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,2400,,,0,2400,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2024-02-09 16:38:39.0,,,,,,,,,,"0|z1nbp4:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Use daemon threads for Netty client,ZOOKEEPER-4804,13567851,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,stoty,stoty,stoty,08/Feb/24 07:56,24/Oct/24 20:09,08/Dec/25 08:12,09/Mar/24 05:32,3.8.3,,,,,,,,3.10.0,3.9.3,,,,,,0,pull-request-available,,,"When the Netty client is used, the Java process hangs on System.exit if there is an open Zookeeper connection.

This is caused by the non-daemon threads created by Netty.

Exiting without closing the connection is not a good practice, but this hang does not happen with the NIO client, and I think ZK should behave the same regardless of the client implementation used.

The Netty ThreadFactory implementation is configurable, it shouldn't be too hard make sure that daemon threads are created.
",,"stoty opened a new pull request, #2142:
URL: https://github.com/apache/zookeeper/pull/2142

   (no comment)


;22/Feb/24 12:35;githubbot;600","stoty commented on PR #2142:
URL: https://github.com/apache/zookeeper/pull/2142#issuecomment-1985102641

   I have re-run the test suite on an empty change, and it fails the same way as these checks.
   #2145
   
   So the test failure is pre-existing.


;08/Mar/24 06:17;githubbot;600","stoty commented on PR #2142:
URL: https://github.com/apache/zookeeper/pull/2142#issuecomment-1985105477

   The test failure already has a ticket : https://issues.apache.org/jira/browse/ZOOKEEPER-4746


;08/Mar/24 06:21;githubbot;600","anmolnar commented on PR #2142:
URL: https://github.com/apache/zookeeper/pull/2142#issuecomment-1986528336

   I don't get it. The same test suite runs fine in hadoop-ci:
   https://ci-hadoop.apache.org/blue/organizations/jenkins/zookeeper-precommit-github-pr/detail/PR-2142/3/pipeline


;08/Mar/24 22:45;githubbot;600","tisonkun merged PR #2142:
URL: https://github.com/apache/zookeeper/pull/2142


;09/Mar/24 05:31;githubbot;600","stoty opened a new pull request, #2150:
URL: https://github.com/apache/zookeeper/pull/2150

   (no comment)


;20/Mar/24 19:39;githubbot;600","stoty commented on PR #2150:
URL: https://github.com/apache/zookeeper/pull/2150#issuecomment-2010477009

   FYI @anmolnar 


;20/Mar/24 19:40;githubbot;600","anmolnar commented on PR #2150:
URL: https://github.com/apache/zookeeper/pull/2150#issuecomment-2013853408

   @tisonkun @phunt Based on your thoughts, is this one eligible as a critical fix for `branch-3.8`?


;21/Mar/24 21:45;githubbot;600","anmolnar closed pull request #2150: ZOOKEEPER-4804. Use daemon threads for Netty client (#2142)
URL: https://github.com/apache/zookeeper/pull/2150


;03/May/24 13:19;githubbot;600","anmolnar commented on PR #2150:
URL: https://github.com/apache/zookeeper/pull/2150#issuecomment-2093006146

   I close this PR, because it's not considered a critical fix for 3.8


;03/May/24 13:19;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,6000,,,0,6000,,,,,,,,PHOENIX-7223,HBASE-28353,HBASE-28448,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Wed Mar 20 15:44:02 UTC 2024,,,,,,,,,,"0|z1naio:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"08/Feb/24 07:57;stoty;FYI [~andor].;;;","08/Feb/24 08:22;eolivelli;would you like to send a PR ?;;;","08/Feb/24 09:43;stoty;I don't have the time right now.
Maybe in a few weeks, but if anyone feels like doing this, don't wait for me.
;;;","22/Feb/24 14:53;stoty;I have uploaded a PR with the fix [~eolivelli].;;;","09/Mar/24 05:32;tison;master via 803c485db99134d8f41c2ea90ca9305e6b806d52;;;","20/Mar/24 15:44;stoty;I think this is important enopugh to be backported to all active branches.
FYI [~andor];;;",,,,,,
Secure prometheus support,ZOOKEEPER-4798,13566606,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,puru,puru,puru,30/Jan/24 00:28,28/Sep/24 11:56,08/Dec/25 08:12,23/Sep/24 18:59,,,,,,,,,3.10.0,,,,,,,0,pull-request-available,,,"The current implementation uses HTTP. However, many companies, especially those on the cloud, require HTTPS.",,"purushah opened a new pull request, #2127:
URL: https://github.com/apache/zookeeper/pull/2127

   (no comment)


;01/Feb/24 19:40;githubbot;600","eolivelli commented on code in PR #2127:
URL: https://github.com/apache/zookeeper/pull/2127#discussion_r1481022680


##########
zookeeper-metrics-providers/zookeeper-prometheus-metrics/src/main/java/org/apache/zookeeper/metrics/prometheus/PrometheusMetricsProvider.java:
##########
@@ -101,8 +100,8 @@ public class PrometheusMetricsProvider implements MetricsProvider {
     private final CollectorRegistry collectorRegistry = CollectorRegistry.defaultRegistry;
     private final RateLogger rateLogger = new RateLogger(LOG, 60 * 1000);
     private String host = ""0.0.0.0"";
-    private int port = 7000;
-    private boolean exportJvmInfo = true;
+    protected int port = 7000;

Review Comment:
   I would add support for a secondary port here instead of creating an alternative metrics provider.
   
   The Metrics Provider is the library/system that you use to export metrics, and it should not be related to security/https
   
   Can you please merge the two classes in one ?



;07/Feb/24 07:51;githubbot;600","purushah commented on PR #2127:
URL: https://github.com/apache/zookeeper/pull/2127#issuecomment-2000190434

   Hello @eolivelli, I have taken your suggestions into consideration and made the necessary changes. Can you please review the patch and let me know your thoughts?


;15/Mar/24 18:11;githubbot;600","eolivelli commented on code in PR #2127:
URL: https://github.com/apache/zookeeper/pull/2127#discussion_r1527195094


##########
zookeeper-metrics-providers/zookeeper-prometheus-metrics/src/main/java/org/apache/zookeeper/metrics/prometheus/PrometheusMetricsProvider.java:
##########
@@ -111,11 +115,46 @@ public class PrometheusMetricsProvider implements MetricsProvider {
     private long workerShutdownTimeoutMs = 1000;
     private Optional<ExecutorService> executorOptional = Optional.empty();
 
+    // Constants for SSL configuration
+    public static final int SCAN_INTERVAL = 60 * 10; // 10 minutes
+    public static final String SSL_KEYSTORE_LOCATION = ""ssl.keyStore.location"";
+    public static final String SSL_KEYSTORE_PASSWORD = ""ssl.keyStore.password"";
+    public static final String SSL_KEYSTORE_TYPE = ""ssl.keyStore.type"";
+    public static final String SSL_TRUSTSTORE_LOCATION = ""ssl.trustStore.location"";
+    public static final String SSL_TRUSTSTORE_PASSWORD = ""ssl.trustStore.password"";
+    public static final String SSL_TRUSTSTORE_TYPE = ""ssl.trustStore.type"";
+    public static final String SSL_X509_CN = ""ssl.x509.cn"";
+    public static final String SSL_X509_REGEX_CN = ""ssl.x509.cn.regex"";
+    public static final String SSL_NEED_CLIENT_AUTH = ""ssl.need.client.auth"";
+    public static final String SSL_WANT_CLIENT_AUTH = ""ssl.want.client.auth"";
+
+    private String keyStorePath;
+    private String keyStorePassword;
+    private String keyStoreType;
+    private String trustStorePath;
+    private String trustStorePassword;
+    private String trustStoreType;
+    private boolean needClientAuth = true;
+    private boolean wantClientAuth = true;
+
     @Override
     public void configure(Properties configuration) throws MetricsProviderLifeCycleException {
         LOG.info(""Initializing metrics, configuration: {}"", configuration);
         this.host = configuration.getProperty(""httpHost"", ""0.0.0.0"");
-        this.port = Integer.parseInt(configuration.getProperty(""httpPort"", ""7000""));
+        if (configuration.containsKey(""httpsPort"")) {
+            this.port = Integer.parseInt(configuration.getProperty(""httpsPort""));

Review Comment:
   It seems that this way you can only configure http or https but  not both..
   
   I suggest to allow to configure both of them, then the amministrator can decide what to enable.
   
   



;16/Mar/24 16:13;githubbot;600","purushah commented on code in PR #2127:
URL: https://github.com/apache/zookeeper/pull/2127#discussion_r1556051784


##########
zookeeper-metrics-providers/zookeeper-prometheus-metrics/src/main/java/org/apache/zookeeper/metrics/prometheus/PrometheusMetricsProvider.java:
##########
@@ -111,11 +115,46 @@ public class PrometheusMetricsProvider implements MetricsProvider {
     private long workerShutdownTimeoutMs = 1000;
     private Optional<ExecutorService> executorOptional = Optional.empty();
 
+    // Constants for SSL configuration
+    public static final int SCAN_INTERVAL = 60 * 10; // 10 minutes
+    public static final String SSL_KEYSTORE_LOCATION = ""ssl.keyStore.location"";
+    public static final String SSL_KEYSTORE_PASSWORD = ""ssl.keyStore.password"";
+    public static final String SSL_KEYSTORE_TYPE = ""ssl.keyStore.type"";
+    public static final String SSL_TRUSTSTORE_LOCATION = ""ssl.trustStore.location"";
+    public static final String SSL_TRUSTSTORE_PASSWORD = ""ssl.trustStore.password"";
+    public static final String SSL_TRUSTSTORE_TYPE = ""ssl.trustStore.type"";
+    public static final String SSL_X509_CN = ""ssl.x509.cn"";
+    public static final String SSL_X509_REGEX_CN = ""ssl.x509.cn.regex"";
+    public static final String SSL_NEED_CLIENT_AUTH = ""ssl.need.client.auth"";
+    public static final String SSL_WANT_CLIENT_AUTH = ""ssl.want.client.auth"";
+
+    private String keyStorePath;
+    private String keyStorePassword;
+    private String keyStoreType;
+    private String trustStorePath;
+    private String trustStorePassword;
+    private String trustStoreType;
+    private boolean needClientAuth = true;
+    private boolean wantClientAuth = true;
+
     @Override
     public void configure(Properties configuration) throws MetricsProviderLifeCycleException {
         LOG.info(""Initializing metrics, configuration: {}"", configuration);
         this.host = configuration.getProperty(""httpHost"", ""0.0.0.0"");
-        this.port = Integer.parseInt(configuration.getProperty(""httpPort"", ""7000""));
+        if (configuration.containsKey(""httpsPort"")) {
+            this.port = Integer.parseInt(configuration.getProperty(""httpsPort""));

Review Comment:
   Done



;08/Apr/24 15:36;githubbot;600","abhilash1in commented on code in PR #2127:
URL: https://github.com/apache/zookeeper/pull/2127#discussion_r1569684478


##########
zookeeper-metrics-providers/zookeeper-prometheus-metrics/src/main/java/org/apache/zookeeper/metrics/prometheus/PrometheusMetricsProvider.java:
##########
@@ -111,11 +115,46 @@ public class PrometheusMetricsProvider implements MetricsProvider {
     private long workerShutdownTimeoutMs = 1000;
     private Optional<ExecutorService> executorOptional = Optional.empty();
 
+    // Constants for SSL configuration
+    public static final int SCAN_INTERVAL = 60 * 10; // 10 minutes
+    public static final String SSL_KEYSTORE_LOCATION = ""ssl.keyStore.location"";
+    public static final String SSL_KEYSTORE_PASSWORD = ""ssl.keyStore.password"";
+    public static final String SSL_KEYSTORE_TYPE = ""ssl.keyStore.type"";
+    public static final String SSL_TRUSTSTORE_LOCATION = ""ssl.trustStore.location"";
+    public static final String SSL_TRUSTSTORE_PASSWORD = ""ssl.trustStore.password"";
+    public static final String SSL_TRUSTSTORE_TYPE = ""ssl.trustStore.type"";
+    public static final String SSL_X509_CN = ""ssl.x509.cn"";
+    public static final String SSL_X509_REGEX_CN = ""ssl.x509.cn.regex"";
+    public static final String SSL_NEED_CLIENT_AUTH = ""ssl.need.client.auth"";
+    public static final String SSL_WANT_CLIENT_AUTH = ""ssl.want.client.auth"";
+
+    private String keyStorePath;
+    private String keyStorePassword;
+    private String keyStoreType;
+    private String trustStorePath;
+    private String trustStorePassword;
+    private String trustStoreType;
+    private boolean needClientAuth = true;
+    private boolean wantClientAuth = true;
+
     @Override
     public void configure(Properties configuration) throws MetricsProviderLifeCycleException {
         LOG.info(""Initializing metrics, configuration: {}"", configuration);
         this.host = configuration.getProperty(""httpHost"", ""0.0.0.0"");
-        this.port = Integer.parseInt(configuration.getProperty(""httpPort"", ""7000""));
+        if (configuration.containsKey(""httpsPort"")) {
+            this.port = Integer.parseInt(configuration.getProperty(""httpsPort""));

Review Comment:
   Is there a way to support port unification, like we do for client port and admin server port?



;17/Apr/24 23:47;githubbot;600","purushah commented on PR #2127:
URL: https://github.com/apache/zookeeper/pull/2127#issuecomment-2125514332

   @eolivelli, could you please merge it? I am worried that further delay could lead to conflicts.


;22/May/24 18:42;githubbot;600","tisonkun commented on PR #2127:
URL: https://github.com/apache/zookeeper/pull/2127#issuecomment-2264285518

   Thanks for your contribution! LGTM.
   
   I'll wait a bit for CI and then merge if no blocker.


;02/Aug/24 00:46;githubbot;600","tisonkun merged PR #2127:
URL: https://github.com/apache/zookeeper/pull/2127


;02/Aug/24 03:47;githubbot;600","tisonkun commented on PR #2127:
URL: https://github.com/apache/zookeeper/pull/2127#issuecomment-2264468566

   cppunit failure should be unrelated to this patch. Merging ...


;02/Aug/24 03:48;githubbot;600","anmolnar commented on PR #2127:
URL: https://github.com/apache/zookeeper/pull/2127#issuecomment-2362658369

   @tisonkun @eolivelli branch-3.9 ?


;20/Sep/24 02:56;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,6600,,,0,6600,,,,,,,,,,ZOOKEEPER-4862,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2024-01-30 00:28:25.0,,,,,,,,,,"0|z1n2u8:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Reduce the ZKDatabase#committedLog memory usage,ZOOKEEPER-4794,13566070,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Critical,Fixed,horizonzy,horizonzy,horizonzy,25/Jan/24 05:01,13/Feb/24 10:23,08/Dec/25 08:12,09/Feb/24 16:39,3.9.1,,,,,,,,3.10.0,3.9.2,,server,,,,0,pull-request-available,,,"In ZKDatabase, after a quorum request is committed successfully, the ZKDatabase will wrap the request into a proposal and store it in the committedLog. 
The wrap operation: Serialize the request to a byte array and wrap the byte array in the QuorumPacket, so if the request payload size is 1M, the Proposal will occupy 2M memory, which will increase the memory pressure.

The committedLog is used for fast follower synchronization, so we can serialize the request in the synchronization of the processes, no need to serialize the request in advance.

It can reduce half of the memory for committedLog
",,"horizonzy opened a new pull request, #2115:
URL: https://github.com/apache/zookeeper/pull/2115

   In most cases, the committed log isn't used, it's only used in the fast follower synchronization. 
   So we can generate the QuorumPacket when fast follower synchronizing to reduce the  ZKDatabase#committedLog memory usage.
   
   
   


;25/Jan/24 10:46;githubbot;600","eolivelli commented on code in PR #2115:
URL: https://github.com/apache/zookeeper/pull/2115#discussion_r1466194310


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/Request.java:
##########
@@ -169,24 +168,16 @@ public boolean isThrottlable() {
                 && this.type != OpCode.createSession;
     }
 
-    private transient byte[] serializeData;
-
-    @SuppressFBWarnings(value = ""EI_EXPOSE_REP"")
     public byte[] getSerializeData() {
         if (this.hdr == null) {
             return null;
         }
-
-        if (this.serializeData == null) {

Review Comment:
   so basically you are saying that caching this value is useless ?
   do you know why we were caching it ?
   



;25/Jan/24 10:57;githubbot;600","horizonzy commented on code in PR #2115:
URL: https://github.com/apache/zookeeper/pull/2115#discussion_r1466201702


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/Request.java:
##########
@@ -169,24 +168,16 @@ public boolean isThrottlable() {
                 && this.type != OpCode.createSession;
     }
 
-    private transient byte[] serializeData;
-
-    @SuppressFBWarnings(value = ""EI_EXPOSE_REP"")
     public byte[] getSerializeData() {
         if (this.hdr == null) {
             return null;
         }
-
-        if (this.serializeData == null) {

Review Comment:
   See https://github.com/apache/zookeeper/pull/2030, the aim is to reduce the serialization. From the prd, the memory looks more sensitive.



;25/Jan/24 11:02;githubbot;600","eolivelli commented on PR #2115:
URL: https://github.com/apache/zookeeper/pull/2115#issuecomment-1911782238

   @anmolnar @tisonkun @lvfangmin @ztzg 


;26/Jan/24 10:01;githubbot;600","anmolnar commented on code in PR #2115:
URL: https://github.com/apache/zookeeper/pull/2115#discussion_r1484547484


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/TxnLogProposalIterator.java:
##########
@@ -58,20 +58,19 @@ public boolean hasNext() {
     @Override
     public Proposal next() {
 
-        Proposal p = new Proposal();
+        Proposal p;
         try {
             byte[] serializedData = Util.marshallTxnEntry(itr.getHeader(), itr.getTxn(), itr.getDigest());
 
             QuorumPacket pp = new QuorumPacket(Leader.PROPOSAL, itr.getHeader().getZxid(), serializedData, null);
-            p.packet = pp;
-            p.request = null;
-
+            p = new Proposal(pp);
             // This is the only place that can throw IO exception
             hasNext = itr.next();
 
         } catch (IOException e) {
             LOG.error(""Unable to read txnlog from disk"", e);
             hasNext = false;
+            p = new Proposal();

Review Comment:
   Weird to create objects in catch block, but it's okay.



;09/Feb/24 16:31;githubbot;600","anmolnar merged PR #2115:
URL: https://github.com/apache/zookeeper/pull/2115


;09/Feb/24 16:32;githubbot;600","anmolnar commented on PR #2115:
URL: https://github.com/apache/zookeeper/pull/2115#issuecomment-1936247697

   Merged to `master` and `branch-9` branches. Thanks @horizonzy! Please share your jira id.


;09/Feb/24 16:41;githubbot;600","horizonzy commented on PR #2115:
URL: https://github.com/apache/zookeeper/pull/2115#issuecomment-1936262797

   > Merged to `master` and `branch-3.9` branches. Thanks @horizonzy! Please share your jira id.
   
   horizonzy


;09/Feb/24 16:52;githubbot;600","anmolnar commented on PR #2115:
URL: https://github.com/apache/zookeeper/pull/2115#issuecomment-1941095996

   > horizonzy
   
   Thanks, now you're officially a ZooKeeper contributor. ;)


;13/Feb/24 10:23;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,5400,,,0,5400,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2024-01-25 05:01:17.0,,,,,,,,,,"0|z1mzj4:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Tune the env log at the start of the process,ZOOKEEPER-4792,13566060,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,horizonzy,horizonzy,horizonzy,25/Jan/24 03:28,07/Jul/25 14:21,08/Dec/25 08:12,07/Feb/24 07:37,3.9.1,,,,,,,,3.10.0,,,server,,,,0,pull-request-available,,,"At the start of the process, it will print the env info in the log. 
There are three logs for the memory metrics.

{code:java}
        // Get memory information.
        Runtime runtime = Runtime.getRuntime();
        int mb = 1024 * 1024;
        put(l, ""os.memory.free"", runtime.freeMemory() / mb + ""MB"");
        put(l, ""os.memory.max"", runtime.maxMemory() / mb + ""MB"");
        put(l, ""os.memory.total"", runtime.totalMemory() / mb + ""MB"");
{code}

https://github.com/apache/zookeeper/blob/9e40464d98319b4553d93b12c6d7db4d240bbce9/zookeeper-server/src/main/java/org/apache/zookeeper/Environment.java#L88-L90

It's misleading for the user, use jvm as the prefix will be better.

Change to:
{code:java}
        // Get memory information.
        Runtime runtime = Runtime.getRuntime();
        int mb = 1024 * 1024;
        put(l, ""jvm,.memory.free"", runtime.freeMemory() / mb + ""MB"");
        put(l, ""jvm.memory.max"", runtime.maxMemory() / mb + ""MB"");
        put(l, ""jvm.memory.total"", runtime.totalMemory() / mb + ""MB"");
{code}
",,"horizonzy opened a new pull request, #2112:
URL: https://github.com/apache/zookeeper/pull/2112

   Use jvm as the prefix for the memory env log.


;25/Jan/24 03:29;githubbot;600","maoling merged PR #2112:
URL: https://github.com/apache/zookeeper/pull/2112


;07/Feb/24 07:35;githubbot;600","maoling commented on PR #2112:
URL: https://github.com/apache/zookeeper/pull/2112#issuecomment-1931448020

   @horizonzy 
   Thanks for your contribution.


;07/Feb/24 07:37;githubbot;600","anmolnar commented on PR #2112:
URL: https://github.com/apache/zookeeper/pull/2112#issuecomment-1935973418

   @horizonzy This is the second great patch I've found under your name. You should be a Zk contributor. Please provide your jira id.


;09/Feb/24 13:53;githubbot;600","horizonzy commented on PR #2112:
URL: https://github.com/apache/zookeeper/pull/2112#issuecomment-1936241833

   > @horizonzy This is the second great patch I've found under your name. You should be a Zk contributor. Please provide your jira id.
   
   Ok, Jira id: horizonzy


;09/Feb/24 16:37;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,3000,,,0,3000,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,2024-01-25 03:28:33.0,,,,,,,,,,"0|z1mzgw:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
Improve logging when the connection to a remote server is closed,ZOOKEEPER-4791,13565975,,Improvement,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Trivial,Fixed,,sliebau,sliebau,24/Jan/24 13:32,30/Jan/24 18:12,08/Dec/25 08:12,30/Jan/24 18:10,3.9.1,,,,,,,,3.10.0,,,server,,,,0,pull-request-available,,,"When a server closes the connection to a remote server, the logging around why the connection is being closed could be improved a bit.

https://github.com/apache/zookeeper/blob/1cc1eb6a2be7323a5c326652d59a070473bb8779/zookeeper-server/src/main/java/org/apache/zookeeper/server/NettyServerCnxn.java#L524

{code:java}
ZooKeeperServer zks = this.zkServer;
if (zks == null || !zks.isRunning()) {
                            LOG.info(""Closing connection to {} because the server is not ready"",
                                    getRemoteSocketAddress());
                            close(DisconnectReason.IO_EXCEPTION);
                            return;
                        }
{code}

It would be helpful to log what zkServer is, because it can have multiple states that would trigger this shutdown.",,"Maleware opened a new pull request, #2114:
URL: https://github.com/apache/zookeeper/pull/2114

   …r is closed


;25/Jan/24 09:31;githubbot;600","eolivelli commented on code in PR #2114:
URL: https://github.com/apache/zookeeper/pull/2114#discussion_r1466377773


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/NettyServerCnxn.java:
##########
@@ -528,7 +528,7 @@ private void receiveMessage(ByteBuf message) {
                         ZooKeeperServer zks = this.zkServer;
                         if (zks == null || !zks.isRunning()) {
                             LOG.info(""Closing connection to {} because the server is not ready"",
-                                    getRemoteSocketAddress());
+                                getRemoteSocketAddress(), zks == null ? ""null"" : zks.getState());

Review Comment:
   maybe ""UNKNOWN"" is better than ""null"" here ?



##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/NettyServerCnxn.java:
##########
@@ -528,7 +528,7 @@ private void receiveMessage(ByteBuf message) {
                         ZooKeeperServer zks = this.zkServer;
                         if (zks == null || !zks.isRunning()) {
                             LOG.info(""Closing connection to {} because the server is not ready"",

Review Comment:
   it seem that you are not printing the state



;25/Jan/24 13:26;githubbot;600","Maleware commented on code in PR #2114:
URL: https://github.com/apache/zookeeper/pull/2114#discussion_r1467465837


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/NettyServerCnxn.java:
##########
@@ -528,7 +528,7 @@ private void receiveMessage(ByteBuf message) {
                         ZooKeeperServer zks = this.zkServer;
                         if (zks == null || !zks.isRunning()) {
                             LOG.info(""Closing connection to {} because the server is not ready"",

Review Comment:
   Yeah! Good catch, thanks!
   



;26/Jan/24 10:23;githubbot;600","Maleware commented on code in PR #2114:
URL: https://github.com/apache/zookeeper/pull/2114#discussion_r1467466098


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/NettyServerCnxn.java:
##########
@@ -528,7 +528,7 @@ private void receiveMessage(ByteBuf message) {
                         ZooKeeperServer zks = this.zkServer;
                         if (zks == null || !zks.isRunning()) {
                             LOG.info(""Closing connection to {} because the server is not ready"",
-                                    getRemoteSocketAddress());
+                                getRemoteSocketAddress(), zks == null ? ""null"" : zks.getState());

Review Comment:
   I think you are right, UNKOWN is a bit more speaking. Done.



;26/Jan/24 10:23;githubbot;600","soenkeliebau commented on code in PR #2114:
URL: https://github.com/apache/zookeeper/pull/2114#discussion_r1467548303


##########
zookeeper-server/src/main/java/org/apache/zookeeper/server/NettyServerCnxn.java:
##########
@@ -528,7 +528,7 @@ private void receiveMessage(ByteBuf message) {
                         ZooKeeperServer zks = this.zkServer;
                         if (zks == null || !zks.isRunning()) {
                             LOG.info(""Closing connection to {} because the server is not ready"",
-                                    getRemoteSocketAddress());
+                                getRemoteSocketAddress(), zks == null ? ""null"" : zks.getState());

Review Comment:
   super-nit: I think I'd prefer ""unknown"", by capitalizing it we suggest that UNKNOWN is a variant of the State enum, whereas ""unknown"" would rather suggest that we were unable to figure out the state.
   But again, super-super-nitty comment and I have no strong opinion - might just be my brain is wired weird to think about this :)



;26/Jan/24 11:28;githubbot;600","soenkeliebau commented on PR #2114:
URL: https://github.com/apache/zookeeper/pull/2114#issuecomment-1916949378

   ping @eolivelli - this looks good me now


;30/Jan/24 14:10;githubbot;600","Maleware commented on PR #2114:
URL: https://github.com/apache/zookeeper/pull/2114#issuecomment-1917594997

   Ping @tisonkun . Thanks :) 


;30/Jan/24 17:59;githubbot;600","tisonkun merged PR #2114:
URL: https://github.com/apache/zookeeper/pull/2114


;30/Jan/24 18:09;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,4800,,,0,4800,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Tue Jan 30 18:10:09 UTC 2024,,,,,,,,,,"0|z1myy0:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"24/Jan/24 14:00;eolivelli;would you send a PR ?;;;","24/Jan/24 16:32;sliebau;Someone from our team is on the PR, yes. I just opened the issue because he doesn't have an account here and registration is disabled.
PR should be opened tomorrow I hope.;;;","30/Jan/24 18:10;tison;Master via https://github.com/apache/zookeeper/commit/3913303677935a60f05aa0cfc0787d5809961c3b;;;",,,,,,,,,
TLS Quorum hostname verification breaks in some scenarios,ZOOKEEPER-4790,13565925,,Improvement,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Minor,Fixed,sliebau,sliebau,sliebau,24/Jan/24 09:55,29/Aug/25 21:29,08/Dec/25 08:12,22/Nov/24 22:32,3.9.1,,,,,,,,3.10.0,3.9.4,,,,,,0,pull-request-available,,,"Currently, enabling Quorum TLS will make the server validate SANs client certificates of connecting quorum peers against their reverse DNS address. 

 We have seen this cause issues when running in Kubernetes, due to ip addresses resolving to multiple dns names, when ZooKeeper pods participate in multiple services. 

Since `InetAddress.getHostAddress()` returns a String, it basically becomes a game of chance which dns name is checked against the cert. 
This usually shakes itself loose after a few minutes, when the hostname that gets returned by the reverse lookup randomly changes and all of a sudden matches the certificate... but this is less than ideal.

This has also caused issues in the Strimzi operator as well (see [this issue|https://github.com/strimzi/strimzi-kafka-operator/issues/3099]) - they solved this by pretty much adding anything they can find that might be relevant to the SAN, and a few wildcards on top of that.

This is both, error prone and doesn't really add any relevant extra amount of security, since ""This certificate matches the connecting peer"" shouldn't automatically mean ""this peer should be allowed to connect"".
 
 There are two (probably more) ways to fix this:

# Retrieve _all_  reverse entries and check against all of them
# The ZK server could verify the SAN against the list of servers ({{{}servers.N{}}} in the config). A peer should be able to connect on the quorum port if and only if at least one SAN matches at least one of the listed servers.

I'd argue that the second option is the better one, especially since the java api doesn't even seem to have the option of retrieving all dns entries, but also because it better matches the expressed intent of the ZK admin.

Additionally, it would be nice to have a ""disable client hostname verification"" option that still leaves server hostname verification enabled. Strictly speaking this is a separate issue though, I'd be happy to spin that out into a ticket of its own..

",,"nightkr opened a new pull request, #2173:
URL: https://github.com/apache/zookeeper/pull/2173

   FIPS mode _technically_ covers this, in a sort of sledgehammery way, but I think it's still worthwhile to have an explicit option for this and only this. Especially since FIPS compliance is a pretty broad thing (see [ZOOKEEPER-4832](https://issues.apache.org/jira/browse/ZOOKEEPER-4832)) that will likely expand in the future to cover a lot of things that may or may not be desired.


;17/Jun/24 13:18;githubbot;600","anmolnar closed pull request #2173: ZOOKEEPER-4790: Make client hostname verification configurable
URL: https://github.com/apache/zookeeper/pull/2173


;27/Aug/24 19:26;githubbot;600","anmolnar commented on PR #2173:
URL: https://github.com/apache/zookeeper/pull/2173#issuecomment-2313343656

   > FIPS mode _technically_ covers this, in a sort of sledgehammery way, but I think it's still worthwhile to have an explicit option for this and only this. Especially since FIPS compliance is a pretty broad thing (see [ZOOKEEPER-4832](https://issues.apache.org/jira/browse/ZOOKEEPER-4832)) that will likely expand in the future to cover a lot of things that may or may not be desired.
   
   What do


;27/Aug/24 19:26;githubbot;600","nightkr opened a new pull request, #2173:
URL: https://github.com/apache/zookeeper/pull/2173

   FIPS mode _technically_ covers this, in a sort of sledgehammery way, but I think it's still worthwhile to have an explicit option for this and only this. Especially since FIPS compliance is a pretty broad thing (see [ZOOKEEPER-4832](https://issues.apache.org/jira/browse/ZOOKEEPER-4832)) that will likely expand in the future to cover a lot of things that may or may not be desired.


;27/Aug/24 19:26;githubbot;600","anmolnar commented on PR #2173:
URL: https://github.com/apache/zookeeper/pull/2173#issuecomment-2313348045

   Accidentally closed the PR, sorry.
   Wanted to ask:
   
   Have you considered replacing the current apporach with separate config settings
   - `zookeeper.ssl.(quorum.)server.hostnameVerification`
   - `zookeeper.ssl.(quorum.)client.hostnameVerification`


;27/Aug/24 19:28;githubbot;600","nightkr commented on PR #2173:
URL: https://github.com/apache/zookeeper/pull/2173#issuecomment-2313436433

   In a green field I think that makes sense, but I don't think it's worth breaking the old config value ""just"" for this.


;27/Aug/24 20:20;githubbot;600","anmolnar commented on PR #2173:
URL: https://github.com/apache/zookeeper/pull/2173#issuecomment-2313488555

   > In a green field I think that makes sense, but I don't think it's worth breaking the old config value ""just"" for this.
   
   You can keep backward compatibility by parsing both `zookeeper.ssl.server.hostnameVerification` and `zookeeper.ssl.hostnameVerification` as the server setting.


;27/Aug/24 20:37;githubbot;600","anmolnar commented on code in PR #2173:
URL: https://github.com/apache/zookeeper/pull/2173#discussion_r1733492664


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1739,6 +1739,12 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Disabling it only recommended for testing purposes.
     Default: true
 
+* *ssl.clientHostnameVerification* and *ssl.quorum.clientHostnameVerification* :
+    (Java system properties: **zookeeper.ssl.clientHostnameVerification** and **zookeeper.ssl.quorum.clientHostnameVerification**)
+    **New in (INSERT VERSION HERE):**

Review Comment:
   3.9.3



;27/Aug/24 20:43;githubbot;600","anmolnar commented on code in PR #2173:
URL: https://github.com/apache/zookeeper/pull/2173#discussion_r1733494485


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1739,6 +1739,12 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Disabling it only recommended for testing purposes.
     Default: true
 
+* *ssl.clientHostnameVerification* and *ssl.quorum.clientHostnameVerification* :
+    (Java system properties: **zookeeper.ssl.clientHostnameVerification** and **zookeeper.ssl.quorum.clientHostnameVerification**)
+    **New in (INSERT VERSION HERE):**
+    Specifies whether the client's hostname verification is enabled in client and quorum TLS negotiation process.

Review Comment:
   Please add that this setting will require server `hostnameVerification` setting to be true.



;27/Aug/24 20:45;githubbot;600","anmolnar commented on PR #2173:
URL: https://github.com/apache/zookeeper/pull/2173#issuecomment-2313527852

   @nightkr Ignore my previous comment. Since client hostname verification is bound to server hostname verification setting, it makes sense to keep the original and general `hostnameVerification` setting. It enables/disabled the entire feature. Your patch is good as it is.


;27/Aug/24 20:59;githubbot;600","nightkr commented on code in PR #2173:
URL: https://github.com/apache/zookeeper/pull/2173#discussion_r1853829024


##########
zookeeper-docs/src/main/resources/markdown/zookeeperAdmin.md:
##########
@@ -1739,6 +1739,12 @@ and [SASL authentication for ZooKeeper](https://cwiki.apache.org/confluence/disp
     Disabling it only recommended for testing purposes.
     Default: true
 
+* *ssl.clientHostnameVerification* and *ssl.quorum.clientHostnameVerification* :
+    (Java system properties: **zookeeper.ssl.clientHostnameVerification** and **zookeeper.ssl.quorum.clientHostnameVerification**)
+    **New in (INSERT VERSION HERE):**

Review Comment:
   689794749d71489c849fcaf8137a98c39dbd250a
   
   Skipped 3.9.3 since it's already released at this point



;22/Nov/24 12:18;githubbot;600","nightkr commented on PR #2173:
URL: https://github.com/apache/zookeeper/pull/2173#issuecomment-2493633341

   Sorry about the delay, got distracted by other stuff.


;22/Nov/24 12:21;githubbot;600","anmolnar merged PR #2173:
URL: https://github.com/apache/zookeeper/pull/2173


;22/Nov/24 22:32;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,7800,,,0,7800,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Mon Jan 13 14:22:08 UTC 2025,,,,,,,,,,"0|z1mymw:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"27/Aug/24 19:25;andor;[~sliebau] 
{quote} There are two (probably more) ways to fix this:
 # Retrieve _all_ reverse entries and check against all of them
 # The ZK server could verify the SAN against the list of servers ({{{}servers.N{}}} in the config). A peer should be able to connect on the quorum port if and only if at least one SAN matches at least one of the listed servers.{quote}
I think these two approaches don't contradict each other. You can add a new flag to toggle client hostname verification and also improve the logic how ZK does it if it's turned on.;;;","22/Nov/24 22:32;andor;Issue resolved by pull request 2173
[https://github.com/apache/zookeeper/pull/2173];;;","13/Jan/25 14:22;giorgos.georgiou;Hi!

The issue doesn't seem to be resolved by the linked pull request since the PR allows disabling hostnameVerification instead of validating against the configured ensemble (number 2 in the ""ways to fix"").

Is there a different issue for the second part?;;;",,,,,,,,,
Failed to establish connection between zookeeper,ZOOKEEPER-4787,13565203,,Bug,Closed,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Blocker,Fixed,softrock,softrock,softrock,18/Jan/24 07:10,29/Aug/25 21:29,08/Dec/25 08:12,24/Jul/25 18:02,3.7.2,3.8.3,3.9.1,,,,,,3.10.0,3.8.5,3.9.4,server,,,,0,pull-request-available,,,"*Problem:*

When run zookeepers version 3.8.3 on z/OS platform,they cannot establish the connection

Error:

[2024-01-17 23:06:44,194] INFO Received connection request from /xx.xx.xx.xx:23840 (org.apache.zookeeper.server.quorum.QuorumCnxManager)
 [2024-01-17 23:06:44,197] ERROR Initial message parsing error! (org.apache.zookeeper.server.quorum.QuorumCnxManager)
 org.apache.zookeeper.server.quorum.QuorumCnxManager$InitialMessage$InitialMessageException: Badly formed address: ????????K???K???K???z????
     at org.apache.zookeeper.server.quorum.QuorumCnxManager$InitialMessage.parse(QuorumCnxManager.java:271)
     at org.apache.zookeeper.server.quorum.QuorumCnxManager.handleConnection(QuorumCnxManager.java:607)
     at org.apache.zookeeper.server.quorum.QuorumCnxManager.receiveConnection(QuorumCnxManager.java:555)
     at org.apache.zookeeper.server.quorum.QuorumCnxManager$Listener$ListenerHandler.acceptConnections(QuorumCnxManager.java:1085)
     at org.apache.zookeeper.server.quorum.QuorumCnxManager$Listener$ListenerHandler.run(QuorumCnxManager.java:1039)
     at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:522)
     at java.util.concurrent.FutureTask.run(FutureTask.java:277)
     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1160)
     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)
     at java.lang.Thread.run(Thread.java:825)

*Root cause:*

The receiver cannot resolve the address from the sender requesting a connection. This is because the sender sends the address in UTF-8 encoding, but the receiver parses the address in IBM-1047 encoding (the default).

*Resolution:*

 Both receiver and sender sides use UTF-8 encoding

 ",z/OS,"Softrock opened a new pull request, #2108:
URL: https://github.com/apache/zookeeper/pull/2108

   (no comment)


;18/Jan/24 10:27;githubbot;600","Softrock opened a new pull request, #2109:
URL: https://github.com/apache/zookeeper/pull/2109

   (no comment)


;18/Jan/24 10:36;githubbot;600","Softrock opened a new pull request, #2110:
URL: https://github.com/apache/zookeeper/pull/2110

   (no comment)


;18/Jan/24 10:38;githubbot;600","Softrock commented on PR #2108:
URL: https://github.com/apache/zookeeper/pull/2108#issuecomment-1903504267

   @kezhuw Can you help me review this PR, Thanks so much!


;22/Jan/24 08:43;githubbot;600","Softrock commented on PR #2109:
URL: https://github.com/apache/zookeeper/pull/2109#issuecomment-1903509434

   @kezhuw Can you help me review this PR, Thanks so much!


;22/Jan/24 08:46;githubbot;600","Softrock commented on PR #2110:
URL: https://github.com/apache/zookeeper/pull/2110#issuecomment-1903509934

   @kezhuw Can you help me review this PR, Thanks so much!


;22/Jan/24 08:47;githubbot;600","anmolnar commented on PR #2108:
URL: https://github.com/apache/zookeeper/pull/2108#issuecomment-1978389108

   @Softrock Looks fine, but please open a PR to master branch only.


;05/Mar/24 10:03;githubbot;600","Softrock commented on PR #2108:
URL: https://github.com/apache/zookeeper/pull/2108#issuecomment-1980198092

   > @Softrock Looks fine, but please open a PR to master branch only.
   OK,thanks so much!
   
   


;06/Mar/24 06:51;githubbot;600","Softrock opened a new pull request, #2143:
URL: https://github.com/apache/zookeeper/pull/2143

   JIRA:https://issues.apache.org/jira/browse/ZOOKEEPER-4787


;06/Mar/24 07:53;githubbot;600","Softrock closed pull request #2109: ZOOKEEPER-4787:Failed to establish connection between zookeeper
URL: https://github.com/apache/zookeeper/pull/2109


;06/Mar/24 08:00;githubbot;600","Softrock closed pull request #2110: ZOOKEEPER-4787:Failed to establish connection between zookeeper
URL: https://github.com/apache/zookeeper/pull/2110


;06/Mar/24 08:01;githubbot;600","Softrock closed pull request #2108: ZOOKEEPER-4787:Failed to establish connection between zookeeper
URL: https://github.com/apache/zookeeper/pull/2108


;06/Mar/24 08:03;githubbot;600","Softrock commented on PR #2143:
URL: https://github.com/apache/zookeeper/pull/2143#issuecomment-1980311757

   >>@Softrock Looks fine, but please open a PR to master branch only.
   @anmolnar I opened the PR to master branch,Could you please take a look, thanks so much!
   


;06/Mar/24 08:18;githubbot;600","Softrock commented on PR #2143:
URL: https://github.com/apache/zookeeper/pull/2143#issuecomment-2071335856

   @anmolnar Could you help me review and approve the PR,Thank you so much!


;23/Apr/24 03:21;githubbot;600","Softrock commented on PR #2143:
URL: https://github.com/apache/zookeeper/pull/2143#issuecomment-2255326340

   Hi @anmolnar @breed @ztzg @maoling
   If the issue is not resolved, Zookeeper version 3.7.2 or later will not work on the z/OS platform. It prevents us from using newer versions. I want to know when the PR will be merged into the master and reflected in the new version?
   Thank you so much!


;29/Jul/24 08:32;githubbot;600","kezhuw merged PR #2143:
URL: https://github.com/apache/zookeeper/pull/2143


;24/Jul/25 17:58;githubbot;600","kezhuw commented on PR #2143:
URL: https://github.com/apache/zookeeper/pull/2143#issuecomment-3114371051

   Merged and backported to 3.8, 3.9 as it is a bug and quite simple.
   
   @Softrock Thank you for your contribution!


;24/Jul/25 18:04;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,10200,,,0,10200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Thu Jul 24 18:02:01 UTC 2025,,,,,,,,,,"0|z1mu6g:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"24/Jul/25 18:02;kezhuw;Issue resolved by pull request 2143
[https://github.com/apache/zookeeper/pull/2143];;;",,,,,,,,,,,
Txn loss due to race condition in Learner.syncWithLeader() during DIFF sync,ZOOKEEPER-4785,13564433,,Bug,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,li4wang,li4wang,li4wang,12/Jan/24 00:00,07/Jul/25 14:20,08/Dec/25 08:12,20/Mar/24 19:10,3.7.1,3.7.2,3.8.0,3.8.1,3.8.2,3.9.1,,,3.10.0,3.8.4,3.9.2,server,,,,0,pull-request-available,,,"We had txn loss incident in production recently. After investigation, we found it was caused by the race condition of follower writing the current epoch and sending the ACK_LD before successfully persisting all the txns from DIFF sync in Learner.syncWithLeader() method.

{code:java}
case Leader.NEWLEADER: 
        ...
        self.setCurrentEpoch(newEpoch);
        writeToTxnLog = true;
        //Anything after this needs to go to the transaction log, not applied directly in memory
        isPreZAB1_0 = false;

        // ZOOKEEPER-3911: make sure sync the uncommitted logs before commit them (ACK NEWLEADER).
        sock.setSoTimeout(self.tickTime * self.syncLimit);
        self.setSyncMode(QuorumPeer.SyncMode.NONE);
        zk.startupWithoutServing();
        if (zk instanceof FollowerZooKeeperServer) {
            FollowerZooKeeperServer fzk = (FollowerZooKeeperServer) zk;
            for (PacketInFlight p : packetsNotCommitted) {
              fzk.logRequest(p.hdr, p.rec, p.digest);
            }
            packetsNotCommitted.clear();
        }

        writePacket(new QuorumPacket(Leader.ACK, newLeaderZxid, null, null), true);
        break;
    }
{code}



In this method, when follower receives the NEWLEADER msg, the current epoch is updated before writing the uncommitted txns to the disk and writing txns is done asynchronously by the SyncThreadd.  If follower crashes after setting the current epoch and sending ACK_LD and before all transactions are successfully written to disk, transactions loss can happen.  

This is because leader election is based on epoch first and then transaction id.  When the follower becomes a leader because it has highest epoch, it will ask the other followers to truncate txns even they have been written to disk, causing data loss.

The following is the scenario

1. Leader election happened
2. A follower synced with Leader via DIFF, received committed proposals from leader and kept them in memory
3. The follower received the NEWLEADER message
4. The follower updated the newEpoch
5. The follower was bounced  before writing all the uncommitted txns to disk
6. Leader shutdown and a new election triggered
7. Follower became the new leader because it has largest currentEpoch
8. New leader asked other followers to truncate their committed txns and transactions got lost




",,"li4wang opened a new pull request, #2111:
URL: https://github.com/apache/zookeeper/pull/2111

   (no comment)


;23/Jan/24 05:43;githubbot;600","li4wang merged PR #2111:
URL: https://github.com/apache/zookeeper/pull/2111


;26/Jan/24 06:22;githubbot;600","li4wang opened a new pull request, #2132:
URL: https://github.com/apache/zookeeper/pull/2132

   cherry pick https://github.com/apache/zookeeper/pull/2111 to branch-3.8


;12/Feb/24 07:57;githubbot;600","li4wang opened a new pull request, #2133:
URL: https://github.com/apache/zookeeper/pull/2133

   backporting https://github.com/apache/zookeeper/pull/2111 to branch-3.9


;12/Feb/24 08:01;githubbot;600","li4wang merged PR #2133:
URL: https://github.com/apache/zookeeper/pull/2133


;12/Feb/24 19:59;githubbot;600","li4wang merged PR #2132:
URL: https://github.com/apache/zookeeper/pull/2132


;13/Feb/24 21:03;githubbot;600","ChengYilong89 commented on PR #2111:
URL: https://github.com/apache/zookeeper/pull/2111#issuecomment-2266656554

   hello, my friend. I met a issue in the production, the temporary node in the lead is deleted, however the temporary node in the other followers is not deleted. so we got data inconsistent between lead and follower.
   Then I see the ISSUE-4785, and the scenario is similar with the ISSUE-4785, the follower A sync with the leader, and old leader restart, and the  follower A became a new leader. 
   Does ISSUE-4785 can caused the issue I described above? In your description, what does ""5. The follower was bounced before writing all the uncommitted txns to disk"" means?


;03/Aug/24 09:45;githubbot;600","li4wang commented on PR #2111:
URL: https://github.com/apache/zookeeper/pull/2111#issuecomment-2268253444

   > Does ISSUE-4785 can caused the data inconsistent?
   Data inconsistence here means digest mismatch count is greater than 0 or you mean client see different data  from leader and follower?
   
   > what does ""5. The follower was bounced before writing all the uncommitted txns to disk""
   
   This means that follower didn't persist the txns from diff sync with leader into disk before shutdown and the follower lost the txns.


;05/Aug/24 06:12;githubbot;600","ChengYilong89 commented on PR #2111:
URL: https://github.com/apache/zookeeper/pull/2111#issuecomment-2268283708

   Data inconsistence here means digest mismatch count is greater than 0 or you mean client see different data from leader and follower?
   --;05/Aug/24 06:36;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,5400,,,0,5400,,,,,,,,ZOOKEEPER-4808,,,,,,,ZOOKEEPER-4541,ZOOKEEPER-4643,ZOOKEEPER-4646,ZOOKEEPER-3023,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Jan 12 00:46:28 UTC 2024,,,,,,,,,,"0|z1mpfk:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"12/Jan/24 00:46;li4wang;The issue can be fixed by persisting uncommitted txns from leader synchronously, so we can ensure the following order when processing NEWLEADER msg in the Learner.syncWithLeader() method.

1. Persisting all the txns/proposals in disk
2. Writing current epoch to disk
3. Sending ACK of NEWLEADER to leader
4. Sending ACK of proposals to leader


;;;",,,,,,,,,,,
Token based ASF JIRA authentication,ZOOKEEPER-4784,13564014,13553106,Sub-task,Resolved,ZOOKEEPER,ZooKeeper,software,phunt,Apache ZooKeeper is a service for coordinating processes of distributed applications.,http://zookeeper.apache.org,Major,Fixed,szucsvillo,szucsvillo,szucsvillo,09/Jan/24 08:37,09/Feb/24 11:24,08/Dec/25 08:12,09/Feb/24 11:24,,,,,,,,,3.10.0,,,tools,,,,0,pull-request-available,,,https://issues.apache.org/jira/browse/SPARK-44802,,"szucsvillo opened a new pull request, #2106:
URL: https://github.com/apache/zookeeper/pull/2106

   Change-Id: I71203b7c02d4e25ce47c11eea859c372ed0c18b6


;10/Jan/24 09:33;githubbot;600","anmolnar merged PR #2106:
URL: https://github.com/apache/zookeeper/pull/2106


;09/Feb/24 11:23;githubbot;600",,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,0,1200,,,0,1200,,,,,,,,,,,,,,,,,,,,,,,,,0.0,,,,,,,,,,,,,,,,,,,,,,false,,,,,,,,,,,,,,,,,,,,9223372036854775807,,,,,,Fri Feb 09 11:24:00 UTC 2024,,,,,,,,,,"0|z1mmug:",9223372036854775807,,,,,,,,,,,,,,,,,,,,,"09/Feb/24 11:24;andor;Issue resolved by pull request 2106
[https://github.com/apache/zookeeper/pull/2106];;;",,,,,,,,,,,
